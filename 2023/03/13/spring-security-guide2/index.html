<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>spring security 快速使用 (2) OAUTH2 | Calico's Space</title><meta name="author" content="Calico"><meta name="copyright" content="Calico"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Oauth2 概念和授权码模式鸽了很久，其实也因为自己确实比较忙，加之自己在造demo的时候也遇到了很多问题，并且网上这方面的解答非常之少，不过也正是因为少，才更加让我想写这样的知识分享，最终，在一篇博客的解答下解决了问题，本节我们就开始Oauth2的学习。在之前的学习中，我们可以说SpringSecurity本身的基础学习差不多告一段落，大家已经可以通过自己的能力去搭建一个SpringSecur">
<meta property="og:type" content="article">
<meta property="og:title" content="spring security 快速使用 (2) OAUTH2">
<meta property="og:url" content="http://xeons.cn/2023/03/13/spring-security-guide2/index.html">
<meta property="og:site_name" content="Calico&#39;s Space">
<meta property="og:description" content="Oauth2 概念和授权码模式鸽了很久，其实也因为自己确实比较忙，加之自己在造demo的时候也遇到了很多问题，并且网上这方面的解答非常之少，不过也正是因为少，才更加让我想写这样的知识分享，最终，在一篇博客的解答下解决了问题，本节我们就开始Oauth2的学习。在之前的学习中，我们可以说SpringSecurity本身的基础学习差不多告一段落，大家已经可以通过自己的能力去搭建一个SpringSecur">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://xeons.cn/2023/03/13/spring-security-guide2/logo.jpg">
<meta property="article:published_time" content="2023-03-12T16:00:00.000Z">
<meta property="article:author" content="Calico">
<meta property="article:tag" content="springSecurity">
<meta property="article:tag" content="oauth2">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://xeons.cn/2023/03/13/spring-security-guide2/logo.jpg"><link rel="shortcut icon" href="/images/calico-ss.png"><link rel="canonical" href="http://xeons.cn/2023/03/13/spring-security-guide2/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//hm.baidu.com"/><meta/><link rel="stylesheet" href="/css/index.css?v=4.13.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?6f97e3791752fae830e3db5ba194c6cb";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.11.1/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'spring security 快速使用 (2) OAUTH2',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-04-12 14:43:03'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.1.1"><link rel="alternate" href="/atom.xml" title="Calico's Space" type="application/atom+xml">
</head><body><script>window.paceOptions = {
  restartOnPushState: false
}

document.addEventListener('pjax:send', () => {
  Pace.restart()
})
</script><link rel="stylesheet" href="/css/loading_bar.css"/><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images/calico.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">62</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">35</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">27</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list hide"></i><span> 其他</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/demopage/"><i class="fa-fw fas fa-music"></i><span> Theme测试页</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="not-top-img" id="page-header"><nav id="nav"><span id="blog-info"><a href="/" title="Calico's Space"><span class="site-name">Calico's Space</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list hide"></i><span> 其他</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/demopage/"><i class="fa-fw fas fa-music"></i><span> Theme测试页</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav></header><main class="layout" id="content-inner"><div id="post"><div id="post-info"><h1 class="post-title">spring security 快速使用 (2) OAUTH2</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="fa-fw post-meta-icon far fa-calendar-alt"></i><span class="post-meta-label">发表于</span><time datetime="2023-03-12T16:00:00.000Z" title="发表于 2023-03-13 00:00:00">2023-03-13</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/dev/">dev</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/dev/spring/">spring</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">35.1k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>136分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="spring security 快速使用 (2) OAUTH2"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div><article class="post-content" id="article-container"><h2 id="Oauth2-概念和授权码模式"><a href="#Oauth2-概念和授权码模式" class="headerlink" title="Oauth2 概念和授权码模式"></a>Oauth2 概念和授权码模式</h2><p>鸽了很久，其实也因为自己确实比较忙，加之自己在造demo的时候也遇到了很多问题，并且网上这方面的解答非常之少，不过也正是因为少，才更加让我想写这样的知识分享，最终，在一篇博客的解答下解决了问题，本节我们就开始Oauth2的学习。在之前的学习中，我们可以说SpringSecurity本身的基础学习差不多告一段落，大家已经可以通过自己的能力去搭建一个SpringSecurity的安全应用。</p>
<p>那么接下来我们就接着学习OAuth2这样一个庞大的主题，我们在这一章主要介绍一个概要，即OAuth2是什么，然后将会把它应用到一个关注使用单点登录（SSO）进行身份验证的应用程序上。这里之所以选用SSO，是因为其非常简单，也非常有用。</p>
<h3 id="OAuth2框架"><a href="#OAuth2框架" class="headerlink" title="OAuth2框架"></a>OAuth2框架</h3><p>在大多数情况下，<strong>OAuth2被称为授权框架(或规范框架)，其主要目的是允许第三方网站或应用程序访问资源</strong>。有时人们也把OAuth2称为一项委托协议。无论如何称呼它，重要的是要记住<strong>OAuth2不是一个特定的实现或库。也可以将OAuth2流程定义应用于其他平台、工具或语言</strong>。这里将介绍如何实现OAuth2与SpringBoot和Spring Security的集成应用。</p>
<p>理解OAuth2我们可以通过和之前学习过的HTTP Basic身份验证方法进行对比，我们以前使用的是HTTP Basic身份言则会那个，它有以下两个问题：</p>
<ul>
<li><strong>为每个请求发送凭据</strong></li>
<li><strong>由单独的系统管理用户的凭据</strong></li>
</ul>
<p>为每个请求发送凭据可能只适用于隔离环境的情况，但这通常是不可取的，因为这意味着：</p>
<ul>
<li><strong>需要经常在网络上共享凭据</strong></li>
<li><strong>让客户端(就Web应用程序而言就是浏览器)以某种方式存储凭据</strong>，以便客户端可以将这些凭据发送到服务器，并请求进行身份验证和授权。</li>
</ul>
<p>我们希望在应用程序的架构中去掉这两点，因为它们会使凭据变成漏洞，从而削弱安全性。通常，我们会希望有一个单独的系统管理系统用户凭据。假设我们必须为组织中使用的所有应用程序配置和使用单独的凭据。如下图：在组织中，通常会使用多个应用程序。其中大多数需要用户进行身份验证才能使用。用户需要记住多个密码，组织要管理多个凭据集合，这将是一项挑战。</p>
 <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/03/13/spring-security-guide2/1695614675945.png" class="">
<p>如果将<strong>凭据管理的职责隔离在系统的一个组件中会更好</strong>。目前，我们将其称为<strong>授权服务器</strong>。如下图：它拥有<strong>更易于维护的架构会将凭据单独保存，并允许所有应用程序为其用户使用同一组凭据</strong>。</p>
 <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/03/13/spring-security-guide2/1695614676556.png" class="">
<p>这种方式消除了表示同一个人的重复凭据。通过这种方式，架构将变得简单。</p>
<h3 id="OAuth2身份验证架构的组件"><a href="#OAuth2身份验证架构的组件" class="headerlink" title="OAuth2身份验证架构的组件"></a>OAuth2身份验证架构的组件</h3><ul>
<li><strong>资源服务器</strong>：<strong>托管用户所拥有的资源的应用程序</strong>。资源可以是<strong>用户的数据或他们被授权的操作</strong>。</li>
<li><strong>用户(也成为资源拥有者)<strong>：拥有由</strong>资源服务器暴露的资源的个体</strong>。用户通常有一个用户名和密码，他们用用户名和密码标识自己。</li>
<li><strong>客户端</strong>：以用户名义<strong>访问用户所拥有的资源的应用程序</strong>。<strong>客户端使用客户端ID和客户端密钥来标识自己</strong>。请注意，<strong>这些凭据与用户凭据不同。客户端在发出请求时需要自己的凭据来标识自己</strong>。</li>
<li><strong>授权服务器</strong>：<strong>授权客户端访问由资源服务器暴露的用户资源的应用程序</strong>。<strong>当授权服务器决定授权客户端已用户名义访问资源时，它会发出一个令牌</strong>。<strong>客户端使用此令牌向资源服务器证明他已被授权服务器授权。如果它有一个有效的令牌，则资源服务器将允许客户端访问它请求的资源</strong>。</li>
</ul>
 <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/03/13/spring-security-guide2/1695614677331.png" class="">

<h3 id="使用OAuth2的实现选项"><a href="#使用OAuth2的实现选项" class="headerlink" title="使用OAuth2的实现选项"></a>使用OAuth2的实现选项</h3><p>OAuth2主要是指<strong>使用令牌进行授权</strong>。令牌就像门禁卡一样。一旦获得令牌，就可以访问特定的资源。但是OAuth2提供了多种可能性以便获取令牌也称为授权。以下是可以选择的最常见的OAuth2授权方式。</p>
<ul>
<li>授权码</li>
<li>密码</li>
<li>刷新令牌</li>
<li>客户端凭据</li>
</ul>
<h3 id="实现授权码授权类型"><a href="#实现授权码授权类型" class="headerlink" title="实现授权码授权类型"></a>实现授权码授权类型</h3><p>这种授权类型是最常用的OAuth2流程之一。</p>
 <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/03/13/spring-security-guide2/1695614678155.png" class="">
<p>如上图，授权代码授权类型。<strong>客户端会要求用户直接与授权服务器交互，以便为其授予用户请求的权限</strong>。在授权之后，<strong>授权服务器会发出令牌</strong>，这样客户端就可以使用该令牌访问用户的资源。</p>
<p>ps：上图中的箭头<strong>不一定表示HTTP请求和响应</strong>。这些箭头表示<strong>OAuth2的参与者之间交换的消息</strong>。例如，当客户端告知用户“告知授权服务器你允许我做这个操作”时，<strong>客户端就会将用户重定向到授权服务器登录页面</strong>。当授权服务器向客户端提供访问令牌时，<strong>授权服务器实际上会根据所谓的重定向URI来调用客户端</strong>。当然这些细节后面会讲到，这里只需知道这些序列图不仅仅表示HTTP请求和响应，它们是对OAuth2参与者之间通信的简化描述</p>
<p>以下是授权码授权类型的工作方式。接下来将详细深入讲解每个步骤的细节。</p>
<p>(1)<strong>发出身份验证请求</strong>。</p>
<p>(2)<strong>获取访问令牌</strong>。</p>
<p>(3)<strong>调用受保护的资源</strong>。</p>
<h4 id="步骤1：使用授权码授权类型发出身份验证请求"><a href="#步骤1：使用授权码授权类型发出身份验证请求" class="headerlink" title="步骤1：使用授权码授权类型发出身份验证请求"></a>步骤1：使用授权码授权类型发出身份验证请求</h4><p><strong>客户端将用户重定向到需要进行身份验证的授权服务器端点</strong>。假设我们正在使用应用程序X，并且需要访问一个受保护的资源。为了访问该资源，<strong>应用程序X需要我们进行身份验证。它会打开一个授权服务器上的页面，其中包含登录表单，我们必须用凭据填写该表单</strong>。</p>
<p>ps:这里真正需要注意的是，<strong>用户会直接与授权服务器交互。用户不会向客户端应用程序发送凭据</strong><br>从技术上讲，这里发生的处理是，<strong>当客户端将用户重定向到授权服务器时，客户端会调用授权端点</strong>，并在请求中使用以下详细信息。</p>
<ul>
<li>带有code值的<strong>response_type</strong>,<strong>它会告知授权服务器客户端需要一个授权码。客户端需要该授权码用来获取访问令牌</strong>，第(2)步中将会接受。</li>
<li><strong>client_id</strong>具有客户端ID值，<strong>它会标识应用程序本身</strong>。</li>
<li><strong>redirect_uri</strong>，<strong>它会告知授权服务器在成功进行身份验证之后将用户重定向到何处</strong>。有时授权服务器已经知道每个客户端的默认重定向URI。由于这个原因，客户端不需要发送重定向URI。</li>
<li><strong>scope</strong>，它类似于<strong>被授予的权限</strong>。</li>
<li><strong>state</strong>，他定义了一个<strong>跨站请求伪造(CSRF)令牌</strong>。用以CSRF防护<br>拿一个后面实例中这一步出现的链接说明：</li>
</ul>
 <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/03/13/spring-security-guide2/1695614678881.png" class="">
<p>这一步就是客户端将用户重定向到授权服务器的场景，此时客户端向授权服务器（这里是gitee）发送请求，请求链接为：</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://gitee.com/oauth/authorize?response_type=code&client_id=c70egngnghhn464541b580db179d027df1f3017797e053890edd&scope=user_info&state=x5dLt6OkIRluOTVN4UQXG4mds5tqJBokhAd140_nqog=&redirect_uri=http://localhost:9090/login/oauth2/code/gitee">https://gitee.com/oauth/authorize?response_type=code&amp;client_id=c70egngnghhn464541b580db179d027df1f3017797e053890edd&amp;scope=user_info&amp;state=x5dLt6OkIRluOTVN4UQXG4mds5tqJBokhAd140_nqog%3D&amp;redirect_uri=http://localhost:9090/login/oauth2/code/gitee</a></p>
</blockquote>
<p>大家对比一下就会发现和上面的元素是一样的<br>身份验证成功后，授权服务器将根据重定向URI回调客户端，并提供授权码和状态值。客户端要检查状态值是否与它在请求中发送的状态值相同，以确认不是其他人试图调用重定向URI。之后客户端会使用授权码获取第(2)步中所示的访问令牌。</p>
<h4 id="步骤2：使用授权码授权类型获取访问令牌"><a href="#步骤2：使用授权码授权类型获取访问令牌" class="headerlink" title="步骤2：使用授权码授权类型获取访问令牌"></a>步骤2：使用授权码授权类型获取访问令牌</h4><p>为了允许用户访问资源，<strong>第(1)步所产生的授权码就是经过身份验证的用户的客户端证明</strong>。没错，这就是<strong>它被称为授权码类型的原因</strong>。现在<strong>客户端将使用该授权码调用授权服务器以获取令牌</strong>。</p>
<p>PS:在第一步中，交互发生在用户和授权服务器之间。而在这个步骤中，交互是在客户端和授权服务器之间进行的</p>
 <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/03/13/spring-security-guide2/1695614679639.png" class="">
<p>你可能会好奇，为什么流程需要对授权服务器进行两次调用并且得到两个不同的令牌——授权码和访问令牌。花点时间理解这一点：</p>
<ul>
<li>授权服务器生成第一个授权码作为用户直接与之交互的证明。客户端接收到此授权码，并且必须再次使用该授权码及其凭据进行身份验证，以获得访问令牌。</li>
<li>客户端使用第二个令牌访问资源服务器上的资源</li>
</ul>
<p>那么授权服务器为什么不直接返回访问令牌呢？OAuth2定义了一个被称为<strong>隐式授权类型</strong>的流程，授权服务器会在其中直接返回访问令牌。该隐式授权类型后面不会去进行讲解，因为<strong>不建议使用</strong>，而且如今大多数授权服务器都不允许使用。<strong>授权服务器将使用访问令牌直接调用重定向URI，而不会确保接收该令牌的确实是正确的客户端，这一简单事实会降低流程的安全性</strong>。<strong>通过首先发送授权码，客户端必须再次使用其凭据来证明其身份，以便获得令牌</strong>。客户端会进行最后一次调用以获取访问令牌并在其中发送：</p>
<ul>
<li><strong>授权码</strong>，这会证明用户对客户端进行了授权</li>
<li><strong>客户端的凭据，这将证明它们确实是同一个客户端，而不是其他人截获了授权码</strong>。</li>
</ul>
<p>从技术上讲，客户端现在会向授权服务器发出请求。该请求包含以下详细信息：</p>
<ul>
<li><strong>code</strong>,这是步骤1中接收到的授权码。这将证明用户经过了身份验证。</li>
<li><strong>client_id和client_secret</strong>，它们是客户端的凭据。</li>
<li><strong>redirect_uri</strong>，它与步骤1中用于验证的重定向URI相同。</li>
<li>具有authorization_code值得grant_type，它会标识所使用的的流程的类型。服务器可能支持多个流程，因此必须始终指定当前要执行哪个身份验证流程。</li>
</ul>
<p>作为响应，服务器会返回一个<strong>access_token</strong>。<strong>这个令牌是一个客户端可用来调用由资源服务器暴露的资源的值</strong>。</p>
<h4 id="步骤3：使用授权码授权类型调用受保护资源"><a href="#步骤3：使用授权码授权类型调用受保护资源" class="headerlink" title="步骤3：使用授权码授权类型调用受保护资源"></a>步骤3：使用授权码授权类型调用受保护资源</h4><p>在成功地从授权服务器获得访问令牌之后，客户端现在就可以调用受保护的资源了。在调用资源服务器的端点时，客户端要在授权请求头中使用访问令牌。</p>
<p>我将接口所经历的步骤总结成下图：</p>
 <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/03/13/spring-security-guide2/1695614680320.png" class="">
<p>客户端从进行第三方认证操作的起点，默认格式为{baseUrl}&#x2F;oauth2&#x2F;authorization&#x2F;{clientRegistrationId}，其中clientRegistrationId代表着一个第三方标识，可以是微信、支付宝等开放平台，这里为gitee。用户点击了这个请求后就开始了授权之旅。</p>
<p>也就有了客户端向客户重定向的第②步，然后第⑤步就是向授权服务器（gitee）去获取授权码，然后用户通过认证同意授权后，授权服务器将客户重定向到通过配置的发回授权码的redirectUri发回授权码，<br>用户此时通过这个Url将授权码发给了客户端，客户端通过该授权码通过⑩请求获取accessToken<br>那么更详细的，也是我参考过觉得不错的文章有下面2篇，大家可以去看一下：</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/longlivechina008/article/details/125007457">https://blog.csdn.net/longlivechina008/article/details/125007457</a><br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/felordcn/p/13952072.html">https://www.cnblogs.com/felordcn/p/13952072.html</a></p>
</blockquote>
<p>其中上图中Client客户端中的OAuthFilter相当于之前SpringSecurity流程中的AuthenticationManager-&gt;AuthenticationProvider-&gt;UserDetailsService层层返回UserDetails到Filter,然后Filter将UserDetails打包为Authentication然后放到SecurityContext安全上下文中供后续使用，然后结束filterChain到达。</p>
<p>授权码是使用频率非常高的一种授权类型，大家需要好好吸收，尤其是概念，后面我们还会通过授权码授权类型的一个实例-sso单点登录去让大家印象更加深刻。</p>
<p>授权码授权类型的最大优点是让用户可以允许客户端执行特定的操作，而不需要与客户端共享其凭据，不过，这种授权类型有一个缺点：如果有人截获授权码，会发生什么？当然，如之前所属，客户端需要使用其凭据进行身份验证。但是，如果客户端凭据也以某种方式被盗了呢？即使这种情况非常罕见，但是我们也可以认为它是这种授权类型的漏洞。要避免这个漏洞，就需要借助PKCE授权码授权类型所提供的更复杂的场景，大家有兴趣可以自行了解。</p>
<h2 id="密码模式、客户端模式、刷新令牌"><a href="#密码模式、客户端模式、刷新令牌" class="headerlink" title="密码模式、客户端模式、刷新令牌"></a>密码模式、客户端模式、刷新令牌</h2><p>本篇将讨论剩余的授权类型以及使用刷新令牌重新获得令牌等内容，仍然以概念为主。下一节我们将通过一个SSO实例让大家对授权码授权类型更加熟悉。</p>
<h3 id="实现密码授权类型"><a href="#实现密码授权类型" class="headerlink" title="实现密码授权类型"></a>实现密码授权类型</h3><p>此授权类型也被称为资源所有者凭据授权类型。使用此流程的应用程序会假定客户端收集用户凭据，并使用这些凭据进行身份验证，然后从授权服务器获得访问令牌。</p>
 <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/03/13/spring-security-guide2/1695614681376.png" class="">
<p>如上图，密码授权类型会假设<strong>用户与客户端共享其凭据</strong>。客户端使用这些凭据从授权服务器获取令牌。然后，它会以用户名义从资源服务器访问资源。</p>
<p>不知道你还记不记得之前动手过的实践，只是我们没有实现JWT而已，但是思想架构和这个非常相似。当然在后面的学习中，我们会搭建一个真正的OAuth2的密码授权类型架构。</p>
<p>对于密码授权类型，我们应该期望应用程序向用户提供一个登陆表单，并让客户端负责向服务器发送用户凭据以进行身份验证。用户不需要知道我们如何在应用程序中设计身份验证职责。让我们看看使用密码授权类型时会发生什么。涉及的两项任务如下：<br>（1）请求一个访问令牌<br>（2）使用该访问令牌调用资源</p>
<h4 id="步骤1：使用密码授权类型时请求访问令牌"><a href="#步骤1：使用密码授权类型时请求访问令牌" class="headerlink" title="步骤1：使用密码授权类型时请求访问令牌"></a>步骤1：使用密码授权类型时请求访问令牌</h4><p>使用密码授权类型，流程会简单很多。客户端会收集用户凭据并调用授权服务器来获取访问令牌。当请求访问令牌时，客户端还会在请求中发送以下详细信息：</p>
<ul>
<li>具有<strong>password</strong>值的grant_type。</li>
<li>client_id和client_secret，它们是客户端用于对其自身进行身份验证的凭据。</li>
<li>scope:可以将其理解为已授权权限。</li>
<li>username和password，它们是用户凭据。会以<strong>纯文本的形式</strong>将其作为请求头的值来发送。</li>
</ul>
<p>客户端在响应中接收回一个访问令牌。接下来客户端就可以使用该访问令牌调用资源服务器的端点。</p>
<h4 id="步骤2：使用密码授权类型时，需要使用访问令牌调用资源"><a href="#步骤2：使用密码授权类型时，需要使用访问令牌调用资源" class="headerlink" title="步骤2：使用密码授权类型时，需要使用访问令牌调用资源"></a>步骤2：使用密码授权类型时，需要使用访问令牌调用资源</h4><p>一旦客户端有了访问令牌，它就可以使用该令牌调用资源服务器上的端点，这与授权码授权类型完全相同。客户端要在授权请求头中将访问令牌添加到请求。</p>
<p><strong>ps</strong>：<strong>密码授权类型比授权码授权类型更不安全，主要是因为其前提是要与客户端应用程序共享用户凭据</strong>。虽然它确实比授权码授权类型更简单，但是我们仍需尽量不把它放到实际开发中，而是将它放在理论示例当中去。</p>
<h3 id="实现客户端凭据授权类型"><a href="#实现客户端凭据授权类型" class="headerlink" title="实现客户端凭据授权类型"></a>实现客户端凭据授权类型</h3><p>这是OAuth2所描述的最简单的授权类型。<strong>可以在用户不参与的情况下使用它</strong>：也就是说，<strong>在两个应用程序之间实现身份验证时不需要用户参与。可以将客户端凭据授权类型看作密码授权类型和API密钥身份验证流程的组合</strong>。假设有一个使用OAuth2实现身份验证的系统。现在需要允许外部服务器进行身份验证并调用服务器暴露的特定资源。</p>
 <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/03/13/spring-security-guide2/1695614681945.png" class="">

<p>客户端凭据授权类型的步骤与密码授权类型类似。唯一的例外是对访问令牌的请求不需要任何用户凭据。以下是实现这一授权类型的步骤：</p>
<h4 id="步骤1：使用客户端凭据授权类型请求访问令牌"><a href="#步骤1：使用客户端凭据授权类型请求访问令牌" class="headerlink" title="步骤1：使用客户端凭据授权类型请求访问令牌"></a>步骤1：使用客户端凭据授权类型请求访问令牌</h4><p>为了获得访问令牌，客户端要向授权服务器发送一个包含以下详细信息的请求。</p>
<ul>
<li>具有<strong>client_credentials</strong>值的grant_type；</li>
<li>client_id和client_secret，它们代表了客户端凭据；</li>
<li>scope，它表示已授权的权限。</li>
</ul>
<p>作为响应，客户端将接收到一个访问令牌。接下来客户端可以使用该访问令牌调用资源服务器的端点。</p>
<h4 id="步骤2：使用客户端凭据授权类型时，可访问令牌调用资源"><a href="#步骤2：使用客户端凭据授权类型时，可访问令牌调用资源" class="headerlink" title="步骤2：使用客户端凭据授权类型时，可访问令牌调用资源"></a>步骤2：使用客户端凭据授权类型时，可访问令牌调用资源</h4><p>一旦客户端有了访问令牌，它就可以使用该令牌调用资源服务器上的端点，这与授权码授权类型和密码授权类型完全相同。客户端要在授权请求头中将访问令牌添加到请求。</p>
<h3 id="使用刷新令牌获得新的访问令牌"><a href="#使用刷新令牌获得新的访问令牌" class="headerlink" title="使用刷新令牌获得新的访问令牌"></a>使用刷新令牌获得新的访问令牌</h3><p>本节将讨论刷新令牌。到目前为止，本节已经介绍了OAuth2流程（也称为授权）的结果是一个访问令牌。但其中并没有过多谈论这个令牌本身。归根结底，OAuth2并没有为令牌预设一个特定的实现。接下来将会介绍，无论如何实现，令牌都可鞥过期。这并不是强制的——可以创建具有无限生命周期的令牌——但是，一般来说，都应该使其生命周期尽可能短。而本节将讨论的刷新令牌代表了使用凭据获取新访问令牌的另一种选择。这里将展示在OAuth2中刷新令牌是如何工作的，后面我们再讲具体实现。</p>
 <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/03/13/spring-security-guide2/1695614682380.png" class="">
<p>假设在应用程序中实现了永不过期的令牌。这意味着客户端可以一次又一次地使用相同的令牌调用资源服务器上的资源。那么如果令牌被偷了，该怎么办？最后，不要忘记令牌作为一个简单的HTTP头信息被附加在每个请求上。如果令牌没有过期，得到令牌的人就可以使用它访问资源。<strong>不会过期的令牌太强大了。它变得几乎和用户凭据一样强大</strong>。<strong>应该避免这种情况，并缩短令牌的生命周期。这样，过期的令牌就不能再使用了。客户端必须获得另一个访问令牌</strong>。</p>
<p>要获得新的访问令牌，<strong>客户端可以根据所使用的的授权类型重新运行流程</strong>。例如，如果授权类型是身份验证授权码，则客户端会将用户重定向到授权服务器登录端点，用户必须再次填写他们的用户名和密码。这对用户不太友好，是吗？假设这个令牌的生命周期只有20分钟，而用户在这个在线应用程序上工作了两个小时。那么在这段时间里，这个应用程序会将用户<strong>重定向回去6次，以便再次登录</strong>。<strong>为了避免重新进行身份验证</strong>，<strong>授权服务器可以发出刷新令牌，它的值和用途与访问令牌不同。应用程序使用刷新令牌获得一个新的访问令牌，而不必重新进行身份验证</strong>。</p>
<p>如何使用刷新令牌，从哪里获得刷新令牌,当使用授权码或密码授权类型等流程时，授权服务器将返回一个刷新令牌和一个访问令牌。<strong>对于客户端凭据授权，则不存在刷新令牌，因为此流程不需要用户凭据</strong>。一旦客户端有了一个刷新令牌，那么当访问令牌过期时，客户端应该发出一个包含以下详细信息的请求：</p>
<ul>
<li>具有refresh_token值得grant_type；</li>
<li>具有刷新令牌值的refresh_token；</li>
<li>具有客户端凭据的client_id和client_secret；</li>
<li>scope,它定义了相同或更少的授权权限。如果需要授权更多已授权的权限，则需要进行重新身份验证。</li>
</ul>
<p>为了响应此请求，授权服务器会发出一个新的访问令牌和一个新的刷新令牌。</p>
<p>五、OAuth2的弱点<br>OAuth2并不是无懈可击的。它有其弱点，我们必须意识到这些弱点，并且在构建应用程序时必须考虑这些弱点，这里列举一些最常见的：</p>
<ul>
<li>在客户端上使用跨站请求伪造（CSRF）——用户已登录时，如果应用程序没有应用任何CSRF防护机制，则可能会遇到CSRF</li>
<li>窃取客户端凭据——存储或传输未受保护的凭据会造成损失，使攻击者得以窃取和使用他们。</li>
<li>重放令牌——这个后面会介绍，令牌时OAuth2身份验证和授权架构中用来访问资源的密钥。这些信息是通过网络发送的，但有时候，它们可能会被拦截。如果被截获，它们就被窃取了，并且可能再次使用。想象一下，如果你把你家大门钥匙弄丢了，会发生什么呢？其他人可以用它打开门，想打开多少次都可以（也就是所谓的令牌重放）</li>
<li>令牌劫持——意味着有人入侵身份验证过程并窃取可以用来访问资源的令牌。这也是使用刷新令牌的一个潜在漏洞，因为这些令牌也可以被拦截并用于获取新的访问令牌.这里推荐一片有用的文章</li>
</ul>
<blockquote>
<p><a target="_blank" rel="noopener" href="http://blog.intothesymmetry.com/2015/06/on-oauth-token-hijacks-for-fun-and.html">http://blog.intothesymmetry.com/2015/06/on-oauth-token-hijacks-for-fun-and.html</a></p>
</blockquote>
<h2 id="实现一个简单的sso登录"><a href="#实现一个简单的sso登录" class="headerlink" title="实现一个简单的sso登录"></a>实现一个简单的sso登录</h2><p>本章实现第一个使用带有Spring Boot和Spring Security 的OAuth2框架的应用程序。这个示例将展示如何将OAuth2应用到Spring Security中，并阐释你需要了解的一些接口的内容。顾名思义，单点登录（SSO）应用程序是通过授权服务器进行身份验证的应用程序，然后将使用刷新令牌让用户保持登陆状态。在我们的示例中，它只代表来自OAuth2架构的客户端。</p>
<p>在这个应用程序中，我们要使用Gitee作为授权和资源服务器，并重点关注使用授权码授权类型的组件之间的通信.在后面的学习中我们将在OAuth2架构中实现一个授权服务器和一个资源服务器。</p>
 <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/03/13/spring-security-guide2/1695614682979.png" class="">

<h3 id="项目前准备"><a href="#项目前准备" class="headerlink" title="项目前准备"></a>项目前准备</h3><p>大家如果是从之前跟过来的，我这里推荐大家重新构建一个OAuth2项目取名spring_security_oauth2_sso，然后将之前写的短信认证的那个项目，除了security包的内容不copy,其他都copy下来就好，然后对报错的地方做一下相关适配（例如passwordEncoder，这个自己新建一个security包，将以前的security对应内容放进去就好），这里就不重新展现了。</p>
<h3 id="管理授权服务器"><a href="#管理授权服务器" class="headerlink" title="管理授权服务器"></a>管理授权服务器</h3><p>本节将配置授权服务器。本章<strong>不会实现我们自己的授权服务器</strong>，而是使用一个现有的：Gitee。</p>
<p>如何使用Gitee这样的第三方作为授权服务器呢？这意味着，最终，<strong>我们的应用程序不会管理它的用户</strong>，任何人都可以使用他们的Gitee账户登录到我们的应用程序。<strong>与其他授权服务器一样，Gitee需要知道它要向哪个客户端应用程序发出令牌</strong>。因此，<strong>OAuth应用程序必须向Gitee授权服务器进行注册</strong>。为此，需要使用以下链接完成一个简短的表单。</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://gitee.com/oauth/applications/new">https://gitee.com/oauth/applications/new</a></p>
</blockquote>
 <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/03/13/spring-security-guide2/1695614683593.png" class="">
<p>上图的“应用回调地址”就是我们注册的应用程序client（客户端）的接收授权码和access-token的地址其中,<strong>&#x2F;login&#x2F;oauth2&#x2F;code必须是这样，这是由Client引入的oauth2AuthenticationFilter的内部默认路径</strong>。而后面的gitee是registrationid，与我们在自己的Client代码中配置的一致，<strong>Client的oauth2AuthenticationFilter要靠这个值去对应配置在程序中的clientid和clientSecret然后发给gitee认证服务器。且将来gitee授权服务器收到授权请求后，会将配置的这个应用回调地址与请求参数中的redirect_uri匹配，正确才回传授权码以及access_token</strong>。否则会报无效的回调地址（别问我为什么知道，问就是鸽那么多天都在尝试解决这个）</p>
 <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/03/13/spring-security-guide2/1695614684392.png" class="">
<p>创建后会给我产生一个<strong>clientId和clientSecret</strong>，这个就是Gitee为我们提供的<strong>客户端ID和客户端密钥</strong>信息。当然我这里打上了马赛克，<strong>大家一定要自己去生成自己的凭据，另外在使用这样的凭据编写应用程序时要小心，特别是在使用Gitee存储库存储它们的时候</strong>。</p>
 <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/03/13/spring-security-guide2/1695614685051.png" class="">
<p>这个配置就是需要为授权服务器做的所有处理。现在我们有了客户端凭据，可以开始处理应用程序了。</p>
<h3 id="开始实现"><a href="#开始实现" class="headerlink" title="开始实现"></a>开始实现</h3><h4 id="1准备工作"><a href="#1准备工作" class="headerlink" title="1准备工作"></a>1准备工作</h4><p>本节将开始实现一个SSO应用程序。我们首先需要将一下依赖添加到Pom文件中：<br>以前的项目中已加入spring-boot-starter-security和spring-boot-starter-web依赖，如果已经加了可以不用加后面两个。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-oauth2-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>首先需要确保某些东西的安全：一个网页。为此，要创建一个控制器类和一个表示应用程序的简单的HTML页面。如下代码展示了HomeController类，它定义了应用程序的单个端点：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HomeController</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">	<span class="meta">@GetMapping(&quot;/&quot;)</span></span><br><span class="line">	<span class="keyword">public</span> String <span class="title function_">home</span><span class="params">(OAuth2AuthenticationToken token)</span></span><br><span class="line">	&#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		log.info(String.valueOf(token.getPrincipal()));</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;home&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里的OAuth2AuthenticationToken你可以类比为UsernamePasswordAuthenticationToken,同样实现<strong>Authentication接口表示身份验证请求事件，并且会保存请求访问应用程序的实体的详细信息</strong>。大家在写短信认证登录的时候，应该知道Authentication是分<strong>请求前和请求后</strong>，不知道大家是否还记得Principal这个对象，<strong>在认证前存放的是认证所需的信息</strong>，例如手机号，<strong>认证后存放的是认证后的用户详细信息</strong>，这里也是一样的，如果SSO认证通过后，我们也可以拿到资源服务器（这里仍然是gitee)给我们的用户信息，通过token.getPrincipal()获取。</p>
<p>而home的页面很简单</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Title<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>Welcome<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>现在才要开始真正的工作！接下来设置安全配置，以允许应用程序使用GItee登录。首先要编写一个配置类，就像我们过往所做的那样，这里扩展了WebSecurityConfigurerAdapter并重写了configure(HttpSecurity http)方法。现在有了一个不同之处：此处调用了另一个名为**oauth2Login()**方法，而不是之前介绍的httpBasic()或formLogin()。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.mbw.security.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.crypto.password.DelegatingPasswordEncoder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.crypto.password.NoOpPasswordEncoder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.crypto.password.PasswordEncoder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.crypto.scrypt.SCryptPasswordEncoder;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProjectConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		http.oauth2Login();</span><br><span class="line">		http.authorizeRequests()</span><br><span class="line">				.anyRequest().authenticated();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="keyword">public</span> PasswordEncoder <span class="title function_">passwordEncoder</span><span class="params">()</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		HashMap&lt;String, PasswordEncoder&gt; encoders = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">		encoders.put(<span class="string">&quot;noop&quot;</span>, NoOpPasswordEncoder.getInstance());</span><br><span class="line">		encoders.put(<span class="string">&quot;bcrypt&quot;</span>, <span class="keyword">new</span> <span class="title class_">BCryptPasswordEncoder</span>());</span><br><span class="line">		encoders.put(<span class="string">&quot;scrypt&quot;</span>, <span class="keyword">new</span> <span class="title class_">SCryptPasswordEncoder</span>());</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DelegatingPasswordEncoder</span>(<span class="string">&quot;bcrypt&quot;</span>, encoders);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里出现了一个新方法：oauth2Login(),但经过了之前的学习的你应该需要能反应过来其中进行了什么处理。与httpBasic()和formLogin()一样，oauth2Login()只是将一个新的身份验证过滤器添加到过滤器链中。我们之前说过SpringSecurity有一些过滤器实现，并且还可以向过滤器链添加自定义的过滤器。在本示例中，当调用oauthLogin()方法时，框架添加到过滤器链中的过滤器就是之前提到过的OAuth2LoginAuthenticationFilter.这个过滤器会拦截请求，并应用OAuth2身份验证所需的逻辑。</p>
 <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/03/13/spring-security-guide2/1695614685684.png" class="">
<p><strong>ps:securityFilterChain中不再有usernamePasswordAuthenticationFilter和basicAuthenticationFitler</strong>,因为你配置的本client的http.oauth2Login().那么本client的“认证凭证”就由oauth2AuthenticationFilter来提供oauth2AuthenticationToken了。</p>
<h4 id="2、实现ClientRegistration"><a href="#2、实现ClientRegistration" class="headerlink" title="2、实现ClientRegistration"></a>2、实现ClientRegistration</h4><p>本节将讨论如何实现OAuth2客户端和授权服务器之间的连接。如果想让应用程序真正做一些事情，这是至关重要的。如果现在就启动该应用程序，那么将无法访问主页。无法访问该页面的原因是由于<strong>指定了对于任何请求，用户都需要进行身份验证</strong>，但是这里还没有提供任何身份验证方法。我们需要将gitee确立为授权服务器。为此Spring Security定义了<strong>ClientRegistration</strong>契约。</p>
<p><strong>ClientRegistration接口表示OAuth2架构中的客户端</strong>。对于该客户端，需要定义其所需的所有详情，其中包括：</p>
<ul>
<li>客户端ID和密钥</li>
<li>用于身份验证的授权类型</li>
<li>重定向URI</li>
<li>作用域<br>你可能还记得在之前讲解授权码授权类型时，应用程序需要将所有这些详细信息用于身份验证过程中，Spring Security还提供了一种创建构建器实例的简单方法，类似于一开始构造UserDetails方法是一样的。下面代码展示了如何构建这样一个表示客户端实现的实例：</li>
</ul>
<p>GiteeClient.java#</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.mbw.security.client.gitee;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.client.registration.ClientRegistration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.core.AuthorizationGrantType;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GiteeClient</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> ClientRegistration <span class="title function_">clientRegistration</span><span class="params">()</span>&#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		<span class="keyword">return</span> ClientRegistration.withRegistrationId(<span class="string">&quot;gitee&quot;</span>)  <span class="comment">//起个名字,代表client，如clientId和clientSecret</span></span><br><span class="line">				.clientId(<span class="string">&quot;your clientId&quot;</span>)  <span class="comment">//此处要换成你在gitee上创建应用得到的</span></span><br><span class="line">				.clientSecret(<span class="string">&quot;your clientSecret&quot;</span>) <span class="comment">//此处要换成你在gitee上创建应用得到的</span></span><br><span class="line">				.scope(<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;</span><br><span class="line">   </span><br><span class="line">     <span class="string">&quot;user_info&quot;</span>&#125;)    <span class="comment">//读取用户权限，参见你gitee上创建应用时的授权勾选</span></span><br><span class="line">				.authorizationUri(<span class="string">&quot;https://gitee.com/oauth/authorize&quot;</span>)   <span class="comment">//这要看gitee的api，是user认证以及client认证获取授权码的地址</span></span><br><span class="line">				.tokenUri(<span class="string">&quot;https://gitee.com/oauth/token&quot;</span>) <span class="comment">//这要看gitee的api，是client得到授权码后去换token的gitee地址</span></span><br><span class="line">				.userInfoUri(<span class="string">&quot;https://gitee.com/api/v5/user&quot;</span>) <span class="comment">//资源服务器api地址-也是client用access-token去获取用户user详情的“用户详情资源服务器地址”-这里也是gitee】】</span></span><br><span class="line">				.userNameAttributeName(<span class="string">&quot;id&quot;</span>)</span><br><span class="line">				.clientName(<span class="string">&quot;gitee&quot;</span>)  <span class="comment">//为我们的应用client起了个名字</span></span><br><span class="line">				.authorizationGrantType(AuthorizationGrantType.AUTHORIZATION_CODE)  <span class="comment">//注是授权码模式</span></span><br><span class="line">				.redirectUriTemplate(<span class="string">&quot;&#123;baseUrl&#125;/&#123;action&#125;/oauth2/code/&#123;registrationId&#125;&quot;</span>)  <span class="comment">//本应用配置的gitee发回授权码的地址</span></span><br><span class="line">				.build();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第一眼看上去要设置的东西有点多，但它只不过是设置客户端ID和密钥而已。此外，还定义了作用域(授予的权限)、客户端名称和所选择的注册ID。除了这些信息，还必须提供授权服务器的URL。</p>
<ul>
<li><strong>授权URI</strong>:<strong>客户端将用户重定向</strong>到其进行身份验证的URI。</li>
<li><strong>令牌URI</strong>：<strong>客户端</strong>为获取访问令牌和刷新令牌而<strong>调用</strong>的URI。</li>
<li><strong>用户信息URI</strong>：<strong>客户端</strong>在获得访问令牌后可以<strong>调用</strong>的URI，以<strong>获得关于用户的更多详细信息</strong>。</li>
</ul>
<p>这些URI是从哪里获得的？如果授权服务器不是由我们开发的，则需要从说明文档中获取它们。以Gitee为例，可以在这里找到它们：</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://gitee.com/api/v5/oauth_doc#/">https://gitee.com/api/v5/oauth_doc#/</a></p>
</blockquote>
<p>当然如果你的授权服务器提供者不是gitee,而是Github,Google,FaceBook,Okta这四个中的任意一个，那么Spring security给我们提供了CommonOAuth2Provider的类，这个类部分定义了可以用于身份验证的最常见提供程序的ClientRegistration实例，拿Github为例，你可以这样如下配置：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> ClientRegistration <span class="title function_">githubClient</span><span class="params">()</span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> CommonOAuth2Provider.GITHUB</span><br><span class="line">        .getBuilder(<span class="string">&quot;github&quot;</span>)</span><br><span class="line">        .clientId(<span class="string">&quot;your clientId&quot;</span>)</span><br><span class="line">        .clientSecret(<span class="string">&quot;your clientSecret&quot;</span>)</span><br><span class="line">        .build();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如上所示，这样更为清晰，并且我们不必手动查找和设置授权服务器的URL。当然，这只适用于公共提供程序。如果授权服务器不在公共提供程序之列，则只能完全定义ClientRegistration。</p>
<p>然后我们之前定义的GiteeClient已经交由Spring容器进行管理，我们可以在配置类中注入它。但是这样身份验证过滤器仍不能直接获取关于授权服务器客户端注册的详细信息，我们需要实现<strong>clientRegistrationRepository</strong>!</p>
<h4 id="3、实现ClientRegistrationRepository"><a href="#3、实现ClientRegistrationRepository" class="headerlink" title="3、实现ClientRegistrationRepository"></a>3、实现ClientRegistrationRepository</h4><p>我们之前讲到配置了ClientRegistration还不够，需要对其进行设置，以便将其用于身份验证。为此，Spirng Security使用了类型为ClientRegistrationRepository的对象</p>
 <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/03/13/spring-security-guide2/1695614686069.png" class="">
<p>ClientRegistrationRepository会检索ClientRegistration详细信息（客户端ID、客户端密钥、URL、作用域等）。身份验证过滤器需要将这些详细信息用于身份验证流程。</p>
<p>ClientRegistrationRepository接口<strong>类似于前面介绍过的UserDetailsService接口</strong>。与UserDetailsService对象通过其用户名查找UserDetails相同，<strong>ClientRegistrationRepository对象通过其注册ID查找ClientRegistration</strong>。</p>
<p><strong>可以实现ClientRegistrationRepository接口来告知框架在哪里找到ClientRegistration实例</strong>。Spring Security为ClientRegistrationRepository提供了一个实现，该实现会将ClientRegistration的实例存储在内存中，也就是<strong>InMemoryClientRegistrationRepository</strong>。是不是很熟悉，这与InMemoryUserDetailsManager对UserDetails实例所做的处理类似。</p>
<p>而且可以实现ClientRegistrationRepository也说明<strong>我们可以像之前通过mysql管理userDetails一样去管理ClientRegistration</strong>，不知道大家还记不记得之前写过的mybatisUserDetailsService.但是这里就暂时不作展示了，大家有兴趣可以自行尝试。</p>
<p>为了完成该应用程序实现，这里使用InMemoryClientRegistrationRepository实现定义了一个ClientRegistrationRepository，并将构建的ClientRegistration实例添加到InMemoryClientRegistrationRepository中，这是通过将其作为InMemoryClientRegistrationRepository构造函数的参数来完成的。然后将构造 ClientRegistrationRepository的方法通过oauth2Login()的customizaer设置，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.mbw.security.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.mbw.security.client.gitee.GiteeClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.crypto.password.DelegatingPasswordEncoder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.crypto.password.NoOpPasswordEncoder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.crypto.password.PasswordEncoder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.crypto.scrypt.SCryptPasswordEncoder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.client.registration.ClientRegistrationRepository;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.client.registration.InMemoryClientRegistrationRepository;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProjectConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> GiteeClient giteeClient;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		http.oauth2Login(c-&gt;c.clientRegistrationRepository(clientRegistrationRepository()));</span><br><span class="line">		http.authorizeRequests()</span><br><span class="line">				.anyRequest().authenticated();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> ClientRegistrationRepository <span class="title function_">clientRegistrationRepository</span><span class="params">()</span>&#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">InMemoryClientRegistrationRepository</span>(giteeClient.clientRegistration());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="keyword">public</span> PasswordEncoder <span class="title function_">passwordEncoder</span><span class="params">()</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		HashMap&lt;String, PasswordEncoder&gt; encoders = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">		encoders.put(<span class="string">&quot;noop&quot;</span>, NoOpPasswordEncoder.getInstance());</span><br><span class="line">		encoders.put(<span class="string">&quot;bcrypt&quot;</span>, <span class="keyword">new</span> <span class="title class_">BCryptPasswordEncoder</span>());</span><br><span class="line">		encoders.put(<span class="string">&quot;scrypt&quot;</span>, <span class="keyword">new</span> <span class="title class_">SCryptPasswordEncoder</span>());</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DelegatingPasswordEncoder</span>(<span class="string">&quot;bcrypt&quot;</span>, encoders);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="4、Spring-boot配置的纯粹方式"><a href="#4、Spring-boot配置的纯粹方式" class="headerlink" title="4、Spring boot配置的纯粹方式"></a>4、Spring boot配置的纯粹方式</h4><p>Springboot旨在使用其纯粹的配置方式直接从属性文件构建ClientRegistration和ClientRegistrationRepository对象。这种方法在Spring Boot项目并不少见。对于其他对象也是如此，例如数据源配置，下面代码展示了如何在yaml文件中为此处的示例设置客户端注册：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  security:</span><br><span class="line">    oauth2:</span><br><span class="line">      client:</span><br><span class="line">        registration:</span><br><span class="line">          gitee:</span><br><span class="line">            client-id: your clientId</span><br><span class="line">            client-secret: 4your clientSecret</span><br><span class="line">            authorization-grant-type: authorization_code</span><br><span class="line">            redirect-uri: <span class="string">&#x27;&#123;baseUrl&#125;/&#123;action&#125;/oauth2/code/&#123;registrationId&#125;&#x27;</span></span><br><span class="line">            client-name: gitee</span><br><span class="line">            provider: gitee</span><br><span class="line">            scope:</span><br><span class="line">              - user_info</span><br><span class="line">        provider:</span><br><span class="line">          gitee:</span><br><span class="line">            authorization-uri: https:<span class="comment">//gitee.com/oauth/authorize</span></span><br><span class="line">            token-uri: https:<span class="comment">//gitee.com/oauth/token</span></span><br><span class="line">            user-info-uri: https:<span class="comment">//gitee.com/api/v5/user</span></span><br><span class="line">            user-name-attribute: id</span><br></pre></td></tr></table></figure>

<p>这样你的配置类就可以不再需要指定ClientRegistration和ClientRegistrationRepository的任何详情，因为它们是由Spring Boot根据属性文件自动创建的:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.mbw.security.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.crypto.password.DelegatingPasswordEncoder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.crypto.password.NoOpPasswordEncoder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.crypto.password.PasswordEncoder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.crypto.scrypt.SCryptPasswordEncoder;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProjectConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		http.oauth2Login();</span><br><span class="line">		http.authorizeRequests()</span><br><span class="line">				.anyRequest().authenticated();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="keyword">public</span> PasswordEncoder <span class="title function_">passwordEncoder</span><span class="params">()</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		HashMap&lt;String, PasswordEncoder&gt; encoders = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">		encoders.put(<span class="string">&quot;noop&quot;</span>, NoOpPasswordEncoder.getInstance());</span><br><span class="line">		encoders.put(<span class="string">&quot;bcrypt&quot;</span>, <span class="keyword">new</span> <span class="title class_">BCryptPasswordEncoder</span>());</span><br><span class="line">		encoders.put(<span class="string">&quot;scrypt&quot;</span>, <span class="keyword">new</span> <span class="title class_">SCryptPasswordEncoder</span>());</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DelegatingPasswordEncoder</span>(<span class="string">&quot;bcrypt&quot;</span>, encoders);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="5、测试应用程序"><a href="#5、测试应用程序" class="headerlink" title="5、测试应用程序"></a>5、测试应用程序</h4> <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/03/13/spring-security-guide2/1695614686761.png" class="">

<p>这个图在当时讲解授权码授权类型时给大家展示过，里面就是一个具体的流程，更加具体的步骤讲解可以参考下面的博客，讲的比较到位。</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/longlivechina008/article/details/125007457">https://blog.csdn.net/longlivechina008/article/details/125007457</a></p>
</blockquote>
<p>我们下面演示一下流程：<br>启动程序：<br>输入localhost:9090时，由于所有路径都需要认证，所以被过滤器拦截，然后重定向到gitee登录页面</p>
 <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/03/13/spring-security-guide2/1695614687869.png" class="">
<p>输入自己的gitee的账号密码后，客户端将我们重定向到gitee的授权页面，这个就是上图中的⑤-⑧步</p>
 <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/03/13/spring-security-guide2/1695614689194.png" class="">
<p>点击同意授权后，当Gitee认证服务器认证了user，同时也获得了clientid和用户授权的权限后，发回重定向指令到浏览器，<strong>带着【授权码】</strong>–实际上是 HTTP 302响应</p>
 <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/03/13/spring-security-guide2/1695614689942.png" class="">
<p>接着浏览器被重定向，向Client发出请求，带着授权码GET请求</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="http://localhost:9090/login/oauth2/code/gitee?code=3d459a2fgttbb60c168e9df64175ab3739085b28d0a12071efd&state=-AVIglbqTn6a0GjcoQWJQE0efOtbDI1L1fxYxnlMp1k=">http://localhost:9090/login/oauth2/code/gitee?code=3d459a2fgttbb60c168e9df64175ab3739085b28d0a12071efd&amp;state=-AVIglbqTn6a0GjcoQWJQE0efOtbDI1L1fxYxnlMp1k%3D</a></p>
</blockquote>
<p>【千万注意】这个地址<a target="_blank" rel="noopener" href="http://localhost:9090/login/oauth2/code/gitee">http://localhost:9090/login/oauth2/code/gitee</a><br>就是我们代码中配置的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.redirectUriTemplate(<span class="string">&quot;&#123;baseUrl&#125;/&#123;action&#125;/oauth2/code/&#123;registrationId&#125;&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>【注意】redirectUriTemplate其中：</p>
<p><strong>1、</strong> baseUrl的值<a target="_blank" rel="noopener" href="http://localhost:9090/%E5%B0%B1%E6%98%AF%E6%88%91%E4%BB%AC%E7%9A%84%E5%BA%94%E7%94%A8Client%E7%9A%84%E6%A0%B9%E8%B7%AF%E5%BE%84%EF%BC%9B">http://localhost:9090/就是我们的应用Client的根路径；</a><br><strong>2、</strong> {action}不是我们配置的，而是OauthAuthenticationFilter拦截请求Filter中固定的-login，不同的路径对应不同拦截功能我们没有自己写filter，采用的是默认的我们只要配置了http.oauth2Login();就会有此默认的拦截器OauthAuthenticationFilter，他的逻辑是固定的；<br><strong>3、</strong> oauth2&#x2F;code也是OauthAuthenticationFilter固定的因为我们没有自己写filter；<br><strong>4、</strong> .gitee是我们为Client起的名字，OauthAuthenticationFilter拦截请求后，会根据路径上的这个名字gitee这个id取出clientidclientsecret权限scope等等；</p>
<p>所以,<strong>我们在Gitee上配置的客户端clientid和clientsecret一定要和Client传来的一致</strong>，且我们在gitee上配置的<strong>应用回调Url才是Gitee发出请求的依据</strong>。Gitee是根据配置的这个回调Url来进行请求的。所以，<strong>这个回调url必须和我们应用client配置一致才对</strong>。gitee对用户user认证并得到user对client的scope确认后，才会根据【gitee上的应用回调地址做出请求】。</p>
<p>而我们.redirectUriTemplate(“{baseUrl}&#x2F;{action}&#x2F;oauth2&#x2F;code&#x2F;{registrationId}”)这里的配置是配置应用client。当收到这样的请求，<strong>client会向gitee发出post请求。以便用得到的授权码到gitee上换取access_token</strong>,所以gitee上的用户配置的回调地址<strong>决定了Gitee向哪个地址发送认证码</strong><br>而我们代码配置的.redirectUriTemplate(“{baseUrl}&#x2F;{action}&#x2F;oauth2&#x2F;code&#x2F;{registrationId}”<br>是这个地址的<strong>决定的Oauth2AuthenticationFilter的有效拦截功能启用</strong>。 <strong>两个地址必须一致才能收到Gitee来的授权码</strong>.</p>
 <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/03/13/spring-security-guide2/1695614690905.png" class="">
<p>然后有了accessToken后，我们就可以自由的对整个程序的端点进行访问了。</p>
<p>如果想要移除用户已经存在的有效accessToken重新认证，可以到gitee的配置好的第三方应用处选择移除已授权用户的有效Token然后重启程序，等下次访问就有需要重新授权认证了。</p>
<h2 id="实现授权服务器"><a href="#实现授权服务器" class="headerlink" title="实现授权服务器"></a>实现授权服务器</h2><p>本节大家如果一直从一开始看过来的话，就会巧妙发现我们将之前的实践代码全部连接起来，本节将会使用到之前的短信&#x2F;验证码登录相关的逻辑代码，如果大家没有看的感兴趣可以回到<a target="_blank" rel="noopener" href="http://ddkk.com/zhuanlan/security/springsecurity/6/14.html">14、Spring Security 速成 - 实现过滤器（下）整合短信认证</a>先将这部分逻辑代码看一看，尝试自己完成。然后本节仍然以实践为主，大家要完全吸收前几节关于OAuth2内容再来学习本节会更好点，然后当时再讲解搭建单点应用程序时，我们讲到过ClientRegistrationRepository这个类，讲到可以通过数据库去管理客户端，但是当时我们没有做相关展示，本次将会通过mysql结合mybatis完成对客户端的管理操作。</p>
<p>我们知道，授权服务器是在OAuth2架构中发挥作用的组件之一。<strong>授权服务器的职责是对用户进行身份验证，并向客户端提供令牌</strong>。客户端可以使用此令牌访问由资源服务器代表用户暴露的资源其中还介绍了，<strong>OAuth2框架定义了获取令牌的多个流程，我们称这些流程为授权</strong>。可以根据面临的场景选择一种不同的授权。所选择的授权的不同，授权服务器的行为也会有所不同。本章将介绍如何使用Spring Security为最常见的OAuth2授权类型配置授权服务器。</p>
<ul>
<li>授权码授权类型</li>
<li>密码授权类型</li>
<li>客户端凭据授权类型</li>
</ul>
<p>并且还会讲解如何配置授权服务器以颁发刷新令牌。客户端要使用刷新令牌获得新的访问令牌。如果访问令牌过期，则客户端必须获得一个新的访问令牌。</p>
<h3 id="编写我们自己的授权服务器实现"><a href="#编写我们自己的授权服务器实现" class="headerlink" title="编写我们自己的授权服务器实现"></a>编写我们自己的授权服务器实现</h3><p>没有授权服务器就没有OAuth2流程。如之前所说，OAuth2的主要处理就是获取访问令牌。授权服务器是OAuth2架构的组件，它可以颁发访问令牌。所以我们首先需要知道如何实现它。</p>
<p>我们接着之前的项目基础上进行改造，首先在父项目的pom上加入spring-cloud-dependencies的组件依赖：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt; </span><br><span class="line">    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-cloud-dependencies&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;Hoxton.SR1&lt;/version&gt;</span><br><span class="line">    &lt;type&gt;pom&lt;/type&gt;</span><br><span class="line">    &lt;scope&gt;<span class="keyword">import</span>&lt;/scope&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<p>当然我们引入cloud组件主要是为了用spring-cloud-starter-oauth2这个依赖，所以我们接下来在子项目的Pom加入该依赖：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-cloud-starter-oauth2&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<p>接下来可以定义一个配置类，这里将其称为AuthServerConfig.除了经典的@Configuration注解外，<strong>还需要使用@EnableAuthorizationServer对这个类进行注解</strong>。通过这种方式，就可以指示Spring Boot<strong>启用特定于OAuth2授权服务器的配置</strong>。可以通过配置AuthorizationServerConfigurerAdapter类和重写将在本章中讨论的特定方法来自定义这个配置：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.mbw.security.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.config.annotation.web.configuration.AuthorizationServerConfigurerAdapter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.config.annotation.web.configuration.EnableAuthorizationServer;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableAuthorizationServer</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AuthServerConfig</span> <span class="keyword">extends</span> <span class="title class_">AuthorizationServerConfigurerAdapter</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="定义用户管理"><a href="#定义用户管理" class="headerlink" title="定义用户管理"></a>定义用户管理</h3><p>本节将讨论用户管理。授权服务器是OAuth2框架中处理用户身份验证的组件。因此，它自然需要管理用户。幸运的是，这里的用户管理实现和之前讲解的UserDetails一家子是相同的，我们将继续使用它们来管理凭据。为了管理密码，我们要继续使用PasswordEncoder。</p>
 <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/03/13/spring-security-guide2/1695614692318.png" class="">
<p>上图再次描述了Spring Security中执行身份验证过程的主要组件。你应该注意到，与之前描述的身份验证架构不同的是，图中不再有SecurityContext。之所以发生此更改，是因为身份验证的结果没有存储在SecurityContext中。取而代之的是，其中使用了来自TokenStore的令牌来管理身份验证。这个我们后面说资源服务器会细说。</p>
<p>那关于用户管理的配置不需要我多说，<strong>大家直接把当时短信认证登录写的用户的配置完全搬过来即可，顺便可以把之前写的短信认证，验证码登录相关的逻辑代码全部照搬过来</strong>，将前文写的ProjectConfig进行相关修改：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.mbw.security.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.mbw.security.filter.CaptchaCodeFilter;</span><br><span class="line"><span class="keyword">import</span> com.mbw.security.handler.CommonLoginFailureHandler;</span><br><span class="line"><span class="keyword">import</span> com.mbw.security.handler.CommonLoginSuccessHandler;</span><br><span class="line"><span class="keyword">import</span> com.mbw.security.handler.MyLogoutSuccessHandler;</span><br><span class="line"><span class="keyword">import</span> com.mbw.security.service.UserDetailsServiceImpl;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.authentication.AuthenticationManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.builders.WebSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.http.SessionCreationPolicy;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.crypto.password.PasswordEncoder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.cors.CorsConfiguration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.cors.CorsConfigurationSource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.cors.UrlBasedCorsConfigurationSource;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProjectConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> UserDetailsServiceImpl commonUserDetailServiceImpl;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> CommonLoginSuccessHandler successHandler;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> CommonLoginFailureHandler failureHandler;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> MyLogoutSuccessHandler logoutSuccessHandler;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> CaptchaCodeFilter captchaCodeFilter;</span><br><span class="line">	<span class="meta">@Resource</span></span><br><span class="line">	<span class="keyword">private</span> SmsCodeSecurityConfig smsCodeSecurityConfig;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		http.cors().and()</span><br><span class="line"><span class="comment">//				.addFilterBefore(captchaCodeFilter, UsernamePasswordAuthenticationFilter.class)</span></span><br><span class="line">				.logout()</span><br><span class="line">				.logoutSuccessHandler(logoutSuccessHandler)</span><br><span class="line">				.and()</span><br><span class="line">				.rememberMe()</span><br><span class="line">				<span class="comment">//默认都为remember-me</span></span><br><span class="line">				.rememberMeParameter(<span class="string">&quot;remeber-me&quot;</span>)</span><br><span class="line">				<span class="comment">//cookieName一般设置复杂一些，迷惑别人(不容易看出)</span></span><br><span class="line">				.rememberMeCookieName(<span class="string">&quot;remeber-me&quot;</span>)</span><br><span class="line">				<span class="comment">//过期时间</span></span><br><span class="line">				.tokenValiditySeconds(<span class="number">24</span> * <span class="number">60</span> * <span class="number">60</span> * <span class="number">2</span>)</span><br><span class="line">				.and()</span><br><span class="line">				.csrf().disable()</span><br><span class="line">				.formLogin()</span><br><span class="line">				.loginPage(<span class="string">&quot;/toLogin&quot;</span>) <span class="comment">//用户没有权限就跳转到这个页面</span></span><br><span class="line">				.loginProcessingUrl(<span class="string">&quot;/login&quot;</span>)<span class="comment">//登录跳转页面，表单中的action</span></span><br><span class="line">				.usernameParameter(<span class="string">&quot;uname&quot;</span>)</span><br><span class="line">				.passwordParameter(<span class="string">&quot;upassword&quot;</span>)<span class="comment">//传递的属性</span></span><br><span class="line">				.successHandler(successHandler)</span><br><span class="line">				.failureHandler(failureHandler)</span><br><span class="line">				.and()</span><br><span class="line">				.apply(smsCodeSecurityConfig)</span><br><span class="line">				.and().httpBasic().and()</span><br><span class="line">				.authorizeRequests()</span><br><span class="line">				.antMatchers(<span class="string">&quot;/home&quot;</span>,<span class="string">&quot;/toLogin&quot;</span>,<span class="string">&quot;/login&quot;</span>, <span class="string">&quot;/user/create&quot;</span>, <span class="string">&quot;/kaptcha&quot;</span>, <span class="string">&quot;/smsCode&quot;</span>, <span class="string">&quot;/smslogin&quot;</span>).permitAll()</span><br><span class="line">				.mvcMatchers(<span class="string">&quot;/test/a/*&quot;</span>).permitAll()</span><br><span class="line">				.anyRequest().authenticated()</span><br><span class="line">				.and()</span><br><span class="line">				.sessionManagement()</span><br><span class="line">				.sessionCreationPolicy(SessionCreationPolicy.IF_REQUIRED)</span><br><span class="line">				.sessionFixation().migrateSession()</span><br><span class="line">				.maximumSessions(<span class="number">1</span>).</span><br><span class="line">				maxSessionsPreventsLogin(<span class="literal">false</span>)</span><br><span class="line">				.expiredSessionStrategy(<span class="keyword">new</span> <span class="title class_">CustomExpiredSessionStrategy</span>());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		auth.userDetailsService(commonUserDetailServiceImpl)</span><br><span class="line">				.passwordEncoder(passwordEncoder());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(WebSecurity web)</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		<span class="comment">//将项目中的静态资源路径开放出来</span></span><br><span class="line">		<span class="comment">//为什么要抽出来？上面的规则都需要通过过滤器校验，这个不需要</span></span><br><span class="line">		web.ignoring().antMatchers(<span class="string">&quot;/css/**&quot;</span>, <span class="string">&quot;/fonts/**&quot;</span>, <span class="string">&quot;/js/**&quot;</span>, <span class="string">&quot;/templates/**&quot;</span>, <span class="string">&quot;/static/**&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="keyword">public</span> PasswordEncoder <span class="title function_">passwordEncoder</span><span class="params">()</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BCryptPasswordEncoder</span>();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//跨域配置</span></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	CorsConfigurationSource <span class="title function_">corsConfigurationSource</span><span class="params">()</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		<span class="type">CorsConfiguration</span> <span class="variable">configuration</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CorsConfiguration</span>();</span><br><span class="line">		configuration.addAllowedOrigin(<span class="string">&quot;*&quot;</span>);</span><br><span class="line">		configuration.addAllowedMethod(<span class="string">&quot;*&quot;</span>);</span><br><span class="line">		configuration.addAllowedHeader(<span class="string">&quot;*&quot;</span>);</span><br><span class="line">		configuration.applyPermitDefaultValues();</span><br><span class="line">		configuration.setAllowCredentials(<span class="literal">true</span>);</span><br><span class="line">		<span class="type">UrlBasedCorsConfigurationSource</span> <span class="variable">source</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UrlBasedCorsConfigurationSource</span>();</span><br><span class="line">		source.registerCorsConfiguration(<span class="string">&quot;/**&quot;</span>, configuration);</span><br><span class="line">		<span class="keyword">return</span> source;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>那么现在已经有了用户，接下来只需将用户管理关联到授权服务器配置即可。为此，需要在Spring上下文中将AuthenticationManager暴露一个bean,然后在AuthServerConfig类中使用它。所以我们紧接着上面的ProjectConfig配置我们的AuthenticationManager。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> AuthenticationManager <span class="title function_">authenticationManagerBean</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">  </span><br><span class="line">    </span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">super</span>.authenticationManagerBean();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下来更改AuthServerConfig类，<strong>以便向授权服务器去注册AuthenticationManager</strong>.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.mbw.security.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.mbw.security.service.UserDetailsServiceImpl;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.authentication.AuthenticationManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.config.annotation.web.configuration.AuthorizationServerConfigurerAdapter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.config.annotation.web.configuration.EnableAuthorizationServer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.config.annotation.web.configurers.AuthorizationServerEndpointsConfigurer;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableAuthorizationServer</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AuthServerConfig</span> <span class="keyword">extends</span> <span class="title class_">AuthorizationServerConfigurerAdapter</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> AuthenticationManager authenticationManager;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> UserDetailsServiceImpl userDetailsService;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthorizationServerEndpointsConfigurer endpoints)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		endpoints.authenticationManager(authenticationManager)</span><br><span class="line">		.userDetailsService(userDetailsService);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>有了这些配置，<strong>就有了可以在身份验证服务器上进行身份验证的用户</strong>。但OAuth2架构意味着<strong>用户向客户端授予权利。客户端则以用户名义使用资源</strong>。所以接下来讲解如何配置客户端。</p>
<h3 id="向授权服务器注册客户端"><a href="#向授权服务器注册客户端" class="headerlink" title="向授权服务器注册客户端"></a>向授权服务器注册客户端</h3><p>本节将介绍如何让授权服务器知晓客户端<strong>。要调用授权服务器，在OAuth2架构中充当客户端的应用程序需要自己的凭据</strong>。<strong>授权服务器还要管理这些凭据，并且只允许来自已知客户端的请求</strong>。</p>
 <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/03/13/spring-security-guide2/1695614692861.png" class="">

<p>还记得之前开发过的客户端应用程序吗？就那个GiteeClient,其中使用Gitee作为身份验证服务器。<strong>Gitee需要知悉该客户端应用程序</strong>，所以我们做的第一件事就是在Gitee上<strong>注册这个应用程序</strong>。<strong>然后，我们会接收到客户端ID和客户端密钥：客户端凭据</strong>。接着我们配置了这些凭据，该客户端应用程序使用它们通过授权服务器（Gitee）进行身份验证。同样的情况也适用于本示例。<strong>授权服务器需要知悉其客户端，因为它要接收来自客户端的请求</strong>。这里的处理过程你应该很熟悉。<strong>为授权服务器定义客户端的契约是ClientDetails.定义对象以便根据其ID检索ClientDetails的契约是ClientDetailsService</strong>。</p>
<p>这些名称听着熟悉吗？没错，<strong>这些接口的工作方式类似于UserDetails和UserDetailsService接口，只不过一个是用户，一个是客户端。你会发现，他俩很多都是类似的</strong>。例如InMemoryClientDetailsService是ClientDetailsService接口的实现，该接口管理内存中的ClientDetails.它的工作方式类似于用于UserDetails的InMemoryUserDetailsManager类。同样，JdbcClientDetailsService也类似于JdbcUserDetailsManager。</p>
 <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/03/13/spring-security-guide2/1695614693359.png" class="">
<p>可以把这些相似之处总结为很容易记住的以下几点：</p>
<ul>
<li>ClientDetails之于客户端就像UserDetails之于用户一样。</li>
<li>ClientDetailsService之于客户端就像UserDetailsService之于用户一样。</li>
<li>InMemoryClientDetailsService之于客户端就像InMemoryUserDetailsManager之于用户一样</li>
<li>JdbcClientDetailsService之于客户端就像JdbcUserDetailsManager之于用户一样</li>
</ul>
<p>理解这一层关系后，我们就可以使用之前类似于配置UserDetails的方法同样用于ClientDetails上<br>首先我们需要一张存储客户端信息的表，表的结构和数据如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> Navicat Premium Data Transfer</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> Source Server         : local_mysql</span></span><br><span class="line"><span class="comment"> Source Server Type    : MySQL</span></span><br><span class="line"><span class="comment"> Source Server Version : 50727</span></span><br><span class="line"><span class="comment"> Source Host           : localhost:3306</span></span><br><span class="line"><span class="comment"> Source Schema         : spring_security</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> Target Server Type    : MySQL</span></span><br><span class="line"><span class="comment"> Target Server Version : 50727</span></span><br><span class="line"><span class="comment"> File Encoding         : 65001</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> Date: 28/11/2022 12:00:29</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line">SET NAMES utf8mb4;</span><br><span class="line"><span class="type">SET</span> <span class="variable">FOREIGN_KEY_CHECKS</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">-- </span><br><span class="line"></span><br><span class="line">--------</span><br><span class="line">-- Table structure <span class="keyword">for</span> oauth_client_details</span><br><span class="line">-- </span><br><span class="line"></span><br><span class="line">--------</span><br><span class="line">DROP TABLE IF EXISTS oauth_client_details;</span><br><span class="line">CREATE TABLE <span class="title function_">oauth_client_details</span>  <span class="params">(</span></span><br><span class="line"><span class="params">  id bigint(<span class="number">20</span>)</span> NOT NULL COMMENT <span class="string">&#x27;id&#x27;</span>,</span><br><span class="line">  clientId <span class="title function_">varchar</span><span class="params">(<span class="number">128</span>)</span> CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL COMMENT <span class="string">&#x27;客户端ID&#x27;</span>,</span><br><span class="line">  resourceIds <span class="title function_">varchar</span><span class="params">(<span class="number">256</span>)</span> CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL COMMENT <span class="string">&#x27;资源ID集合，多个资源时用英文逗号分隔&#x27;</span>,</span><br><span class="line">  clientSecret <span class="title function_">varchar</span><span class="params">(<span class="number">256</span>)</span> CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL COMMENT <span class="string">&#x27;客户端密匙&#x27;</span>,</span><br><span class="line">  scope <span class="title function_">varchar</span><span class="params">(<span class="number">256</span>)</span> CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL COMMENT <span class="string">&#x27;客户端申请的权限范围&#x27;</span>,</span><br><span class="line">  authorizedGrantTypes <span class="title function_">varchar</span><span class="params">(<span class="number">256</span>)</span> CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL COMMENT <span class="string">&#x27;客户端支持的grant_type&#x27;</span>,</span><br><span class="line">  webServerRedirectUri <span class="title function_">varchar</span><span class="params">(<span class="number">256</span>)</span> CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL COMMENT <span class="string">&#x27;重定向URI&#x27;</span>,</span><br><span class="line">  authorities <span class="title function_">varchar</span><span class="params">(<span class="number">256</span>)</span> CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL COMMENT <span class="string">&#x27;客户端所拥有的SpringSecurity的权限值，多个用英文逗号分隔&#x27;</span>,</span><br><span class="line">  accessTokenValidity <span class="title function_">int</span><span class="params">(<span class="number">11</span>)</span> NULL DEFAULT NULL COMMENT <span class="string">&#x27;访问令牌有效时间值(单位秒)&#x27;</span>,</span><br><span class="line">  refreshTokenValidity <span class="title function_">int</span><span class="params">(<span class="number">11</span>)</span> NULL DEFAULT NULL COMMENT <span class="string">&#x27;更新令牌有效时间值(单位秒)&#x27;</span>,</span><br><span class="line">  additionalInformation <span class="title function_">varchar</span><span class="params">(<span class="number">500</span>)</span> CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL COMMENT <span class="string">&#x27;预留字段&#x27;</span>,</span><br><span class="line">  autoApprove <span class="title function_">tinyint</span><span class="params">(<span class="number">1</span>)</span> NULL DEFAULT NULL COMMENT <span class="string">&#x27;用户是否自动Approval操作&#x27;</span>,</span><br><span class="line">  PRIMARY <span class="title function_">KEY</span> <span class="params">(id)</span> USING BTREE,</span><br><span class="line">  UNIQUE INDEX <span class="title function_">UNIQUE_CLIENT_ID</span><span class="params">(clientId)</span> USING BTREE</span><br><span class="line">) ENGINE = InnoDB <span class="type">CHARACTER</span> <span class="variable">SET</span> <span class="operator">=</span> <span class="type">utf8</span> <span class="variable">COLLATE</span> <span class="operator">=</span> <span class="type">utf8_general_ci</span> <span class="variable">COMMENT</span> <span class="operator">=</span> <span class="string">&#x27;客户端信息&#x27;</span> ROW_FORMAT = Dynamic;</span><br><span class="line"></span><br><span class="line">-- </span><br><span class="line"></span><br><span class="line">--------</span><br><span class="line">-- Records of oauth_client_details</span><br><span class="line">-- </span><br><span class="line"></span><br><span class="line">--------</span><br><span class="line">INSERT INTO oauth_client_details <span class="title function_">VALUES</span> <span class="params">(<span class="number">1596077605292945410</span>, <span class="string">&#x27;f7n6ockwdb9zmayr&#x27;</span>, NULL, <span class="string">&#x27;$2a$10$b87rn4FF4TeR7r6VB45rC.kTv5M36Qs2U62WheA4mnEB5MmA3mVAW&#x27;</span>, <span class="string">&#x27;user_info&#x27;</span>, <span class="string">&#x27;password,authorization_code,refresh_token&#x27;</span>, <span class="string">&#x27;http://localhost:9090/yidou&#x27;</span>, <span class="string">&#x27;add,delete&#x27;</span>, <span class="number">86400</span>, <span class="number">432000</span>, NULL, <span class="number">0</span>)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">SET</span> <span class="variable">FOREIGN_KEY_CHECKS</span> <span class="operator">=</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<p>然后同样的我们需要建立一个客户端的实体类，同样的，<strong>这个实体类和真正用于OAuth的客户端是分离开来的，类似于我们之前的User类和JwtUserDto类的关系</strong>：<br><strong>OAuth2Client.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.mbw.pojo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.annotation.IdType;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.annotation.TableField;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.annotation.TableId;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.annotation.TableName;</span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@TableName(&quot;oauth_client_details&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OAuth2Client</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">	<span class="meta">@TableId(type = IdType.ASSIGN_ID, value = &quot;id&quot;)</span></span><br><span class="line">	<span class="keyword">private</span> Long id;</span><br><span class="line">	<span class="meta">@TableField(&quot;clientId&quot;)</span></span><br><span class="line">	<span class="keyword">private</span> String clientId;</span><br><span class="line">	<span class="meta">@TableField(value = &quot;resourceIds&quot;)</span></span><br><span class="line">	<span class="keyword">private</span> String resourceIds;</span><br><span class="line">	<span class="meta">@TableField(value = &quot;authorities&quot;)</span></span><br><span class="line">	<span class="keyword">private</span> String authorities;</span><br><span class="line">	<span class="meta">@TableField(&quot;clientSecret&quot;)</span></span><br><span class="line">	<span class="keyword">private</span> String clientSecret;</span><br><span class="line">	<span class="meta">@TableField(value = &quot;scope&quot;)</span></span><br><span class="line">	<span class="keyword">private</span> String scope;</span><br><span class="line">	<span class="meta">@TableField(value = &quot;authorizedGrantTypes&quot;)</span></span><br><span class="line">	<span class="keyword">private</span> String authorizedGrantTypes;</span><br><span class="line">	<span class="meta">@TableField(&quot;webServerRedirectUri&quot;)</span></span><br><span class="line">	<span class="keyword">private</span> String webServerRedirectUri;</span><br><span class="line">	<span class="meta">@TableField(&quot;accessTokenValidity&quot;)</span></span><br><span class="line">	<span class="keyword">private</span> Integer accessTokenValidity;</span><br><span class="line">	<span class="meta">@TableField(&quot;refreshTokenValidity&quot;)</span></span><br><span class="line">	<span class="keyword">private</span> Integer refreshTokenValidity;</span><br><span class="line">	<span class="meta">@TableField(&quot;additionalInformation&quot;)</span></span><br><span class="line">	<span class="keyword">private</span> String additionalInformation;</span><br><span class="line">	<span class="meta">@TableField(&quot;autoApprove&quot;)</span></span><br><span class="line">	<span class="keyword">private</span> Boolean autoApprove;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>同样的dao-service-controller我们也需要建立，并且提供2个方法，通过clientId查找client（这个也是ClientDetailsService需要重写的方法的原理），然后还有注册client的方法</p>
<p><strong>OAuth2ClientMapper.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.mbw.mapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.core.mapper.BaseMapper;</span><br><span class="line"><span class="keyword">import</span> com.mbw.pojo.OAuth2Client;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Mapper;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">OAuth2ClientMapper</span> <span class="keyword">extends</span> <span class="title class_">BaseMapper</span>&lt;OAuth2Client&gt; &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">	OAuth2Client <span class="title function_">queryByClientId</span><span class="params">(String clientId)</span>;</span><br><span class="line">	OAuth2Client <span class="title function_">queryClientUnique</span><span class="params">(String clientId)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>OAuth2ClientMapper.xml</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mapper</span> <span class="keyword">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span></span><br><span class="line"><span class="meta">        <span class="string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;com.mbw.mapper.OAuth2ClientMapper&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;queryByClientId&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;com.mbw.pojo.OAuth2Client&quot;</span>&gt;</span></span><br><span class="line">        select * from oauth_client_details</span><br><span class="line">        where clientId =&#123;clientId&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;queryClientUnique&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;com.mbw.pojo.OAuth2Client&quot;</span>&gt;</span></span><br><span class="line">        select ocd.id,ocd.clientId from oauth_client_details ocd</span><br><span class="line">        where ocd.clientId =&#123;clientId&#125; limit 1</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>OAuth2ClientService.java</strong><br>这里主要是需要解析一下clientSecret，我在这里当时出现过Bad Crendential相关的异常。</p>
<p>由于OAuth2解析客户端秘钥也会通过我们配置的passwordEncoder去解密,而我们在projectConfig已经对PasswordEncoder配置为BCryptPasswordEncoder，那么如果在注册客户端不通过passwordEncoder对clientSecret进行加密，在解析的时候就会出现解析错误。所以这里我们需要注入passwordEncoder.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.mbw.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.util.ObjectUtil;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.util.RandomUtil;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;</span><br><span class="line"><span class="keyword">import</span> com.mbw.mapper.OAuth2ClientMapper;</span><br><span class="line"><span class="keyword">import</span> com.mbw.pojo.OAuth2Client;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Lazy;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.crypto.password.PasswordEncoder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OAuth2ClientService</span> <span class="keyword">extends</span> <span class="title class_">ServiceImpl</span>&lt;OAuth2ClientMapper, OAuth2Client&gt; &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> OAuth2ClientMapper oAuth2ClientMapper;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="meta">@Lazy</span></span><br><span class="line">	<span class="keyword">private</span> PasswordEncoder passwordEncoder;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> OAuth2Client <span class="title function_">queryClientByClientId</span><span class="params">(String clientId)</span>&#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		<span class="keyword">return</span> oAuth2ClientMapper.queryByClientId(clientId);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> String <span class="title function_">getClientIdUnique</span><span class="params">(OAuth2Client oAuth2Client)</span>&#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		<span class="type">Long</span> <span class="variable">id</span> <span class="operator">=</span> ObjectUtil.isEmpty(oAuth2Client.getId()) ? -<span class="number">1</span>: oAuth2Client.getId();</span><br><span class="line">		<span class="type">String</span> <span class="variable">clientId</span> <span class="operator">=</span> RandomUtil.randomString(<span class="number">16</span>);</span><br><span class="line">		<span class="type">OAuth2Client</span> <span class="variable">oAuthClient</span> <span class="operator">=</span> oAuth2ClientMapper.queryClientUnique(clientId);</span><br><span class="line">		<span class="keyword">if</span>(ObjectUtil.isNotEmpty(oAuthClient) &amp;&amp; !oAuthClient.getId().equals(id))&#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">			<span class="comment">//说明有重复，重新生成一次</span></span><br><span class="line">			<span class="keyword">return</span> getClientIdUnique(oAuth2Client);</span><br><span class="line">		&#125;<span class="keyword">else</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">			<span class="keyword">return</span> clientId;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> OAuth2Client <span class="title function_">createOAuth2Client</span><span class="params">(OAuth2Client oAuth2Client)</span>&#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		<span class="type">String</span> <span class="variable">clientId</span> <span class="operator">=</span> getClientIdUnique(oAuth2Client);</span><br><span class="line">		<span class="type">String</span> <span class="variable">clientSecret</span> <span class="operator">=</span> RandomUtil.randomString(<span class="number">16</span>);</span><br><span class="line">		<span class="type">String</span> <span class="variable">clientSecretEncoded</span> <span class="operator">=</span> passwordEncoder.encode(clientSecret);</span><br><span class="line">		oAuth2Client.setClientId(clientId);</span><br><span class="line">		<span class="comment">//对clientSecret进行加密</span></span><br><span class="line">		oAuth2Client.setClientSecret(clientSecretEncoded);</span><br><span class="line">		oAuth2ClientMapper.insert(oAuth2Client);</span><br><span class="line">		oAuth2Client.setClientSecret(clientSecret);</span><br><span class="line">		<span class="keyword">return</span> oAuth2Client;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但是对于加入@Lazy的原因，如果直接注入passwordEncoder,看似没什么问题，但<strong>启动后会报循环依赖的问题</strong>。原因是我们的ProjectConfig在引用两个类，SmsUserDetailsServiceImpl和UserDetailsServiceImpl分别代表短信认证和用户认证的两个Service,而这两个Service都依赖了UserService，UserService又依赖了PasswordEncoder,具体关系如下图：</p>
 <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/03/13/spring-security-guide2/1695614694054.png" class="">
<p>但是我这里有一个疑问，那就是为什么我们在没写OAuth2相关业务时，其实也存在这样一个循环依赖关系，为什么在当时不会报错，而加入OAuth2Service相关逻辑，就报了相关的错误呢，如果有知道的小伙伴可以在评论群帮我解决这个疑惑，非常感谢。</p>
<p>接着上面代码，我们接着写OAuth2ClientController类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.mbw.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.mbw.common.utils.Res;</span><br><span class="line"><span class="keyword">import</span> com.mbw.pojo.OAuth2Client;</span><br><span class="line"><span class="keyword">import</span> com.mbw.service.OAuth2ClientService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/oauth2/client&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OAuth2ClientController</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> OAuth2ClientService oAuth2ClientService;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@PostMapping(&quot;query/clientId&quot;)</span></span><br><span class="line">	<span class="keyword">public</span> Res <span class="title function_">queryOauthClientByClientId</span><span class="params">(String clientId)</span>&#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		<span class="type">OAuth2Client</span> <span class="variable">oAuth2Client</span> <span class="operator">=</span> oAuth2ClientService.queryClientByClientId(clientId);</span><br><span class="line">		<span class="keyword">return</span> Res.success(oAuth2Client);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@PostMapping(&quot;create&quot;)</span></span><br><span class="line">	<span class="keyword">public</span> Res <span class="title function_">createOAuthClient</span><span class="params">(<span class="meta">@RequestBody</span> OAuth2Client oAuth2Client)</span>&#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		<span class="type">OAuth2Client</span> <span class="variable">oAuth2ClientCreated</span> <span class="operator">=</span> oAuth2ClientService.createOAuth2Client(oAuth2Client);</span><br><span class="line">		<span class="keyword">return</span> Res.success(oAuth2ClientCreated);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后别忘了在projectConfig中对创建客户端这个接口进行放行：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.mvcMatchers(<span class="string">&quot;/oauth2/client/create&quot;</span>).permitAll()</span><br></pre></td></tr></table></figure>

<p>然后对于client这个单体我们完成了，现在我们要把它和OAuth2相关的逻辑类实现<br>类似于我们之前实现UserDetails和UserDetailsService一样<br>首先我们在dto包中加入<strong>OAuth2ClientDto并实现ClientDetails</strong><br><strong>OAuth2ClientDto.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.mbw.security.dto;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.text.CharSequenceUtil;</span><br><span class="line"><span class="keyword">import</span> com.mbw.pojo.OAuth2Client;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.ToString;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.GrantedAuthority;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.authority.SimpleGrantedAuthority;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.ClientDetails;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"><span class="keyword">import</span> java.util.Collection;</span><br><span class="line"><span class="keyword">import</span> java.util.Collections;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.HashSet;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OAuth2ClientDto</span> <span class="keyword">implements</span> <span class="title class_">ClientDetails</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> OAuth2Client oAuth2Client;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> String <span class="title function_">getClientId</span><span class="params">()</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		<span class="keyword">return</span> oAuth2Client.getClientId();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> Set&lt;String&gt; <span class="title function_">getResourceIds</span><span class="params">()</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		<span class="type">String</span> <span class="variable">resourceIds</span> <span class="operator">=</span> oAuth2Client.getResourceIds();</span><br><span class="line">		<span class="keyword">if</span>(CharSequenceUtil.isNotBlank(resourceIds))&#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">			String[] resourceCollection = resourceIds.split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;(Arrays.asList(resourceCollection));</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> Collections.emptySet();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isSecretRequired</span><span class="params">()</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> String <span class="title function_">getClientSecret</span><span class="params">()</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		<span class="keyword">return</span> oAuth2Client.getClientSecret();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isScoped</span><span class="params">()</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> Set&lt;String&gt; <span class="title function_">getScope</span><span class="params">()</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		<span class="type">String</span> <span class="variable">scopes</span> <span class="operator">=</span> oAuth2Client.getScope();</span><br><span class="line">		<span class="keyword">if</span>(CharSequenceUtil.isNotBlank(scopes))&#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">			String[] scopeCollection = scopes.split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;(Arrays.asList(scopeCollection));</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> Collections.emptySet();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> Set&lt;String&gt; <span class="title function_">getAuthorizedGrantTypes</span><span class="params">()</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		<span class="type">String</span> <span class="variable">authorizedGrantTypes</span> <span class="operator">=</span> oAuth2Client.getAuthorizedGrantTypes();</span><br><span class="line">		<span class="keyword">if</span>(CharSequenceUtil.isNotBlank(authorizedGrantTypes))&#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">			String[] grantTypes = authorizedGrantTypes.split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;(Arrays.asList(grantTypes));</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> Collections.emptySet();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> Set&lt;String&gt; <span class="title function_">getRegisteredRedirectUri</span><span class="params">()</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		<span class="type">String</span> <span class="variable">webServerRedirectUri</span> <span class="operator">=</span> oAuth2Client.getWebServerRedirectUri();</span><br><span class="line">		<span class="keyword">if</span>(CharSequenceUtil.isNotBlank(webServerRedirectUri))&#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">			HashSet&lt;String&gt; redirectUris = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line">			redirectUris.add(webServerRedirectUri);</span><br><span class="line">			<span class="keyword">return</span> redirectUris;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> Collections.emptySet();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> Collection&lt;GrantedAuthority&gt; <span class="title function_">getAuthorities</span><span class="params">()</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		<span class="type">String</span> <span class="variable">authorities</span> <span class="operator">=</span> oAuth2Client.getAuthorities();</span><br><span class="line">		List&lt;GrantedAuthority&gt; grantedAuthorityList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">		<span class="keyword">if</span>(CharSequenceUtil.isNotBlank(authorities))&#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">			String[] grantAuthorities = authorities.split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">			<span class="keyword">for</span> (String grantAuthority : grantAuthorities) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">				<span class="type">SimpleGrantedAuthority</span> <span class="variable">simpleGrantedAuthority</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleGrantedAuthority</span>(grantAuthority);</span><br><span class="line">				grantedAuthorityList.add(simpleGrantedAuthority);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span> grantedAuthorityList;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> Collections.emptyList();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> Integer <span class="title function_">getAccessTokenValiditySeconds</span><span class="params">()</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		<span class="keyword">return</span> oAuth2Client.getAccessTokenValidity();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> Integer <span class="title function_">getRefreshTokenValiditySeconds</span><span class="params">()</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		<span class="keyword">return</span> oAuth2Client.getRefreshTokenValidity();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isAutoApprove</span><span class="params">(String s)</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		<span class="keyword">return</span> oAuth2Client.getAutoApprove();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title function_">getAdditionalInformation</span><span class="params">()</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		<span class="type">String</span> <span class="variable">additionalInformation</span> <span class="operator">=</span> oAuth2Client.getAdditionalInformation();</span><br><span class="line">		<span class="keyword">if</span>(CharSequenceUtil.isNotBlank(additionalInformation))&#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">			HashMap&lt;String, Object&gt; information = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">			information.put(<span class="string">&quot;额外信息&quot;</span>,additionalInformation);</span><br><span class="line">			<span class="keyword">return</span> information;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> Collections.emptyMap();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_">OAuth2ClientDto</span><span class="params">(OAuth2Client oAuth2Client)</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		<span class="built_in">this</span>.oAuth2Client = oAuth2Client;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后实现ClientDetailsServiceImpl,让它实现ClientDetailsService类。重写loadClientByClientId(String clientId)方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.mbw.security.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.mbw.mapper.OAuth2ClientMapper;</span><br><span class="line"><span class="keyword">import</span> com.mbw.pojo.OAuth2Client;</span><br><span class="line"><span class="keyword">import</span> com.mbw.security.dto.OAuth2ClientDto;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.ClientDetails;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.ClientDetailsService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.ClientRegistrationException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ClientDetailsServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">ClientDetailsService</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> OAuth2ClientMapper oAuth2ClientMapper;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> ClientDetails <span class="title function_">loadClientByClientId</span><span class="params">(String clientId)</span> <span class="keyword">throws</span> ClientRegistrationException &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		<span class="type">OAuth2Client</span> <span class="variable">oAuth2Client</span> <span class="operator">=</span> oAuth2ClientMapper.queryByClientId(clientId);</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">OAuth2ClientDto</span>(oAuth2Client);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对比一下我们实现UserDetails和UserDetailsService,是不是基本一致呢。</p>
<p>写完后，我们就需要在授权服务器配置类当中去配置客户端了，完整配置类代码如下：<br><strong>AuthServerConfig.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.mbw.security.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.mbw.security.service.ClientDetailsServiceImpl;</span><br><span class="line"><span class="keyword">import</span> com.mbw.security.service.UserDetailsServiceImpl;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.authentication.AuthenticationManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.config.annotation.configurers.ClientDetailsServiceConfigurer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.config.annotation.web.configuration.AuthorizationServerConfigurerAdapter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.config.annotation.web.configuration.EnableAuthorizationServer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.config.annotation.web.configurers.AuthorizationServerEndpointsConfigurer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.config.annotation.web.configurers.AuthorizationServerSecurityConfigurer;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableAuthorizationServer</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AuthServerConfig</span> <span class="keyword">extends</span> <span class="title class_">AuthorizationServerConfigurerAdapter</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> AuthenticationManager authenticationManager;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> ClientDetailsServiceImpl clientDetailsServiceImpl;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> UserDetailsServiceImpl userDetailsServiceImpl;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthorizationServerEndpointsConfigurer endpoints)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		endpoints.authenticationManager(authenticationManager)</span><br><span class="line">		.userDetailsService(userDetailsServiceImpl);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(ClientDetailsServiceConfigurer clients)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		clients.withClientDetails(clientDetailsServiceImpl);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 解决访问/oauth/check_token 403的问题</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> security</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthorizationServerSecurityConfigurer security)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		<span class="comment">// 允许表单认证</span></span><br><span class="line">		security</span><br><span class="line">				.tokenKeyAccess(<span class="string">&quot;permitAll()&quot;</span>)</span><br><span class="line">				.checkTokenAccess(<span class="string">&quot;permitAll()&quot;</span>)</span><br><span class="line">				.allowFormAuthenticationForClients();</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>完成后我们可以来到postman<br>试试创建一个客户端：</p>
 <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/03/13/spring-security-guide2/1695614694549.png" class="">
<p>发现创建成功，但是大家最好拿笔记本记录下这个未加密的clientSecret,因为db存储的加密后的secret。到时候我们需要该密钥去请求token。</p>
<p>到此，我们就完成了环境和相关骨架的搭建，下一章我们将在代码基础上完成三种授权类型的测试。</p>
<p>大家如果是一路跟过笔者写的文章过来的，可以发现OAuth2并不是独立的，相反，它将我们之前的学习内容通过这一章又紧密连接了起来，所以大家对于之前的内容不能忘记，必须加以巩固。</p>
<p>如果大家需要代码的话，可以在评论区回复我，我看到时候需不需要把代码放gitee上供大家自由克隆下来学习使用。</p>
<h3 id="使用密码授权类型"><a href="#使用密码授权类型" class="headerlink" title="使用密码授权类型"></a>使用密码授权类型</h3><p>本节将使用带有OAuth2密码授权的授权服务器，来测试它是否有效。</p>
<p>首先我们在postman通过之前写的创建客户端的接口创建一个客户端，其中authorizedGrantTypes这个参数，我们填上”password,authorization_code,refresh_token”分别代表密码授权模式，授权码授权模式以及支持刷新token。</p>
 <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/03/13/spring-security-guide2/1695614695290.png" class="">
<p>创建成功后，我们的客户端就可以使用密码授权类型了。</p>
<p>怎么测试密码授权类型呢，我们可以通过请求&#x2F;oauth&#x2F;token端点请求令牌，这个接口是Spring Security自动为我们配置的，我们直接请求就可以，使用密码授权类型需要带上以下参数：</p>
<ul>
<li>grant_type，授权类型，这里填写password即可</li>
<li>username:用户名</li>
<li>password:用户密码</li>
<li>scope:它们是所授予的权限</li>
<li>clientId:客户端Id</li>
<li>clientSecret:客户端密钥，注意这里的客户端密钥是加密前的密钥，不要直接把db存储的搬上来。</li>
</ul>
<p>密码授权类型流程图如下：总计就是客户端直接使用资源所有者的凭据进行身份验证并获得访问令牌。</p>
 <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/03/13/spring-security-guide2/1695614695901.png" class="">
<p>大家注意到除了访问令牌，我们还得到了一个刷新令牌，这个就是因为我们在创建客户端那会儿对<br>authorizedGrantTypes这个参数配置了refresh_token这个模式。  <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/03/13/spring-security-guide2/1695614696528.png" class=""><br>那么仔细观察上述响应中的令牌。使用Spring Security中的默认配置，令牌其实就是一个简单的UUID。接下来客户端可以使用这个令牌调用资源服务器暴露的资源，后面我们将会学习如何搭建资源服务器。</p>
<h3 id="使用授权码授权类型"><a href="#使用授权码授权类型" class="headerlink" title="使用授权码授权类型"></a>使用授权码授权类型</h3><p>在之前讲解授权码授权类型的时候，我曾介绍给这是最常用的OAuth2授权类型之一。理解如何配置授权服务器以便使用这种授权类型非常重要，因为我们很可能会在实际的系统中面对这种需求。下图我们可以回顾一下授权码授权类型是如何工作的：</p>
 <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/03/13/spring-security-guide2/1695614697128.png" class="">
<p>在授权码授权类型中，客户端会将用户重定向到授权服务器进行身份验证。用户直接与授权服务器交互，通过身份验证后，授权服务器会向客户端返回一个重定向URI。在回调客户端时，它还会提供一个授权码。客户端要使用该授权码获取访问令牌。</p>
<p>而我们刚刚注册的客户端的authorizedGrantTypes已经有了authorization_code这个模式，所以可以直接通过该客户端进行测试<br>启动程序后在浏览器中访问链接，如下面的代码片段所示。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="comment">//localhost:9090/oauth/authorize?response_type=code&amp;client_id=f7n6ockwdb9zmayr</span></span><br></pre></td></tr></table></figure>

<p>然后授权服务器会将用户重定向到登陆页面，具体的登录页面就是我们在ProjectConfig中配置的loginPage</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		http.cors().and()</span><br><span class="line"><span class="comment">//				.addFilterBefore(captchaCodeFilter, UsernamePasswordAuthenticationFilter.class)</span></span><br><span class="line">				.logout()</span><br><span class="line">				.logoutSuccessHandler(logoutSuccessHandler)</span><br><span class="line">				.and()</span><br><span class="line">				.rememberMe()</span><br><span class="line">				<span class="comment">//默认都为remember-me</span></span><br><span class="line">				.rememberMeParameter(<span class="string">&quot;remeber-me&quot;</span>)</span><br><span class="line">				<span class="comment">//cookieName一般设置复杂一些，迷惑别人(不容易看出)</span></span><br><span class="line">				.rememberMeCookieName(<span class="string">&quot;remeber-me&quot;</span>)</span><br><span class="line">				<span class="comment">//过期时间</span></span><br><span class="line">				.tokenValiditySeconds(<span class="number">24</span> * <span class="number">60</span> * <span class="number">60</span> * <span class="number">2</span>)</span><br><span class="line">				.and()</span><br><span class="line">				.csrf().disable()</span><br><span class="line">				.formLogin()</span><br><span class="line">				.loginPage(<span class="string">&quot;/toLogin&quot;</span>) <span class="comment">//用户没有权限就跳转到这个页面</span></span><br><span class="line">				.loginProcessingUrl(<span class="string">&quot;/login&quot;</span>)<span class="comment">//登录跳转页面，表单中的action</span></span><br><span class="line">				.usernameParameter(<span class="string">&quot;uname&quot;</span>)</span><br><span class="line">				.passwordParameter(<span class="string">&quot;upassword&quot;</span>)<span class="comment">//传递的属性</span></span><br><span class="line">				.successHandler(successHandler)</span><br><span class="line">				.failureHandler(failureHandler)</span><br><span class="line">				.and()</span><br><span class="line">				.apply(smsCodeSecurityConfig)</span><br><span class="line">				.and().httpBasic().and()</span><br><span class="line">				.authorizeRequests()</span><br><span class="line">				.antMatchers(<span class="string">&quot;/home&quot;</span>,<span class="string">&quot;/toLogin&quot;</span>,<span class="string">&quot;/login&quot;</span>, <span class="string">&quot;/user/create&quot;</span>, <span class="string">&quot;/kaptcha&quot;</span>, <span class="string">&quot;/smsCode&quot;</span>, <span class="string">&quot;/smslogin&quot;</span>).permitAll()</span><br><span class="line">				.mvcMatchers(<span class="string">&quot;/test/a/*&quot;</span>,<span class="string">&quot;/oauth2/client/create&quot;</span>).permitAll()</span><br><span class="line">				.anyRequest().authenticated()</span><br><span class="line">				.and()</span><br><span class="line">				.sessionManagement()</span><br><span class="line">				.sessionCreationPolicy(SessionCreationPolicy.IF_REQUIRED)</span><br><span class="line">				.sessionFixation().migrateSession()</span><br><span class="line">				.maximumSessions(<span class="number">1</span>).</span><br><span class="line">				maxSessionsPreventsLogin(<span class="literal">false</span>)</span><br><span class="line">				.expiredSessionStrategy(<span class="keyword">new</span> <span class="title class_">CustomExpiredSessionStrategy</span>());</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

 <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/03/13/spring-security-guide2/1695614697824.png" class="">
<p>登陆后，授权服务器会明确要求用户提供授予或拒绝所请求的作用域。如下图所示</p>
 <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/03/13/spring-security-guide2/1695614698338.png" class="">
<p>一旦对作用域进行了授权，授权服务器就会将用户重定向到重定向URI并提供一个访问令牌。以下代码片段显示了授权服务器将用户重定向到的URL。通过请求中查询参数观察客户端获得的访问码：</p>
 <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/03/13/spring-security-guide2/1695614698736.png" class="">
<p>之后我们在postman通过授权码调用&#x2F;oauth&#x2F;token就可以获取访问令牌了：</p>
 <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/03/13/spring-security-guide2/1695614699123.png" class="">
<p>需要注意的是，授权码只能使用一次。如果尝试再次使用相同的授权码调用&#x2F;.oauth&#x2F;token端点，则会收到以下代码片段中所显示的类似错误。只能通过请求用户再次登录来获得另一个有效的授权码：</p>
 <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/03/13/spring-security-guide2/1695614699776.png" class="">

<h3 id="使用客户端凭据授权类型"><a href="#使用客户端凭据授权类型" class="headerlink" title="使用客户端凭据授权类型"></a>使用客户端凭据授权类型</h3><p>本节将讨论如何实现客户端凭据授权类型，在保护与特定用户无关且客户端需要访问的端点时，可以使用客户端凭据授权类型。假设打算实现一个返回服务器状态的端点，客户端可以调用此端点检查连接性，并最终向用户展示连接状态或错误信息。由于此端点仅仅表示客户端和资源服务器的交互，并且不涉及任何特定于用户的资源，因此客户端应该能够调用它而不需要用户进行身份验证。对于这样的场景，可以使用客户端凭据授权类型。</p>
 <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/03/13/spring-security-guide2/1695614700512.png" class="">
<p>那么我们新建一个客户端，并且让它的授权类型给它设置上客户端凭据授权类型：</p>
 <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/03/13/spring-security-guide2/1695614701109.png" class="">
<p>然后可以直接启动程序，调用&#x2F;oauth&#x2F;token端点来获得访问令牌：</p>
 <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/03/13/spring-security-guide2/1695614701875.png" class="">
<p>注意：要<strong>谨慎使用客户端凭据授权类型</strong>。这种授权类型只要求客户端用其凭据。<strong>应该确保它无法访问与需要用户凭据的流程相同的作用域</strong>，例如我将一个客户端<strong>同时设置客户端凭据授权类型和密码授权类型</strong>，这样就<strong>意味着客户端可以通过用户进行身份验证或仅使用自己的凭据来获得相同的令牌</strong>，这肯定是不合理的，甚至是一个安全漏洞都不为过，因为这样会<strong>让客户端可以访问客户的资源而不需要经过客户验证</strong>。</p>
<h3 id="使用刷新令牌授权类型"><a href="#使用刷新令牌授权类型" class="headerlink" title="使用刷新令牌授权类型"></a>使用刷新令牌授权类型</h3><p>本节将讨论如何通过Spring Security开发的授权服务器来使用刷新令牌。当与其他授权类型一起使用时，刷新令牌提供了几个好处。可以使用带有授权码授权类型和密码授权类型的刷新令牌</p>
 <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/03/13/spring-security-guide2/1695614702544.png" class="">
<p>如果希望授权服务器支持刷新令牌，则需要将刷新令牌授权添加到客户端的授权列表中。而我们一开始创建的客户端的authorizedGrantTypes已经包含refresh_token，所以我们使用该客户端通过密码授权类型访问&#x2F;oauth&#x2F;token接口，可以看到应用程序将刷新令牌添加到响应中。</p>
 <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/03/13/spring-security-guide2/1695614703433.png" class="">









<h2 id="实现资源服务器"><a href="#实现资源服务器" class="headerlink" title="实现资源服务器"></a>实现资源服务器</h2><p>本章将讨论如何使用Spring Security实现一个资源服务器，资源服务器是管理用户资源的组件。另外，学习本章有个前提，需要先把前面搭建授权服务器的相关文章先给阅读，否则可能后面出现的授权服务器相关代码不知道个所以然。就OAuth2而言，它代表了我们要保护的后端（端点）,就像前几章保护的其他应用程序是一样的。为了允许客户端访问资源，资源服务器需要一个有效的访问令牌。客户端会从授权服务器获得访问令牌，并通过将该令牌添加到HTTP请求头信息来使用该令牌调用资源服务器上的资源。</p>
<p>还记得前两章讨论客户端和授权服务器的实现时，我们曾经提起过资源服务器更为重要的是选择资源服务器验证令牌的方式。对于在资源服务器级别实现令牌验证，我们主要有三种方式:</p>
<ul>
<li><strong>远程检查令牌</strong>，即通过网络调用授权服务器检查token</li>
<li><strong>黑板模式</strong>，我们使用一个公共数据库，<strong>这个可以是Mysql也可以是redis</strong>,这个我们都会讲。redis我会专门提起一章来说。授权服务器会在其中存储令牌，然后资源服务器可以在其中访问和验证令牌。这种方法也称为黑板模式。</li>
<li>最后第三个选项是使用<strong>加密签名</strong>。<strong>授权服务器在颁发令牌时会对其进行签名，资源服务器则要验证签</strong>名。这里是我们通常使用的<strong>JWT</strong>的地方。这个也会专门提一章后面讲。</li>
</ul>
<h3 id="实现资源服务器-1"><a href="#实现资源服务器-1" class="headerlink" title="实现资源服务器"></a>实现资源服务器</h3><p>首先要实现我们的第一个资源服务器应用程序，这是OAuth2拼图的最后一块。</p>
<p>使用可以颁发令牌的授权服务器的原因是为了允许客户端访问用户的资源。资源服务器将管理和保护用户的资源。由于这个原因，我们需要知道如何实现资源服务器。</p>
 <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/03/13/spring-security-guide2/1695614704085.png" class="">
<p>当资源服务器需要验证令牌时，它会直接调用授权服务器。<strong>如果授权服务器确认它颁发了该令牌，则资源服务器认为该令牌有效</strong>。</p>
<p>要实现资源服务器，需要在和之前搭建授权服务器的同一个父项目下创建一个新项目spring_security_resource_server并添加依赖项，完整pom文件如下，关于mysql,redis,fastjson等后面会用到，大家可以提前加上。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring_security_oauth2_demo<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring_security_resource_server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.56<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-oauth2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-oauth2-resource-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--redis--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>资源服务器的目的是管理和保护用户的资源。因此为了证明它是如何工作的，这里需要一个我们希望访问的资源。我们写一个控制器类代表我们需要保护的资源：<br><strong>TestController.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.mbw.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.Authentication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.context.SecurityContextHolder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PathVariable;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/test&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestController</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line"></span><br><span class="line">	<span class="meta">@GetMapping(&quot;/xiao&quot;)</span></span><br><span class="line">	<span class="keyword">public</span> String <span class="title function_">xiao</span><span class="params">()</span>&#123;</span><br><span class="line">   </span><br><span class="line">     <span class="keyword">return</span> <span class="string">&quot;纳西妲我抽爆！&quot;</span>;&#125;</span><br><span class="line">	<span class="meta">@GetMapping(&quot;/giao&quot;)</span></span><br><span class="line">	<span class="keyword">public</span> String <span class="title function_">giao</span><span class="params">()</span>&#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		<span class="type">Authentication</span> <span class="variable">authentication</span> <span class="operator">=</span> SecurityContextHolder.getContext().getAuthentication();</span><br><span class="line">		<span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> authentication.getName();</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;giao,&quot;</span>+name;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="meta">@GetMapping(&quot;/a&quot;)</span></span><br><span class="line">	<span class="keyword">public</span> String <span class="title function_">getEndpointA</span><span class="params">()</span>&#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;a&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="meta">@GetMapping(&quot;/a/b&quot;)</span></span><br><span class="line">	<span class="keyword">public</span> String <span class="title function_">getEndpointAB</span><span class="params">()</span>&#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;ab&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@GetMapping(&quot;/product/&#123;code&#125;&quot;)</span></span><br><span class="line">	<span class="keyword">public</span> String <span class="title function_">productCode</span><span class="params">(<span class="meta">@PathVariable</span> String code)</span>&#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		<span class="keyword">return</span> code;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里还需要一个配置类，在这个类中将使用@EnableResourceServer注解来允许Spring Boot为应用程序配置成为资源服务器所需的内容。而你也可以通过扩展ResourceServerConfigurerAdapter去重写资源服务器相关组件和方法，代码如下：<br><strong>ResourceServerConfig.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.mbw.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.config.annotation.web.configuration.EnableResourceServer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.config.annotation.web.configuration.ResourceServerConfigurerAdapter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableResourceServer</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ResourceServerConfig</span> <span class="keyword">extends</span> <span class="title class_">ResourceServerConfigurerAdapter</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		http</span><br><span class="line">				.csrf().disable()</span><br><span class="line">				.exceptionHandling()</span><br><span class="line">				.authenticationEntryPoint((request, response, authException) -&gt; response.sendError(HttpServletResponse.SC_UNAUTHORIZED))</span><br><span class="line">				.and()</span><br><span class="line">				.authorizeRequests()</span><br><span class="line">				.antMatchers(<span class="string">&quot;/test/**&quot;</span>).authenticated()</span><br><span class="line">				.and()</span><br><span class="line">				.httpBasic();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面的代码如果大家对spring Security熟悉的小伙伴应该很快能反应过来，几乎一模一样，其中&#x2F;test&#x2F;**就是我们刚才写的Controller的所有端点。</p>
<p>那么我们现在就有了一个资源服务器。但是，如果不能访问端点，它就没有任何用处，就像目前这个示例一样，因为还没有配置资源服务器检查令牌的任何方式。我们知道，对资源的请求也需要提供有效的访问令牌。但即使它提供了有效的访问令牌，请求仍然不能工作，这里的资源服务器还无法验证这些是否是有效的令牌，也无法验证授权服务器确实颁发了它们。这是因为还没有实现资源服务器验证访问令牌所需的任何选项，接下来我们将讨论这些方式。</p>
<h3 id="远程检查令牌"><a href="#远程检查令牌" class="headerlink" title="远程检查令牌"></a>远程检查令牌</h3><p>本节将通过允许资源服务器直接调用授权服务器来实现令牌验证。此方法是使用有效访问令牌启用对资源服务器的访问的最简单实现，如果系统中的令牌是简单形式（例如，在Spring Security的授权服务器的默认实现中使用的简单UUID），则可以选择此方法。这种验证令牌的机制很简单：</p>
<p><strong>1、</strong> 授权服务器暴露一个端点对于有效的令牌，它会返回先前向其颁发该令牌的用户所被授予的权限此处把这个端点称为check_token端点；<br><strong>2、</strong> 资源服务器为每个请求调用check_token端点这样，它就会验证从客户端接收的令牌，并获得授予客户端的权限；</p>
 <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/03/13/spring-security-guide2/1695614704718.png" class="">
<p>这种方法的优点是简单。可以将其应用于任何类型的令牌实现。这种方法的缺点是，对于资源服务器上具有新的未知令牌的每个请求，资源服务器将调用授权服务器来验证该令牌。这些调用会<strong>给授权服务器带来不必要的负荷</strong>。此外，请记住：网络并不是100%可靠的。每次在架构中设计新的远程调用时，都需要记住这一点。如<strong>果由于网络不稳定导致调用失败，则可能还需要应用一些替代解决方案</strong>。并且如果<strong>重启资源服务器，就算之前产生了令牌并且还没过期，资源服务器也验证不了这个令牌</strong>。因为这个令牌已经失效了，所以也就有了后面将令牌持久化的方案。</p>
<p>那么接下来讨论如何实现。此处的预期是：如果&#x2F;hello端点提供了授权服务器颁发的访问令牌，则允许客户端访问该端点。</p>
<p>默认情况下，授<strong>权服务器会实现端点&#x2F;oauth&#x2F;check_token，资源服务器可以使用该端点验证令牌。但是，目前授权服务器将隐式拒绝对该端点的所有请求</strong>。在使用&#x2F;oauth&#x2F;check_token端点之前，需要确保资源服务器可以调用它。</p>
<p>为了允许经过身份验证的请求调用&#x2F;oauth&#x2F;check_token端点，<strong>需要重写授权服务器的AuthServerConfig类中的configure(AuthorizationServerSecurityConfigurer c)方法</strong>。<strong>重写configure()方法就可以设置允许调用&#x2F;oauth&#x2F;check_token端点的条件</strong>。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.mbw.security.service.ClientDetailsServiceImpl;</span><br><span class="line"><span class="keyword">import</span> com.mbw.security.service.UserDetailsServiceImpl;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.authentication.AuthenticationManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.config.annotation.configurers.ClientDetailsServiceConfigurer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.config.annotation.web.configuration.AuthorizationServerConfigurerAdapter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.config.annotation.web.configuration.EnableAuthorizationServer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.config.annotation.web.configurers.AuthorizationServerEndpointsConfigurer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.config.annotation.web.configurers.AuthorizationServerSecurityConfigurer;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableAuthorizationServer</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AuthServerConfig</span> <span class="keyword">extends</span> <span class="title class_">AuthorizationServerConfigurerAdapter</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> AuthenticationManager authenticationManager;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> ClientDetailsServiceImpl clientDetailsServiceImpl;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> UserDetailsServiceImpl userDetailsServiceImpl;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthorizationServerEndpointsConfigurer endpoints)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		endpoints.authenticationManager(authenticationManager)</span><br><span class="line">		.userDetailsService(userDetailsServiceImpl)</span><br><span class="line">				.tokenStore(jsonRedisTokenStore);</span><br><span class="line">		<span class="type">DefaultTokenServices</span> <span class="variable">tokenService</span> <span class="operator">=</span> getTokenStore(endpoints);</span><br><span class="line">		endpoints.tokenServices(tokenService);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(ClientDetailsServiceConfigurer clients)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		clients.withClientDetails(clientDetailsServiceImpl);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 解决访问/oauth/check_token 403的问题</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthorizationServerSecurityConfigurer security)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		<span class="comment">// 允许表单认证</span></span><br><span class="line">		security</span><br><span class="line">				.tokenKeyAccess(<span class="string">&quot;permitAll()&quot;</span>)</span><br><span class="line">				.checkTokenAccess(<span class="string">&quot;permitAll()&quot;</span>)  <span class="comment">//指定可以调用check_token端点的条件</span></span><br><span class="line">				.allowFormAuthenticationForClients();</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>你也可以使用isAuthenticated(),只是我这儿用permitAll在没有身份验证的情况下也可以访问</strong>，便于我测试，<strong>但是不建议像我这样做让端点不受保护，在真实场景下，最好对这个端点使用身份验证</strong>。</p>
<p>除了使这个端点可访问之外，如果还决定只允许经过身份验证的访问，<strong>就需要为资源服务器本身注册一个客户端。对于授权服务器而言，资源服务器也是客户端，并且也需要它自己的凭据</strong>。需要像添加到其他客户端那样添加它，<strong>对于资源服务器，则不需要任何授权类型或作用域，只需要资源服务器用于调用check_token端点的一组凭据即可</strong>。</p>
<p>所以我修改了下上次注册客户端的接口，让他们也可以<strong>自行输入clientId和clientSecret</strong>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> OAuth2Client <span class="title function_">createOAuth2Client</span><span class="params">(OAuth2Client oAuth2Client)</span>&#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		<span class="type">String</span> <span class="variable">clientId</span> <span class="operator">=</span> oAuth2Client.getClientId();</span><br><span class="line">		<span class="keyword">if</span>(CharSequenceUtil.isBlank(clientId))&#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">			clientId = getClientIdUnique(oAuth2Client);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="type">String</span> <span class="variable">clientSecret</span> <span class="operator">=</span> oAuth2Client.getClientSecret();</span><br><span class="line">		<span class="keyword">if</span>(CharSequenceUtil.isBlank(clientSecret)) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">			clientSecret = RandomUtil.randomString(<span class="number">16</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="type">String</span> <span class="variable">clientSecretEncoded</span> <span class="operator">=</span> passwordEncoder.encode(clientSecret);</span><br><span class="line">		oAuth2Client.setClientId(clientId);</span><br><span class="line">		oAuth2Client.setClientSecret(clientSecretEncoded);</span><br><span class="line">		oAuth2ClientMapper.insert(oAuth2Client);</span><br><span class="line">		oAuth2Client.setClientSecret(clientSecret);</span><br><span class="line">		<span class="keyword">return</span> oAuth2Client;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>然后到postman调用注册客户端的接口，cleintId就取名为resourceServer,clientSecret就为resourceServerSecret</p>
 <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/03/13/spring-security-guide2/1695614705748.png" class="">
<p>并且入库，且对clientecret加密。</p>
<p>现在启动授权服务器并获得一个令牌，就想之前授权服务器那样，直接通过postman调用，随便你使用某一种方式都行，这里我为了方便就选择密码授权模式</p>
 <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/03/13/spring-security-guide2/1695614706308.png" class="">
<p>接下来要调用check_token端点查找前面的代码片段中所获得的访问令牌的详细信息。这一调用是这样的：</p>
 <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/03/13/spring-security-guide2/1695614706886.png" class="">
<p>观察从check_token端点返回的响应。其中包含关于访问令牌所需的所有详细信息：</p>
<ul>
<li><strong>该令牌是否仍然有效并且何时过期</strong></li>
<li><strong>该令牌是为哪个用户颁发的</strong></li>
<li><strong>表示权利的权限</strong></li>
<li><strong>该令牌是为哪个客户颁发的</strong></li>
</ul>
<p>现在，如果使用postman调用端点，则资源服务器应该能够用它验证令牌了。<strong>还需要配置授权服务器的端点和资源服务器用于访问端点的凭据</strong>。可以在application.yaml文件中完成所有这些配置。以下就是配置文件的代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">server:</span><br><span class="line">  port: <span class="number">9091</span></span><br><span class="line">security:</span><br><span class="line">  oauth2:</span><br><span class="line">    resource:</span><br><span class="line">      token-info-uri: http:<span class="comment">//localhost:9090/oauth/check_token</span></span><br><span class="line">    client:</span><br><span class="line">      client-id: resourceServer</span><br><span class="line">      client-secret: resourceServerSecret</span><br></pre></td></tr></table></figure>

<p>ps:<strong>在对&#x2F;oauth&#x2F;check_token（令牌自省）端点使用身份验证时，资源服务器将充当授权服务器的客户端。由于这个原因，它就需要注册一些凭据，在调用自省端点时，它将是&#x3D;使用这些凭据利用HTTP Basic身份验证进行身份验证</strong>。</p>
<p>现在可以通过调用&#x2F;hello端点运行该应用程序和测试整个设置。需要在请求的Authorization头信息中设置访问令牌，<strong>并且需要在其值前面加上带有单次bearer的前缀。对于这个单词来说，其大小写是不区分的。这就意味着也可以写作“bearer”或者“BEARER”</strong>。</p>
 <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/03/13/spring-security-guide2/1695614707425.png" class="">
<p>如果在没有令牌或使用错误令牌的情况下调用了端点，<strong>那么其结果将是HTTP响应上出现401 Unauthorized状态</strong>。例如我现在不传Authorization这个请求头，下面的代码片段给出了该响应：</p>
 <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/03/13/spring-security-guide2/1695614708085.png" class="">
<p>又或者我传了一个错误的令牌：</p>
 <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/03/13/spring-security-guide2/1695614708643.png" class="">





<h3 id="实现黑板模式"><a href="#实现黑板模式" class="headerlink" title="实现黑板模式"></a>实现黑板模式</h3><p>我们将继续之前的项目基础上进行修改。首先解释一下黑板模式的架构：当授权服务器颁发令牌时，它也会将令牌存储在与资源服务器共享的数据库中</p>
 <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/03/13/spring-security-guide2/1695614709317.png" class="">
<p>它还意味着资源服务器在需要验证令牌时将访问该数据库.</p>
 <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/03/13/spring-security-guide2/1695614709937.png" class="">
<p>如上图，资源服务器在共享数据库中搜索令牌。如果令牌存在，则资源服务器将在数据库中找到与它相关的详细信息，包括用户名及其权限。有了这些详细信息，资源服务器就可以对请求进行授权。</p>
<p>在授权服务器和资源服务器上，<strong>代表在Spring Security中管理令牌的对象的契约是TokenStore</strong>。对于授权服务器，可以把它想象成在<strong>我们以前使用SecurityContext的身份验证架构中的位置</strong>，身份验证完成后，<strong>授权服务器会使用TokenStore生成一个令牌</strong></p>
 <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/03/13/spring-security-guide2/1695614710531.png" class="">
<p><strong>对于资源服务器。身份验证过滤器要使用TokenStore验证令牌并查找稍后用于授权的用户详细信息</strong>。然后<strong>资源服务器会将用户的详细信息存储在安全上下文中</strong>。</p>
 <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/03/13/spring-security-guide2/1695614711096.png" class="">

<p>ps：授权服务器和资源服务器实现了两种不同的职责,<strong>但这些职责不一定必须由两个独立的应用程序执行。不过在大多数真实的实现中，我们都会在不同的应用程序中开发它们，但是，也可以选择在同一个应用程序实现这两者。在这种情况下，就不需要建立任何调用或使用一个共享数据库</strong>。但是，如果在同一个应用程序中实现这两种职责，<strong>授权服务器和资源服务器就都可以访问相同的bean.因此，它们可以使用相同的令牌存储，而不需要进行网络调用或访问数据库</strong>。请大家记住这句结论，这个我们后面搭建redisTokenStore会用到这个结论。</p>
<p>SpringSecurity为TokenStore接口提供了各种实现,在大多数情况下，我们都不需要编写自己的实现。例如，对于前面的所有授权服务器实现，我们都没有指定TokenStore实现。<strong>SpringSecurity提供了一个InMemoryTokenStore类型的默认令牌存储。可以想见，在所有这些情况下，令牌都会存储在应用程序的内存中。它们没有被持久化！如果重启授权服务器，那么启动前颁发的令牌将不再生效</strong>。</p>
<p>为了使用黑板模式实现令牌管理，Spring Security提供了<strong>JdbcTokenStore</strong>实现。顾名思义，<strong>这个令牌存储直接通过JDBC与数据库一起工作。它的工作原理类似于之前讨论的JdbcUserDetailsManager</strong>,但与用户管理不同的是，JdbcTokenStore管理的是令牌。</p>
<p>ps:我们只是在这一章中选择了JdbcTokenStore实现黑板模式，<strong>但是也可以选择使用TokenStore持久化令牌，甚至你可以自己重写你自己的tokenStore以达到你的理想的持久化的方式</strong>，例如下一章会说到的重写一个TokenStore以达到redis存储令牌，并且将相关数据放进本地缓存caffeine.那么本章我们还是以JdbcTokenStore为例子进行讲解。</p>
<p>JdbcTokenStore期望数据库中有两个表。<strong>它会使用一个表存储访问令牌（该表的名称默认规定为oauth_access_token）和一个表存储刷新令牌（该表的名称默认规定为oauth_refresh_token）。用于存储令牌的表将同时持久化刷新令牌</strong>。</p>
<p>ps:注意如果我们不对JdbcTokenStore进行重写的话，表名和表的结构都是默认规定好的，不去重写是不能任意去更改表名表的结构等。</p>
<p>如下图，JdbcTokenStore默认已经封装了很多的SQL语句，这也证明你不能在不重写JdbcTokenStore的情况下去更改表的结构。</p>
 <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/03/13/spring-security-guide2/1695614711576.png" class="">
<p>但是，如果你想使用其他表或者其他列甚至是属性结构，SpringSecurity也允许你去自定义JdbcTokenStore,当然你必须重写它用来检索或存储令牌的所有相关SQL。那这里我们就不对JdbcTokenStore进行重写，采取默认结构去进行讲解：<br>同样的，既然和sql挂钩，我们就得从表结构开始说起，以下两张表结构已经固定好了。大家直接copy就行：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">DROP TABLE IF EXISTS oauth_access_token;</span><br><span class="line">CREATE TABLE <span class="title function_">oauth_access_token</span>  <span class="params">(</span></span><br><span class="line"><span class="params">  token_id varchar(<span class="number">256</span>)</span> CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL COMMENT <span class="string">&#x27;MD5加密的access_token的值&#x27;</span>,</span><br><span class="line">  token blob NULL COMMENT <span class="string">&#x27;OAuth2AccessToken.java对象序列化后的二进制数据&#x27;</span>,</span><br><span class="line">  authentication_id <span class="title function_">varchar</span><span class="params">(<span class="number">256</span>)</span> CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL COMMENT <span class="string">&#x27;MD5加密过的username,client_id,scope&#x27;</span>,</span><br><span class="line">  user_name <span class="title function_">varchar</span><span class="params">(<span class="number">256</span>)</span> CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL COMMENT <span class="string">&#x27;登录的用户名&#x27;</span>,</span><br><span class="line">  client_id <span class="title function_">varchar</span><span class="params">(<span class="number">256</span>)</span> CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL COMMENT <span class="string">&#x27;客户端ID&#x27;</span>,</span><br><span class="line">  authentication blob NULL COMMENT <span class="string">&#x27;OAuth2Authentication.java对象序列化后的二进制数据&#x27;</span>,</span><br><span class="line">  refresh_token <span class="title function_">varchar</span><span class="params">(<span class="number">256</span>)</span> CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL COMMENT <span class="string">&#x27;MD5加密后的refresh_token的值&#x27;</span>,</span><br><span class="line">  PRIMARY <span class="title function_">KEY</span> <span class="params">(authentication_id)</span> USING BTREE</span><br><span class="line">) ENGINE = InnoDB <span class="type">CHARACTER</span> <span class="variable">SET</span> <span class="operator">=</span> <span class="type">utf8</span> <span class="variable">COLLATE</span> <span class="operator">=</span> <span class="type">utf8_general_ci</span> <span class="variable">COMMENT</span> <span class="operator">=</span> <span class="string">&#x27;访问令牌&#x27;</span> ROW_FORMAT = Dynamic;</span><br><span class="line">DROP TABLE IF EXISTS oauth_refresh_token;</span><br><span class="line">CREATE TABLE <span class="title function_">oauth_refresh_token</span>  <span class="params">(</span></span><br><span class="line"><span class="params">  token_id varchar(<span class="number">256</span>)</span> CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL COMMENT <span class="string">&#x27;MD5加密过的refresh_token的值&#x27;</span>,</span><br><span class="line">  token blob NULL COMMENT <span class="string">&#x27;OAuth2RefreshToken.java对象序列化后的二进制数据&#x27;</span>,</span><br><span class="line">  authentication blob NULL COMMENT <span class="string">&#x27;OAuth2Authentication.java对象序列化后的二进制数据&#x27;</span></span><br><span class="line">) ENGINE = InnoDB <span class="type">CHARACTER</span> <span class="variable">SET</span> <span class="operator">=</span> <span class="type">utf8</span> <span class="variable">COLLATE</span> <span class="operator">=</span> <span class="type">utf8_general_ci</span> <span class="variable">COMMENT</span> <span class="operator">=</span> <span class="string">&#x27;更新令牌&#x27;</span> ROW_FORMAT = Dynamic;</span><br></pre></td></tr></table></figure>

<p>然后授权服务器和资源服务器均加入Mybatis和mysq-javal相关依赖：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.baomidou&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;mybatis-plus-boot-starter&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;mysql&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<p>在application.yaml文件中，需要添加数据源的定义。以下代码片段提供了该定义：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  datasource:</span><br><span class="line">    driver-class-name: com.mysql.jdbc.Driver</span><br><span class="line">    username: root</span><br><span class="line">    password: <span class="number">123456</span></span><br><span class="line">    url: jdbc:mysql:<span class="comment">//127.0.0.1:3306/spring_security?useUnicode=true&amp;characterEncoding=UTF-8&amp;useSSL=false&amp;allowPublicKeyRetrieval=true&amp;serverTimezone=Asia/Shanghai&amp;nullCatalogMeansCurrent=true</span></span><br><span class="line">    initialization-mode: always</span><br><span class="line">mybatis-plus:</span><br><span class="line">  mapper-locations: classpath:/mapper<span class="comment">/**/*.xml,classpath:/META-INF/modeler-mybatis-mappings/*.xml</span></span><br><span class="line"><span class="comment">  typeAliasesPackage: com.mbw.pojo</span></span><br><span class="line"><span class="comment">  global-config:</span></span><br><span class="line"><span class="comment">    banner: false</span></span><br><span class="line"><span class="comment">  configuration:</span></span><br><span class="line"><span class="comment">    map-underscore-to-camel-case: false</span></span><br><span class="line"><span class="comment">    cache-enabled: false</span></span><br><span class="line"><span class="comment">    call-setters-on-nulls: true</span></span><br><span class="line"><span class="comment">    jdbc-type-for-null: &#x27;null&#x27;</span></span><br><span class="line"><span class="comment">    log-impl: org.apache.ibatis.logging.stdout.StdOutImpl</span></span><br></pre></td></tr></table></figure>

<p>接下来我们需要在之前配置的授权服务器配置类AuthServerConfig中注入数据源，然后定义和配置令牌存储。下面代码显示了这一更改：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.mbw.security.service.ClientDetailsServiceImpl;</span><br><span class="line"><span class="keyword">import</span> com.mbw.security.service.UserDetailsServiceImpl;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.authentication.AuthenticationManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.config.annotation.configurers.ClientDetailsServiceConfigurer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.config.annotation.web.configuration.AuthorizationServerConfigurerAdapter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.config.annotation.web.configuration.EnableAuthorizationServer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.config.annotation.web.configurers.AuthorizationServerEndpointsConfigurer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.config.annotation.web.configurers.AuthorizationServerSecurityConfigurer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.token.TokenStore;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.token.store.JdbcTokenStore;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.sql.DataSource;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableAuthorizationServer</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AuthServerConfig</span> <span class="keyword">extends</span> <span class="title class_">AuthorizationServerConfigurerAdapter</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> AuthenticationManager authenticationManager;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> ClientDetailsServiceImpl clientDetailsServiceImpl;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> UserDetailsServiceImpl userDetailsServiceImpl;</span><br><span class="line">	<span class="comment">//注入application.yaml文件中的数据源</span></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> DataSource dataSource;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthorizationServerEndpointsConfigurer endpoints)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		endpoints.authenticationManager(authenticationManager)</span><br><span class="line">		.userDetailsService(userDetailsServiceImpl)</span><br><span class="line">				.tokenStore(tokenStore());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(ClientDetailsServiceConfigurer clients)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		clients.withClientDetails(clientDetailsServiceImpl);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 解决访问/oauth/check_token 403的问题</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> security</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthorizationServerSecurityConfigurer security)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		<span class="comment">// 允许表单认证</span></span><br><span class="line">		security</span><br><span class="line">				.tokenKeyAccess(<span class="string">&quot;permitAll()&quot;</span>)</span><br><span class="line">				.checkTokenAccess(<span class="string">&quot;permitAll()&quot;</span>)</span><br><span class="line">				.allowFormAuthenticationForClients();</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="keyword">public</span> TokenStore <span class="title function_">tokenStore</span><span class="params">()</span>&#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">JdbcTokenStore</span>(dataSource);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>并且我们可以对token本身做相关的设置，例如设置accessToken和refreshToken的有效时间，这里SpringSecurity给我们提供了TokenService类，我们可以通过配置它来对token的一些属性作设置，这里我们也在授权服务器配置类配置即可，完整的AuthServerConfig类如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.mbw.security.service.ClientDetailsServiceImpl;</span><br><span class="line"><span class="keyword">import</span> com.mbw.security.service.UserDetailsServiceImpl;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.authentication.AuthenticationManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.config.annotation.configurers.ClientDetailsServiceConfigurer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.config.annotation.web.configuration.AuthorizationServerConfigurerAdapter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.config.annotation.web.configuration.EnableAuthorizationServer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.config.annotation.web.configurers.AuthorizationServerEndpointsConfigurer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.config.annotation.web.configurers.AuthorizationServerSecurityConfigurer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.token.DefaultTokenServices;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.token.TokenStore;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.token.store.JdbcTokenStore;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.sql.DataSource;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableAuthorizationServer</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AuthServerConfig</span> <span class="keyword">extends</span> <span class="title class_">AuthorizationServerConfigurerAdapter</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> AuthenticationManager authenticationManager;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> ClientDetailsServiceImpl clientDetailsServiceImpl;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> UserDetailsServiceImpl userDetailsServiceImpl;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> JsonRedisTokenStore jsonRedisTokenStore;</span><br><span class="line">	<span class="comment">//注入application.yaml文件中的数据源</span></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> DataSource dataSource;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthorizationServerEndpointsConfigurer endpoints)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		endpoints.authenticationManager(authenticationManager)</span><br><span class="line">		.userDetailsService(userDetailsServiceImpl)</span><br><span class="line">				.tokenStore(tokenStore());</span><br><span class="line">		<span class="type">DefaultTokenServices</span> <span class="variable">tokenService</span> <span class="operator">=</span> getTokenStore(endpoints);</span><br><span class="line">		endpoints.tokenServices(tokenService);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//配置TokenService参数</span></span><br><span class="line">	<span class="keyword">private</span> DefaultTokenServices <span class="title function_">getTokenStore</span><span class="params">(AuthorizationServerEndpointsConfigurer endpoints)</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		<span class="type">DefaultTokenServices</span> <span class="variable">tokenService</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultTokenServices</span>();</span><br><span class="line">		tokenService.setTokenStore(endpoints.getTokenStore());</span><br><span class="line">		tokenService.setSupportRefreshToken(<span class="literal">true</span>);</span><br><span class="line">		tokenService.setClientDetailsService(endpoints.getClientDetailsService());</span><br><span class="line">		tokenService.setTokenEnhancer(endpoints.getTokenEnhancer());</span><br><span class="line">		<span class="comment">//token有效期 1小时</span></span><br><span class="line">		tokenService.setAccessTokenValiditySeconds(<span class="number">3600</span>);</span><br><span class="line">		<span class="comment">//token刷新有效期 15天</span></span><br><span class="line">		tokenService.setRefreshTokenValiditySeconds(<span class="number">3600</span> * <span class="number">12</span> * <span class="number">15</span>);</span><br><span class="line">		tokenService.setReuseRefreshToken(<span class="literal">false</span>);</span><br><span class="line">		<span class="keyword">return</span> tokenService;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(ClientDetailsServiceConfigurer clients)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		clients.withClientDetails(clientDetailsServiceImpl);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 解决访问/oauth/check_token 403的问题</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> security</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthorizationServerSecurityConfigurer security)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		<span class="comment">// 允许表单认证</span></span><br><span class="line">		security</span><br><span class="line">				.tokenKeyAccess(<span class="string">&quot;permitAll()&quot;</span>)</span><br><span class="line">				.checkTokenAccess(<span class="string">&quot;permitAll()&quot;</span>)</span><br><span class="line">				.allowFormAuthenticationForClients();</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="keyword">public</span> TokenStore <span class="title function_">tokenStore</span><span class="params">()</span>&#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">JdbcTokenStore</span>(dataSource);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>现在可以启动授权服务器并颁发令牌，这个和前面章节获取令牌是一样的，我们仍然可以采取password授权类型颁发令牌：</p>
 <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/03/13/spring-security-guide2/1695614712431.png" class="">
<p>响应中返回的访问令牌也可以在oauth_access_token表中作为其记录而找到。由于数据库会持久化令牌，因此及时授权服务器关闭或者重新启动后，资源服务器也可以验证已颁发且未过期的令牌。</p>
 <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/03/13/spring-security-guide2/1695614712985.png" class="">
<p>因为配置了刷新令牌授权类型，所以会接收到一个刷新令牌。出于这个原因，还可以在oauth_refresh_token表中找到刷新令牌的记录。</p>
 <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/03/13/spring-security-guide2/1695614713371.png" class="">
<p>且我们还可以通过该refreshToken重新获取一个新的token和refreshToken:</p>
 <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/03/13/spring-security-guide2/1695614713966.png" class="">
<p>现在是配置资源服务器的时候，以便它也可以使用相同的数据库。所以我们也需要<strong>在之前的资源服务器上加入和授权服务器同样的数据源相关依赖和配置</strong>，这里我就不作代码演示了，直接copy授权服务器直接写的配置和依赖即可。</p>
<p>然后来到资源服务器的配置类中，需要注入数据源并配置JdbcTokenStore:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableResourceServer</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ResourceServerConfig</span> <span class="keyword">extends</span> <span class="title class_">ResourceServerConfigurerAdapter</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> DataSource dataSource;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(ResourceServerSecurityConfigurer resources)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		resources.tokenStore(tokenStore());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="keyword">public</span> TokenStore <span class="title function_">tokenStore</span><span class="params">()</span>&#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">JdbcTokenStore</span>(dataSource);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>现在可以启动资源服务器，并使用之前颁发的访问令牌访问&#x2F;test&#x2F;yidou测试端点。</p>
 <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/03/13/spring-security-guide2/1695614714487.png" class="">
<p>这样，我们就实现了黑板模式，用于资源服务器和授权服务器之间的通信。其中使用了一个名为JdbcTokenStore的TokenStore实现。现在可以将令牌持久化到数据库中了，并且可以避免在资源服务器和授权服务器之间使用直接调用来验证令牌。<strong>但是让授权服务器和资源服务器都依赖于同一个数据库是一个缺点。在大量请求的情况下，共享数据库可能成为一个瓶颈，并影响系统性能。那么就有了可以让redis存储令牌让响应速度快一点，但是这种方案治标不治本，那么有其他实现选项吗？答案是肯定的：在JWT中使用签名令牌</strong>，这个我们后面会讲到。</p>
<p>最后的最后，让大家思考一点，在对资源服务器去作相关配置的时候，我说了为了让资源服务器和授权服务器使用相同的tokenStore(共享数据库)，所以需要在资源服务器配置和授权服务器同样的tokenStore,这样的做法真的好吗，真的合适吗？说的绝一点，有时候我们需要对TokenStore重写，其中关于用户详细信息的内容涉及到UserDetails，那在授权服务器这个项目重写配置后，你总不能把同样的UserDetails类又放到资源服务器项目上去，然后再重写一个相同的TokenStore,代码太耦合了，这样的做法肯定是不合适的。</p>
<p>再结合一下如果授权服务器和资源服务器如果在同一个项目可以访问相同的bean，而不需要在资源服务器额外配置tokenStore，只需要在授权服务器配置这个点，大家可以去思考下有没有更好地解决方式呢？这个我将在下一章通过redis重写TokenStore中提一提我的解决方案也是我在看了一些oauth项目解决方案初步总结出的。</p>
<h3 id="自定义的tokenStore"><a href="#自定义的tokenStore" class="headerlink" title="自定义的tokenStore"></a>自定义的tokenStore</h3><p>本章将在前面几章基础上进行讲解，所以大家最好尽量先去看一下前几章的内容再来跟进会好很多。那么本章我们将通过redis和本地缓存Caffeine对JdbcTokenStore进行重写，并且讲解资源服务器配置的新方案，使得我们可以不用在资源服务器又配置一个和授权服务器一样的tokenStore.<br>我们上一章实现了JdbcTokenStore,那么大家都知道，redis的速度是肯定的比普通的数据库是要快的，且JdbcTokenStore实在是有点难拓展，尤其涉及到表结构的更改，所以选择使用Redis对TokenStore进行重写。但是大量的请求，且token基本都是长信息，肯定也是会对Redis造成不小的压力，所以这里使用了本地缓存Caffeine。那么这里的写法我是照着下面这篇博客写的，我看了很多重写的方法，基本只有这篇我仿写后能够正常运行。再次也对这篇博客作者表示感谢，真的强！</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/chongsha/p/14558011.html">https://www.cnblogs.com/chongsha/p/14558011.html</a></p>
</blockquote>
<p>后面有时间和能力后我会阅读OAuth2源码结合之前写的代码做几期分享</p>
<h3 id="实现JsonRedisTokenStore"><a href="#实现JsonRedisTokenStore" class="headerlink" title="实现JsonRedisTokenStore"></a>实现JsonRedisTokenStore</h3><p>在说实现之前，先来说一下为什么要重写这个类，其实懂一点的开发同仁会说，欸，OAuth2不是提供了RedisTokenStore类吗，为啥还要重写？<br>确实，OAuth2给我们提供了RedisTokenStore类，并且使用上比JdbcTokenStore还简单，我们只需要配置好redis以及在授权服务器类注入RedisConnectFactory就可以直接配置RedisTokenStore。</p>
 <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/03/13/spring-security-guide2/1695614715058.png" class="">
<p>但是你或许也看到了，默认的RedisTokenStore采用的默认序列化方式是JDK序列化。</p>
 <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/03/13/spring-security-guide2/1695614715713.png" class="">
<p>学过Redis的应该了解了，<strong>这会引起存储的对象产生乱码问题</strong>，所以我们需要使用json对Authentication和token进行序列化，这就是我们重写的原因，且我们可以在其基础上加入本地缓存减小Redis的压力。</p>
<p>首先在授权服务器项目上我们需要redis和Caffeine,fastJson的依赖，大家如果有自己想用的本地缓存也可以直接换，例如仍然使用Redis实现本地缓存也是Ok的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--redis--&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-starter-data-redis&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.github.ben-manes.caffeine&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;caffeine&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<p>然后在yaml文件需要对redis做相关配置：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  redis配置</span><br><span class="line">  redis:</span><br><span class="line">    host: <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">    password: <span class="number">123456</span></span><br><span class="line">    port: <span class="number">6379</span></span><br></pre></td></tr></table></figure>

<p>然后就可以重写了，关于方法的大致解释我已经做了相关注释，大家直接看着一块儿块儿自己写就好,我们这儿<br><strong>JsonRedisTokenStore.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.mbw.security.token;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.date.DateUnit;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.date.DateUtil;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.util.StrUtil;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSONObject;</span><br><span class="line"><span class="keyword">import</span> com.github.benmanes.caffeine.cache.Cache;</span><br><span class="line"><span class="keyword">import</span> com.github.benmanes.caffeine.cache.Caffeine;</span><br><span class="line"><span class="keyword">import</span> com.mbw.pojo.Role;</span><br><span class="line"><span class="keyword">import</span> com.mbw.pojo.User;</span><br><span class="line"><span class="keyword">import</span> com.mbw.security.dto.JwtUserDto;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.StringRedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.authentication.UsernamePasswordAuthenticationToken;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.common.DefaultOAuth2AccessToken;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.common.ExpiringOAuth2RefreshToken;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.common.OAuth2AccessToken;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.common.OAuth2RefreshToken;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.OAuth2Authentication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.OAuth2Request;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.token.AuthenticationKeyGenerator;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.token.TokenStore;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.Collection;</span><br><span class="line"><span class="keyword">import</span> java.util.Collections;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.HashSet;</span><br><span class="line"><span class="keyword">import</span> java.util.LinkedHashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"><span class="keyword">import</span> java.util.function.Function;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JsonRedisTokenStore</span> <span class="keyword">implements</span> <span class="title class_">TokenStore</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ACCESS</span> <span class="operator">=</span> <span class="string">&quot;access:&quot;</span>;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">AUTH_TO_ACCESS</span> <span class="operator">=</span> <span class="string">&quot;auth_to_access:&quot;</span>;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">AUTH</span> <span class="operator">=</span> <span class="string">&quot;auth:&quot;</span>;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">REFRESH_AUTH</span> <span class="operator">=</span> <span class="string">&quot;refresh_auth:&quot;</span>;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ACCESS_TO_REFRESH</span> <span class="operator">=</span> <span class="string">&quot;access_to_refresh:&quot;</span>;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">REFRESH</span> <span class="operator">=</span> <span class="string">&quot;refresh:&quot;</span>;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">REFRESH_TO_ACCESS</span> <span class="operator">=</span> <span class="string">&quot;refresh_to_access:&quot;</span>;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">CLIENT_ID_TO_ACCESS</span> <span class="operator">=</span> <span class="string">&quot;client_id_to_access:&quot;</span>;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">UNAME_TO_ACCESS</span> <span class="operator">=</span> <span class="string">&quot;uname_to_access:&quot;</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> Cache&lt;Object, Object&gt; CACHE;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">static</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		CACHE = Caffeine.newBuilder()</span><br><span class="line">				.expireAfterWrite(<span class="number">60</span>, TimeUnit.SECONDS)</span><br><span class="line">				.maximumSize(<span class="number">1000</span>).build();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> <span class="type">AuthenticationKeyGenerator</span> <span class="variable">authenticationKeyGenerator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CustomAuthenticationKeyGenerator</span>();</span><br><span class="line">	<span class="keyword">public</span> <span class="title function_">JsonRedisTokenStore</span><span class="params">(StringRedisTemplate stringRedisTemplate)</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		<span class="built_in">this</span>.stringRedisTemplate = stringRedisTemplate;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> OAuth2Authentication <span class="title function_">readAuthentication</span><span class="params">(OAuth2AccessToken token)</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">this</span>.readAuthentication(token.getValue());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//根据AccessToken对象查询对应的OAuth2Authentication（认证的用户信息）</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> OAuth2Authentication <span class="title function_">readAuthentication</span><span class="params">(String token)</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		<span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> AUTH + token;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> (OAuth2Authentication) loadCache(key, (k) -&gt; &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">			<span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(key);</span><br><span class="line">			<span class="keyword">if</span> (StrUtil.isBlank(json)) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">				<span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span> fullParseJSON(json);</span><br><span class="line">		&#125;);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 完整的OAuth2Authentication 对象转换</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> json 完整OAuth2Authentication json字符串</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> OAuth2Authentication对象</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> OAuth2Authentication <span class="title function_">fullParseJSON</span><span class="params">(String json)</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		<span class="type">JSONObject</span> <span class="variable">jsonObject</span> <span class="operator">=</span> JSONObject.parseObject(json);</span><br><span class="line"></span><br><span class="line">		<span class="type">JSONObject</span> <span class="variable">userAuthenticationObject</span> <span class="operator">=</span> jsonObject.getJSONObject(<span class="string">&quot;userAuthentication&quot;</span>);</span><br><span class="line">		<span class="comment">/**</span></span><br><span class="line"><span class="comment">		 * 这里通过之前写的UserDetails的构造方法，我的UserDetails由三部分构造：User类，Set&lt;Role&gt;,List&lt;String&gt; authorityName</span></span><br><span class="line"><span class="comment">		 * 所以这里你可以直接按照你自己的userDetails来进行json解析</span></span><br><span class="line"><span class="comment">		 * 而UserDetails在这里就是Principal部分，所以json得先解析principal才能得到我需要的UserDetails组件</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		</span><br><span class="line">		<span class="type">User</span> <span class="variable">userInfo</span> <span class="operator">=</span> userAuthenticationObject.getJSONObject(<span class="string">&quot;principal&quot;</span>).getObject(<span class="string">&quot;user&quot;</span>,User.class);</span><br><span class="line">		Set&lt;Role&gt; roleInfo = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;(userAuthenticationObject.getJSONObject(<span class="string">&quot;principal&quot;</span>).getJSONArray(<span class="string">&quot;roleInfo&quot;</span>).toJavaList(Role.class));</span><br><span class="line">		List&lt;String&gt; authorityNames = userAuthenticationObject.getJSONObject(<span class="string">&quot;principal&quot;</span>).getJSONArray(<span class="string">&quot;authorityNames&quot;</span>).toJavaList(String.class);</span><br><span class="line">		<span class="type">JwtUserDto</span> <span class="variable">jwtUserDto</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JwtUserDto</span>(userInfo, roleInfo, authorityNames);</span><br><span class="line">		<span class="type">String</span> <span class="variable">credentials</span> <span class="operator">=</span> userAuthenticationObject.getString(<span class="string">&quot;credentials&quot;</span>);</span><br><span class="line">		<span class="type">JSONObject</span> <span class="variable">detailsJSONObject</span> <span class="operator">=</span> userAuthenticationObject.getJSONObject(<span class="string">&quot;details&quot;</span>);</span><br><span class="line">		LinkedHashMap&lt;String, Object&gt; details = <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>&lt;&gt;();</span><br><span class="line">		<span class="keyword">for</span> (String key : detailsJSONObject.keySet()) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">			details.put(key, detailsJSONObject.get(key));</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="type">UsernamePasswordAuthenticationToken</span> <span class="variable">userAuthentication</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UsernamePasswordAuthenticationToken</span>(jwtUserDto</span><br><span class="line">				, credentials, <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(<span class="number">0</span>));</span><br><span class="line">		userAuthentication.setDetails(details);</span><br><span class="line"></span><br><span class="line">		<span class="type">JSONObject</span> <span class="variable">storedRequest</span> <span class="operator">=</span> jsonObject.getJSONObject(<span class="string">&quot;oAuth2Request&quot;</span>);</span><br><span class="line">		<span class="type">String</span> <span class="variable">clientId</span> <span class="operator">=</span> storedRequest.getString(<span class="string">&quot;clientId&quot;</span>);</span><br><span class="line"></span><br><span class="line">		<span class="type">JSONObject</span> <span class="variable">requestParametersJSON</span> <span class="operator">=</span> storedRequest.getJSONObject(<span class="string">&quot;requestParameters&quot;</span>);</span><br><span class="line">		Map&lt;String, String&gt; requestParameters = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">		<span class="keyword">for</span> (String key : requestParametersJSON.keySet()) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">			requestParameters.put(key, requestParametersJSON.getString(key));</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		Set&lt;String&gt; scope = convertSetString(storedRequest, <span class="string">&quot;scope&quot;</span>);</span><br><span class="line">		Set&lt;String&gt; resourceIds = convertSetString(storedRequest, <span class="string">&quot;resourceIds&quot;</span>);</span><br><span class="line">		Set&lt;String&gt; responseTypes = convertSetString(storedRequest, <span class="string">&quot;responseTypes&quot;</span>);</span><br><span class="line"></span><br><span class="line">		<span class="type">OAuth2Request</span> <span class="variable">oAuth2Request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OAuth2Request</span>(requestParameters</span><br><span class="line">				, clientId</span><br><span class="line">				<span class="comment">//由于这个项目不需要处理权限角色，所以就没有对权限角色集合做处理</span></span><br><span class="line">				, <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(<span class="number">0</span>)</span><br><span class="line">				, storedRequest.getBoolean(<span class="string">&quot;approved&quot;</span>)</span><br><span class="line">				, scope</span><br><span class="line">				, resourceIds</span><br><span class="line">				, storedRequest.getString(<span class="string">&quot;redirectUri&quot;</span>)</span><br><span class="line">				, responseTypes</span><br><span class="line">				, <span class="literal">null</span> <span class="comment">//extensionProperties</span></span><br><span class="line">		);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">OAuth2Authentication</span>(oAuth2Request, userAuthentication);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> Set&lt;String&gt; <span class="title function_">convertSetString</span><span class="params">(JSONObject data, String key)</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		List&lt;String&gt; list = data.getJSONArray(key).toJavaList(String.class);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;(list);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//存储accessToken并且存储用户认证信息（Principal)</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">storeAccessToken</span><span class="params">(OAuth2AccessToken token, OAuth2Authentication authentication)</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		<span class="type">String</span> <span class="variable">serializedAccessToken</span> <span class="operator">=</span> JSONObject.toJSONString(token);</span><br><span class="line">		<span class="type">String</span> <span class="variable">serializedAuth</span> <span class="operator">=</span> JSONObject.toJSONString(authentication);</span><br><span class="line">		<span class="type">String</span> <span class="variable">accessKey</span> <span class="operator">=</span> ACCESS + token.getValue();</span><br><span class="line">		<span class="type">String</span> <span class="variable">authKey</span> <span class="operator">=</span> AUTH + token.getValue();</span><br><span class="line">		<span class="type">String</span> <span class="variable">authToAccessKey</span> <span class="operator">=</span> AUTH_TO_ACCESS + authenticationKeyGenerator.extractKey(authentication);</span><br><span class="line">		<span class="type">String</span> <span class="variable">approvalKey</span> <span class="operator">=</span> UNAME_TO_ACCESS + getApprovalKey(authentication);</span><br><span class="line">		<span class="type">String</span> <span class="variable">clientId</span> <span class="operator">=</span> CLIENT_ID_TO_ACCESS + authentication.getOAuth2Request().getClientId();</span><br><span class="line"></span><br><span class="line">		<span class="type">int</span> <span class="variable">seconds</span> <span class="operator">=</span> <span class="number">30</span> * <span class="number">24</span> * <span class="number">60</span> * <span class="number">60</span>;</span><br><span class="line">		<span class="keyword">if</span> (token.getExpiration() != <span class="literal">null</span>) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">			seconds = (<span class="type">int</span>) DateUtil.between(<span class="keyword">new</span> <span class="title class_">Date</span>(),token.getExpiration(), DateUnit.SECOND);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">			stringRedisTemplate.opsForValue().set(accessKey, serializedAccessToken);</span><br><span class="line">			stringRedisTemplate.opsForValue().set(authKey, serializedAuth);</span><br><span class="line">			stringRedisTemplate.opsForValue().set(authToAccessKey, serializedAccessToken);</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (!authentication.isClientOnly()) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">				stringRedisTemplate.opsForHash().putIfAbsent(approvalKey, token.getValue(), serializedAccessToken);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">			<span class="comment">//如果中途失败，则还可以补偿过期时间</span></span><br><span class="line">			stringRedisTemplate.expire(accessKey, seconds, TimeUnit.SECONDS);</span><br><span class="line">			stringRedisTemplate.expire(authKey, seconds, TimeUnit.SECONDS);</span><br><span class="line">			stringRedisTemplate.expire(authToAccessKey, seconds, TimeUnit.SECONDS);</span><br><span class="line">			stringRedisTemplate.expire(clientId, seconds, TimeUnit.SECONDS);</span><br><span class="line">			stringRedisTemplate.expire(approvalKey, seconds, TimeUnit.SECONDS);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="type">OAuth2RefreshToken</span> <span class="variable">refreshToken</span> <span class="operator">=</span> token.getRefreshToken();</span><br><span class="line">		<span class="keyword">if</span> (refreshToken != <span class="literal">null</span> &amp;&amp; refreshToken.getValue() != <span class="literal">null</span>) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">			<span class="type">String</span> <span class="variable">refreshValue</span> <span class="operator">=</span> token.getRefreshToken().getValue();</span><br><span class="line">			<span class="type">String</span> <span class="variable">refreshToAccessKey</span> <span class="operator">=</span> REFRESH_TO_ACCESS + refreshValue;</span><br><span class="line">			<span class="type">String</span> <span class="variable">accessToRefreshKey</span> <span class="operator">=</span> ACCESS_TO_REFRESH + token.getValue();</span><br><span class="line"></span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">				stringRedisTemplate.opsForValue().set(refreshToAccessKey, token.getValue());</span><br><span class="line">				stringRedisTemplate.opsForValue().set(accessToRefreshKey, refreshValue);</span><br><span class="line">			&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">				<span class="comment">//如果中途失败，则还可以补偿过期时间</span></span><br><span class="line">				refreshTokenProcess(refreshToken, refreshToAccessKey, accessToRefreshKey);</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			CACHE.put(refreshToAccessKey, token.getValue());</span><br><span class="line">			CACHE.put(accessToRefreshKey, refreshValue);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		CACHE.put(accessKey, token);</span><br><span class="line">		CACHE.put(authKey, authentication);</span><br><span class="line">		CACHE.put(authToAccessKey, token);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">refreshTokenProcess</span><span class="params">(OAuth2RefreshToken refreshToken, String refreshKey, String refreshAuthKey)</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		<span class="type">int</span> <span class="variable">seconds</span> <span class="operator">=</span> <span class="number">30</span> * <span class="number">24</span> * <span class="number">60</span> * <span class="number">60</span>;</span><br><span class="line">		<span class="keyword">if</span> (refreshToken <span class="keyword">instanceof</span> ExpiringOAuth2RefreshToken) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">			<span class="type">ExpiringOAuth2RefreshToken</span> <span class="variable">expiringRefreshToken</span> <span class="operator">=</span> (ExpiringOAuth2RefreshToken) refreshToken;</span><br><span class="line">			<span class="type">Date</span> <span class="variable">expiration</span> <span class="operator">=</span> expiringRefreshToken.getExpiration();</span><br><span class="line"></span><br><span class="line">			<span class="type">int</span> temp;</span><br><span class="line">			<span class="keyword">if</span> (expiration != <span class="literal">null</span>) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">				temp = Long.valueOf((expiration.getTime() - System.currentTimeMillis()) / <span class="number">1000L</span>)</span><br><span class="line">						.intValue();</span><br><span class="line"></span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">				temp = seconds;</span><br><span class="line">			&#125;</span><br><span class="line">			stringRedisTemplate.expire(refreshKey, temp, TimeUnit.SECONDS);</span><br><span class="line">			stringRedisTemplate.expire(refreshAuthKey, temp, TimeUnit.SECONDS);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">private</span> String <span class="title function_">getApprovalKey</span><span class="params">(OAuth2Authentication authentication)</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		<span class="type">String</span> <span class="variable">userName</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">		<span class="keyword">if</span> (authentication.getUserAuthentication() != <span class="literal">null</span>) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">			<span class="type">JwtUserDto</span> <span class="variable">userInfoDetails</span> <span class="operator">=</span> (JwtUserDto) authentication.getUserAuthentication().getPrincipal();</span><br><span class="line">			userName = userInfoDetails.getUser().getMobile() + <span class="string">&quot;_&quot;</span> + userInfoDetails.getUsername();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> getApprovalKey(authentication.getOAuth2Request().getClientId(), userName);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> String <span class="title function_">getApprovalKey</span><span class="params">(String clientId, String userName)</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		<span class="keyword">return</span> clientId + (userName == <span class="literal">null</span> ? <span class="string">&quot;&quot;</span> : <span class="string">&quot;:&quot;</span> + userName);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//根据AccessToken的value值查询对应的token对象</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> OAuth2AccessToken <span class="title function_">readAccessToken</span><span class="params">(String tokenValue)</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		<span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> ACCESS + tokenValue;</span><br><span class="line">		<span class="comment">//先从本地缓存取，没有再从redis中取，都没有返回Null</span></span><br><span class="line">		<span class="keyword">return</span> (OAuth2AccessToken) loadCache(key, (k) -&gt; &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">			<span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(key);</span><br><span class="line">			<span class="keyword">if</span> (StrUtil.isNotBlank(json)) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">				<span class="keyword">return</span> JSONObject.parseObject(json, DefaultOAuth2AccessTokenEx.class);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">		&#125;);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">removeAccessToken</span><span class="params">(OAuth2AccessToken accessToken)</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		removeAccessToken(accessToken.getValue());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">removeAccessToken</span><span class="params">(String tokenValue)</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		<span class="type">String</span> <span class="variable">accessKey</span> <span class="operator">=</span> ACCESS + tokenValue;</span><br><span class="line">		<span class="type">String</span> <span class="variable">authKey</span> <span class="operator">=</span> AUTH + tokenValue;</span><br><span class="line">		<span class="type">String</span> <span class="variable">accessToRefreshKey</span> <span class="operator">=</span> ACCESS_TO_REFRESH + tokenValue;</span><br><span class="line"></span><br><span class="line">		<span class="type">OAuth2Authentication</span> <span class="variable">authentication</span> <span class="operator">=</span> readAuthentication(tokenValue);</span><br><span class="line">		<span class="type">String</span> <span class="variable">access</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(accessKey);</span><br><span class="line"></span><br><span class="line">		List&lt;String&gt; keys = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(<span class="number">6</span>);</span><br><span class="line">		keys.add(accessKey);</span><br><span class="line">		keys.add(authKey);</span><br><span class="line">		keys.add(accessToRefreshKey);</span><br><span class="line"></span><br><span class="line">		stringRedisTemplate.delete(keys);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (authentication != <span class="literal">null</span>) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">			<span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> authenticationKeyGenerator.extractKey(authentication);</span><br><span class="line">			<span class="type">String</span> <span class="variable">authToAccessKey</span> <span class="operator">=</span> AUTH_TO_ACCESS + key;</span><br><span class="line">			<span class="type">String</span> <span class="variable">unameKey</span> <span class="operator">=</span> UNAME_TO_ACCESS + getApprovalKey(authentication);</span><br><span class="line">			<span class="type">String</span> <span class="variable">clientId</span> <span class="operator">=</span> CLIENT_ID_TO_ACCESS + authentication.getOAuth2Request().getClientId();</span><br><span class="line"></span><br><span class="line">			stringRedisTemplate.delete(authToAccessKey);</span><br><span class="line">			stringRedisTemplate.opsForHash().delete(unameKey, tokenValue);</span><br><span class="line">			stringRedisTemplate.opsForList().remove(clientId, <span class="number">1</span>, access);</span><br><span class="line">			stringRedisTemplate.delete(ACCESS + key);</span><br><span class="line"></span><br><span class="line">			CACHE.invalidate(authToAccessKey);</span><br><span class="line">			CACHE.invalidate(ACCESS + key);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		CACHE.invalidateAll(keys);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">storeRefreshToken</span><span class="params">(OAuth2RefreshToken refreshToken, OAuth2Authentication authentication)</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		<span class="type">String</span> <span class="variable">refreshKey</span> <span class="operator">=</span> REFRESH + refreshToken.getValue();</span><br><span class="line">		<span class="type">String</span> <span class="variable">refreshAuthKey</span> <span class="operator">=</span> REFRESH_AUTH + refreshToken.getValue();</span><br><span class="line">		<span class="type">String</span> <span class="variable">serializedRefreshToken</span> <span class="operator">=</span> JSONObject.toJSONString(refreshToken);</span><br><span class="line"></span><br><span class="line">		stringRedisTemplate.opsForValue().set(refreshKey, serializedRefreshToken);</span><br><span class="line">		stringRedisTemplate.opsForValue().set(refreshAuthKey, JSONObject.toJSONString(authentication));</span><br><span class="line"></span><br><span class="line">		refreshTokenProcess(refreshToken, refreshKey, refreshAuthKey);</span><br><span class="line"></span><br><span class="line">		CACHE.put(refreshKey, refreshToken);</span><br><span class="line">		CACHE.put(refreshAuthKey, authentication);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//和readAccessToken的原理一致</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> OAuth2RefreshToken <span class="title function_">readRefreshToken</span><span class="params">(String tokenValue)</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		<span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> REFRESH + tokenValue;</span><br><span class="line">		<span class="keyword">return</span> (OAuth2RefreshToken) loadCache(key, (k) -&gt; &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">			<span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(key);</span><br><span class="line">			<span class="keyword">if</span> (StrUtil.isNotBlank(json)) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">				<span class="keyword">return</span> JSONObject.parseObject(json, DefaultOAuth2RefreshTokenEx.class);</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">		&#125;);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> OAuth2Authentication <span class="title function_">readAuthenticationForRefreshToken</span><span class="params">(OAuth2RefreshToken token)</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">this</span>.readAuthenticationForRefreshToken(token.getValue());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> OAuth2Authentication <span class="title function_">readAuthenticationForRefreshToken</span><span class="params">(String token)</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		<span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> REFRESH_AUTH + token;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> (OAuth2Authentication) loadCache(key, (k) -&gt; &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">			<span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(key);</span><br><span class="line">			<span class="keyword">if</span> (StrUtil.isBlank(json)) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">				<span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">return</span> fullParseJSON(json);</span><br><span class="line">		&#125;);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">removeRefreshToken</span><span class="params">(OAuth2RefreshToken refreshToken)</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		<span class="built_in">this</span>.removeRefreshToken(refreshToken.getValue());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">removeRefreshToken</span><span class="params">(String refreshToken)</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		<span class="type">String</span> <span class="variable">refreshKey</span> <span class="operator">=</span> REFRESH + refreshToken;</span><br><span class="line">		<span class="type">String</span> <span class="variable">refreshAuthKey</span> <span class="operator">=</span> REFRESH_AUTH + refreshToken;</span><br><span class="line">		<span class="type">String</span> <span class="variable">refresh2AccessKey</span> <span class="operator">=</span> REFRESH_TO_ACCESS + refreshToken;</span><br><span class="line">		<span class="type">String</span> <span class="variable">access2RefreshKey</span> <span class="operator">=</span> ACCESS_TO_REFRESH + refreshToken;</span><br><span class="line"></span><br><span class="line">		List&lt;String&gt; keys = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(<span class="number">7</span>);</span><br><span class="line">		keys.add(refreshKey);</span><br><span class="line">		keys.add(refreshAuthKey);</span><br><span class="line">		keys.add(refresh2AccessKey);</span><br><span class="line">		keys.add(access2RefreshKey);</span><br><span class="line"></span><br><span class="line">		stringRedisTemplate.delete(keys);</span><br><span class="line"></span><br><span class="line">		CACHE.invalidateAll(keys);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">removeAccessTokenUsingRefreshToken</span><span class="params">(OAuth2RefreshToken refreshToken)</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		<span class="built_in">this</span>.removeAccessTokenUsingRefreshToken(refreshToken.getValue());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">removeAccessTokenUsingRefreshToken</span><span class="params">(String refreshToken)</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		<span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> REFRESH_TO_ACCESS + refreshToken;</span><br><span class="line"></span><br><span class="line">		<span class="type">String</span> <span class="variable">accessToken</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(key);</span><br><span class="line">		stringRedisTemplate.delete(key);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (accessToken != <span class="literal">null</span>) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">			removeAccessToken(accessToken);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		CACHE.invalidate(key);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> &lt;T&gt; Object <span class="title function_">loadCache</span><span class="params">(String key, Function&lt;Object, ? extends T&gt; loadData)</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">			<span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> CACHE.getIfPresent(key);</span><br><span class="line">			<span class="keyword">if</span> (value == <span class="literal">null</span>) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">				value = loadData.apply(key);</span><br><span class="line">				<span class="comment">//如果redis中有则将redis中的token放入本地缓存中</span></span><br><span class="line">				<span class="keyword">if</span> (value != <span class="literal">null</span>) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">					CACHE.put(key, value);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">return</span> value;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;JsonRedisTokenStore.loadCache从缓存中加载数据发生错误&quot;</span>, e);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> OAuth2AccessToken <span class="title function_">getAccessToken</span><span class="params">(OAuth2Authentication authentication)</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		<span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> AUTH_TO_ACCESS + authenticationKeyGenerator.extractKey(authentication);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> (OAuth2AccessToken) loadCache(key, (k) -&gt; &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">			<span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(key);</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (StrUtil.isNotBlank(json)) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">				<span class="type">DefaultOAuth2AccessToken</span> <span class="variable">accessToken</span> <span class="operator">=</span> JSONObject.parseObject(json, DefaultOAuth2AccessTokenEx.class);</span><br><span class="line">				<span class="type">OAuth2Authentication</span> <span class="variable">storedAuthentication</span> <span class="operator">=</span> readAuthentication(accessToken.getValue());</span><br><span class="line"></span><br><span class="line">				<span class="keyword">if</span> (storedAuthentication == <span class="literal">null</span></span><br><span class="line">						|| !key.equals(authenticationKeyGenerator.extractKey(storedAuthentication))) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">					<span class="built_in">this</span>.storeAccessToken(accessToken, authentication);</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				<span class="keyword">return</span> accessToken;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">		&#125;);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> Collection&lt;OAuth2AccessToken&gt; <span class="title function_">findTokensByClientIdAndUserName</span><span class="params">(String clientId, String userName)</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		<span class="type">String</span> <span class="variable">approvalKey</span> <span class="operator">=</span> UNAME_TO_ACCESS + getApprovalKey(clientId, userName);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> getOAuth2AccessTokens(approvalKey);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Collection&lt;OAuth2AccessToken&gt; <span class="title function_">getOAuth2AccessTokens</span><span class="params">(String approvalKey)</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		<span class="keyword">return</span> (Collection&lt;OAuth2AccessToken&gt;) loadCache(approvalKey, (k) -&gt; &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">			Map&lt;Object, Object&gt; accessTokens = stringRedisTemplate.opsForHash().entries(approvalKey);</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (accessTokens.size() == <span class="number">0</span>) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">				<span class="keyword">return</span> Collections.emptySet();</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			List&lt;OAuth2AccessToken&gt; result = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">			<span class="keyword">for</span> (Object json : accessTokens.values()) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">				<span class="type">String</span> <span class="variable">strJSON</span> <span class="operator">=</span> json.toString();</span><br><span class="line">				<span class="type">OAuth2AccessToken</span> <span class="variable">accessToken</span> <span class="operator">=</span> JSONObject.parseObject(strJSON, DefaultOAuth2AccessTokenEx.class);</span><br><span class="line"></span><br><span class="line">				result.add(accessToken);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span> Collections.unmodifiableCollection(result);</span><br><span class="line">		&#125;);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> Collection&lt;OAuth2AccessToken&gt; <span class="title function_">findTokensByClientId</span><span class="params">(String clientId)</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		<span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> CLIENT_ID_TO_ACCESS + clientId;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> getOAuth2AccessTokens(key);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>DefaultOAuth2RefreshTokenEx.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.mbw.security.token;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.common.DefaultOAuth2RefreshToken;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.common.ExpiringOAuth2RefreshToken;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DefaultOAuth2RefreshTokenEx</span> <span class="keyword">extends</span> <span class="title class_">DefaultOAuth2RefreshToken</span> <span class="keyword">implements</span> <span class="title class_">ExpiringOAuth2RefreshToken</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">	<span class="keyword">private</span> Date expiration;</span><br><span class="line">	<span class="keyword">private</span> String value;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_">DefaultOAuth2RefreshTokenEx</span><span class="params">()</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		<span class="built_in">super</span>(<span class="literal">null</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>DefaultOAuth2AccessTokenEx.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.mbw.security.token;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.common.DefaultOAuth2AccessToken;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DefaultOAuth2AccessTokenEx</span> <span class="keyword">extends</span> <span class="title class_">DefaultOAuth2AccessToken</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">	<span class="keyword">private</span> DefaultOAuth2RefreshTokenEx refreshToken;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_">DefaultOAuth2AccessTokenEx</span><span class="params">()</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		<span class="built_in">super</span>((String) <span class="literal">null</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setValue</span><span class="params">(String value)</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		<span class="built_in">super</span>.setValue(value);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> DefaultOAuth2RefreshTokenEx <span class="title function_">getRefreshToken</span><span class="params">()</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		<span class="keyword">return</span> refreshToken;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setRefreshToken</span><span class="params">(DefaultOAuth2RefreshTokenEx refreshToken)</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		<span class="built_in">this</span>.refreshToken = refreshToken;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在项目中使用spring security oauth2做了统一登录授权，在实际开发过程中，发现不同终端同一账号登录，返回的token是一样的。我们使用的是redis存储token，于是查了资料，发现是因为生成token key的算法的原因，导致了多端登录返回一个token的问题，原因如图：</p>
 <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/03/13/spring-security-guide2/1695614716283.png" class="">
<p>生成key使用的是DefaultAuthenticationKeyGenerator，代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DefaultAuthenticationKeyGenerator</span> <span class="keyword">implements</span> <span class="title class_">AuthenticationKeyGenerator</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">CLIENT_ID</span> <span class="operator">=</span> <span class="string">&quot;client_id&quot;</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">SCOPE</span> <span class="operator">=</span> <span class="string">&quot;scope&quot;</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">USERNAME</span> <span class="operator">=</span> <span class="string">&quot;username&quot;</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> String <span class="title function_">extractKey</span><span class="params">(OAuth2Authentication authentication)</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		Map&lt;String, String&gt; values = <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>&lt;String, String&gt;();</span><br><span class="line">		<span class="type">OAuth2Request</span> <span class="variable">authorizationRequest</span> <span class="operator">=</span> authentication.getOAuth2Request();</span><br><span class="line">		<span class="keyword">if</span> (!authentication.isClientOnly()) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">			values.put(USERNAME, authentication.getName());</span><br><span class="line">		&#125;</span><br><span class="line">		values.put(CLIENT_ID, authorizationRequest.getClientId());</span><br><span class="line">		<span class="keyword">if</span> (authorizationRequest.getScope() != <span class="literal">null</span>) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">			values.put(SCOPE, OAuth2Utils.formatParameterList(<span class="keyword">new</span> <span class="title class_">TreeSet</span>&lt;String&gt;(authorizationRequest.getScope())));</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> generateKey(values);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从代码里面看，生成key使用的是 client_id、scope、username三个字段，由于这三个字段同一用户在同一子系统中是不变的，所以导致多端登录时，生成的token key是一样的，就会造成返回的token一样，这样的后果就是，其中一个终端退出登录，所有已登录设备就失效了，于是就重写这extractKey方法，继承这个类，增加了一个device_id字段，从而解决多端登录需要互不干扰的需求：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.mbw.security.token;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.common.util.OAuth2Utils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.OAuth2Authentication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.OAuth2Request;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.token.DefaultAuthenticationKeyGenerator;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.LinkedHashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.TreeSet;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomAuthenticationKeyGenerator</span> <span class="keyword">extends</span> <span class="title class_">DefaultAuthenticationKeyGenerator</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">CLIENT_ID</span> <span class="operator">=</span> <span class="string">&quot;client_id&quot;</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">SCOPE</span> <span class="operator">=</span> <span class="string">&quot;scope&quot;</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">USERNAME</span> <span class="operator">=</span> <span class="string">&quot;username&quot;</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DEVICE_ID</span> <span class="operator">=</span> <span class="string">&quot;device_id&quot;</span>;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> String <span class="title function_">extractKey</span><span class="params">(OAuth2Authentication authentication)</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		Map&lt;String, String&gt; values = <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>&lt;String, String&gt;();</span><br><span class="line">		<span class="type">OAuth2Request</span> <span class="variable">authorizationRequest</span> <span class="operator">=</span> authentication.getOAuth2Request();</span><br><span class="line">		<span class="keyword">if</span> (!authentication.isClientOnly()) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">			values.put(USERNAME, authentication.getName());</span><br><span class="line">		&#125;</span><br><span class="line">		values.put(CLIENT_ID, authorizationRequest.getClientId());</span><br><span class="line">		<span class="keyword">if</span> (authorizationRequest.getScope() != <span class="literal">null</span>) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">			values.put(SCOPE, OAuth2Utils.formatParameterList(<span class="keyword">new</span> <span class="title class_">TreeSet</span>&lt;String&gt;(authorizationRequest.getScope())));</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="type">String</span> <span class="variable">deviceId</span> <span class="operator">=</span> authorizationRequest.getRequestParameters().get(DEVICE_ID);</span><br><span class="line">		values.put(DEVICE_ID, deviceId);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> generateKey(values);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>而我们生成Token的接口的参数就要再加一个device_id，而这个deviceId可以通过存进用户表让前端取到。</p>
 <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/03/13/spring-security-guide2/1695614716768.png" class="">
<p>然后就可以在AuthServerConfig配置该类了：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.mbw.security.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.mbw.security.service.ClientDetailsServiceImpl;</span><br><span class="line"><span class="keyword">import</span> com.mbw.security.service.UserDetailsServiceImpl;</span><br><span class="line"><span class="keyword">import</span> com.mbw.security.token.JsonRedisTokenStore;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.authentication.AuthenticationManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.config.annotation.configurers.ClientDetailsServiceConfigurer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.config.annotation.web.configuration.AuthorizationServerConfigurerAdapter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.config.annotation.web.configuration.EnableAuthorizationServer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.config.annotation.web.configurers.AuthorizationServerEndpointsConfigurer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.config.annotation.web.configurers.AuthorizationServerSecurityConfigurer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.token.DefaultTokenServices;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableAuthorizationServer</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AuthServerConfig</span> <span class="keyword">extends</span> <span class="title class_">AuthorizationServerConfigurerAdapter</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> AuthenticationManager authenticationManager;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> ClientDetailsServiceImpl clientDetailsServiceImpl;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> UserDetailsServiceImpl userDetailsServiceImpl;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> JsonRedisTokenStore jsonRedisTokenStore;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthorizationServerEndpointsConfigurer endpoints)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		endpoints.authenticationManager(authenticationManager)</span><br><span class="line">		.userDetailsService(userDetailsServiceImpl)</span><br><span class="line">				.tokenStore(jsonRedisTokenStore);</span><br><span class="line">		<span class="type">DefaultTokenServices</span> <span class="variable">tokenService</span> <span class="operator">=</span> getTokenStore(endpoints);</span><br><span class="line">		endpoints.tokenServices(tokenService);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//配置TokenService参数</span></span><br><span class="line">	<span class="keyword">private</span> DefaultTokenServices <span class="title function_">getTokenStore</span><span class="params">(AuthorizationServerEndpointsConfigurer endpoints)</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		<span class="type">DefaultTokenServices</span> <span class="variable">tokenService</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultTokenServices</span>();</span><br><span class="line">		tokenService.setTokenStore(endpoints.getTokenStore());</span><br><span class="line">		tokenService.setSupportRefreshToken(<span class="literal">true</span>);</span><br><span class="line">		tokenService.setClientDetailsService(endpoints.getClientDetailsService());</span><br><span class="line">		tokenService.setTokenEnhancer(endpoints.getTokenEnhancer());</span><br><span class="line">		<span class="comment">//token有效期 1小时</span></span><br><span class="line">		tokenService.setAccessTokenValiditySeconds(<span class="number">3600</span>);</span><br><span class="line">		<span class="comment">//token刷新有效期 15天</span></span><br><span class="line">		tokenService.setRefreshTokenValiditySeconds(<span class="number">3600</span> * <span class="number">12</span> * <span class="number">15</span>);</span><br><span class="line">		tokenService.setReuseRefreshToken(<span class="literal">false</span>);</span><br><span class="line">		<span class="keyword">return</span> tokenService;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(ClientDetailsServiceConfigurer clients)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		clients.withClientDetails(clientDetailsServiceImpl);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 解决访问/oauth/check_token 403的问题</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> security</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthorizationServerSecurityConfigurer security)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		<span class="comment">// 允许表单认证</span></span><br><span class="line">		security</span><br><span class="line">				.tokenKeyAccess(<span class="string">&quot;permitAll()&quot;</span>)</span><br><span class="line">				.checkTokenAccess(<span class="string">&quot;permitAll()&quot;</span>)</span><br><span class="line">				.allowFormAuthenticationForClients();</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后现在启动授权服务器调用获取token</p>
 <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/03/13/spring-security-guide2/1695614717378.png" class="">
<p>然后回到redis看看成果：</p>
 <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/03/13/spring-security-guide2/1695614717951.png" class="">
<p>发现token已经存进redis，并且序列化。</p>
<h3 id="资源服务器配置"><a href="#资源服务器配置" class="headerlink" title="资源服务器配置"></a>资源服务器配置</h3><p>如果按照上一章的说法，我们接下来要在资源服务器也要配置同样的tokenStore,但是这也是我上一章结尾提到的代码耦合问题，明显不应该这样做。那么怎么解决呢？首先大家需要了解一个额外的配置：user-info-uri。user-info-uri原理是<strong>在授权服务器认证后将认证信息Principal通过形参绑定的方法通过URL的方式获取用户信息</strong>。所以这个大家可以想象成和token-info-uri类似的作用，只是我们不再直接调用授权服务器而已，而是一种类似职责分离，授权认证交给授权服务器，认证后的用户信息给到资源服务器，资源服务器再提供资源。</p>
<p>那么我们只需要在application.yaml修改如下配置即可：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">security:</span><br><span class="line">  oauth2:</span><br><span class="line">    resource:</span><br><span class="line">      id: resource_server</span><br><span class="line">      user-info-uri: http:<span class="comment">//localhost:9090/api/member</span></span><br><span class="line">      prefer-token-info: <span class="literal">false</span></span><br></pre></td></tr></table></figure>

<p>与此同时，资源服务器的配置类只需要专注于我们需要保护的资源即可：<br><strong>ResourceServerConfig.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.mbw.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.config.annotation.web.configuration.EnableResourceServer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.config.annotation.web.configuration.ResourceServerConfigurerAdapter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableResourceServer</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ResourceServerConfig</span> <span class="keyword">extends</span> <span class="title class_">ResourceServerConfigurerAdapter</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		http</span><br><span class="line">				.csrf().disable()</span><br><span class="line">				.exceptionHandling()</span><br><span class="line">				.authenticationEntryPoint((request, response, authException) -&gt; response.sendError(HttpServletResponse.SC_UNAUTHORIZED))</span><br><span class="line">				.and()</span><br><span class="line">				.authorizeRequests()</span><br><span class="line">				.antMatchers(<span class="string">&quot;/test/**&quot;</span>).authenticated()</span><br><span class="line">				.and()</span><br><span class="line">				.httpBasic();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>那资源服务器怎么知道我要访问哪个tokenStore呢？<br>还记得如果资源服务器和授权服务器在同一个项目时访问的是同一个bean这个结论吗，那么我们只需要在授权服务器项目上再配置一个资源服务器去保护user-info-uri这个资源即可：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.mbw.security.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.annotation.Order;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.config.annotation.web.configuration.EnableResourceServer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.config.annotation.web.configuration.ResourceServerConfigurerAdapter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableResourceServer</span></span><br><span class="line"><span class="meta">@Order(3)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ResourceServerConfig</span> <span class="keyword">extends</span> <span class="title class_">ResourceServerConfigurerAdapter</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		http</span><br><span class="line">				.csrf().disable()</span><br><span class="line">				.exceptionHandling()</span><br><span class="line">				.authenticationEntryPoint((request, response, authException) -&gt; response.sendError(HttpServletResponse.SC_UNAUTHORIZED))</span><br><span class="line">				.and()</span><br><span class="line">				.requestMatchers().antMatchers(<span class="string">&quot;/api/**&quot;</span>)</span><br><span class="line">				.and()</span><br><span class="line">				.authorizeRequests()</span><br><span class="line">				.antMatchers(<span class="string">&quot;/api/**&quot;</span>).authenticated()</span><br><span class="line">				.and()</span><br><span class="line">				.httpBasic();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>而在授权服务器配置的资源服务器是知道用哪个tokenStore的，那么一个调用链就出现了：<br>①用户带着token访问资源服务器保护的资源，而资源服务器为了获取用户信息，就会去调用user-info-uri,而这个路径被我们在授权服务器配置的资源服务器拦截，因为需要经过身份认证，第一站经过OAuth2AuthenticationProcessingFilter认证处理过滤器：</p>
 <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/03/13/spring-security-guide2/1695614718644.png" class="">
<p>此时Authentication中的Principal装着就是token，就类似于短信认证，认证前我们自己封装的Authentication对象Principal认证前放的是短信一个道理</p>
 <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/03/13/spring-security-guide2/1695614719791.png" class="">
<p>②然后由AuthenticationManager通过token进行身份验证，熟悉吗，是不是和之前学习的原生Spring Security的身份验证链很像，然后通过tokenService的loadAuthentication进行认证获取认证对象，这里的tokenService大家想象成UserDetailsService就好了。</p>
 <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/03/13/spring-security-guide2/1695614751840.png" class="">
<p>③tokenService获取Authentication对象来自DefaultTokenServices类，就是我们授权服务器配置的类：</p>
 <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/03/13/spring-security-guide2/1695614752351.png" class="">
<p>那这里的tokenStore就是授权服务器配置的，也就是我们重写的jsonRedisTokenStore:</p>
 <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/03/13/spring-security-guide2/1695614752934.png" class="">
<p>最后，来到这个配置的user-info-uri，读取用户认证信息返回给我们真正的授权服务器。</p>
 <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/03/13/spring-security-guide2/1695614753626.png" class="">
<p>然后有了用户的认证信息，资源服务器把资源返回给客户端：</p>
 <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/03/13/spring-security-guide2/1695614754320.png" class="">
<p>当然这只是我的个人理解，我自己debug了很多遍，由于找不到类似的资料，书上也没有讲解，我只能这样理解。如果大家有更好的想法，可以在评论区分享。</p>
<h3 id="将JSON-Web-Token-JWT-用于令牌实现。"><a href="#将JSON-Web-Token-JWT-用于令牌实现。" class="headerlink" title="将JSON Web Token(JWT)用于令牌实现。"></a>将JSON Web Token(JWT)用于令牌实现。</h3><p>使用加密签名验证令牌的优点是<strong>允许资源服务器验证令牌</strong>，<strong>而不需要直接调用授权服务器，也不需要共享数据库</strong>。这种实现令牌验证的方法通常用于使用OAuth2实现身份验证和授权的系统。出于这个原因，我们需要了解这一实现令牌验证的方式。</p>
<h4 id="使用JWT以及对称秘钥签名的令牌"><a href="#使用JWT以及对称秘钥签名的令牌" class="headerlink" title="使用JWT以及对称秘钥签名的令牌"></a>使用JWT以及对称秘钥签名的令牌</h4><p>用于令牌签名的最简单的方法是使用对称秘钥。<strong>在这种方法中，使用相同的密钥，既可以签署一个令牌，又可以验证它的签名</strong>。使用对称秘钥对令牌进行签名的优点是，它比将在本章后面内容讨论的其他方法<strong>更简单，而且速度更快</strong>。然后，正如将介绍的，它也有缺点，<strong>不能总是与身份验证过程中涉及的所有应用程序共享用于签名令牌的密钥</strong>。</p>
<h4 id="使用JWT"><a href="#使用JWT" class="headerlink" title="使用JWT"></a>使用JWT</h4><p>JWT是一个令牌实现。<strong>令牌由三部分组成：头信息、主体和签名</strong>。<strong>头信息和主体中的详情用JSON表示，并且它们是Base64编码的</strong>，第三部分是签名，这是使用一种<strong>加密算法生成的</strong>，该算法<strong>使用头信息和主体作为其输入</strong>。<strong>密码算法还意味着需要密钥。密钥就像一个密码，拥有正确密钥的所有者可以签署令牌或验证签名的真实性。如果令牌上的签名是真实的，就可以确保在签名之后没有人修改令牌</strong>。</p>
 <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/03/13/spring-security-guide2/1695614754957.png" class="">
<p>当<strong>JWT被签名时，我们也称它为JWS（JSON Web Token Signed）</strong> 。通常，应用加密算法对令牌进行签名就足够了，但有时可以选择对令牌进行加密，如果对令牌进行了签名，就可以在没有任何密钥或密码的情况下查看其内容。但是，<strong>即使黑客看到了令牌的内容，他们也不能更改令牌的内容，因为如果他们这么做了，签名就会无效</strong>。要让签名有效，签名必须</p>
<ul>
<li><strong>是使用正确密钥生成的</strong></li>
<li><strong>匹配签名过的内容</strong></li>
</ul>
 <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/03/13/spring-security-guide2/1695614755593.png" class="">
<p><strong>如果令牌被加密了，则还会将其称为JWE（JSON Web Token Encrypted）</strong> 。没有有效密钥，则无法看到已加密令牌的内容。</p>
<h4 id="使用授权服务器以颁发JWT"><a href="#使用授权服务器以颁发JWT" class="headerlink" title="使用授权服务器以颁发JWT"></a>使用授权服务器以颁发JWT</h4><p>本家将实现一个授权服务器，该服务器会向客户端颁发JWT以进行授权。我们之前说过管理令牌的组件是TokenStore。本节要做的是使用Spring Security提供的TokenStore的另一种实现。<strong>这里要使用的实现的名称是JwtTokenStore,它会管理JWT</strong>。本节还将测试授权服务器。而关于资源服务器，我们暂时不会进行特定实现，之后会解析原因。</p>
<ul>
<li><strong>如果使用相同的密钥对令牌进行签名和验证签名，就可以说该密钥是对称的</strong>。</li>
<li><strong>如果使用一个密钥签名令牌，但使用另一个密钥验证签名，则可以说使用的是一个非对称密钥对</strong>。</li>
</ul>
<p>这个示例将使用对称密钥实现签名。<strong>这种方法意味着授权服务器和资源服务器都知道并使用相同的密钥。授权服务器使用密钥对令牌进行签名，资源服务器使用相同的密钥验证签名</strong>。</p>
 <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/03/13/spring-security-guide2/1695614756166.png" class="">
<p>那么依赖仍然使用我们之前学习搭建项目使用的依赖即可。</p>
<p>这里为JdbcTokenStore配置JwtTokenStore的方式与 第14章相同。此外，还需要定义一个JwtAccessTokenConverter类型的对象。使用JwtAccessTokenConverter,就可以配置授权服务器验证令牌的方式；在这个示例中，将使用对称密钥。下面代码展示了如何在授权服务器配置类中配置JwtTokenStore:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.mbw.security.service.ClientDetailsServiceImpl;</span><br><span class="line"><span class="keyword">import</span> com.mbw.security.service.UserDetailsServiceImpl;</span><br><span class="line"><span class="keyword">import</span> com.mbw.security.token.JsonRedisTokenStore;</span><br><span class="line"><span class="keyword">import</span> com.mbw.security.token.enhancer.CustomTokenEnhancer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.authentication.AuthenticationManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.config.annotation.configurers.ClientDetailsServiceConfigurer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.config.annotation.web.configuration.AuthorizationServerConfigurerAdapter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.config.annotation.web.configuration.EnableAuthorizationServer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.config.annotation.web.configurers.AuthorizationServerEndpointsConfigurer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.config.annotation.web.configurers.AuthorizationServerSecurityConfigurer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.token.DefaultTokenServices;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.token.TokenEnhancer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.token.TokenEnhancerChain;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.token.TokenStore;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.token.store.JwtAccessTokenConverter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.token.store.JwtTokenStore;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableAuthorizationServer</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AuthServerConfig</span> <span class="keyword">extends</span> <span class="title class_">AuthorizationServerConfigurerAdapter</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> AuthenticationManager authenticationManager;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> ClientDetailsServiceImpl clientDetailsServiceImpl;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> UserDetailsServiceImpl userDetailsServiceImpl;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> CustomTokenEnhancer customTokenEnhancer;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> JsonRedisTokenStore jsonRedisTokenStore;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Value(&quot;$&#123;jwt.key&#125;&quot;)</span></span><br><span class="line">	<span class="keyword">private</span> String jwtKey;  <span class="comment">//从application.yaml文件中获取对称密钥的值</span></span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthorizationServerEndpointsConfigurer endpoints)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		endpoints.authenticationManager(authenticationManager)</span><br><span class="line">				.userDetailsService(userDetailsServiceImpl)</span><br><span class="line">				.accessTokenConverter(jwtAccessTokenConverter()) <span class="comment">//配置访问令牌转换器对象</span></span><br><span class="line">				.tokenStore(tokenStore());    <span class="comment">//配置令牌存储对象</span></span><br><span class="line">		<span class="type">DefaultTokenServices</span> <span class="variable">tokenService</span> <span class="operator">=</span> getTokenStore(endpoints);</span><br><span class="line">		endpoints.tokenServices(tokenService);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//配置TokenService参数</span></span><br><span class="line">	<span class="keyword">private</span> DefaultTokenServices <span class="title function_">getTokenStore</span><span class="params">(AuthorizationServerEndpointsConfigurer endpoints)</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		<span class="type">DefaultTokenServices</span> <span class="variable">tokenService</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultTokenServices</span>();</span><br><span class="line">		tokenService.setTokenStore(endpoints.getTokenStore());</span><br><span class="line">		tokenService.setSupportRefreshToken(<span class="literal">true</span>);</span><br><span class="line">		tokenService.setClientDetailsService(endpoints.getClientDetailsService());</span><br><span class="line">		tokenService.setTokenEnhancer(endpoints.getTokenEnhancer());</span><br><span class="line">		<span class="comment">//token有效期 1小时</span></span><br><span class="line">		tokenService.setAccessTokenValiditySeconds(<span class="number">3600</span>);</span><br><span class="line">		<span class="comment">//token刷新有效期 15天</span></span><br><span class="line">		tokenService.setRefreshTokenValiditySeconds(<span class="number">3600</span> * <span class="number">12</span> * <span class="number">15</span>);</span><br><span class="line">		tokenService.setReuseRefreshToken(<span class="literal">false</span>);</span><br><span class="line">		<span class="keyword">return</span> tokenService;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(ClientDetailsServiceConfigurer clients)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		clients.withClientDetails(clientDetailsServiceImpl);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 解决访问/oauth/check_token 403的问题</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> security</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthorizationServerSecurityConfigurer security)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		<span class="comment">// 允许表单认证</span></span><br><span class="line">		security</span><br><span class="line">				.tokenKeyAccess(<span class="string">&quot;permitAll()&quot;</span>)</span><br><span class="line">				.checkTokenAccess(<span class="string">&quot;permitAll()&quot;</span>)</span><br><span class="line">				.allowFormAuthenticationForClients();</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="keyword">public</span> TokenStore <span class="title function_">tokenStore</span><span class="params">()</span>&#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">JwtTokenStore</span>(jwtAccessTokenConverter());  <span class="comment">//创建带有与之关联的访问令牌转换器的令牌存储</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="keyword">public</span> JwtAccessTokenConverter <span class="title function_">jwtAccessTokenConverter</span><span class="params">()</span>&#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		<span class="type">JwtAccessTokenConverter</span> <span class="variable">jwtAccessTokenConverter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JwtAccessTokenConverter</span>();</span><br><span class="line">		jwtAccessTokenConverter.setSigningKey(jwtKey); <span class="comment">//设置访问令牌转换器对象的对称密钥的值</span></span><br><span class="line">		<span class="keyword">return</span> jwtAccessTokenConverter;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里在application.yaml文件中存储了这个示例的对称密钥的值，如下面的代码片段所示。但是，不要忘记<strong>签名密钥是敏感数据，在现实场景中将其存储在密钥库中</strong>！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">jwt:</span><br><span class="line">  key: MjWP5L7CiD</span><br></pre></td></tr></table></figure>

<p>接下来可以启动授权服务器并调用&#x2F;oauth&#x2F;token端点来获取访问令牌。下面的代码片段展示了用于调用&#x2F;oauth&#x2F;token端点的postman调用展示：<br>调用后，首先在DefaultTokenService建立原始的refreshToken和accessToken,此时它们还不是JWT</p>
 <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/03/13/spring-security-guide2/1695614756741.png" class="">
<p>然后放行，你会发现程序直接结束了，出来的token不是jwt，这是为什么呢？</p>
 <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/03/13/spring-security-guide2/1695614757548.png" class="">
<p>经过我初步查资料，首先我们回归到创建token的代码—-DefaultTokenServices</p>
 <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/03/13/spring-security-guide2/1695614758125.png" class="">
<p>我们点进createAccessToken的方法，看到最后一行代码，<strong>如果accessTokenEnhancer存在，则做token增强，如果不存在，则返回普通token。回到问题之初，正是返回了普通token，所以，最大的可能便是此处的accessTokenEnhancer为空</strong>。</p>
 <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/03/13/spring-security-guide2/1695614758690.png" class="">
<p>那我们debug看一下原因是否是这个：</p>
 <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/03/13/spring-security-guide2/1695614759154.png" class="">
<p>果然是空，所以我们的配置类根本没有设置这个accessTokenEnhancer<br>我们来到配置DefaultTokenServices的地方–AuthorizationServerEndpointsConfigurer：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> DefaultTokenServices <span class="title function_">createDefaultTokenServices</span><span class="params">()</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		<span class="type">DefaultTokenServices</span> <span class="variable">tokenServices</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultTokenServices</span>();</span><br><span class="line">		tokenServices.setTokenStore(tokenStore());</span><br><span class="line">		tokenServices.setSupportRefreshToken(<span class="literal">true</span>);</span><br><span class="line">		tokenServices.setReuseRefreshToken(reuseRefreshToken);</span><br><span class="line">		tokenServices.setClientDetailsService(clientDetailsService());</span><br><span class="line">		tokenServices.setTokenEnhancer(tokenEnhancer());</span><br><span class="line">		addUserDetailsService(tokenServices, <span class="built_in">this</span>.userDetailsService);</span><br><span class="line">		<span class="keyword">return</span> tokenServices;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> TokenEnhancer <span class="title function_">tokenEnhancer</span><span class="params">()</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">this</span>.tokenEnhancer == <span class="literal">null</span> &amp;&amp; accessTokenConverter() <span class="keyword">instanceof</span> JwtAccessTokenConverter) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">			tokenEnhancer = (TokenEnhancer) accessTokenConverter;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">this</span>.tokenEnhancer;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>逻辑比较明显，<strong>如果tokenEnhancer为空，同时，此时的accessTokenConverter为JwtAccessTokenConverter时，tokenEnhancer便赋值为accessTokenConverter，即JwtAccessTokenConverter。但是此时，我们并没有配置accessTokenConverter。所以tokenEnhancer便为空。从而造成DefaultTokenServices中的token返回便会直接普通token</strong>。</p>
<p>那你可能会有疑问，刚刚那段代码我们不是配置了accessTokenConverter吗，为什么没生效呢，<strong>原因就在于我们自己配置的DefaultTokenServices修改了配置类获取tokenEnhancer的逻辑</strong>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//配置TokenService参数</span></span><br><span class="line">	<span class="keyword">private</span> DefaultTokenServices <span class="title function_">getTokenStore</span><span class="params">(AuthorizationServerEndpointsConfigurer endpoints)</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		<span class="type">DefaultTokenServices</span> <span class="variable">tokenService</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultTokenServices</span>();</span><br><span class="line">		tokenService.setTokenStore(endpoints.getTokenStore());</span><br><span class="line">		tokenService.setSupportRefreshToken(<span class="literal">true</span>);</span><br><span class="line">		tokenService.setClientDetailsService(endpoints.getClientDetailsService());</span><br><span class="line">		tokenService.setTokenEnhancer(endpoints.getTokenEnhancer());</span><br><span class="line">		<span class="comment">//token有效期 1小时</span></span><br><span class="line">		tokenService.setAccessTokenValiditySeconds(<span class="number">3600</span>);</span><br><span class="line">		<span class="comment">//token刷新有效期 15天</span></span><br><span class="line">		tokenService.setRefreshTokenValiditySeconds(<span class="number">3600</span> * <span class="number">12</span> * <span class="number">15</span>);</span><br><span class="line">		tokenService.setReuseRefreshToken(<span class="literal">false</span>);</span><br><span class="line">		<span class="keyword">return</span> tokenService;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p><strong>看到我们这边调用的tokenEnhancer使用的是endpoints.getTokenEnhancer,点进这个方法可以看到它使用的是源码中获取tokenEnhancer的代码，也就是我们如果没有做额外配置，它直接取的是你一开始的属性，也就是空，也就是没有走我们刚刚看到的处理enhancer的逻辑，那么就算我们设置了tokenConverter也是无济于事的</strong>：</p>
 <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/03/13/spring-security-guide2/1695614759837.png" class="">

<p>那么我们唯一想到的办法就是给endPoints(AuthorizationServerEndpointsConfigurer)配置上我们的tokenEnhancer,你可能会想，我不额外配置DefaultTokenServices就好了，让它使用默认的，但现在假设我们需要额外设置token的有效时间这些属性，那我们不得不重写tokenServices这个类，那么方法就只有对endPoints中的tokenEnhancer下手，这里呢我们可以直接写一个方法配置tokenEnhancer：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.mbw.security.service.ClientDetailsServiceImpl;</span><br><span class="line"><span class="keyword">import</span> com.mbw.security.service.UserDetailsServiceImpl;</span><br><span class="line"><span class="keyword">import</span> com.mbw.security.token.JsonRedisTokenStore;</span><br><span class="line"><span class="keyword">import</span> com.mbw.security.token.enhancer.CustomTokenEnhancer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.authentication.AuthenticationManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.config.annotation.configurers.ClientDetailsServiceConfigurer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.config.annotation.web.configuration.AuthorizationServerConfigurerAdapter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.config.annotation.web.configuration.EnableAuthorizationServer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.config.annotation.web.configurers.AuthorizationServerEndpointsConfigurer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.config.annotation.web.configurers.AuthorizationServerSecurityConfigurer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.token.DefaultTokenServices;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.token.TokenEnhancer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.token.TokenEnhancerChain;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.token.TokenStore;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.token.store.JwtAccessTokenConverter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.token.store.JwtTokenStore;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableAuthorizationServer</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AuthServerConfig</span> <span class="keyword">extends</span> <span class="title class_">AuthorizationServerConfigurerAdapter</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> AuthenticationManager authenticationManager;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> ClientDetailsServiceImpl clientDetailsServiceImpl;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> UserDetailsServiceImpl userDetailsServiceImpl;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> CustomTokenEnhancer customTokenEnhancer;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> JsonRedisTokenStore jsonRedisTokenStore;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Value(&quot;$&#123;jwt.key&#125;&quot;)</span></span><br><span class="line">	<span class="keyword">private</span> String jwtKey;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthorizationServerEndpointsConfigurer endpoints)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		endpoints.authenticationManager(authenticationManager)</span><br><span class="line">				.userDetailsService(userDetailsServiceImpl)</span><br><span class="line">				.tokenEnhancer(tokenEnhancerChain())</span><br><span class="line">				.tokenStore(tokenStore());</span><br><span class="line">		<span class="type">DefaultTokenServices</span> <span class="variable">tokenService</span> <span class="operator">=</span> getTokenStore(endpoints);</span><br><span class="line">		endpoints.tokenServices(tokenService);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="keyword">public</span> TokenEnhancerChain <span class="title function_">tokenEnhancerChain</span><span class="params">()</span>&#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		<span class="type">TokenEnhancerChain</span> <span class="variable">enhancerChain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TokenEnhancerChain</span>();</span><br><span class="line">		List&lt;TokenEnhancer&gt; enhancers = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">		enhancers.add(jwtAccessTokenConverter());</span><br><span class="line">		enhancers.add(customTokenEnhancer);</span><br><span class="line">		enhancerChain.setTokenEnhancers(enhancers);<span class="comment">//将自定义Enhancer加入EnhancerChain的delegates数组中</span></span><br><span class="line">		<span class="keyword">return</span> enhancerChain;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//配置TokenService参数</span></span><br><span class="line">	<span class="keyword">private</span> DefaultTokenServices <span class="title function_">getTokenStore</span><span class="params">(AuthorizationServerEndpointsConfigurer endpoints)</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		<span class="type">DefaultTokenServices</span> <span class="variable">tokenService</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultTokenServices</span>();</span><br><span class="line">		tokenService.setTokenStore(endpoints.getTokenStore());</span><br><span class="line">		tokenService.setSupportRefreshToken(<span class="literal">true</span>);</span><br><span class="line">		tokenService.setClientDetailsService(endpoints.getClientDetailsService());</span><br><span class="line">		tokenService.setTokenEnhancer(endpoints.getTokenEnhancer());</span><br><span class="line">		<span class="comment">//token有效期 1小时</span></span><br><span class="line">		tokenService.setAccessTokenValiditySeconds(<span class="number">3600</span>);</span><br><span class="line">		<span class="comment">//token刷新有效期 15天</span></span><br><span class="line">		tokenService.setRefreshTokenValiditySeconds(<span class="number">3600</span> * <span class="number">12</span> * <span class="number">15</span>);</span><br><span class="line">		tokenService.setReuseRefreshToken(<span class="literal">false</span>);</span><br><span class="line">		<span class="keyword">return</span> tokenService;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(ClientDetailsServiceConfigurer clients)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		clients.withClientDetails(clientDetailsServiceImpl);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 解决访问/oauth/check_token 403的问题</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> security</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthorizationServerSecurityConfigurer security)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		<span class="comment">// 允许表单认证</span></span><br><span class="line">		security</span><br><span class="line">				.tokenKeyAccess(<span class="string">&quot;permitAll()&quot;</span>)</span><br><span class="line">				.checkTokenAccess(<span class="string">&quot;permitAll()&quot;</span>)</span><br><span class="line">				.allowFormAuthenticationForClients();</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="keyword">public</span> TokenStore <span class="title function_">tokenStore</span><span class="params">()</span>&#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">JwtTokenStore</span>(jwtAccessTokenConverter());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="keyword">public</span> JwtAccessTokenConverter <span class="title function_">jwtAccessTokenConverter</span><span class="params">()</span>&#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		<span class="type">JwtAccessTokenConverter</span> <span class="variable">jwtAccessTokenConverter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JwtAccessTokenConverter</span>();</span><br><span class="line">		jwtAccessTokenConverter.setSigningKey(jwtKey);</span><br><span class="line">		<span class="keyword">return</span> jwtAccessTokenConverter;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如上所示，配置自定义令牌增强器有点复杂，假设我现在需要额外配置一个自定义的令牌增强对象customTokenEnhancer,对我的令牌做一个增强，又想让其包含jwtTokenConverter的功能怎么办呢？</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.mbw.security.token.enhancer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.common.DefaultOAuth2AccessToken;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.common.OAuth2AccessToken;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.OAuth2Authentication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.token.TokenEnhancer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomTokenEnhancer</span> <span class="keyword">implements</span> <span class="title class_">TokenEnhancer</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> OAuth2AccessToken <span class="title function_">enhance</span><span class="params">(OAuth2AccessToken accessToken, OAuth2Authentication authentication)</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		<span class="type">DefaultOAuth2AccessToken</span> <span class="variable">token</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultOAuth2AccessToken</span>(accessToken);</span><br><span class="line">		HashMap&lt;String, Object&gt; stringObjectHashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">		stringObjectHashMap.put(<span class="string">&quot;loginTime&quot;</span>,<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">		token.setAdditionalInformation(stringObjectHashMap);</span><br><span class="line">		<span class="keyword">return</span> token;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如上代码，既然提到了令牌增强，我就多提一嘴，有时候我们需要向令牌添加自定义的信息，比如上面代码中的loginTime，<strong>那么我们就需要创建一个TokenEnhancer类型的对象去实现TokenEnhancer接口，实现它的enhance()方法，enhance()方法会接收要增强的令牌作为参数，并返回该增强后的令牌，其中包含额外的详细信息</strong>。</p>
<p>那么我们<strong>必须创建一个令牌增强器链TokenEnhancerChain，并设置整个链，而不是只设置一个对象，因为访问令牌转换器对象也是一个令牌增强器。如果只配置自定义令牌增强器，则要重写访问令牌转换器的行为。我们转而要将两者都添加到职责链中，并配置包含这两个对象的链</strong>。</p>
<p>现在我们可以启动我们的授权服务器，并且调用&#x2F;oauth&#x2F;token接口了，大家也可以看到接口返回的信息多出了我们刚刚自定义的loginTIme</p>
 <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/03/13/spring-security-guide2/1695614760073.png" class="">
<p>可以在响应中观察到，访问和刷新令牌现在都是JWT。在下面代码片段中，可以找到令牌主体的解码（JSON）形式，那么这个呢是通过一个在线解析jwt获取的，<a target="_blank" rel="noopener" href="https://tooltt.com/jwt-decode/">点击这个链接即可</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">  <span class="string">&quot;exp&quot;</span>: <span class="number">1672371264</span>,</span><br><span class="line">  <span class="string">&quot;user_name&quot;</span>: <span class="string">&quot;张飞&quot;</span>,</span><br><span class="line">  <span class="string">&quot;authorities&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;read&quot;</span>,</span><br><span class="line">    <span class="string">&quot;ROLE_USER&quot;</span>,</span><br><span class="line">    <span class="string">&quot;ROLE_管理员&quot;</span>,</span><br><span class="line">    <span class="string">&quot;update&quot;</span>,</span><br><span class="line">    <span class="string">&quot;ROLE_ADMIN&quot;</span>,</span><br><span class="line">    <span class="string">&quot;delete&quot;</span>,</span><br><span class="line">    <span class="string">&quot;write&quot;</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="string">&quot;jti&quot;</span>: <span class="string">&quot;dbd597f0-46ed-4a21-83c5-c5a66fb90273&quot;</span>,</span><br><span class="line">  <span class="string">&quot;client_id&quot;</span>: <span class="string">&quot;f7n6ockwdb9zmayr&quot;</span>,</span><br><span class="line">  <span class="string">&quot;scope&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;user_info&quot;</span></span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>那么下一步我们实现资源服务器，我们来到我们之前搭建的另一个服务–spring_security_resource_server,首先我们将我们配置类之前在yaml配置的用来同步授权服务器那个服务中的资源服务器这部分配置代码先注释，这个是为了能更好的带大家体验jwtTokenStore</p>
 <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/03/13/spring-security-guide2/1695614760906.png" class="">
<p>然后在yaml配置和授权服务器相同的对称密钥：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">jwt:</span><br><span class="line">  key: MjWP5L7CiD</span><br></pre></td></tr></table></figure>

<p><strong>然后在资源服务器中配置tokenStore,这个你会发现要比redisTokenStore好配置很多，之前我们配置redisTokenStore的做法是在授权服务器中暴露一个获取角色资源的端点，然后用授权服务器的同一个服务中的资源服务器去保护这个端点，这样就避免了在其他资源服务器服务中引入过多依赖，尤其是对userDetails还做了定制的服务</strong>。</p>
<p><strong>但是jwtTokenStore不同，这个不需要我们引入过多依赖，所以我们可以试着通过在资源服务器中配置我们的jwtTokenStore</strong>。那么当时在授权服务器配置的资源服务器就没什么用了。那么回到正题，<strong>使用对称加密最重要的方式是确保密钥使用相同的值</strong>。资源服务器需要该密钥用来验证令牌的签名：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.config.annotation.web.configuration.EnableResourceServer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.config.annotation.web.configuration.ResourceServerConfigurerAdapter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.config.annotation.web.configurers.ResourceServerSecurityConfigurer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.token.TokenStore;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.token.store.JwtAccessTokenConverter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.token.store.JwtTokenStore;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableResourceServer</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ResourceServerConfig</span> <span class="keyword">extends</span> <span class="title class_">ResourceServerConfigurerAdapter</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line"></span><br><span class="line">	<span class="meta">@Value(&quot;$&#123;jwt.key&#125;&quot;)</span></span><br><span class="line">	<span class="keyword">private</span> String jwtKey;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(ResourceServerSecurityConfigurer resources)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		resources.tokenStore(tokenStore());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		http</span><br><span class="line">				.csrf().disable()</span><br><span class="line">				.exceptionHandling()</span><br><span class="line">				.authenticationEntryPoint((request, response, authException) -&gt; response.sendError(HttpServletResponse.SC_UNAUTHORIZED))</span><br><span class="line">				.and()</span><br><span class="line">				.authorizeRequests()</span><br><span class="line">				.antMatchers(<span class="string">&quot;/test/**&quot;</span>).authenticated()</span><br><span class="line">				.and()</span><br><span class="line">				.httpBasic();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="keyword">public</span> TokenStore <span class="title function_">tokenStore</span><span class="params">()</span>&#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">JwtTokenStore</span>(jwtAccessTokenConverter());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="keyword">public</span> JwtAccessTokenConverter <span class="title function_">jwtAccessTokenConverter</span><span class="params">()</span>&#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		<span class="type">JwtAccessTokenConverter</span> <span class="variable">jwtAccessTokenConverter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JwtAccessTokenConverter</span>();</span><br><span class="line">		jwtAccessTokenConverter.setSigningKey(jwtKey);</span><br><span class="line">		<span class="keyword">return</span> jwtAccessTokenConverter;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>现在可以启动资源服务器，并使用前面从授权服务器获得的有效JWT调用我们保护的资源。在这个示例中，必须将令牌添加到以”Bearer”为前缀的请求的Authorization HTTP头信息中：</p>
 <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/03/13/spring-security-guide2/1695614761197.png" class="">
<p>那么已上就是对称密钥对令牌进行签名和验证。</p>
<h3 id="使用通过JWT和非对称密钥签名的令牌"><a href="#使用通过JWT和非对称密钥签名的令牌" class="headerlink" title="使用通过JWT和非对称密钥签名的令牌"></a>使用通过JWT和非对称密钥签名的令牌</h3><p>本节将实现OAuth2身份验证的一个示例，其中授权服务器和资源服务器会使用一个非对称密钥对来对令牌签名和验证令牌。有时只让授权服务器和资源服务器共享一个密钥的做法是不可行的。通常，如果授权服务器和资源服务器不是由同一组织开发的，就会发生这种情况。在这种情况下，就可以认为授权服务器不“信任：资源服务器，因此我们不希望授权服务器与资源服务器共享密钥。而且，使用对称密钥，资源服务器就拥有了过多的功能：不仅可以验证令牌，还可以对它们签名（这种情况示例见下图）：</p>
 <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/03/13/spring-security-guide2/1695614761909.png" class="">
<p>ps:<strong>对称密钥是私钥。有该密钥的人可以用它进入系统，所以请永远不要在不安全通道交换对称密钥。如果需要在系统之外共享密钥，它就不应该是对称的</strong>！<br>当我们不能在授权服务器和资源服务器之间认定一种可信的关系时，就要使用非对称密钥对。由于这个原因，我们就需要知道如何实现这样的系统。</p>
<p>什么是非对称密钥对？它是如何工作的？这个概念很简单。非对称密钥对有两个密钥：一个称为私钥，另一个称为公钥。授权服务器将使用私钥对令牌进行签名，而其他人也只能使用私钥对令牌进行签名。</p>
 
<p>公钥与私钥是结合在一起的，这就是我们将其称为一对的原因。但是公钥只能用于验证签名。没有人可以使用公钥对令牌进行签名（见下图）</p>
 

<h3 id="1、生成密钥对"><a href="#1、生成密钥对" class="headerlink" title="1、生成密钥对"></a>1、生成密钥对</h3><p>本节将讲解如何生成一个非对称密钥对。这里需要一个密钥对用来配置后面实现的授权服务器和资源服务器。这是一个非对称密钥对（这意味着授权服务器使用它的私钥签署令牌，而资源服务器则使用公钥验证签名）。为了生成该密钥对，这里使用了keytool和OpenSSL,它们是两个简单易用的命令行工具。Java的JDK会安装keytool,所以我们的计算机一般都安装了它。而对于OpenSSL.则需要从<a target="_blank" rel="noopener" href="https://www.openssl.org/">官网</a>处下载它。如果使用OpenSSL自带的Git Bash,则不需要单独安装它。有了工具之后，需要运行两个命令：</p>
<ul>
<li><strong>生成一个私钥</strong></li>
<li><strong>获取之前所生成私钥的公钥</strong></li>
</ul>
<h4 id="1-1、生成一个私钥"><a href="#1-1、生成一个私钥" class="headerlink" title="1.1、生成一个私钥"></a>1.1、生成一个私钥</h4><p>要生成私钥，可以运行下面代码片段中的keytool命令。它将在名为mbw.jks的文件中生成一个私钥。这里还是用了密码”mbw123”保护私钥，并且使用别名”mbw”为密钥指定一个名称。在下面的命令中，可以看到用来生成密钥的算法，即RSA。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">keytool -genkeypair -alias mbw -keyalg RSA -keypass mbw123 -keystore mbw.jks -storepass mbw123</span><br></pre></td></tr></table></figure>

<p>运行后，回答相关问题生成你的dn后输入y,在keytool.exe所在文件夹下就生成了mbw.jks文件：</p>
 

<h4 id="1-2、获取公钥"><a href="#1-2、获取公钥" class="headerlink" title="1.2、获取公钥"></a>1.2、获取公钥</h4><p>要获取先前所生成私钥的公钥，可以运行这个keytool命令：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">keytool -list -rfc --keystore mbw.jks | openssl x509 -inform pem -pubkey</span><br></pre></td></tr></table></figure>

<p>在生成公钥时，系统会提示我们输入密码；这里使用的是mbw123.然后就可以在输出中找到公钥和证书。（对于本示例而言，只有密钥的值是必要的。）这个密钥应该类似于下面的代码片段：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">-----BEGIN PUBLIC KEY-----</span><br><span class="line">MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAo7HHwNVxcW6iYwyzqbMt</span><br><span class="line">awSkqiARgh6pz5eArBa1KzG3dCH8pupONozjD0G+PCAEu/hCwxEYglLHVLfcuQil</span><br><span class="line">8b8rWuGXVZgA+VHohEEO5KHibKqazGpJGSDQkJG6VNnfuMasZ7DUeQpyyUI6RRkz</span><br><span class="line">CSU7NuQAHHX5J9QEtrEAodv4Mpla1sKTraxMxjb3+BUtTFvW4iSr9fNJWyUsoxDs</span><br><span class="line">6mOhRYEOUUiBl2P8USm7HK7M7rWy90BRG7hOFvKKjXiyM+d2uRN6ASOWVQ168ZcD</span><br><span class="line">0iOdUeBF4sNowZWqWoY4DOiLp0bFRQIDkKuwxGvwrBRNA/K2J+HY0Jz2ULXhdGlU</span><br><span class="line">iQIDAQAB</span><br><span class="line">-----END PUBLIC KEY-----</span><br></pre></td></tr></table></figure>

<p>就是这样！现在我们有了一个用于JWT签名的私钥和一个用于验证签名的公钥。接下来只需要在授权和资源服务器中配置它们即可。</p>
<h4 id="1-3、实现使用私钥的授权服务器"><a href="#1-3、实现使用私钥的授权服务器" class="headerlink" title="1.3、实现使用私钥的授权服务器"></a>1.3、实现使用私钥的授权服务器</h4><p>本节要将授权服务器配置为使用私钥签名JWT。这里首先我们将之前的mbw.jks复制到应用程序的resources文件夹中。需要将密钥添加到resources文件夹中，因为直接从类路径读取它会更容易。但是，将其放入类路径中的做法并不是强制的。在application.yaml文件中，存储了文件名、密钥的别名，以及用于保护私钥而生成的密码。我们需要这些详细信息用来配置JwtTokenStore.下面代码片段展示了yaml文件中的内容：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">password: mbw123</span><br><span class="line">privateKey: mbw.jks</span><br><span class="line">alias: mbw</span><br></pre></td></tr></table></figure>

<p>与之前使用对称密钥相比，唯一更改的是JwtAccessTokenConverter对象的定义。这里仍然使用JwtTokenStore,我们仍将使用JwtAccessTokenConverter对象设置私钥。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.mbw.security.service.ClientDetailsServiceImpl;</span><br><span class="line"><span class="keyword">import</span> com.mbw.security.service.UserDetailsServiceImpl;</span><br><span class="line"><span class="keyword">import</span> com.mbw.security.token.JsonRedisTokenStore;</span><br><span class="line"><span class="keyword">import</span> com.mbw.security.token.enhancer.CustomTokenEnhancer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.io.ClassPathResource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.authentication.AuthenticationManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.config.annotation.configurers.ClientDetailsServiceConfigurer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.config.annotation.web.configuration.AuthorizationServerConfigurerAdapter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.config.annotation.web.configuration.EnableAuthorizationServer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.config.annotation.web.configurers.AuthorizationServerEndpointsConfigurer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.config.annotation.web.configurers.AuthorizationServerSecurityConfigurer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.token.DefaultTokenServices;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.token.TokenEnhancer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.token.TokenEnhancerChain;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.token.TokenStore;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.token.store.JwtAccessTokenConverter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.token.store.JwtTokenStore;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.token.store.KeyStoreKeyFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableAuthorizationServer</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AuthServerConfig</span> <span class="keyword">extends</span> <span class="title class_">AuthorizationServerConfigurerAdapter</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> AuthenticationManager authenticationManager;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> ClientDetailsServiceImpl clientDetailsServiceImpl;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> UserDetailsServiceImpl userDetailsServiceImpl;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> CustomTokenEnhancer customTokenEnhancer;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> JsonRedisTokenStore jsonRedisTokenStore;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Value(&quot;$&#123;jwt.key&#125;&quot;)</span></span><br><span class="line">	<span class="keyword">private</span> String jwtKey;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Value(&quot;$&#123;privateKey&#125;&quot;)</span></span><br><span class="line">	<span class="keyword">private</span> String privateKey;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Value(&quot;$&#123;password&#125;&quot;)</span></span><br><span class="line">	<span class="keyword">private</span> String password;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Value(&quot;$&#123;alias&#125;&quot;)</span></span><br><span class="line">	<span class="keyword">private</span> String alias;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthorizationServerEndpointsConfigurer endpoints)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		endpoints.authenticationManager(authenticationManager)</span><br><span class="line">				.userDetailsService(userDetailsServiceImpl)</span><br><span class="line">				.tokenEnhancer(tokenEnhancerChain())</span><br><span class="line">				.tokenStore(tokenStore());</span><br><span class="line">		<span class="type">DefaultTokenServices</span> <span class="variable">tokenService</span> <span class="operator">=</span> getTokenStore(endpoints);</span><br><span class="line">		endpoints.tokenServices(tokenService);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="keyword">public</span> TokenEnhancerChain <span class="title function_">tokenEnhancerChain</span><span class="params">()</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		<span class="type">TokenEnhancerChain</span> <span class="variable">enhancerChain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TokenEnhancerChain</span>();</span><br><span class="line">		List&lt;TokenEnhancer&gt; enhancers = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">		enhancers.add(jwtAccessTokenConverter());</span><br><span class="line">		enhancers.add(customTokenEnhancer);</span><br><span class="line">		enhancerChain.setTokenEnhancers(enhancers);<span class="comment">//将自定义Enhancer加入EnhancerChain的delegates数组中</span></span><br><span class="line">		<span class="keyword">return</span> enhancerChain;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//配置TokenService参数</span></span><br><span class="line">	<span class="keyword">private</span> DefaultTokenServices <span class="title function_">getTokenStore</span><span class="params">(AuthorizationServerEndpointsConfigurer endpoints)</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		<span class="type">DefaultTokenServices</span> <span class="variable">tokenService</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultTokenServices</span>();</span><br><span class="line">		tokenService.setTokenStore(endpoints.getTokenStore());</span><br><span class="line">		tokenService.setSupportRefreshToken(<span class="literal">true</span>);</span><br><span class="line">		tokenService.setClientDetailsService(endpoints.getClientDetailsService());</span><br><span class="line">		tokenService.setTokenEnhancer(endpoints.getTokenEnhancer());</span><br><span class="line">		<span class="comment">//token有效期 1小时</span></span><br><span class="line">		tokenService.setAccessTokenValiditySeconds(<span class="number">3600</span>);</span><br><span class="line">		<span class="comment">//token刷新有效期 15天</span></span><br><span class="line">		tokenService.setRefreshTokenValiditySeconds(<span class="number">3600</span> * <span class="number">12</span> * <span class="number">15</span>);</span><br><span class="line">		tokenService.setReuseRefreshToken(<span class="literal">false</span>);</span><br><span class="line">		<span class="keyword">return</span> tokenService;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(ClientDetailsServiceConfigurer clients)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		clients.withClientDetails(clientDetailsServiceImpl);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 解决访问/oauth/check_token 403的问题</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> security</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthorizationServerSecurityConfigurer security)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		<span class="comment">// 允许表单认证</span></span><br><span class="line">		security</span><br><span class="line">				.tokenKeyAccess(<span class="string">&quot;permitAll()&quot;</span>)</span><br><span class="line">				.checkTokenAccess(<span class="string">&quot;permitAll()&quot;</span>)</span><br><span class="line">				.allowFormAuthenticationForClients();</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="keyword">public</span> TokenStore <span class="title function_">tokenStore</span><span class="params">()</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">JwtTokenStore</span>(jwtAccessTokenConverter());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="keyword">public</span> JwtAccessTokenConverter <span class="title function_">jwtAccessTokenConverter</span><span class="params">()</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		<span class="type">JwtAccessTokenConverter</span> <span class="variable">jwtAccessTokenConverter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JwtAccessTokenConverter</span>();</span><br><span class="line">		<span class="type">KeyStoreKeyFactory</span> <span class="variable">keyStoreKeyFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">KeyStoreKeyFactory</span>(<span class="keyword">new</span> <span class="title class_">ClassPathResource</span>(privateKey), password.toCharArray());</span><br><span class="line">		jwtAccessTokenConverter.setKeyPair(keyStoreKeyFactory.getKeyPair(alias));</span><br><span class="line">		<span class="keyword">return</span> jwtAccessTokenConverter;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>现在可以启动该授权服务器并调用&#x2F;oauth&#x2F;token端点来生成一个新的访问令牌。当然，这里只是创建了一个普通的JWT，但是现在的区别是，要验证它的签名，需要使用密钥对中的公钥。</p>
<p>如果遇到启动报错说找不到jks文件的，把idea关了重启就好了，我idea2019.3是这样处理成功的，下面是postman的运行截图：</p>
 
<p>然后若现在我们使用这个token去请求资源服务器，肯定会失败的：</p>
 
<p>所以我们现在要去资源服务器配置公钥，在配置公钥之前，我们先把授权服务器的这行代码删除</p>
 
<p>原因之后会讲到。</p>
<p>首先在yaml文件配置公钥：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">jwt:</span><br><span class="line">  key: MjWP5L7CiD</span><br><span class="line">  publicKey: -----BEGIN PUBLIC KEY-----MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAo7HHwNVxcW6iYwyzqbMtawSkqiARgh6pz5eArBa1KzG3dCH8pupONozjD0G+PCAEu/hCwxEYglLHVLfcuQil8b8rWuGXVZgA+VHohEEO5KHibKqazGpJGSDQkJG6VNnfuMasZ7DUeQpyyUI6RRkzCSU7NuQAHHX5J9QEtrEAodv4Mpla1sKTraxMxjb3+BUtTFvW4iSr9fNJWyUsoxDs6mOhRYEOUUiBl2P8USm7HK7M7rWy90BRG7hOFvKKjXiyM+d2uRN6ASOWVQ168ZcD0iOdUeBF4sNowZWqWoY4DOiLp0bFRQIDkKuwxGvwrBRNA/K2J+HY0Jz2ULXhdGlUiQIDAQAB-----END PUBLIC KEY-----</span><br></pre></td></tr></table></figure>

<p>然后在资源服务器这块儿对公钥进行配置：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.config.annotation.web.configuration.EnableResourceServer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.config.annotation.web.configuration.ResourceServerConfigurerAdapter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.config.annotation.web.configurers.ResourceServerSecurityConfigurer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.token.TokenStore;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.token.store.JwtAccessTokenConverter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.token.store.JwtTokenStore;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableResourceServer</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ResourceServerConfig</span> <span class="keyword">extends</span> <span class="title class_">ResourceServerConfigurerAdapter</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line"></span><br><span class="line">	<span class="meta">@Value(&quot;$&#123;jwt.publicKey&#125;&quot;)</span></span><br><span class="line">	<span class="keyword">private</span> String publicKey;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(ResourceServerSecurityConfigurer resources)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		resources.tokenStore(tokenStore());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		http</span><br><span class="line">				.csrf().disable()</span><br><span class="line">				.exceptionHandling()</span><br><span class="line">				.authenticationEntryPoint((request, response, authException) -&gt; response.sendError(HttpServletResponse.SC_UNAUTHORIZED))</span><br><span class="line">				.and()</span><br><span class="line">				.authorizeRequests()</span><br><span class="line">				.antMatchers(<span class="string">&quot;/test/**&quot;</span>).authenticated()</span><br><span class="line">				.and()</span><br><span class="line">				.httpBasic();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="keyword">public</span> TokenStore <span class="title function_">tokenStore</span><span class="params">()</span>&#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">JwtTokenStore</span>(jwtAccessTokenConverter());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="keyword">public</span> JwtAccessTokenConverter <span class="title function_">jwtAccessTokenConverter</span><span class="params">()</span>&#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		<span class="type">JwtAccessTokenConverter</span> <span class="variable">jwtAccessTokenConverter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JwtAccessTokenConverter</span>();</span><br><span class="line">		jwtAccessTokenConverter.setVerifierKey(publicKey);</span><br><span class="line">		<span class="keyword">return</span> jwtAccessTokenConverter;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后启动资源服务器测试被保护的资源：</p>
 

<h3 id="2-1、使用一个暴露公钥的端点"><a href="#2-1、使用一个暴露公钥的端点" class="headerlink" title="2.1、使用一个暴露公钥的端点"></a>2.1、使用一个暴露公钥的端点</h3><p>本节将讨论一种让资源服务器获知公钥的方法–用授权服务器暴露公钥。还记得我们上一节将授权服务器删掉的那一行代码吗，这不就来了？在上一节中，我们使用了公私密钥对来对令牌进行签名和验证。其中在资源服务器配置了公钥。资源服务器使用公钥验证JWT。但是，如果想更改密钥时，会发生什么情况呢》最好不要永远保持同一份密钥对，这就是本节要实现的内容。随着时间的推移，应该定期旋转密钥！这将使得系统不容易受到密钥失窃的影响。</p>
 
<p>到目前为止，我们已经在授权服务器端配置了私钥，在资源服务器配置了公钥。而将密钥设置在两个地方使得密钥更难管理。不过如果只在一端配置它们，则可以更容易地管理键。解决方案是将整个密钥对迁至授权服务器端，并允许授权服务器使用端点暴露公钥。</p>
 
<p>那么下面就进入开发<br>对于授权服务器，我们保持和之前一样的配置即可，只需要能确保能够访问端点即可，也就是暴露公钥。的确，Spring Boot已经配置了这样的端点，但也只是这样而已。默认情况下，对该端点的所有请求都会被拒绝。我们需要重写该端点的配置，并允许任何具有客户端凭据的人访问它。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.mbw.security.service.ClientDetailsServiceImpl;</span><br><span class="line"><span class="keyword">import</span> com.mbw.security.service.UserDetailsServiceImpl;</span><br><span class="line"><span class="keyword">import</span> com.mbw.security.token.JsonRedisTokenStore;</span><br><span class="line"><span class="keyword">import</span> com.mbw.security.token.enhancer.CustomTokenEnhancer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.io.ClassPathResource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.authentication.AuthenticationManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.config.annotation.configurers.ClientDetailsServiceConfigurer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.config.annotation.web.configuration.AuthorizationServerConfigurerAdapter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.config.annotation.web.configuration.EnableAuthorizationServer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.config.annotation.web.configurers.AuthorizationServerEndpointsConfigurer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.config.annotation.web.configurers.AuthorizationServerSecurityConfigurer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.token.DefaultTokenServices;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.token.TokenEnhancer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.token.TokenEnhancerChain;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.token.TokenStore;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.token.store.JwtAccessTokenConverter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.token.store.JwtTokenStore;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.token.store.KeyStoreKeyFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableAuthorizationServer</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AuthServerConfig</span> <span class="keyword">extends</span> <span class="title class_">AuthorizationServerConfigurerAdapter</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> AuthenticationManager authenticationManager;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> ClientDetailsServiceImpl clientDetailsServiceImpl;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> UserDetailsServiceImpl userDetailsServiceImpl;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> CustomTokenEnhancer customTokenEnhancer;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> JsonRedisTokenStore jsonRedisTokenStore;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Value(&quot;$&#123;jwt.privateKey&#125;&quot;)</span></span><br><span class="line">	<span class="keyword">private</span> String privateKey;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Value(&quot;$&#123;jwt.password&#125;&quot;)</span></span><br><span class="line">	<span class="keyword">private</span> String password;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Value(&quot;$&#123;jwt.alias&#125;&quot;)</span></span><br><span class="line">	<span class="keyword">private</span> String alias;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthorizationServerEndpointsConfigurer endpoints)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		endpoints.authenticationManager(authenticationManager)</span><br><span class="line">				.userDetailsService(userDetailsServiceImpl)</span><br><span class="line">				.tokenEnhancer(tokenEnhancerChain())</span><br><span class="line">				.tokenStore(tokenStore());</span><br><span class="line">		<span class="type">DefaultTokenServices</span> <span class="variable">tokenService</span> <span class="operator">=</span> getTokenStore(endpoints);</span><br><span class="line">		endpoints.tokenServices(tokenService);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="keyword">public</span> TokenEnhancerChain <span class="title function_">tokenEnhancerChain</span><span class="params">()</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		<span class="type">TokenEnhancerChain</span> <span class="variable">enhancerChain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TokenEnhancerChain</span>();</span><br><span class="line">		List&lt;TokenEnhancer&gt; enhancers = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">		enhancers.add(jwtAccessTokenConverter());</span><br><span class="line">		enhancers.add(customTokenEnhancer);</span><br><span class="line">		enhancerChain.setTokenEnhancers(enhancers);<span class="comment">//将自定义Enhancer加入EnhancerChain的delegates数组中</span></span><br><span class="line">		<span class="keyword">return</span> enhancerChain;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//配置TokenService参数</span></span><br><span class="line">	<span class="keyword">private</span> DefaultTokenServices <span class="title function_">getTokenStore</span><span class="params">(AuthorizationServerEndpointsConfigurer endpoints)</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		<span class="type">DefaultTokenServices</span> <span class="variable">tokenService</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultTokenServices</span>();</span><br><span class="line">		tokenService.setTokenStore(endpoints.getTokenStore());</span><br><span class="line">		tokenService.setSupportRefreshToken(<span class="literal">true</span>);</span><br><span class="line">		tokenService.setClientDetailsService(endpoints.getClientDetailsService());</span><br><span class="line">		tokenService.setTokenEnhancer(endpoints.getTokenEnhancer());</span><br><span class="line">		<span class="comment">//token有效期 1小时</span></span><br><span class="line">		tokenService.setAccessTokenValiditySeconds(<span class="number">3600</span>);</span><br><span class="line">		<span class="comment">//token刷新有效期 15天</span></span><br><span class="line">		tokenService.setRefreshTokenValiditySeconds(<span class="number">3600</span> * <span class="number">12</span> * <span class="number">15</span>);</span><br><span class="line">		tokenService.setReuseRefreshToken(<span class="literal">false</span>);</span><br><span class="line">		<span class="keyword">return</span> tokenService;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(ClientDetailsServiceConfigurer clients)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		clients.withClientDetails(clientDetailsServiceImpl);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 解决访问/oauth/check_token 403的问题</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> security</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthorizationServerSecurityConfigurer security)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		<span class="comment">// 允许表单认证</span></span><br><span class="line">		security</span><br><span class="line">				.tokenKeyAccess(<span class="string">&quot;isAuthenticated()&quot;</span>)</span><br><span class="line">				.checkTokenAccess(<span class="string">&quot;permitAll()&quot;</span>)</span><br><span class="line">				.allowFormAuthenticationForClients();</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="keyword">public</span> TokenStore <span class="title function_">tokenStore</span><span class="params">()</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">JwtTokenStore</span>(jwtAccessTokenConverter());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="keyword">public</span> JwtAccessTokenConverter <span class="title function_">jwtAccessTokenConverter</span><span class="params">()</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		<span class="type">JwtAccessTokenConverter</span> <span class="variable">jwtAccessTokenConverter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JwtAccessTokenConverter</span>();</span><br><span class="line">		<span class="type">KeyStoreKeyFactory</span> <span class="variable">keyStoreKeyFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">KeyStoreKeyFactory</span>(<span class="keyword">new</span> <span class="title class_">ClassPathResource</span>(privateKey), password.toCharArray());</span><br><span class="line">		jwtAccessTokenConverter.setKeyPair(keyStoreKeyFactory.getKeyPair(alias));</span><br><span class="line">		<span class="keyword">return</span> jwtAccessTokenConverter;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>现在可以启动该授权服务器并调用&#x2F;oauth&#x2F;token_key端点来确保正确实现了配置。下面postman展示了其调用，我们需要使用Basic Auth输入资源服务器曾经注册的账号进行认证：</p>
 
<p>为了让资源服务器可以使用此端点并获得公钥，只需要在其属性文件中配置该端点和凭据即可。下面的配置代码展示了资源服务器的yaml新增配置：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">server:</span><br><span class="line">  port: <span class="number">9091</span></span><br><span class="line">spring:</span><br><span class="line">  datasource:</span><br><span class="line">    driver-class-name: com.mysql.jdbc.Driver</span><br><span class="line">    username: root</span><br><span class="line">    password: <span class="number">123456</span></span><br><span class="line">    url: jdbc:mysql:<span class="comment">//127.0.0.1:3306/spring_security?useUnicode=true&amp;characterEncoding=UTF-8&amp;useSSL=false&amp;allowPublicKeyRetrieval=true&amp;serverTimezone=Asia/Shanghai&amp;nullCatalogMeansCurrent=true</span></span><br><span class="line">    initialization-mode: always</span><br><span class="line">  redis配置</span><br><span class="line">  redis:</span><br><span class="line">    host: <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">    password: <span class="number">123456</span></span><br><span class="line">    port: <span class="number">6379</span></span><br><span class="line">jwt:</span><br><span class="line">  key: MjWP5L7CiD</span><br><span class="line">security:</span><br><span class="line">  oauth2:</span><br><span class="line">    resource:</span><br><span class="line">      jwt:</span><br><span class="line">        key-uri: http:<span class="comment">//localhost:9090/oauth/token_key</span></span><br><span class="line">    client:</span><br><span class="line">      client-id: resourceServer</span><br><span class="line">      client-secret: resourceServerSecret</span><br></pre></td></tr></table></figure>

<p>因为资源服务器现在从授权服务器的&#x2F;oauth&#x2F;token_key端点获取公钥，所以不需要在资源服务器配置类中配置它。资源服务器只需要配置保护的资源即可，如下面代码片段所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.config.annotation.web.configuration.EnableResourceServer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.config.annotation.web.configuration.ResourceServerConfigurerAdapter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableResourceServer</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ResourceServerConfig</span> <span class="keyword">extends</span> <span class="title class_">ResourceServerConfigurerAdapter</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">		http</span><br><span class="line">				.csrf().disable()</span><br><span class="line">				.exceptionHandling()</span><br><span class="line">				.authenticationEntryPoint((request, response, authException) -&gt; response.sendError(HttpServletResponse.SC_UNAUTHORIZED))</span><br><span class="line">				.and()</span><br><span class="line">				.authorizeRequests()</span><br><span class="line">				.antMatchers(<span class="string">&quot;/test/**&quot;</span>).authenticated()</span><br><span class="line">				.and()</span><br><span class="line">				.httpBasic();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>现在启动资源服务器，带着令牌访问被保护资源：</p>
 

</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a target="_blank" rel="noopener" href="http://ddkk.com/">ddkk</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="http://xeons.cn/2023/03/13/spring-security-guide2/">http://xeons.cn/2023/03/13/spring-security-guide2/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://xeons.cn" target="_blank">Calico's Space</a>！</span></div></div><script>function setClipboardText(event){
    let clipboardData = event.clipboardData || window.clipboardData;
    if (!clipboardData) { return; }
    event.preventDefault();
    let text = window.getSelection().toString();
    if (text) {
        event.preventDefault();
        var copyright = "\n\n---\n著作权归 ddkk 所有 \n原文链接: http://xeons.cn/2023/03/13/spring-security-guide2/";
        clipboardData.setData('text/plain', text + copyright);
    }
};
var contents = document.getElementsByClassName("post");
contents[0].addEventListener('copy',function(e){
    setClipboardText(e);
});</script><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/springSecurity/">springSecurity</a><a class="post-meta__tags" href="/tags/oauth2/">oauth2</a></div><div class="post_share"><div class="social-share" data-image="/2023/03/13/spring-security-guide2/logo.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i>赞助</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/images/wxpay.png" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images/wxpay.png" alt="wechat"/></a><div class="post-qr-code-desc">wechat</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2023/03/13/spring-security-guide/" title="spring security 快速使用 (1)"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/03/13/spring-security-guide/logo.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">spring security 快速使用 (1)</div></div></a></div><div class="next-post pull-right"><a href="/2023/03/05/spring-boot-guide/" title="spring-boot 常用配置（更新中)"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/03/05/spring-boot-guide/spring.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">spring-boot 常用配置（更新中)</div></div></a></div></nav><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="lv-container" data-id="city" data-uid="MTAyMC81OTczMi8zNjE5NA=="></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images/calico.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Calico</div><div class="author-info__description">It's my blog，Record everything！</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">62</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">35</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">27</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xeonsuo"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/xeonsuo" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="https://weibo.com/xeons" target="_blank" title="微博"><i class="fab fa-weibo" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:xeon511@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">python、aiAgent 进化中...</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Oauth2-%E6%A6%82%E5%BF%B5%E5%92%8C%E6%8E%88%E6%9D%83%E7%A0%81%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.</span> <span class="toc-text">Oauth2 概念和授权码模式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#OAuth2%E6%A1%86%E6%9E%B6"><span class="toc-number">1.1.</span> <span class="toc-text">OAuth2框架</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#OAuth2%E8%BA%AB%E4%BB%BD%E9%AA%8C%E8%AF%81%E6%9E%B6%E6%9E%84%E7%9A%84%E7%BB%84%E4%BB%B6"><span class="toc-number">1.2.</span> <span class="toc-text">OAuth2身份验证架构的组件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8OAuth2%E7%9A%84%E5%AE%9E%E7%8E%B0%E9%80%89%E9%A1%B9"><span class="toc-number">1.3.</span> <span class="toc-text">使用OAuth2的实现选项</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E6%8E%88%E6%9D%83%E7%A0%81%E6%8E%88%E6%9D%83%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.4.</span> <span class="toc-text">实现授权码授权类型</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%AD%A5%E9%AA%A41%EF%BC%9A%E4%BD%BF%E7%94%A8%E6%8E%88%E6%9D%83%E7%A0%81%E6%8E%88%E6%9D%83%E7%B1%BB%E5%9E%8B%E5%8F%91%E5%87%BA%E8%BA%AB%E4%BB%BD%E9%AA%8C%E8%AF%81%E8%AF%B7%E6%B1%82"><span class="toc-number">1.4.1.</span> <span class="toc-text">步骤1：使用授权码授权类型发出身份验证请求</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%AD%A5%E9%AA%A42%EF%BC%9A%E4%BD%BF%E7%94%A8%E6%8E%88%E6%9D%83%E7%A0%81%E6%8E%88%E6%9D%83%E7%B1%BB%E5%9E%8B%E8%8E%B7%E5%8F%96%E8%AE%BF%E9%97%AE%E4%BB%A4%E7%89%8C"><span class="toc-number">1.4.2.</span> <span class="toc-text">步骤2：使用授权码授权类型获取访问令牌</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%AD%A5%E9%AA%A43%EF%BC%9A%E4%BD%BF%E7%94%A8%E6%8E%88%E6%9D%83%E7%A0%81%E6%8E%88%E6%9D%83%E7%B1%BB%E5%9E%8B%E8%B0%83%E7%94%A8%E5%8F%97%E4%BF%9D%E6%8A%A4%E8%B5%84%E6%BA%90"><span class="toc-number">1.4.3.</span> <span class="toc-text">步骤3：使用授权码授权类型调用受保护资源</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AF%86%E7%A0%81%E6%A8%A1%E5%BC%8F%E3%80%81%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%A8%A1%E5%BC%8F%E3%80%81%E5%88%B7%E6%96%B0%E4%BB%A4%E7%89%8C"><span class="toc-number">2.</span> <span class="toc-text">密码模式、客户端模式、刷新令牌</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E5%AF%86%E7%A0%81%E6%8E%88%E6%9D%83%E7%B1%BB%E5%9E%8B"><span class="toc-number">2.1.</span> <span class="toc-text">实现密码授权类型</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%AD%A5%E9%AA%A41%EF%BC%9A%E4%BD%BF%E7%94%A8%E5%AF%86%E7%A0%81%E6%8E%88%E6%9D%83%E7%B1%BB%E5%9E%8B%E6%97%B6%E8%AF%B7%E6%B1%82%E8%AE%BF%E9%97%AE%E4%BB%A4%E7%89%8C"><span class="toc-number">2.1.1.</span> <span class="toc-text">步骤1：使用密码授权类型时请求访问令牌</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%AD%A5%E9%AA%A42%EF%BC%9A%E4%BD%BF%E7%94%A8%E5%AF%86%E7%A0%81%E6%8E%88%E6%9D%83%E7%B1%BB%E5%9E%8B%E6%97%B6%EF%BC%8C%E9%9C%80%E8%A6%81%E4%BD%BF%E7%94%A8%E8%AE%BF%E9%97%AE%E4%BB%A4%E7%89%8C%E8%B0%83%E7%94%A8%E8%B5%84%E6%BA%90"><span class="toc-number">2.1.2.</span> <span class="toc-text">步骤2：使用密码授权类型时，需要使用访问令牌调用资源</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%87%AD%E6%8D%AE%E6%8E%88%E6%9D%83%E7%B1%BB%E5%9E%8B"><span class="toc-number">2.2.</span> <span class="toc-text">实现客户端凭据授权类型</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%AD%A5%E9%AA%A41%EF%BC%9A%E4%BD%BF%E7%94%A8%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%87%AD%E6%8D%AE%E6%8E%88%E6%9D%83%E7%B1%BB%E5%9E%8B%E8%AF%B7%E6%B1%82%E8%AE%BF%E9%97%AE%E4%BB%A4%E7%89%8C"><span class="toc-number">2.2.1.</span> <span class="toc-text">步骤1：使用客户端凭据授权类型请求访问令牌</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%AD%A5%E9%AA%A42%EF%BC%9A%E4%BD%BF%E7%94%A8%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%87%AD%E6%8D%AE%E6%8E%88%E6%9D%83%E7%B1%BB%E5%9E%8B%E6%97%B6%EF%BC%8C%E5%8F%AF%E8%AE%BF%E9%97%AE%E4%BB%A4%E7%89%8C%E8%B0%83%E7%94%A8%E8%B5%84%E6%BA%90"><span class="toc-number">2.2.2.</span> <span class="toc-text">步骤2：使用客户端凭据授权类型时，可访问令牌调用资源</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E5%88%B7%E6%96%B0%E4%BB%A4%E7%89%8C%E8%8E%B7%E5%BE%97%E6%96%B0%E7%9A%84%E8%AE%BF%E9%97%AE%E4%BB%A4%E7%89%8C"><span class="toc-number">2.3.</span> <span class="toc-text">使用刷新令牌获得新的访问令牌</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84sso%E7%99%BB%E5%BD%95"><span class="toc-number">3.</span> <span class="toc-text">实现一个简单的sso登录</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E5%89%8D%E5%87%86%E5%A4%87"><span class="toc-number">3.1.</span> <span class="toc-text">项目前准备</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AE%A1%E7%90%86%E6%8E%88%E6%9D%83%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-number">3.2.</span> <span class="toc-text">管理授权服务器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%80%E5%A7%8B%E5%AE%9E%E7%8E%B0"><span class="toc-number">3.3.</span> <span class="toc-text">开始实现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C"><span class="toc-number">3.3.1.</span> <span class="toc-text">1准备工作</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%E3%80%81%E5%AE%9E%E7%8E%B0ClientRegistration"><span class="toc-number">3.3.2.</span> <span class="toc-text">2、实现ClientRegistration</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3%E3%80%81%E5%AE%9E%E7%8E%B0ClientRegistrationRepository"><span class="toc-number">3.3.3.</span> <span class="toc-text">3、实现ClientRegistrationRepository</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4%E3%80%81Spring-boot%E9%85%8D%E7%BD%AE%E7%9A%84%E7%BA%AF%E7%B2%B9%E6%96%B9%E5%BC%8F"><span class="toc-number">3.3.4.</span> <span class="toc-text">4、Spring boot配置的纯粹方式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5%E3%80%81%E6%B5%8B%E8%AF%95%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F"><span class="toc-number">3.3.5.</span> <span class="toc-text">5、测试应用程序</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E6%8E%88%E6%9D%83%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-number">4.</span> <span class="toc-text">实现授权服务器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%96%E5%86%99%E6%88%91%E4%BB%AC%E8%87%AA%E5%B7%B1%E7%9A%84%E6%8E%88%E6%9D%83%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%AE%9E%E7%8E%B0"><span class="toc-number">4.1.</span> <span class="toc-text">编写我们自己的授权服务器实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89%E7%94%A8%E6%88%B7%E7%AE%A1%E7%90%86"><span class="toc-number">4.2.</span> <span class="toc-text">定义用户管理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%91%E6%8E%88%E6%9D%83%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%B3%A8%E5%86%8C%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="toc-number">4.3.</span> <span class="toc-text">向授权服务器注册客户端</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E5%AF%86%E7%A0%81%E6%8E%88%E6%9D%83%E7%B1%BB%E5%9E%8B"><span class="toc-number">4.4.</span> <span class="toc-text">使用密码授权类型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%8E%88%E6%9D%83%E7%A0%81%E6%8E%88%E6%9D%83%E7%B1%BB%E5%9E%8B"><span class="toc-number">4.5.</span> <span class="toc-text">使用授权码授权类型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%87%AD%E6%8D%AE%E6%8E%88%E6%9D%83%E7%B1%BB%E5%9E%8B"><span class="toc-number">4.6.</span> <span class="toc-text">使用客户端凭据授权类型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E5%88%B7%E6%96%B0%E4%BB%A4%E7%89%8C%E6%8E%88%E6%9D%83%E7%B1%BB%E5%9E%8B"><span class="toc-number">4.7.</span> <span class="toc-text">使用刷新令牌授权类型</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E8%B5%84%E6%BA%90%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-number">5.</span> <span class="toc-text">实现资源服务器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E8%B5%84%E6%BA%90%E6%9C%8D%E5%8A%A1%E5%99%A8-1"><span class="toc-number">5.1.</span> <span class="toc-text">实现资源服务器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%9C%E7%A8%8B%E6%A3%80%E6%9F%A5%E4%BB%A4%E7%89%8C"><span class="toc-number">5.2.</span> <span class="toc-text">远程检查令牌</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E9%BB%91%E6%9D%BF%E6%A8%A1%E5%BC%8F"><span class="toc-number">5.3.</span> <span class="toc-text">实现黑板模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E7%9A%84tokenStore"><span class="toc-number">5.4.</span> <span class="toc-text">自定义的tokenStore</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0JsonRedisTokenStore"><span class="toc-number">5.5.</span> <span class="toc-text">实现JsonRedisTokenStore</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B5%84%E6%BA%90%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%85%8D%E7%BD%AE"><span class="toc-number">5.6.</span> <span class="toc-text">资源服务器配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%86JSON-Web-Token-JWT-%E7%94%A8%E4%BA%8E%E4%BB%A4%E7%89%8C%E5%AE%9E%E7%8E%B0%E3%80%82"><span class="toc-number">5.7.</span> <span class="toc-text">将JSON Web Token(JWT)用于令牌实现。</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8JWT%E4%BB%A5%E5%8F%8A%E5%AF%B9%E7%A7%B0%E7%A7%98%E9%92%A5%E7%AD%BE%E5%90%8D%E7%9A%84%E4%BB%A4%E7%89%8C"><span class="toc-number">5.7.1.</span> <span class="toc-text">使用JWT以及对称秘钥签名的令牌</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8JWT"><span class="toc-number">5.7.2.</span> <span class="toc-text">使用JWT</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%8E%88%E6%9D%83%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%BB%A5%E9%A2%81%E5%8F%91JWT"><span class="toc-number">5.7.3.</span> <span class="toc-text">使用授权服务器以颁发JWT</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E9%80%9A%E8%BF%87JWT%E5%92%8C%E9%9D%9E%E5%AF%B9%E7%A7%B0%E5%AF%86%E9%92%A5%E7%AD%BE%E5%90%8D%E7%9A%84%E4%BB%A4%E7%89%8C"><span class="toc-number">5.8.</span> <span class="toc-text">使用通过JWT和非对称密钥签名的令牌</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E7%94%9F%E6%88%90%E5%AF%86%E9%92%A5%E5%AF%B9"><span class="toc-number">5.9.</span> <span class="toc-text">1、生成密钥对</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1%E3%80%81%E7%94%9F%E6%88%90%E4%B8%80%E4%B8%AA%E7%A7%81%E9%92%A5"><span class="toc-number">5.9.1.</span> <span class="toc-text">1.1、生成一个私钥</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2%E3%80%81%E8%8E%B7%E5%8F%96%E5%85%AC%E9%92%A5"><span class="toc-number">5.9.2.</span> <span class="toc-text">1.2、获取公钥</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3%E3%80%81%E5%AE%9E%E7%8E%B0%E4%BD%BF%E7%94%A8%E7%A7%81%E9%92%A5%E7%9A%84%E6%8E%88%E6%9D%83%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-number">5.9.3.</span> <span class="toc-text">1.3、实现使用私钥的授权服务器</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1%E3%80%81%E4%BD%BF%E7%94%A8%E4%B8%80%E4%B8%AA%E6%9A%B4%E9%9C%B2%E5%85%AC%E9%92%A5%E7%9A%84%E7%AB%AF%E7%82%B9"><span class="toc-number">5.10.</span> <span class="toc-text">2.1、使用一个暴露公钥的端点</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2024/09/09/ai-pandas1/" title="AI之 panda"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2024/09/09/ai-pandas1/algorithm_complexity_1.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="AI之 panda"/></a><div class="content"><a class="title" href="/2024/09/09/ai-pandas1/" title="AI之 panda">AI之 panda</a><time datetime="2024-09-09T06:45:07.000Z" title="发表于 2024-09-09 14:45:07">2024-09-09</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/09/09/ai-python1/" title="AI之 python 基础"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2024/09/09/ai-python1/algorithm_complexity_1.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="AI之 python 基础"/></a><div class="content"><a class="title" href="/2024/09/09/ai-python1/" title="AI之 python 基础">AI之 python 基础</a><time datetime="2024-09-09T05:45:07.000Z" title="发表于 2024-09-09 13:45:07">2024-09-09</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/04/09/1gneicun1yishuju/" title="1g内存如何存储1亿数据"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2024/04/09/1gneicun1yishuju/algorithm_complexity_1.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="1g内存如何存储1亿数据"/></a><div class="content"><a class="title" href="/2024/04/09/1gneicun1yishuju/" title="1g内存如何存储1亿数据">1g内存如何存储1亿数据</a><time datetime="2024-04-09T06:45:07.000Z" title="发表于 2024-04-09 14:45:07">2024-04-09</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/04/09/40yiqqhaoquchong/" title="上亿号码去重方案"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2024/04/09/40yiqqhaoquchong/640.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="上亿号码去重方案"/></a><div class="content"><a class="title" href="/2024/04/09/40yiqqhaoquchong/" title="上亿号码去重方案">上亿号码去重方案</a><time datetime="2024-04-09T06:45:07.000Z" title="发表于 2024-04-09 14:45:07">2024-04-09</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/04/09/alibaba_seata/" title="seate中的tcc"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2024/04/09/alibaba_seata/640.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="seate中的tcc"/></a><div class="content"><a class="title" href="/2024/04/09/alibaba_seata/" title="seate中的tcc">seate中的tcc</a><time datetime="2024-04-09T06:45:07.000Z" title="发表于 2024-04-09 14:45:07">2024-04-09</time></div></div></div></div></div></div></main><footer id="footer" style="background: none"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2025 By Calico</div><div class="footer_custom_text"><a href="icp"><span>Create By hexo,butterfly</span></a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=4.13.0"></script><script src="/js/main.js?v=4.13.0"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload@17.8.8/dist/lazyload.iife.min.js"></script><div class="js-pjax"><script>(() => {
  const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
  if ($mermaid.length === 0) return
  const runMermaid = () => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    Array.from($mermaid).forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const mermaidThemeConfig = '%%{init:{ \'theme\':\'' + theme + '\'}}%%\n'
      const mermaidID = 'mermaid-' + index
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)

      const renderV10 = () => {
        renderFn.then(({svg}) => {
          mermaidSrc.insertAdjacentHTML('afterend', svg)
        })
      }

      const renderV9 = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      typeof renderFn === 'string' ? renderV9(renderFn) : renderV10()
    })
  }

  const loadMermaid = () => {
    window.loadMermaid ? runMermaid() : getScript('https://cdn.jsdelivr.net/npm/mermaid@10.8.0/dist/mermaid.min.js').then(runMermaid)
  }

  btf.addGlobalFn('themeChange', runMermaid, 'mermaid')

  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script><script>(()=>{
  const loadLivere = () => {
    if (typeof LivereTower === 'object') window.LivereTower.init()
    else {
      (function(d, s) {
          var j, e = d.getElementsByTagName(s)[0];
          if (typeof LivereTower === 'function') { return; }
          j = d.createElement(s);
          j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
          j.async = true;
          e.parentNode.insertBefore(j, e);
      })(document, 'script');
    }
  }

  if ('Livere' === 'Livere' || !false) {
    if (false) btf.loadComment(document.getElementById('lv-container'), loadLivere)
    else loadLivere()
  } else {
    window.loadOtherComment = loadLivere
  }
})()</script></div><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="false" data-click="true"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>