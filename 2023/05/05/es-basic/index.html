<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>ElasticSearch 介绍 | Calico's Space</title><meta name="author" content="Calico"><meta name="copyright" content="Calico"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="相关概念1 Elasticsearch概述1.1 Elasticsearch是什么Elasticsearch(ES)是一个基于Apache的开源索引库Lucene而构建的 开源、分布式、具有RESTful接口的全文搜索引擎, 还是一个 分布式文档数据库. ES可以轻松扩展数以百计的服务器(水平扩展), 用于存储和处理数据. 它可以在很短的时间内存储、搜索和分析海量数据, 通常被作为复杂搜索场景下的">
<meta property="og:type" content="article">
<meta property="og:title" content="ElasticSearch 介绍">
<meta property="og:url" content="http://xeons.cn/2023/05/05/es-basic/index.html">
<meta property="og:site_name" content="Calico&#39;s Space">
<meta property="og:description" content="相关概念1 Elasticsearch概述1.1 Elasticsearch是什么Elasticsearch(ES)是一个基于Apache的开源索引库Lucene而构建的 开源、分布式、具有RESTful接口的全文搜索引擎, 还是一个 分布式文档数据库. ES可以轻松扩展数以百计的服务器(水平扩展), 用于存储和处理数据. 它可以在很短的时间内存储、搜索和分析海量数据, 通常被作为复杂搜索场景下的">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://xeons.cn/2023/05/05/es-basic/logo.jpg">
<meta property="article:published_time" content="2023-05-04T16:00:00.000Z">
<meta property="article:author" content="Calico">
<meta property="article:tag" content="java">
<meta property="article:tag" content="elasticsearch">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://xeons.cn/2023/05/05/es-basic/logo.jpg"><link rel="shortcut icon" href="/images/calico-ss.png"><link rel="canonical" href="http://xeons.cn/2023/05/05/es-basic/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//hm.baidu.com"/><meta/><link rel="stylesheet" href="/css/index.css?v=4.13.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?6f97e3791752fae830e3db5ba194c6cb";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.11.1/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'ElasticSearch 介绍',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-03-12 21:47:48'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.1.1"><link rel="alternate" href="/atom.xml" title="Calico's Space" type="application/atom+xml">
</head><body><script>window.paceOptions = {
  restartOnPushState: false
}

document.addEventListener('pjax:send', () => {
  Pace.restart()
})
</script><link rel="stylesheet" href="/css/loading_bar.css"/><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images/calico.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">33</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">23</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">22</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list hide"></i><span> 其他</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/demopage/"><i class="fa-fw fas fa-music"></i><span> Theme测试页</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="not-top-img" id="page-header"><nav id="nav"><span id="blog-info"><a href="/" title="Calico's Space"><span class="site-name">Calico's Space</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list hide"></i><span> 其他</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/demopage/"><i class="fa-fw fas fa-music"></i><span> Theme测试页</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav></header><main class="layout" id="content-inner"><div id="post"><div id="post-info"><h1 class="post-title">ElasticSearch 介绍</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="fa-fw post-meta-icon far fa-calendar-alt"></i><span class="post-meta-label">发表于</span><time datetime="2023-05-04T16:00:00.000Z" title="发表于 2023-05-05 00:00:00">2023-05-05</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%8A%80%E6%9C%AF/">技术</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%8A%80%E6%9C%AF/java/">java</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%8A%80%E6%9C%AF/java/es/">es</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">25.2k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>103分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="ElasticSearch 介绍"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div><article class="post-content" id="article-container"><h2 id="相关概念"><a href="#相关概念" class="headerlink" title="相关概念"></a>相关概念</h2><h3 id="1-Elasticsearch概述"><a href="#1-Elasticsearch概述" class="headerlink" title="1 Elasticsearch概述"></a>1 Elasticsearch概述</h3><h4 id="1-1-Elasticsearch是什么"><a href="#1-1-Elasticsearch是什么" class="headerlink" title="1.1 Elasticsearch是什么"></a>1.1 Elasticsearch是什么</h4><p>Elasticsearch(ES)是一个基于Apache的开源索引库Lucene而构建的 <strong>开源、分布式、具有RESTful接口的全文搜索引擎</strong>, 还是一个 <strong>分布式文档数据库</strong>.</p>
<p>ES可以轻松扩展数以百计的服务器(水平扩展), 用于存储和处理数据. 它可以在很短的时间内存储、搜索和分析海量数据, 通常被作为复杂搜索场景下的核心引擎.</p>
<blockquote>
<p>由于Lucene提供的API操作起来非常繁琐, 需要编写大量的代码, Elasticsearch对Lucene进行了封装与优化, 并提供了REST风格的操作接口, 开箱即用, 很大程度上方便了开发人员的使用.</p>
</blockquote>
<h4 id="1-2-Elasticsearch的优点"><a href="#1-2-Elasticsearch的优点" class="headerlink" title="1.2 Elasticsearch的优点"></a>1.2 Elasticsearch的优点</h4><blockquote>
<p>1、横向可扩展性: 作为大型分布式集群, 很容易就能扩展新的服务器到ES集群中; 也可运行在单机上作为轻量级搜索引擎使用.<br>2、更丰富的功能: 与传统关系型数据库相比, ES提供了全文检索、同义词处理、相关度排名、复杂数据分析、海量数据的近实时处理等功能.<br>3、分片机制提供更好地分布性: 同一个索引被分为多个分片(Shard), 利用分而治之的思想提升处理效率.<br>4、高可用: 提供副本(Replica)机制, 一个分片可以设置多个副本, 即使在某些服务器宕机后, 集群仍能正常工作.<br>5、开箱即用: 提供简单易用的API, 服务的搭建、部署和使用都很容易操作.</p>
</blockquote>
<h4 id="1-3-Elasticsearch的相关产品"><a href="#1-3-Elasticsearch的相关产品" class="headerlink" title="1.3 Elasticsearch的相关产品"></a>1.3 Elasticsearch的相关产品</h4><blockquote>
<p>1、Beats: 是一个代理, 将不同类型的数据发送到Elasticsearch中.<br>2、Shield: 提供基于角色的访问控制与审计, 加密通信、认证保护整个ES的数据, 为ES带来企业级的安全性 — 收费产品.<br>3、Watcher: 是ES的警报和通知工具, 检测ES的状态, 在异常发生时进行提醒 — 收费产品.<br>4、Marvel: 是ES的管理和监控工具, 检测ES集群的索引和节点的活动 — 收费产品.</p>
</blockquote>
<h4 id="1-4-Elasticsearch的使用场景"><a href="#1-4-Elasticsearch的使用场景" class="headerlink" title="1.4 Elasticsearch的使用场景"></a>1.4 Elasticsearch的使用场景</h4><blockquote>
<p>1、维基百科(类似百度百科): 全文检索, 高亮, 搜索推荐;<br>2、The Guardian(新闻网站): 用户行为日志(点击, 浏览, 收藏, 评论) + 社交网络数据(对某某新闻的相关看法), 数据分析(将公众对文章的反馈提交至文章作者);<br>3、Stack Overflow(IT技术论坛): 全文检索, 搜索相关问题和答案;<br>4、GitHub(开源代码管理), 搜索管理其托管的上千亿行代码;<br>5、日志数据分析: ELK技术栈(Elasticsearch + Logstash + Kibana)对日志数据进行采集&amp;分析;<br>6、商品价格监控网站: 用户设定某商品的价格阈值, 当价格低于该阈值时, 向用户推送降价消息;<br>7、BI系统(Business Intelligence, 商业智能): 分析某区域最近3年的用户消费额的趋势、用户群体的组成结构等;<br>8、其他应用: 电商、招聘、门户等网站的内部搜索服务, IT系统(OA, CRM, ERP等)的内部搜索服务、数据分析(ES的又一热门使用场景).</p>
</blockquote>
<h3 id="2-Elasticsearch的功能概述"><a href="#2-Elasticsearch的功能概述" class="headerlink" title="2 Elasticsearch的功能概述"></a>2 Elasticsearch的功能概述</h3><h4 id="2-1-分布式的搜索引擎和数据分析引擎"><a href="#2-1-分布式的搜索引擎和数据分析引擎" class="headerlink" title="2.1 分布式的搜索引擎和数据分析引擎"></a>2.1 分布式的搜索引擎和数据分析引擎</h4><blockquote>
<p>1、搜索: 谷歌, 百度, 各大网站的站内搜索(如淘宝网的商品搜索), IT系统的检索(如OA内部的信息查询);<br>2、数据分析: 电商网站中, 对形如最近30天IT书籍销量排名前10的商家有哪些; 新闻网站中: 最近7天访问量排名Top 10的新闻是哪些……</p>
</blockquote>
<p>总结: <strong>Elasticsearch适用于 在较大用户量、较高访问量的分布式系统中, 对数据进行搜索与分析</strong>.</p>
<h4 id="2-2-全文检索-结构化检索-数据分析"><a href="#2-2-全文检索-结构化检索-数据分析" class="headerlink" title="2.2 全文检索 结构化检索 数据分析"></a>2.2 全文检索 结构化检索 数据分析</h4><blockquote>
<p>1、全文检索: 搜索商品名称包含”编程思想”的商品: <code>select * from products where product_name like &quot;%编程思想%&quot;</code>;<br>2、结构化检索: 搜索商品分类为”计算机科学”的所有商品: <code>select * from products where category_name=&#39;计算机科学&#39;</code>;<br>3、数据分析: 分析每一种商品分类下有多少件商品: <code>select category_name, count(*) from products group by category_name</code>;<br>4、其他个性化搜索需求: 部分匹配、自动完成(输入联想)、搜索纠错、搜索推荐……</p>
</blockquote>
<h4 id="2-3-海量数据的近实时处理"><a href="#2-3-海量数据的近实时处理" class="headerlink" title="2.3 海量数据的近实时处理"></a>2.3 海量数据的近实时处理</h4><blockquote>
<p>1、分布式: Elasticsearch可将海量数据自动分发到多台服务器上, 进行存储和检索;<br>2、海量数据的处理: 分布式系统构建完成后, 就可通过大规模服务器集群去存储和检索数据 —— 服务器有了处理海量数据的能力;<br>3、基于Elasticsearch的搜索和分析服务可达到秒级响应.</p>
</blockquote>
<p><strong>关于近实时:</strong></p>
<p><strong>非近实时</strong>: 检索x个数据要花费很长时间(这就不是近实时, 而是离线批处理, batch-processing).<br><strong>实时</strong>: 数据的处理与响应都是立即呈现的, 几乎没有间隔, 这在大数据应用场景下是很难达到的要求.<br><strong>近实时(near real-time, NRT): 对海量数据进行搜索和分析的响应耗时控制在秒级以内, 方可称为近实时.</strong></p>
<h3 id="3-Elasticsearch的架构"><a href="#3-Elasticsearch的架构" class="headerlink" title="3 Elasticsearch的架构"></a>3 Elasticsearch的架构</h3><p>结合Elasticsearch架构图进行相关概念的介绍:</p>
 <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/05/05/es-basic/1699264203691.png" class="">

<h4 id="3-1-gateway-门户、网关"><a href="#3-1-gateway-门户、网关" class="headerlink" title="3.1 gateway - 门户、网关"></a>3.1 gateway - 门户、网关</h4><blockquote>
<p>ES索引的持久化存储方式, 也就是各类文件系统. 默认是先把索引存放到内存中, 当内存满了时再持久化到硬盘.<br>ES集群重新启动时就会从gateway中读取索引数据.<br>ES支持多种类型的gateway: 本地文件系统(默认), 分布式文件系统, Hadoop的HDFS, 以及Amazon的S3云存储服务等.</p>
</blockquote>
<h4 id="3-2-Lucene-分布式Lucene目录"><a href="#3-2-Lucene-分布式Lucene目录" class="headerlink" title="3.2 Lucene - 分布式Lucene目录"></a>3.2 Lucene - 分布式Lucene目录</h4><blockquote>
<p>Gateway的上层是一个分布式的Lucene框架, Lucene之上是ES的模块, 包括:索引模块、搜索模块、映射解析模块等.</p>
</blockquote>
<h4 id="3-2-Discovery-发现服务"><a href="#3-2-Discovery-发现服务" class="headerlink" title="3.2 Discovery - 发现服务"></a>3.2 Discovery - 发现服务</h4><blockquote>
<p>Discovery是ES的节点发现模块, 要组成集群, 不同的节点之间就需要进行通信.<br>ES集群内部需要选举master节点, 这些工作都是由Discovery模块完成的.<br>ES支持多种发现机制, 如Zen(默认)、EC2、Gce、Azure等.<br>ES是一个基于p2p的系统: <strong>先通过广播寻找存在的节点, 再通过多播协议进行节点之间的通信, 同时也支持点对点的交互.</strong><br>5.x版本关闭了广播, 要开启就需要开发人员自定义.</p>
</blockquote>
<h4 id="3-3-Scripting-脚本"><a href="#3-3-Scripting-脚本" class="headerlink" title="3.3 Scripting - 脚本"></a>3.3 Scripting - 脚本</h4><blockquote>
<p>ES支持在查询语句中插入JavaScript、Python等脚本 —— 由Scripting模块负责解析这些脚本.<br>使用脚本语句时查询性能可能会稍有降低.</p>
</blockquote>
<h4 id="3-4-3rd-Plugins-三方插件"><a href="#3-4-3rd-Plugins-三方插件" class="headerlink" title="3.4 3rd Plugins - 三方插件"></a>3.4 3rd Plugins - 三方插件</h4><p>ES对三方插件的支持非常友好, 因此其开源生态的构建也越发活跃、成熟.</p>
<h4 id="3-5-Transport-通信模块"><a href="#3-5-Transport-通信模块" class="headerlink" title="3.5 Transport - 通信模块"></a>3.5 Transport - 通信模块</h4><blockquote>
<p>ES内部节点或集群与客户端的交互方式, 节点间通信端口默认为: <code>9300 - 9400</code>.<br>ES默认使用TCP协议进行交互, 同时也支持HTTP协议(JSON格式)、Thrift、Servlet、Memcached、ZeroMQ等的传输协议(通过插件方式集成).</p>
</blockquote>
<h4 id="3-6-JMX-Java管理框架"><a href="#3-6-JMX-Java管理框架" class="headerlink" title="3.6 JMX - Java管理框架"></a>3.6 JMX - Java管理框架</h4><p>ES通过Java管理框架JMX来管理其应用.</p>
<h4 id="3-7-RESTful-style-API-与集群进行交互"><a href="#3-7-RESTful-style-API-与集群进行交互" class="headerlink" title="3.7 RESTful style API - 与集群进行交互"></a>3.7 RESTful style API - 与集群进行交互</h4><p>ES最上层是提供给用户的接口, 可以通过RESTful接口与ES集群进行交互.</p>
<h4 id="4-Elasticsearch索引相关概念"><a href="#4-Elasticsearch索引相关概念" class="headerlink" title="4 Elasticsearch索引相关概念"></a>4 Elasticsearch索引相关概念</h4><h4 id="4-1-term-索引词"><a href="#4-1-term-索引词" class="headerlink" title="4.1 term(索引词)"></a>4.1 term(索引词)</h4><blockquote>
<p>在ES中, 索引词(term)是一个能够被索引的精确值, 可以通过<code>term query</code>进行准确搜索. 比如: foo、Foo、FOO都是不同的索引词.</p>
</blockquote>
<h4 id="4-2-text-文本"><a href="#4-2-text-文本" class="headerlink" title="4.2 text(文本)"></a>4.2 text(文本)</h4><blockquote>
<p>文本是一段普通的非结构化文字, 通常文本会被分析成多个Term, 存储在ES的索引库中.<br>文本字段一般需要先分析再存储, 查询文本中的关键词时, 需要根据搜索条件搜索出原文本.</p>
</blockquote>
<h4 id="4-3-analysis-分析"><a href="#4-3-analysis-分析" class="headerlink" title="4.3 analysis(分析)"></a>4.3 analysis(分析)</h4><blockquote>
<p>分析是将文本转换为索引词的过程, 分析的结果依赖于分词器.<br>比如: <code>FOO BAR</code>、<code>Foo-Bar</code>和<code>foo bar</code>可能会被分析成相同的索引词<code>foo</code>和<code>bar</code>, 然后被存储到ES的索引库中. 当通过<code>FoO:bAr</code>进行全文搜索的时候, 搜索引擎根据匹配计算也能在索引库中查找到相关的内容.</p>
</blockquote>
<h4 id="4-4-cluster-集群"><a href="#4-4-cluster-集群" class="headerlink" title="4.4 cluster(集群)"></a>4.4 cluster(集群)</h4><blockquote>
<p>集群由一至多个节点组成, 对外提供索引和搜索服务. 一个节点只能加入到一个集群中.<br><strong>集群中有且只能有一个节点会被选举为主节点</strong> —— 主从节点是集群内部的说法, 对用户是透明的; ES做到了去中心化: 访问任一节点等价于访问整个集群.<br><strong>同一网络中, 每个ES集群都要有唯一的名称用于区分, 默认的集群名称为”elasticsearch”.</strong><br>水平扩展时, 只需要将新增节点的集群名称设置为要扩容的集群名称, 该节点就会自动加入集群中.</p>
</blockquote>
<h4 id="4-5-node-节点"><a href="#4-5-node-节点" class="headerlink" title="4.5 node(节点)"></a>4.5 node(节点)</h4><blockquote>
<p>节点是逻辑上独立的服务, 是集群的一部分, 可以存储数据, 并参与集群的索引和检索功能.<br>节点也有唯一的名称, 用于集群的管理和通信, 节点名称在节点启动时自动分配一个随机的UUID的前7个字符 —— 当然可以自定义.<br><strong>如果有多个节点在运行, 默认情况下, 这些节点会自动组成一个名为Elasticsearch的集群.</strong><br>如果只有一个节点在运行, 该节点就会组成只有一个节点的名为Elasticsearch的集群.<br>每个节点属于哪个集群是通过”集群名称”来决定的.</p>
</blockquote>
<h4 id="4-6-shard-分片"><a href="#4-6-shard-分片" class="headerlink" title="4.6 shard(分片)"></a>4.6 shard(分片)</h4><blockquote>
<p>单台机器(节点)无法存储大量的索引数据, ES可以把一个完整的索引分成多个分片, 分布到不同的节点上, 从而构成分布式索引.<br>每个分片都是一个Lucene实例, 也就是说每个分片底层都有一个单独的Lucene提供独立的索引和检索服务, 它们可以托管在集群的任一节点上.<br>单个Lucene中存储的索引文档最大值为 <code>lucene-5843</code>, 极限是<code>2147483519(=integer.max_value - 128)</code> 个文档. 可使用<code>_cat/shards</code> API 监控分片的大小.</p>
</blockquote>
<p>(1)分片的好处:</p>
<blockquote>
<p>允许水平切分&#x2F;扩展集群容量;<br>可在多个分片上进行分布式的、并行的操作, 提高系统的性能和吞吐量.</p>
</blockquote>
<p>(2)使用注意事项:</p>
<p><strong>分片的数量只能在创建索引前指定, 创建索引后不能修改.</strong><br><strong>5.x 版本默认不能通过配置文件elasticsearch.yml定义分片个数.</strong></p>
<h4 id="4-7-replica-副本"><a href="#4-7-replica-副本" class="headerlink" title="4.7 replica(副本)"></a>4.7 replica(副本)</h4><blockquote>
<p>ES支持为每个Shard创建多个副本, 相当于索引数据的冗余备份.<br><strong>分片有Primary Shard(主分片)、Replica Shard(副本分片), 建立索引时, 系统会先将索引存储在主分片中, 然后再将主分片中的索引复制到不同的副本中.</strong></p>
</blockquote>
<p><strong>(1) 副本的重要性:</strong></p>
<p><strong>1、</strong> 解决单点问题, 提高可用性和容错性: 某个节点失败时服务不受影响, 可以从副本中恢复;<br><strong>2、</strong> 提高查询效率和查询时的吞吐量: 搜索可以在所有的副本上并行执行, 提高了服务的并发量.</p>
<p>(2)使用注意事项:</p>
<p><strong>主分片在建立索引时设置, 后期不能修改;</strong></p>
<blockquote>
<p>主分片和副本分片不能存储在同一个节点中 —— 无法保证高可用.<br><strong>5.x版本中, 默认主分片为5个, 默认副本分片数为1个, 即每个主分片各有1个副本分片(共5个副本分片); 可随时修改副本分片的数量.</strong><br>默认情况下, 每个索引共有 <code>5 primary shard + 5 * 1 replica shard = 10 shard</code>.<br>集群中至少要有2个节点, 这是最少的高可用配置.</p>
</blockquote>
<h4 id="4-8-river-数据源"><a href="#4-8-river-数据源" class="headerlink" title="4.8 river(数据源)"></a>4.8 river(数据源)</h4><blockquote>
<p>从其他存储方式 (如数据库) 中同步数据到ES的方法, 它是以插件方式存在的一个ES服务, 通过读取river中的数据并把它索引到ES中.<br>官方的river有CouchDB、RabbitMQ、Twitter、Wikipedia等.</p>
</blockquote>
<h4 id="4-9-index-索引"><a href="#4-9-index-索引" class="headerlink" title="4.9 index(索引)"></a>4.9 index(索引)</h4><blockquote>
<p>索引是具有相似结构的文档的集合, 等同于Solr中的集合, 比如可以有一个商品分类索引, 订单索引.<br>每个索引都要有唯一的名称, 名称要小写, 通过索引名称来执行索引、搜索、更新和删除等操作.<br><strong>一个集群中可以有任意多个索引, 只要保证名称不同即可.</strong></p>
</blockquote>
<h4 id="4-10-type-类型"><a href="#4-10-type-类型" class="headerlink" title="4.10 type(类型)"></a>4.10 type(类型)</h4><blockquote>
<p>type是index的逻辑分类, <strong>在ES 6.x版本之前, 每个索引中可以定义一个或多个type, 而在6.X版本之后, 一个index中只能定义一个type</strong>.<br>一种type一般被定义为具有一组公共field的document, 比如对博客系统中的数据建立索引, 可以定义用户数据type, 博客数据type, 评论数据type, 也就是每个document都必须属于某一个具体的type, 也就是说每个document都有<code>_type</code>属性.</p>
</blockquote>
<h4 id="4-11-document-文档"><a href="#4-11-document-文档" class="headerlink" title="4.11 document(文档)"></a>4.11 document(文档)</h4><blockquote>
<p>文档是存储在ES中的一个个JSON格式的字符串, 是ES索引中的最小数据单元, 由field(字段)构成.<br>一个document可以是一条商品分类数据, 一条订单数据, 例如:</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">book document</span><br><span class="line">&#123;</span><br><span class="line"> <span class="string">&quot;book_id&quot;</span>: <span class="string">&quot;1&quot;</span>,</span><br><span class="line"> <span class="string">&quot;book_name&quot;</span>: <span class="string">&quot;Thinking in Java(Java 编程思想)&quot;</span>,</span><br><span class="line"> <span class="string">&quot;book_desc&quot;</span>: <span class="string">&quot;Java学习者不得不看的经典书籍&quot;</span>,</span><br><span class="line"> <span class="string">&quot;book_price&quot;</span>: <span class="number">108.00</span>,</span><br><span class="line"> <span class="string">&quot;category_id&quot;</span>: <span class="string">&quot;5&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="4-12-mapping-映射"><a href="#4-12-mapping-映射" class="headerlink" title="4.12 mapping(映射)"></a>4.12 mapping(映射)</h4><blockquote>
<p>类似于关系数据库中的Table结构, 每个index都有一个映射: 定义索引中每个字段的类型.<br><strong>所有文档在写进索引之前都会先进行分析, 如何对文本进行分词、哪些词条又会被过滤, 这类行为叫做映射(mapping).</strong><br>映射可以提前定义, 也可以在第一次存储文档时自动识别. 一般由用户自己定义规则.<br>类似于Solr中<code>schema.xml</code>约束文件的作用.</p>
</blockquote>
<h4 id="4-13-field-字段"><a href="#4-13-field-字段" class="headerlink" title="4.13 field(字段)"></a>4.13 field(字段)</h4><blockquote>
<p>字段可以是一个简单的值(如字符串、数字、日期), 也可以是一个数组, 还可以嵌套一个对象或多个对象.<br>字段类似于关系数据库中表数据的列, 每个字段都对应一个类型.<br>可以指定如何分析某一字段的值, 即对field指定分词器.</p>
</blockquote>
<p><strong>ES的索引中, 各概念的关系为: <code>Field --&gt; Document --&gt; Type --&gt; Index</code></strong>, 索引结构图如下:</p>
 <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/05/05/es-basic/1699264204374.png" class="">

<p><strong>与关系型数据库的对比:</strong></p>
<table>
<thead>
<tr>
<th align="left">Elasticsearch</th>
<th align="left">RDBMS</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Index(索引)</td>
<td align="left">DataBase(数据库)</td>
</tr>
<tr>
<td align="left">Type(类型)</td>
<td align="left">Table(表)</td>
</tr>
<tr>
<td align="left">Document(文档)</td>
<td align="left">Row(行)</td>
</tr>
<tr>
<td align="left">Field(字段)</td>
<td align="left">Column(列)</td>
</tr>
<tr>
<td align="left">Mapping(映射)</td>
<td align="left">Schema(约束)</td>
</tr>
<tr>
<td align="left">Everything is indexed(存储的都是索引)</td>
<td align="left">Index(索引)</td>
</tr>
<tr>
<td align="left">Query DSL(ES独特的查询语言)</td>
<td align="left">SQL(结构化查询语言)</td>
</tr>
</tbody></table>
<h4 id="4-14-recovery-数据恢复"><a href="#4-14-recovery-数据恢复" class="headerlink" title="4.14 recovery(数据恢复)"></a>4.14 recovery(数据恢复)</h4><blockquote>
<p>又叫数据重新分布: 当有节点加入或退出时, ES会根据机器的负载对索引分片进行重新分配, 挂掉的节点重新启动时也会进行数据恢复.<br>Kibana工具中通过 <code>GET _cat/health?v</code>, 就可以看到集群所处的状态.</p>
</blockquote>
<h2 id="主要配置"><a href="#主要配置" class="headerlink" title="主要配置"></a>主要配置</h2><h3 id="1-elasticsearch-yml-ES服务配置"><a href="#1-elasticsearch-yml-ES服务配置" class="headerlink" title="1 elasticsearch.yml(ES服务配置)"></a>1 elasticsearch.yml(ES服务配置)</h3><p>文件位置: <code>$&#123;ES_HOME&#125;/config/elasticsearch.yml</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># ======================== Elasticsearch Configuration =========================</span><br><span class="line">#</span><br><span class="line"># NOTE: Elasticsearch comes with reasonable defaults <span class="keyword">for</span> most settings.</span><br><span class="line">#       Before you set out to tweak and tune the configuration, make sure you</span><br><span class="line">#       understand what are you trying to accomplish and the consequences.</span><br><span class="line">#</span><br><span class="line"># The primary way of configuring a node is via <span class="built_in">this</span> file. This template lists</span><br><span class="line"># the most important settings you may want to configure <span class="keyword">for</span> a production cluster.</span><br><span class="line">#</span><br><span class="line"># Please consult the documentation <span class="keyword">for</span> further information on configuration options:</span><br><span class="line"># https:<span class="comment">//www.elastic.co/guide/en/elasticsearch/reference/index.html</span></span><br></pre></td></tr></table></figure>

<h4 id="1-1-Cluster集群配置"><a href="#1-1-Cluster集群配置" class="headerlink" title="1.1 Cluster集群配置"></a>1.1 Cluster集群配置</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># ---------------------------------- Cluster -----------------------------------</span><br><span class="line">#</span><br><span class="line"># Use a descriptive name <span class="keyword">for</span> your cluster:</span><br><span class="line"># 集群名称, 具有相同名称的节点才能组成一个逻辑集群, 默认是<span class="string">&quot;elasticsearch&quot;</span>, 建议修改为与项目相关的名称.</span><br><span class="line">cluster.name: heal_es</span><br></pre></td></tr></table></figure>

<h4 id="1-2-Node节点配置"><a href="#1-2-Node节点配置" class="headerlink" title="1.2 Node节点配置"></a>1.2 Node节点配置</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># ------------------------------------ Node ------------------------------------</span><br><span class="line">#</span><br><span class="line"># Use a descriptive name <span class="keyword">for</span> the node:</span><br><span class="line"># 本节点的名称, 同一集群中各个node的名称不允许重复. 不配置则系统默认分配.</span><br><span class="line"># node.name: node-<span class="number">1</span></span><br><span class="line">#</span><br><span class="line"># Add custom attributes to the node:</span><br><span class="line"># 指定节点的部落属性 --- 一个比集群更大的范围, 即定义一些通用属性, 用于集群分配碎片时的过滤. </span><br><span class="line">#node.attr.rack: r1</span><br></pre></td></tr></table></figure>

<hr>
<p>Elasticsearch 6.6.0版本中取消了下述配置:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"># 指定本节点是否有资格被选举为主节点, 默认是<span class="literal">true</span>. </span><br><span class="line"># ES集群中第一台机器被默认为master, 若此节点挂掉, 将重新选举master. </span><br><span class="line"># node.master=<span class="literal">true</span></span><br><span class="line"># </span><br><span class="line"># 指定本节点在集群中是否存储数据, 默认为<span class="literal">true</span>. </span><br><span class="line"># node.data=<span class="literal">true</span></span><br><span class="line">#</span><br><span class="line"># 配置文件中给出了三种配置高性能集群拓扑结构的模式, 如下： </span><br><span class="line"># <span class="number">1.</span> 如果想让节点不被选举为主节点, 只用来存储数据, 可作为负载器:  </span><br><span class="line"># node.master: <span class="literal">false</span> </span><br><span class="line"># node.data: <span class="literal">true</span> </span><br><span class="line"># node.ingest: <span class="literal">true</span>  默认为<span class="literal">true</span></span><br><span class="line">#</span><br><span class="line"># <span class="number">2.</span> 如果想让节点成为主节点, 且不存储任何数据, 并保有空闲资源,可作为协调器: </span><br><span class="line"># node.master: <span class="literal">true</span> </span><br><span class="line"># node.data: <span class="literal">false</span></span><br><span class="line"># node.ingest: <span class="literal">true</span></span><br><span class="line">#</span><br><span class="line"># <span class="number">3.</span> 如果想让节点既不作主节点, 又不作数据节点, 那么可将其作为搜索器, 从节点中获取数据, 生成搜索结果等:  </span><br><span class="line"># node.master: <span class="literal">false</span> </span><br><span class="line"># node.data: <span class="literal">false</span> </span><br><span class="line"># node.ingest: <span class="literal">true</span></span><br><span class="line">#</span><br><span class="line"># <span class="number">4.</span> 仅作为协调器: </span><br><span class="line"># node.master: <span class="literal">false</span> </span><br><span class="line"># node.data: <span class="literal">false</span></span><br><span class="line"># node.ingest: <span class="literal">false</span></span><br></pre></td></tr></table></figure>

<h4 id="1-3-Paths路径配置"><a href="#1-3-Paths路径配置" class="headerlink" title="1.3 Paths路径配置"></a>1.3 Paths路径配置</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># ----------------------------------- Paths ------------------------------------</span><br><span class="line">#</span><br><span class="line"># Path to directory where to store the <span class="title function_">data</span> <span class="params">(separate multiple locations by comma)</span>:</span><br><span class="line"># 如果不配置下述两项, ES将在其主目录下创建. 建议将程序与数据分离配置, 方便系统迁移与升级. </span><br><span class="line"># 存放索引数据的目录</span><br><span class="line">path.data: /data/elk-<span class="number">6.6</span><span class="number">.0</span>/data</span><br><span class="line">#</span><br><span class="line"># Path to log files: 存放日志信息的目录</span><br><span class="line">path.logs: /data/elk-<span class="number">6.6</span><span class="number">.0</span>/logs</span><br></pre></td></tr></table></figure>

<h4 id="1-4-Memory内存配置"><a href="#1-4-Memory内存配置" class="headerlink" title="1.4 Memory内存配置"></a>1.4 Memory内存配置</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># ----------------------------------- Memory -----------------------------------</span><br><span class="line">#</span><br><span class="line"># Lock the memory on startup:</span><br><span class="line"># 启动时是否锁定ES运行所需的内存, 默认为<span class="literal">false</span>. </span><br><span class="line"># <span class="literal">true</span>: 锁定---防止ES使用Swap交换空间, 效率较高. 此时要确保当前用户具有memlock的权限. </span><br><span class="line"># <span class="literal">false</span>: 将使用Swap交换空间.</span><br><span class="line"># bootstrap.memory_lock: <span class="literal">false</span> </span><br><span class="line">bootstrap.system_call_filter: <span class="literal">false</span></span><br><span class="line"># </span><br><span class="line"># 确保ES_HEAP_SIZE参数的值设置为系统可用内存的一半左右, 不要超过, 因为Lucene底层索引和检索还需要一定的内存. </span><br><span class="line"># Make sure that the heap size is set to about half the memory available</span><br><span class="line"># on the system and that the owner of the process is allowed to use <span class="built_in">this</span></span><br><span class="line"># limit.</span><br><span class="line"># </span><br><span class="line"># 当系统使用内存交换, ES的性能将变得很差</span><br><span class="line"># Elasticsearch performs poorly when the system is swapping the memory.</span><br></pre></td></tr></table></figure>

<h4 id="1-5-Network网络配置"><a href="#1-5-Network网络配置" class="headerlink" title="1.5 Network网络配置"></a>1.5 Network网络配置</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># ---------------------------------- Network -----------------------------------</span><br><span class="line">#</span><br><span class="line"># Set the bind address to a specific <span class="title function_">IP</span> <span class="params">(IPv4 or IPv6)</span>:</span><br><span class="line"># 对外网关的IP, 默认为localhost, 此时只能通过localhost或<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>访问. </span><br><span class="line"># 设置为<span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>, 即可被外部所有网络访问, 如此但是不够安全, 可以指定某一个网段:</span><br><span class="line">network.host: <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line">#network.host: <span class="number">192.168</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">#</span><br><span class="line"># Set a custom port <span class="keyword">for</span> HTTP:</span><br><span class="line"># 对外提供的HTTP访问端口, 默认为<span class="number">9200.</span> 为提高安全性, 建议设置为其他值.</span><br><span class="line"># 可以指定一个值或一个区间, 如果是区间就会采取区间内第一个可用的端口.</span><br><span class="line">#http.port: <span class="number">9200</span></span><br><span class="line"># </span><br><span class="line"># For more information, consult the network <span class="keyword">module</span> documentation.</span><br></pre></td></tr></table></figure>

<hr>
<p>Elasticsearch 6.6.0版本取消了<code>transport.tcp.port</code>的设置:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># </span><br><span class="line"># 集群节点之间通信的TCP传输端口. 下述Discovery部分的设置、ES的Java API 也通过此端口传输数据. 默认为<span class="number">9300.</span> </span><br><span class="line"># 可以指定一个值或一个区间, 如果是区间就会采取区间内第一个可用的端口.</span><br><span class="line"># transport.tcp.port: <span class="number">9300</span></span><br></pre></td></tr></table></figure>

<p><strong>1、</strong> 旧版本的Java API中客户端<code>TransportClient</code> 使用的是9300端口, 它执行的是序列化的Java请求, 性能较低, 在7.x版本中将过期, 8.x版本中将移除;<br><strong>2、</strong> 新版本推荐使用Java High Level REST Client客户端, 也就是<code>RestHighLevelClient</code>, 它执行HTTP请求, 使用的端口是http.port, 默认就是9200.</p>
<h4 id="1-6-Discovery节点发现配置"><a href="#1-6-Discovery节点发现配置" class="headerlink" title="1.6 Discovery节点发现配置"></a>1.6 Discovery节点发现配置</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"># --------------------------------- Discovery ----------------------------------</span><br><span class="line"># </span><br><span class="line"># 启动新节点时, 通过IP列表进行节点发现, 组建集群</span><br><span class="line"># Pass an initial list of hosts to perform discovery when <span class="keyword">new</span> <span class="title class_">node</span> is started:</span><br><span class="line"># The <span class="keyword">default</span> list of hosts is [<span class="string">&quot;127.0.0.1&quot;</span>, <span class="string">&quot;[::1]&quot;</span>]</span><br><span class="line"># <span class="string">&#x27;127.0.0.1&#x27;</span>是ipv4的回环地址, <span class="string">&#x27;[::1]&#x27;</span>是ipv6的回环地址</span><br><span class="line"># </span><br><span class="line"># <span class="number">1.</span>x中默认使用多播(multicast)协议: 自动发现同一网段中的ES节点并组建集群; </span><br><span class="line"># <span class="number">2.</span>x中默认使用单播(unicast)协议: 要组建集群, 就需要在这里指定集群的节点信息 -- 安全高效, 但不够灵活. </span><br><span class="line"># </span><br><span class="line"># 默认已经关闭了自动发现节点的多播(组播)协议功能: </span><br><span class="line"># discovery.zen.ping.multicast.enabled: <span class="literal">false</span></span><br><span class="line"># </span><br><span class="line"># 指定单播模式的IP(或hostname)列表: </span><br><span class="line"># 也可配置为: [<span class="string">&quot;ip:port&quot;</span>, <span class="string">&quot;ip:port&quot;</span>]. 若port未设置, 将使用transport.tcp.port的值. </span><br><span class="line">#discovery.zen.ping.unicast.hosts: [<span class="string">&quot;host1&quot;</span>, <span class="string">&quot;host2&quot;</span>]</span><br><span class="line"># </span><br><span class="line"># Prevent the <span class="string">&quot;split brain&quot;</span> by configuring the majority of <span class="title function_">nodes</span> <span class="params">(total number of master-eligible nodes / <span class="number">2</span> + <span class="number">1</span>)</span>:</span><br><span class="line"># 配置此参数以防止集群出现<span class="string">&quot;脑裂现象&quot;</span>: 集群中出现<span class="number">2</span>个及以上master节点, 将导致数据不一致. </span><br><span class="line"># 官方推荐: 选举master的最少节点数 = (具有master资格的节点数 / <span class="number">2</span>) + <span class="number">1</span></span><br><span class="line">#discovery.zen.minimum_master_nodes: </span><br><span class="line"># </span><br><span class="line"># 设置集群中自动发现其他节点的连接超时时长, 默认是<span class="number">3</span>秒.</span><br><span class="line"># 在网络不佳时增加这个值, 会增加节点等待响应的时间, 可以减少误判.</span><br><span class="line"># discover.zen.ping.timeout: 3s</span><br><span class="line"># </span><br><span class="line"># For more information, consult the zen discovery <span class="keyword">module</span> documentation.</span><br></pre></td></tr></table></figure>

<h4 id="1-7-Gateway网关配置"><a href="#1-7-Gateway网关配置" class="headerlink" title="1.7 Gateway网关配置"></a>1.7 Gateway网关配置</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># ---------------------------------- Gateway -----------------------------------</span><br><span class="line"># </span><br><span class="line"># Block initial recovery after a full cluster restart until N nodes are started:</span><br><span class="line"># 配置集群中的N个节点启动后, 才允许进行数据恢复处理. 默认是<span class="number">1.</span></span><br><span class="line">#gateway.recover_after_nodes: <span class="number">3</span></span><br><span class="line">#</span><br><span class="line"># For more information, consult the gateway <span class="keyword">module</span> documentation.</span><br></pre></td></tr></table></figure>

<h4 id="1-8-Various其他配置"><a href="#1-8-Various其他配置" class="headerlink" title="1.8 Various其他配置"></a>1.8 Various其他配置</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># ---------------------------------- Various -----------------------------------</span><br><span class="line"># </span><br><span class="line"># 在一台服务器上禁止启动多个es服务</span><br><span class="line"># Disable starting multiple nodes on a single system:</span><br><span class="line">#</span><br><span class="line"># node.max_local_storage_nodes: <span class="number">1</span></span><br><span class="line">#</span><br><span class="line"># 设置是否可以通过正则或者_all删除或者关闭索引库，默认<span class="literal">true</span>表示必须需要显式指定索引库名称</span><br><span class="line"># </span><br><span class="line"># Require explicit names when deleting indices:</span><br><span class="line">#action.destructive_requires_name: <span class="literal">true</span></span><br><span class="line"># 是否压缩TCP传输的数据, 默认是<span class="literal">false</span>: </span><br><span class="line"># transport.tcp.compress: <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"># 是否使用HTTP协议对外提供服务, 默认是<span class="literal">true</span>:</span><br><span class="line"># http.cors.enabled: <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"># http传输内容的最大容量, 默认是100MB:</span><br><span class="line"># http.max_content_length: 100mb</span><br></pre></td></tr></table></figure>

<ul>
<li>注意:</li>
</ul>
<blockquote>
<p>在2.x版本的配置文件中, 存在 <strong>Index</strong> 配置项, 可配置包括分片数、副本分片数在内的配置.<br>在5.x版本中, 不支持在配置文件中设置此类配置项了, 请注意此区别.</p>
</blockquote>
<ul>
<li>修改完之后使用命令查看具体修改了哪些值:</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 查看某个文件上次修改的内容: </span><br><span class="line">grep <span class="string">&#x27;^[a-z]&#x27;</span> /data/elk-<span class="number">6.6</span><span class="number">.0</span>/es-node/config/elasticsearch.yml</span><br></pre></td></tr></table></figure>

<h3 id="2-jvm-options-JVM参数配置"><a href="#2-jvm-options-JVM参数配置" class="headerlink" title="2 jvm.options(JVM参数配置)"></a>2 jvm.options(JVM参数配置)</h3><p>文件位置: <code>$&#123;ES_HOME&#125;/config/jvm.options</code></p>
<p>关于JVM常见参数的配置, 可参考博主文章:</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/shoufeng/p/9739525.html">对Tomcat 8.0进行JVM层面的优化(基于Oracle JDK 8)</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/shoufeng/p/9709464.html">关于JVM的垃圾回收(GC) 这可能是你想了解的</a></p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line">## JVM configuration</span><br><span class="line"></span><br><span class="line">################################################################</span><br><span class="line">## IMPORTANT: JVM heap size</span><br><span class="line">################################################################</span><br><span class="line">##</span><br><span class="line">## You should always set the min and max JVM heap</span><br><span class="line">## size to the same value. For example, to set</span><br><span class="line">## the heap to <span class="number">4</span> GB, set:</span><br><span class="line">##</span><br><span class="line">## -Xms4g</span><br><span class="line">## -Xmx4g</span><br><span class="line">##</span><br><span class="line">## See https:<span class="comment">//www.elastic.co/guide/en/elasticsearch/reference/current/heap-size.html</span></span><br><span class="line">## <span class="keyword">for</span> more information</span><br><span class="line">##</span><br><span class="line">################################################################</span><br><span class="line"></span><br><span class="line"># Xms represents the initial size of total heap space</span><br><span class="line"># Xmx represents the maximum size of total heap space</span><br><span class="line"># 下述配置最好不要超过节点物理内存的<span class="number">50</span>%, 留出<span class="number">50</span>%供Lucene底层索引与检索使用 </span><br><span class="line">-Xms1g</span><br><span class="line">-Xmx1g</span><br><span class="line"></span><br><span class="line">################################################################</span><br><span class="line">## Expert settings</span><br><span class="line">################################################################</span><br><span class="line">##</span><br><span class="line">## All settings below <span class="built_in">this</span> section are considered</span><br><span class="line">## expert settings. Don<span class="string">&#x27;t tamper with them unless</span></span><br><span class="line"><span class="string">## you understand what you are doing</span></span><br><span class="line"><span class="string">##</span></span><br><span class="line"><span class="string">################################################################</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">## GC configuration</span></span><br><span class="line"><span class="string">-XX:+UseConcMarkSweepGC</span></span><br><span class="line"><span class="string">-XX:CMSInitiatingOccupancyFraction=75</span></span><br><span class="line"><span class="string">-XX:+UseCMSInitiatingOccupancyOnly</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">## G1GC Configuration</span></span><br><span class="line"><span class="string"># NOTE: G1GC is only supported on JDK version 10 or later.</span></span><br><span class="line"><span class="string"># To use G1GC uncomment the lines below.</span></span><br><span class="line"><span class="string"># 10-:-XX:-UseConcMarkSweepGC</span></span><br><span class="line"><span class="string"># 10-:-XX:-UseCMSInitiatingOccupancyOnly</span></span><br><span class="line"><span class="string"># 10-:-XX:+UseG1GC</span></span><br><span class="line"><span class="string"># 10-:-XX:InitiatingHeapOccupancyPercent=75</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">## DNS cache policy</span></span><br><span class="line"><span class="string"># cache ttl in seconds for positive DNS lookups noting that this overrides the</span></span><br><span class="line"><span class="string"># JDK security property networkaddress.cache.ttl; set to -1 to cache forever</span></span><br><span class="line"><span class="string">-Des.networkaddress.cache.ttl=60</span></span><br><span class="line"><span class="string"># cache ttl in seconds for negative DNS lookups noting that this overrides the</span></span><br><span class="line"><span class="string"># JDK security property networkaddress.cache.negative ttl; set to -1 to cache</span></span><br><span class="line"><span class="string"># forever</span></span><br><span class="line"><span class="string">-Des.networkaddress.cache.negative.ttl=10</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">## optimizations</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># pre-touch memory pages used by the JVM during initialization</span></span><br><span class="line"><span class="string">-XX:+AlwaysPreTouch</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">## basic</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># explicitly set the stack size (reduce to 320k on 32-bit client JVMs)</span></span><br><span class="line"><span class="string">-Xss1m</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># set to headless, just in case</span></span><br><span class="line"><span class="string">-Djava.awt.headless=true</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># ensure UTF-8 encoding by default (e.g. filenames)</span></span><br><span class="line"><span class="string">-Dfile.encoding=UTF-8</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># use our provided JNA always versus the system one</span></span><br><span class="line"><span class="string">-Djna.nosys=true</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># turn off a JDK optimization that throws away stack traces for common</span></span><br><span class="line"><span class="string"># exceptions because stack traces are important for debugging</span></span><br><span class="line"><span class="string">-XX:-OmitStackTraceInFastThrow</span></span><br><span class="line"><span class="string"># flags to configure Netty</span></span><br><span class="line"><span class="string">-Dio.netty.noUnsafe=true</span></span><br><span class="line"><span class="string">-Dio.netty.noKeySetOptimization=true</span></span><br><span class="line"><span class="string">-Dio.netty.recycler.maxCapacityPerThread=0</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># log4j 2</span></span><br><span class="line"><span class="string">-Dlog4j.shutdownHookEnabled=false</span></span><br><span class="line"><span class="string">-Dlog4j2.disable.jmx=true</span></span><br><span class="line"><span class="string">-Dlog4j.skipJansi=true</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">## heap dumps</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># generate a heap dump when an allocation from the Java heap fails</span></span><br><span class="line"><span class="string"># heap dumps are created in the working directory of the JVM</span></span><br><span class="line"><span class="string">-XX:+HeapDumpOnOutOfMemoryError</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># specify an alternative path for heap dumps; ensure the directory exists and has sufficient space</span></span><br><span class="line"><span class="string"># 生产环境中指定当发生OOM异常时, Heap的Dump Path, 默认是 -XX:HeapDumpPath=data</span></span><br><span class="line"><span class="string">-XX:HeapDumpPath=/var/lib/elasticsearch</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># specify an alternative path for JVM fatal error logs</span></span><br><span class="line"><span class="string">-XX:ErrorFile=logs/hs_err_pid%p.log</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">## JDK 8 GC logging</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">8:-XX:+PrintGCDetails</span></span><br><span class="line"><span class="string">8:-XX:+PrintGCDateStamps</span></span><br><span class="line"><span class="string">8:-XX:+PrintTenuringDistribution</span></span><br><span class="line"><span class="string">8:-XX:+PrintGCApplicationStoppedTime</span></span><br><span class="line"><span class="string">8:-Xloggc:logs/gc.log</span></span><br><span class="line"><span class="string">8:-XX:+UseGCLogFileRotation</span></span><br><span class="line"><span class="string">8:-XX:NumberOfGCLogFiles=32</span></span><br><span class="line"><span class="string">8:-XX:GCLogFileSize=64m</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># JDK 9+ GC logging</span></span><br><span class="line"><span class="string">9-:-Xlog:gc*,gc+age=trace,safepoint:file=logs/gc.log:utctime,pid,tags:filecount=32,filesize=64m</span></span><br><span class="line"><span class="string"># due to internationalization enhancements in JDK 9 Elasticsearch need to set the provider to COMPAT otherwise</span></span><br><span class="line"><span class="string"># time/date parsing will break in an incompatible way for some date patterns and locals</span></span><br><span class="line"><span class="string">9-:-Djava.locale.providers=COMPAT</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># temporary workaround for C2 bug with JDK 10 on hardware with AVX-512</span></span><br><span class="line"><span class="string">10-:-XX:UseAVX=2</span></span><br></pre></td></tr></table></figure>

<hr>
<p>Elasticsearch 6.6.0中已经移除了下述优化配置:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># disable calls to System#gc</span><br><span class="line">-XX:+DisableExplicitGC</span><br><span class="line"></span><br><span class="line"># force the server <span class="title function_">VM</span> <span class="params">(remove on <span class="number">32</span>-bit client JVMs)</span></span><br><span class="line">-server</span><br><span class="line"></span><br><span class="line"># use old-style file permissions on JDK9</span><br><span class="line">-Djdk.io.permissionsUseCanonicalPath=<span class="literal">true</span></span><br></pre></td></tr></table></figure>

<hr>
<p>其他说明:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">-Xmx2g        这种参数没有限制JVM版本</span><br><span class="line"><span class="number">8</span>: -Xmx2g     限制JVM版本为<span class="number">8</span></span><br><span class="line"><span class="number">8</span>-: -Xmx2g    限制JVM版本为<span class="number">8</span>及<span class="number">8</span>以上</span><br><span class="line"><span class="number">8</span>-<span class="number">10</span>: -Xmx2g  限制JVM版本在<span class="number">8</span>-<span class="number">10</span>之间</span><br></pre></td></tr></table></figure>

<h3 id="3-log4j2-properties-日志配置"><a href="#3-log4j2-properties-日志配置" class="headerlink" title="3 log4j2.properties(日志配置)"></a>3 log4j2.properties(日志配置)</h3><p>文件位置: <code>$&#123;ES_HOME&#125;/config/log4j2.properties</code></p>
<p>一般使用默认日志配置即可.</p>
<h2 id="简单查询"><a href="#简单查询" class="headerlink" title="简单查询"></a>简单查询</h2><table>
<thead>
<tr>
<th align="left">请求或返回</th>
<th align="left">解释</th>
</tr>
</thead>
<tbody><tr>
<td align="left">GET bank&#x2F;_search</td>
<td align="left">检索 bank 下所有信息,包括 type 和 docs</td>
</tr>
<tr>
<td align="left">GET bank&#x2F;_search?q&#x3D;*&amp;sort&#x3D;account_number:asc</td>
<td align="left">请求参数方式检索</td>
</tr>
<tr>
<td align="left">响应结果解释：</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">took</td>
<td align="left">Elasticsearch执行搜索的时间(臺秒)</td>
</tr>
<tr>
<td align="left">time_out</td>
<td align="left">告诉我们搜索是否超时</td>
</tr>
<tr>
<td align="left">_shards</td>
<td align="left">告诉我们多少个分片被搜索了,以及统计了成功&#x2F;失败的搜索分片</td>
</tr>
<tr>
<td align="left">hits</td>
<td align="left">搜索结果</td>
</tr>
<tr>
<td align="left">hits.total</td>
<td align="left">搜索结果</td>
</tr>
<tr>
<td align="left">hits.hits</td>
<td align="left">实际的搜索结果数组(默认为前10的文档)</td>
</tr>
<tr>
<td align="left">sort</td>
<td align="left">结果的排序 key (键) (没有则按 score 排序)</td>
</tr>
<tr>
<td align="left">score 和 max_score</td>
<td align="left">相关性得分和最高得分(全文检索用)</td>
</tr>
</tbody></table>
<h3 id="1-Query-String-Search-查询串检索"><a href="#1-Query-String-Search-查询串检索" class="headerlink" title="1 Query String Search(查询串检索)"></a>1 Query String Search(查询串检索)</h3><blockquote>
<p>这种方法通过HTTP请求的Query String携带查询参数, 因此得名.</p>
<p>适用于临时性的查询请求, 比如在终端检查基础信息:</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">检索name中包含Java的文档, 并按价格降序排序: </span><br><span class="line">curl -XGET <span class="string">&#x27;http://localhost:9301/book_shop/it_book/_search?q=name:Java&amp;sort=price:desc&#x27;</span> </span><br></pre></td></tr></table></figure>

<blockquote>
<p>生产环境中很少使用, 因为请求参数都封装到Query String中, 难以构建复杂的查询.</p>
</blockquote>
<p>(1)查询全部商品:</p>
<p>直接在浏览器的URL地址栏内输入搜索参数:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="comment">//172.16.22.133:9301/book_shop/it_book/_search?q=name:Java</span></span><br></pre></td></tr></table></figure>

<p>(2)查询的结果:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;took&quot;</span>: <span class="number">8</span>,</span><br><span class="line">    <span class="string">&quot;timed_out&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="string">&quot;_shards&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;total&quot;</span>: <span class="number">5</span>,</span><br><span class="line">        <span class="string">&quot;successful&quot;</span>: <span class="number">5</span>,</span><br><span class="line">        <span class="string">&quot;skipped&quot;</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="string">&quot;failed&quot;</span>: <span class="number">0</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;hits&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;total&quot;</span>: <span class="number">3</span>,</span><br><span class="line">        <span class="string">&quot;max_score&quot;</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="string">&quot;hits&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&quot;_index&quot;</span>: <span class="string">&quot;book_shop&quot;</span>,</span><br><span class="line">                <span class="string">&quot;_type&quot;</span>: <span class="string">&quot;it_book&quot;</span>,</span><br><span class="line">                <span class="string">&quot;_id&quot;</span>: <span class="string">&quot;2&quot;</span>,</span><br><span class="line">                <span class="string">&quot;_score&quot;</span>: <span class="number">1</span>,</span><br><span class="line">                <span class="string">&quot;_source&quot;</span>: &#123;</span><br><span class="line">                    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;深入理解Java虚拟机：JVM高级特性与最佳实践&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;author&quot;</span>: <span class="string">&quot;周志明&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;category&quot;</span>: <span class="string">&quot;编程语言&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;desc&quot;</span>: <span class="string">&quot;Java图书领域公认的经典著作&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;price&quot;</span>: <span class="number">79</span>,</span><br><span class="line">                    <span class="string">&quot;date&quot;</span>: <span class="string">&quot;2013-10-01&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;publisher&quot;</span>: <span class="string">&quot;机械工业出版社&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;tags&quot;</span>: [</span><br><span class="line">                        <span class="string">&quot;Java&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;虚拟机&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;最佳实践&quot;</span></span><br><span class="line">                    ]</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="comment">// 省略另外两条记录</span></span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>(3)查询结果中的各个参数的含义:</p>
<p><strong>1、</strong> <code>took</code>: 此次检索耗费的时间, 单位是毫秒;</p>
<p><strong>2、</strong> <code>timed_out</code>: 是否超出规定的检索时间, 这里没有设置, 后续会讲解此参数;</p>
<p><strong>3、</strong> <code>_shards</code>: 被查询的<code>index</code>被分散成多个分片, 所以搜索请求会分发到所有的primary shard(或primary shard对应的某个replica shard)上, 这里显示各个分片是否查询成功的信息;</p>
<p><strong>4、</strong> <code>hits</code>: 命中的文档情况, 有如下参数:</p>
<blockquote>
<p><code>total</code>: 符合条件的文档总数, 即hit(命中)数;<br><code>max_score</code>: Lucene底层对检索到的文档的相关度的评分, 相关度越高, 说明越匹配, score的值也就越高.<br><code>hits</code>: 命中的所有document的详细数据.</p>
</blockquote>
<h3 id="2-Query-DSL-ES特定语法检索"><a href="#2-Query-DSL-ES特定语法检索" class="headerlink" title="2 Query DSL(ES特定语法检索)"></a>2 Query DSL(ES特定语法检索)</h3><blockquote>
<p>DSL: Domain Specified Language, 特定领域的语言, 一般需要Kibana等工具配合操作.</p>
<p>这种方式把查询参数构建成JSON格式的数据, 并封装到HTTP请求的Request Body(请求体)中, 可以构建各类复杂的查询语法, 功能要比Query String Search强大很多.</p>
</blockquote>
<p>(1)<strong>查询全部商品:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">GET book_shop/it_book/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;query&quot;</span>: &#123; <span class="string">&quot;match_all&quot;</span>: &#123;&#125; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>(2)<strong>查询name中包含Java的商品, 并按price降序排序:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET book_shop/it_book/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Java&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;sort&quot;</span>: [</span><br><span class="line">        &#123; <span class="string">&quot;price&quot;</span>: <span class="string">&quot;desc&quot;</span> &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>(3)<strong>分页查询商品 - 每页显示1条, 显示第3页:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">GET book_shop/it_book/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;query&quot;</span>: &#123; <span class="string">&quot;match_all&quot;</span>: &#123;&#125; &#125;,</span><br><span class="line">    <span class="string">&quot;from&quot;</span>: <span class="number">2</span>,</span><br><span class="line">    <span class="string">&quot;size&quot;</span>: <span class="number">1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>(4)<strong>只查询商品的名称和价格:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">GET book_shop/it_book/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;query&quot;</span>: &#123;<span class="string">&quot;match_all&quot;</span>: &#123;&#125;&#125;,</span><br><span class="line">    <span class="string">&quot;_source&quot;</span>: [<span class="string">&quot;name&quot;</span>, <span class="string">&quot;price&quot;</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>——上述各类语法可以组合使用, 具体使用方法后续会陆续介绍.</p>
<h3 id="3-Query-Filter-过滤检索"><a href="#3-Query-Filter-过滤检索" class="headerlink" title="3 Query Filter(过滤检索)"></a>3 Query Filter(过滤检索)</h3><blockquote>
<p>过滤查询, 比如: <strong>查询name中包含Java, 且price不大于80元的商品:</strong></p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">GET book_shop/it_book/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;bool&quot;</span>: &#123;</span><br><span class="line">          	<span class="string">&quot;must&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;match&quot;</span>: &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;Java&quot;</span>&#125;	<span class="comment">// name中含有Java</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;filter&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;range&quot;</span>: &#123; </span><br><span class="line">                    <span class="string">&quot;price&quot;</span>: &#123;<span class="string">&quot;lte&quot;</span>: <span class="number">80.0</span>&#125;	<span class="comment">// 价格不大于80.0</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-Full-Text-Search-全文检索"><a href="#4-Full-Text-Search-全文检索" class="headerlink" title="4 Full Text Search(全文检索)"></a>4 Full Text Search(全文检索)</h3><p>(1)查询描述信息desc中包含”Java图书”的文档, 只显示name和desc的值:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">GET book_shop/it_book/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;match&quot;</span>: &#123;<span class="string">&quot;desc&quot;</span>: <span class="string">&quot;Java图书&quot;</span>&#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;_source&quot;</span>: [<span class="string">&quot;name&quot;</span>, <span class="string">&quot;desc&quot;</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>(2)查询结果中有2条数据符合要求:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;took&quot;</span> : <span class="number">2</span>,</span><br><span class="line">  <span class="string">&quot;timed_out&quot;</span> : <span class="literal">false</span>,</span><br><span class="line">  <span class="string">&quot;_shards&quot;</span> : &#123;</span><br><span class="line">    <span class="string">&quot;total&quot;</span> : <span class="number">5</span>,</span><br><span class="line">    <span class="string">&quot;successful&quot;</span> : <span class="number">5</span>,</span><br><span class="line">    <span class="string">&quot;skipped&quot;</span> : <span class="number">0</span>,</span><br><span class="line">    <span class="string">&quot;failed&quot;</span> : <span class="number">0</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;hits&quot;</span> : &#123;</span><br><span class="line">    <span class="string">&quot;total&quot;</span> : <span class="number">2</span>,</span><br><span class="line">    <span class="string">&quot;max_score&quot;</span> : <span class="number">0.8630463</span>,</span><br><span class="line">    <span class="string">&quot;hits&quot;</span> : [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">&quot;_index&quot;</span> : <span class="string">&quot;book_shop&quot;</span>,</span><br><span class="line">        <span class="string">&quot;_type&quot;</span> : <span class="string">&quot;it_book&quot;</span>,</span><br><span class="line">        <span class="string">&quot;_id&quot;</span> : <span class="string">&quot;2&quot;</span>,</span><br><span class="line">        <span class="string">&quot;_score&quot;</span> : <span class="number">0.8630463</span>,</span><br><span class="line">        <span class="string">&quot;_source&quot;</span> : &#123;</span><br><span class="line">          <span class="string">&quot;name&quot;</span> : <span class="string">&quot;深入理解Java虚拟机：JVM高级特性与最佳实践&quot;</span>,</span><br><span class="line">          <span class="string">&quot;desc&quot;</span> : <span class="string">&quot;Java图书领域公认的经典著作&quot;</span>			<span class="comment">// desc中有&quot;Java&quot;和&quot;图书&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">&quot;_index&quot;</span> : <span class="string">&quot;book_shop&quot;</span>,</span><br><span class="line">        <span class="string">&quot;_type&quot;</span> : <span class="string">&quot;it_book&quot;</span>,</span><br><span class="line">        <span class="string">&quot;_id&quot;</span> : <span class="string">&quot;1&quot;</span>,</span><br><span class="line">        <span class="string">&quot;_score&quot;</span> : <span class="number">0.2876821</span>,</span><br><span class="line">        <span class="string">&quot;_source&quot;</span> : &#123;</span><br><span class="line">          <span class="string">&quot;name&quot;</span> : <span class="string">&quot;Java编程思想（第4版）&quot;</span>,</span><br><span class="line">          <span class="string">&quot;desc&quot;</span> : <span class="string">&quot;Java学习必读经典,殿堂级著作！&quot;</span>		<span class="comment">// desc中有&quot;Java&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>(3) 全文检索的过程 —— 对查询结果的说明:</strong></p>
<blockquote>
<p>Elasticsearch会对字段”desc”的内容进行分词, 并建立倒排索引.</p>
<p>也就是说, 这里会把 “Java图书” 分词为 “Java”、”图”、”书” 3个, 检索时将匹配desc中含有 “Java”、”图”、”书” 中任意一个分词的文档.</p>
<p>—— 对于中文分词, 可以通过IK分词器, 把”Java图书”分解为”Java”、”图书” 2个词, 参考博主的文章:ES XX - Elasticsearch中使用IK中文分词器.</p>
</blockquote>
<h3 id="5-Phrase-Search-短语检索"><a href="#5-Phrase-Search-短语检索" class="headerlink" title="5 Phrase Search(短语检索)"></a>5 Phrase Search(短语检索)</h3><p><strong>Full Text Search会对检索文本作分词处理</strong>, 然后从倒排索引中作匹配查询, 如果一个文档的对应field中存在任意一个分解后的词, 那么这个文档就算匹配检索条件.</p>
<blockquote>
</blockquote>
<p><strong>Phrase Search不会对检索串进行分词处理</strong>, 只有一个文档的对应field中包含与检索文本完全一致的内容, 该文档才算匹配检索条件, 也才能作为结果返回 —— 可以理解为全文检索场景下的部分精确匹配.</p>
<p>(1)<strong>精确查询desc中包含”Java图书”的文档:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">GET book_shop/it_book/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;match_phrase&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;desc&quot;</span>: <span class="string">&quot;Java图书&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;_source&quot;</span>: [<span class="string">&quot;name&quot;</span>, <span class="string">&quot;desc&quot;</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>(2)查询结果只有一条数据符合要求了:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;took&quot;</span> : <span class="number">2</span>,</span><br><span class="line">  <span class="string">&quot;timed_out&quot;</span> : <span class="literal">false</span>,</span><br><span class="line">  <span class="string">&quot;_shards&quot;</span> : &#123;</span><br><span class="line">    <span class="string">&quot;total&quot;</span> : <span class="number">5</span>,</span><br><span class="line">    <span class="string">&quot;successful&quot;</span> : <span class="number">5</span>,</span><br><span class="line">    <span class="string">&quot;skipped&quot;</span> : <span class="number">0</span>,</span><br><span class="line">    <span class="string">&quot;failed&quot;</span> : <span class="number">0</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;hits&quot;</span> : &#123;</span><br><span class="line">    <span class="string">&quot;total&quot;</span> : <span class="number">1</span>,</span><br><span class="line">    <span class="string">&quot;max_score&quot;</span> : <span class="number">0.8630463</span>,</span><br><span class="line">    <span class="string">&quot;hits&quot;</span> : [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">&quot;_index&quot;</span> : <span class="string">&quot;book_shop&quot;</span>,</span><br><span class="line">        <span class="string">&quot;_type&quot;</span> : <span class="string">&quot;it_book&quot;</span>,</span><br><span class="line">        <span class="string">&quot;_id&quot;</span> : <span class="string">&quot;2&quot;</span>,</span><br><span class="line">        <span class="string">&quot;_score&quot;</span> : <span class="number">0.8630463</span>,</span><br><span class="line">        <span class="string">&quot;_source&quot;</span> : &#123;</span><br><span class="line">          <span class="string">&quot;name&quot;</span> : <span class="string">&quot;深入理解Java虚拟机：JVM高级特性与最佳实践&quot;</span>,</span><br><span class="line">          <span class="string">&quot;desc&quot;</span> : <span class="string">&quot;Java图书领域公认的经典著作&quot;</span>		<span class="comment">// desc中精确含有&quot;Java图书&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="6-Highlight-Search-高亮检索"><a href="#6-Highlight-Search-高亮检索" class="headerlink" title="6 Highlight Search(高亮检索)"></a>6 Highlight Search(高亮检索)</h3><p>(1)分页查询desc中包含”Java图书”的文档, 页大小为1, 显示第1页, 并对搜索条件高亮处理:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">GET book_shop/it_book/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;match&quot;</span>: &#123;<span class="string">&quot;desc&quot;</span>: <span class="string">&quot;Java图书&quot;</span>&#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;from&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="string">&quot;size&quot;</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="string">&quot;highlight&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;fields&quot;</span>: &#123;<span class="string">&quot;desc&quot;</span>: &#123;&#125;&#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;_source&quot;</span>: [<span class="string">&quot;name&quot;</span>, <span class="string">&quot;desc&quot;</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>(2)查询结果:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;took&quot;</span> : <span class="number">6</span>,</span><br><span class="line">  <span class="string">&quot;timed_out&quot;</span> : <span class="literal">false</span>,</span><br><span class="line">  <span class="string">&quot;_shards&quot;</span> : &#123;</span><br><span class="line">    <span class="string">&quot;total&quot;</span> : <span class="number">5</span>,</span><br><span class="line">    <span class="string">&quot;successful&quot;</span> : <span class="number">5</span>,</span><br><span class="line">    <span class="string">&quot;skipped&quot;</span> : <span class="number">0</span>,</span><br><span class="line">    <span class="string">&quot;failed&quot;</span> : <span class="number">0</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;hits&quot;</span> : &#123;</span><br><span class="line">    <span class="string">&quot;total&quot;</span> : <span class="number">2</span>,</span><br><span class="line">    <span class="string">&quot;max_score&quot;</span> : <span class="number">0.8630463</span>,</span><br><span class="line">    <span class="string">&quot;hits&quot;</span> : [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">&quot;_index&quot;</span> : <span class="string">&quot;book_shop1&quot;</span>,</span><br><span class="line">        <span class="string">&quot;_type&quot;</span> : <span class="string">&quot;it_book&quot;</span>,</span><br><span class="line">        <span class="string">&quot;_id&quot;</span> : <span class="string">&quot;2&quot;</span>,</span><br><span class="line">        <span class="string">&quot;_score&quot;</span> : <span class="number">0.8630463</span>,</span><br><span class="line">        <span class="string">&quot;_source&quot;</span> : &#123;</span><br><span class="line">          <span class="string">&quot;name&quot;</span> : <span class="string">&quot;深入理解Java虚拟机：JVM高级特性与最佳实践&quot;</span>,</span><br><span class="line">          <span class="string">&quot;desc&quot;</span> : <span class="string">&quot;Java图书领域公认的经典著作&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;highlight&quot;</span> : &#123;		<span class="comment">// 高亮显示, 默认添加&lt;em&gt;标签</span></span><br><span class="line">          <span class="string">&quot;desc&quot;</span> : [</span><br><span class="line">            <span class="string">&quot;&lt;em&gt;Java&lt;/em&gt;&lt;em&gt;图&lt;/em&gt;&lt;em&gt;书&lt;/em&gt;领域公认的经典著作&quot;</span></span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从上述结果的<code>&quot;&lt;em&gt;Java&lt;/em&gt;&lt;em&gt;图&lt;/em&gt;&lt;em&gt;书&lt;/em&gt;</code>也可以看出, ES底层对desc字段的值”Java图书”进行了分词处理:</p>
<p><strong>说明: 本文的六种查询方法, 只是一个简单的入门, 详细使用方法会在后续的学习中逐一演示.</strong></p>
<h2 id="索引操作"><a href="#索引操作" class="headerlink" title="索引操作"></a>索引操作</h2><blockquote>
<p>Elasticsearch中的index相当于RDBMS(关系型数据库, 比如MySQL)中的DataBase.<br>本篇文章通过Kibana插件, 演示了ES的基础语法: 对ES中的index进行CRUD(增删改查)以及关闭、开启操作.</p>
</blockquote>
<p><strong>阅读须知:</strong></p>
<blockquote>
<p>在ES 6.x之前的版本中, 每个index中可以有多个type, 类似于MySQL中每个数据库可以有多张表, 可在ES 6.0开始, 每个index都只能有1个type.<br>本篇文章写作较早, 用的是ES 5.6版本, 因此有些操作可能出现不支持等问题, 还请读者查阅解决:-)</p>
</blockquote>
<h3 id="1-创建index（配置mapping-映射-）"><a href="#1-创建index（配置mapping-映射-）" class="headerlink" title="1 创建index（配置mapping[映射]）"></a>1 创建index（配置mapping[映射]）</h3><p>(1)创建语法:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">PUT index</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;settings&quot;</span>: &#123; ... some settings ... &#125;,</span><br><span class="line">    <span class="string">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">        <span class="comment">// ES 6.x开始不再支持1个index中同时存在多个type</span></span><br><span class="line">        <span class="string">&quot;type1&quot;</span>: &#123; ... some mappings ... &#125;,</span><br><span class="line">        <span class="string">&quot;type2&quot;</span>: &#123; ... some mappings ... &#125;,</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>如果不指定settings和mappings, 直接插入数据时, ES会根据要插入数据的类型, 自动创建相关配置 —— 功能强大, 但扩展性不够, 后续若有其他原因需要修改mappings, 会很困难.</p>
</blockquote>
<p><strong>—— 所以创建index时, 推荐手动指定settings和mappings的相关配置.</strong> 可以参考文章: ES XX - ES的mapping的设置.</p>
<p>(2)创建示例:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">PUT address        <span class="comment">// 关于地址(address)的索引</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;settings&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;number_of_shards&quot;</span>: <span class="number">1</span>,    <span class="comment">// 默认分片数为5</span></span><br><span class="line">        <span class="string">&quot;number_of_replicas&quot;</span>: <span class="number">0</span>   <span class="comment">// 默认副本数为1</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;province&quot;</span>: &#123;             <span class="comment">// type是province(省份)</span></span><br><span class="line">            <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;name&quot;</span>: &#123;</span><br><span class="line">                    <span class="string">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>  <span class="comment">// 存储类型是text</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="string">&quot;area&quot;</span>: &#123;</span><br><span class="line">                    <span class="string">&quot;type&quot;</span>: <span class="string">&quot;float&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>(3)创建结果:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;acknowledged&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="string">&quot;shards_acknowledged&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="string">&quot;index&quot;</span>: <span class="string">&quot;address&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-查看index"><a href="#2-查看index" class="headerlink" title="2 查看index"></a>2 查看index</h3><p>(1)查看示例:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">GET address</span><br><span class="line"></span><br><span class="line"><span class="comment">// 也可同时查看多个索引, 类似于删除操作: </span></span><br><span class="line">GET *</span><br><span class="line">GET _all</span><br><span class="line">GET *index*</span><br><span class="line">GET address,shop</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在6.0之前的版本中, 还可以指定返回某些指定项的结果:</span></span><br><span class="line">GET address/_settings,_mappings</span><br></pre></td></tr></table></figure>

<ul>
<li>弃用提示:</li>
</ul>
<blockquote>
<p>查看索引时, 若通过”,”分隔要返回的结果, Elasticsearch将抛出如下警告:</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">! Deprecation: Requesting comma-separated features is deprecated and will be removed in <span class="number">6.0</span>+, retrieve all features instead.</span><br></pre></td></tr></table></figure>

<blockquote>
<p>意为: Elasticsearch不推荐使用逗号分隔功能, 将在6.0+中删除. 建议不要使用”,”, 而是直接检索全部数据, 或检索某一项的结果.</p>
</blockquote>
<blockquote>
<p>在ES 6.6.0中将直接出现:</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   <span class="string">&quot;error&quot;</span>: <span class="string">&quot;Incorrect HTTP method for uri [/address/_settings,_mappings?pretty] and method [GET], allowed: [POST]&quot;</span>,</span><br><span class="line">   <span class="string">&quot;status&quot;</span>: <span class="number">405</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>换做POST请求时, 必须携带请求体, 仍然不支持.</p>
</blockquote>
<p>(2)查看的结果:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;address&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;aliases&quot;</span>: &#123;&#125;,</span><br><span class="line">    <span class="string">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;province&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;area&quot;</span> : &#123;</span><br><span class="line">            <span class="string">&quot;type&quot;</span> : <span class="string">&quot;float&quot;</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="string">&quot;name&quot;</span> : &#123;</span><br><span class="line">            <span class="string">&quot;type&quot;</span> : <span class="string">&quot;text&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;settings&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;index&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;creation_date&quot;</span>: <span class="string">&quot;1542108754899&quot;</span>,</span><br><span class="line">        <span class="string">&quot;number_of_shards&quot;</span>: <span class="string">&quot;1&quot;</span>,</span><br><span class="line">        <span class="string">&quot;number_of_replicas&quot;</span>: <span class="string">&quot;0&quot;</span>,</span><br><span class="line">        <span class="string">&quot;uuid&quot;</span>: <span class="string">&quot;MMpLNHzZR8K1k48rJplWVw&quot;</span>,</span><br><span class="line">        <span class="string">&quot;version&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;created&quot;</span>: <span class="string">&quot;6060099&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;provided_name&quot;</span>: <span class="string">&quot;address&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-修改index"><a href="#3-修改index" class="headerlink" title="3 修改index"></a>3 修改index</h3><p>修改索引的示例:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">PUT address/_settings</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;number_of_replicas&quot;</span>: <span class="number">1</span>		<span class="comment">// 修改副本数为1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>说明:Elasticsearch中的分片数(number_of_shards)只能在创建索引时设置, 无论是否添加过数据, 都不支持修改.</p>
<blockquote>
<p>这与文档的路由有关, 而Solr的<code>SPLITSHARD</code>可以算作动态修改分片的另一种思路: 只对某一路由范围内的进行拆分, 可以参考 <a target="_blank" rel="noopener" href="https://www.cnblogs.com/shoufeng/p/10569644.html">管理SolrCloud集群 (创建集合、切割分片、更新配置)</a> 第5节的内容.<br>关于修改ES的分片数, 应该有其他思路, 后期了解到再作研究整理.</p>
</blockquote>
<h3 id="4-删除index"><a href="#4-删除index" class="headerlink" title="4 删除index"></a>4 删除index</h3><blockquote>
<p>删除索引需要指明索引名称、别名或通配符.<br>Elasticsearch支持同时删除多个索引, 或使用<code>_all</code>或<code>通配符*</code>删除全部索引.</p>
</blockquote>
<p><strong>删除示例:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">DELETE address        <span class="comment">// 删除指定索引</span></span><br><span class="line">DELETE index1,index2  <span class="comment">// 删除多个索引</span></span><br><span class="line">DELETE index_*        <span class="comment">// 按通配符删除以&#x27;index_&#x27;开头的索引</span></span><br><span class="line">DELETE _all           <span class="comment">// 删除全部索引</span></span><br></pre></td></tr></table></figure>

<p><strong>为避免<code>_all</code>操作误删除全部索引, 可在配置文件<code>elasticsearch.yml</code>中作如下配置:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 要求操作索引时必须指定索引的名称</span><br><span class="line">action.destructive_requires_name: <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<h3 id="5-打开-关闭index"><a href="#5-打开-关闭index" class="headerlink" title="5 打开&#x2F;关闭index"></a>5 打开&#x2F;关闭index</h3><p>(1)操作说明:</p>
<p><strong>1、</strong> 可以打开一个已经打开&#x2F;关闭的索引, 以最后一次操作为准;<br><strong>2、</strong> 可以关闭一个已经关闭&#x2F;打开的索引, 以最后一次操作为准;<br><strong>3、</strong> <strong>关闭的索引只能查看index的配置信息, 不能对内部的索引数据进行读写操作.</strong></p>
<p>(2)操作示例:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 可以使用_all打开或关闭全部索引, 也可使用通配符(*)配合操作</span></span><br><span class="line">POST address/_close</span><br><span class="line">POST address/_open</span><br></pre></td></tr></table></figure>

<p><strong>说明事项:</strong></p>
<p><strong>1、</strong> 使用<code>_all</code>或通配符操作索引, 都会受到配置文件中<code>action.destructive_requires_name=true</code>的限制.<br><strong>2、</strong> 关闭的索引会继续占用磁盘空间, 却又不能使用 —— 造成磁盘空间的浪费.<br><strong>3、</strong> 可以在配置文件中禁止使用关闭索引的功能: <code>settingscluster.indices.close.enable=false</code>, 默认为true(开启).</p>
<h3 id="6-常见问题及解决方法"><a href="#6-常见问题及解决方法" class="headerlink" title="6 常见问题及解决方法"></a>6 常见问题及解决方法</h3><p>(1)查看不存在的索引时, 将抛出如下错误信息:</p>
<p>如果要查看的索引不存在, 比如<code>GET addre</code>, 就会抛出类似下面的异常信息:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;error&quot;</span> : &#123;</span><br><span class="line">    <span class="string">&quot;root_cause&quot;</span> : [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span> : <span class="string">&quot;index_not_found_exception&quot;</span>,</span><br><span class="line">        <span class="string">&quot;reason&quot;</span> : <span class="string">&quot;no such index&quot;</span>,</span><br><span class="line">        <span class="string">&quot;resource.type&quot;</span> : <span class="string">&quot;index_or_alias&quot;</span>,</span><br><span class="line">        <span class="string">&quot;resource.id&quot;</span> : <span class="string">&quot;addre&quot;</span>,</span><br><span class="line">        <span class="string">&quot;index_uuid&quot;</span> : <span class="string">&quot;_na_&quot;</span>,</span><br><span class="line">        <span class="string">&quot;index&quot;</span> : <span class="string">&quot;addre&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="string">&quot;type&quot;</span> : <span class="string">&quot;index_not_found_exception&quot;</span>,</span><br><span class="line">    <span class="string">&quot;reason&quot;</span> : <span class="string">&quot;no such index&quot;</span>,</span><br><span class="line">    <span class="string">&quot;resource.type&quot;</span> : <span class="string">&quot;index_or_alias&quot;</span>,</span><br><span class="line">    <span class="string">&quot;resource.id&quot;</span> : <span class="string">&quot;addre&quot;</span>,</span><br><span class="line">    <span class="string">&quot;index_uuid&quot;</span> : <span class="string">&quot;_na_&quot;</span>,</span><br><span class="line">    <span class="string">&quot;index&quot;</span> : <span class="string">&quot;addre&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;status&quot;</span> : <span class="number">404</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>(2)在6.0之前的版本中, 如果修改已经关闭了的索引, 会抛出类似于下面的错误:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;error&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;root_cause&quot;</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;illegal_argument_exception&quot;</span>,</span><br><span class="line">        <span class="string">&quot;reason&quot;</span>: <span class="string">&quot;Can&#x27;t update [index.number_of_replicas] on closed indices [[address/MMpLNHzZR8K1k48rJplWVw]] - can leave index in an unopenable state&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="string">&quot;type&quot;</span>: <span class="string">&quot;illegal_argument_exception&quot;</span>,</span><br><span class="line">    <span class="string">&quot;reason&quot;</span>: <span class="string">&quot;Can&#x27;t update [index.number_of_replicas] on closed indices [[address/MMpLNHzZR8K1k48rJplWVw]] - can leave index in an unopenable state&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;status&quot;</span>: <span class="number">400</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>在本篇博客演示所用的Elasticsearch 6.6.0版本中, 并不存在此异常信息.</p>
</blockquote>
<h2 id="document数据类型"><a href="#document数据类型" class="headerlink" title="document数据类型"></a>document数据类型</h2><blockquote>
<p>说在前面: <strong>Elasticsearch中每个field都要精确对应一个数据类型.</strong><br>本文的所有演示, 都是基于Elasticsearch 6.6.0进行的, 不同的版本可能存在API发生修改、不支持的情况, 还请注意.</p>
</blockquote>
<h3 id="1-核心数据类型"><a href="#1-核心数据类型" class="headerlink" title="1 核心数据类型"></a>1 核心数据类型</h3><h4 id="1-1-字符串类型-string-不再支持"><a href="#1-1-字符串类型-string-不再支持" class="headerlink" title="1.1 字符串类型 - string(不再支持)"></a>1.1 字符串类型 - string(不再支持)</h4><p>(1)使用示例:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">PUT website</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;blog&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;title&quot;</span>: &#123;<span class="string">&quot;type&quot;</span>: <span class="string">&quot;string&quot;</span>&#125;, 	<span class="comment">// 全文本</span></span><br><span class="line">                <span class="string">&quot;tags&quot;</span>: &#123;<span class="string">&quot;type&quot;</span>: <span class="string">&quot;string&quot;</span>, <span class="string">&quot;index&quot;</span>: <span class="string">&quot;not_analyzed&quot;</span>&#125;	<span class="comment">// 关键字, 不分词</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>(2)ES 5.6.10中的响应信息:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#! Deprecation: The [string] field is deprecated, please use [text] or [keyword] instead on [tags]</span><br><span class="line">#! Deprecation: The [string] field is deprecated, please use [text] or [keyword] instead on [title]</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;acknowledged&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="string">&quot;shards_acknowledged&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="string">&quot;index&quot;</span>: <span class="string">&quot;website&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>(3)ES 6.6.0中的响应信息:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;error&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;root_cause&quot;</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;mapper_parsing_exception&quot;</span>,</span><br><span class="line">        <span class="string">&quot;reason&quot;</span>: <span class="string">&quot;No handler for type [string] declared on field [title]&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="string">&quot;type&quot;</span>: <span class="string">&quot;mapper_parsing_exception&quot;</span>,</span><br><span class="line">    <span class="string">&quot;reason&quot;</span>: <span class="string">&quot;Failed to parse mapping [blog]: No handler for type [string] declared on field [title]&quot;</span>,</span><br><span class="line">    <span class="string">&quot;caused_by&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;type&quot;</span>: <span class="string">&quot;mapper_parsing_exception&quot;</span>,</span><br><span class="line">      <span class="string">&quot;reason&quot;</span>: <span class="string">&quot;No handler for type [string] declared on field [title]&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;status&quot;</span>: <span class="number">400</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>可知string类型的field已经被移除了, 我们需要用text或keyword类型来代替string.</strong></p>
<h4 id="1-1-1-文本类型-text"><a href="#1-1-1-文本类型-text" class="headerlink" title="1.1.1 文本类型 - text"></a>1.1.1 文本类型 - text</h4><p>在Elasticsearch 5.4 版本开始, text取代了需要分词的string.</p>
<p>—— <strong>当一个字段需要用于全文搜索(会被分词), 比如产品名称、产品描述信息, 就应该使用text类型.</strong></p>
<blockquote>
<p>text的内容会被分词, 可以设置是否需要存储: <code>&quot;index&quot;: &quot;true|false&quot;</code>.<br>text类型的字段不能用于排序, 也很少用于聚合.</p>
</blockquote>
<p>使用示例:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">PUT website</span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;blog&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">        		<span class="string">&quot;summary&quot;</span>: &#123;<span class="string">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>, <span class="string">&quot;index&quot;</span>: <span class="string">&quot;true&quot;</span>&#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="1-1-2-关键字类型-keyword"><a href="#1-1-2-关键字类型-keyword" class="headerlink" title="1.1.2 关键字类型 - keyword"></a>1.1.2 关键字类型 - keyword</h4><p>在Elasticsearch 5.4 版本开始, keyword取代了不需要分词的string.</p>
<p>—— <strong>当一个字段需要按照精确值进行过滤、排序、聚合等操作时, 就应该使用keyword类型.</strong></p>
<blockquote>
<p>keyword的内容不会被分词, 可以设置是否需要存储: <code>&quot;index&quot;: &quot;true|false&quot;</code>.</p>
</blockquote>
<p>使用示例:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">PUT website</span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;blog&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">        		<span class="string">&quot;tags&quot;</span>: &#123;<span class="string">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>, <span class="string">&quot;index&quot;</span>: <span class="string">&quot;true&quot;</span>&#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="1-2-数字类型-8种"><a href="#1-2-数字类型-8种" class="headerlink" title="1.2 数字类型 - 8种"></a>1.2 数字类型 - 8种</h4><p>数字类型有如下分类:</p>
<table>
<thead>
<tr>
<th align="left">类型</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">byte</td>
<td align="left">有符号的8位整数, 范围: [-128 ~ 127]</td>
</tr>
<tr>
<td align="left">short</td>
<td align="left">有符号的16位整数, 范围: [-32768 ~ 32767]</td>
</tr>
<tr>
<td align="left">integer</td>
<td align="left">有符号的32位整数, 范围: [(-2^{31}) ~ (2^{31})-1]</td>
</tr>
<tr>
<td align="left">long</td>
<td align="left">有符号的64位整数, 范围: [(-2^{63}) ~ (2^{63})-1]</td>
</tr>
<tr>
<td align="left">float</td>
<td align="left">32位单精度浮点数</td>
</tr>
<tr>
<td align="left">double</td>
<td align="left">64位双精度浮点数</td>
</tr>
<tr>
<td align="left">half_float</td>
<td align="left">16位半精度IEEE 754浮点类型</td>
</tr>
<tr>
<td align="left">scaled_float</td>
<td align="left">缩放类型的的浮点数, 比如price字段只需精确到分, 57.34缩放因子为100, 存储结果为5734</td>
</tr>
</tbody></table>
<p>使用注意事项:</p>
<blockquote>
<p>尽可能选择范围小的数据类型, 字段的长度越短, 索引和搜索的效率越高;<br>优先考虑使用带缩放因子的浮点类型.</p>
</blockquote>
<p>使用示例:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">PUT shop</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;book&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;name&quot;</span>: &#123;<span class="string">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>&#125;,</span><br><span class="line">                <span class="string">&quot;quantity&quot;</span>: &#123;<span class="string">&quot;type&quot;</span>: <span class="string">&quot;integer&quot;</span>&#125;,  <span class="comment">// integer类型</span></span><br><span class="line">                <span class="string">&quot;price&quot;</span>: &#123;</span><br><span class="line">                    <span class="string">&quot;type&quot;</span>: <span class="string">&quot;scaled_float&quot;</span>,       <span class="comment">// scaled_float类型</span></span><br><span class="line">                    <span class="string">&quot;scaling_factor&quot;</span>: <span class="number">100</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="1-3-日期类型-date"><a href="#1-3-日期类型-date" class="headerlink" title="1.3 日期类型 - date"></a>1.3 日期类型 - date</h4><p>JSON没有日期数据类型, 所以在ES中, 日期可以是:</p>
<ul>
<li>包含格式化日期的字符串, “2018-10-01”, 或”2018&#x2F;10&#x2F;01 12:10:30”.</li>
<li>代表时间毫秒数的长整型数字.</li>
<li>代表时间秒数的整数.</li>
</ul>
<blockquote>
<p>如果时区未指定, 日期将被转换为UTC格式, 但存储的却是长整型的毫秒值.<br>可以自定义日期格式, 若未指定, 则使用默认格式: <code>strict_date_optional_time||epoch_millis</code></p>
</blockquote>
<p>(1)使用日期格式示例:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 添加映射</span></span><br><span class="line">PUT website</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;blog&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;pub_date&quot;</span>: &#123;<span class="string">&quot;type&quot;</span>: <span class="string">&quot;date&quot;</span>&#125;   <span class="comment">// 日期类型</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加数据</span></span><br><span class="line">PUT website/blog/<span class="number">11</span></span><br><span class="line">&#123; <span class="string">&quot;pub_date&quot;</span>: <span class="string">&quot;2018-10-10&quot;</span> &#125;</span><br><span class="line"></span><br><span class="line">PUT website/blog/<span class="number">12</span></span><br><span class="line">&#123; <span class="string">&quot;pub_date&quot;</span>: <span class="string">&quot;2018-10-10T12:00:00Z&quot;</span> &#125;	<span class="comment">// Solr中默认使用的日期格式</span></span><br><span class="line"></span><br><span class="line">PUT website/blog/<span class="number">13</span></span><br><span class="line">&#123; <span class="string">&quot;pub_date&quot;</span>: <span class="string">&quot;1589584930103&quot;</span> &#125;			<span class="comment">// 时间的毫秒值</span></span><br></pre></td></tr></table></figure>

<p>(2)多种日期格式:</p>
<blockquote>
<p>多个格式使用双竖线<code>||</code>分隔, 每个格式都会被依次尝试, 直到找到匹配的.<br>第一个格式用于将时间毫秒值转换为对应格式的字符串.</p>
</blockquote>
<p>使用示例:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 添加映射</span></span><br><span class="line">PUT website</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;blog&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;date&quot;</span>: &#123;</span><br><span class="line">                    <span class="string">&quot;type&quot;</span>: <span class="string">&quot;date&quot;</span>,  <span class="comment">// 可以接受如下类型的格式</span></span><br><span class="line">                    <span class="string">&quot;format&quot;</span>: <span class="string">&quot;yyyy-MM-dd HH:mm:ss||yyyy-MM-dd||epoch_millis&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="1-4-布尔类型-boolean"><a href="#1-4-布尔类型-boolean" class="headerlink" title="1.4 布尔类型 - boolean"></a>1.4 布尔类型 - boolean</h4><p>可以接受表示真、假的字符串或数字:</p>
<ul>
<li>真值: true, “true”, “on”, “yes”, “1”…</li>
<li>假值: false, “false”, “off”, “no”, “0”, “”(空字符串), 0.0, 0</li>
</ul>
<h4 id="1-5-二进制型-binary"><a href="#1-5-二进制型-binary" class="headerlink" title="1.5 二进制型 - binary"></a>1.5 二进制型 - binary</h4><p>二进制类型是Base64编码字符串的二进制值, 不以默认的方式存储, 且不能被搜索. 有2个设置项:</p>
<blockquote>
<p>(1) <code>doc_values</code>: 该字段是否需要存储到磁盘上, 方便以后用来排序、聚合或脚本查询. 接受<code>true</code>和<code>false</code>(默认);<br>(2) <code>store</code>: 该字段的值是否要和<code>_source</code>分开存储、检索, 意思是除了<code>_source</code>中, 是否要单独再存储一份. 接受<code>true</code>或<code>false</code>(默认).</p>
</blockquote>
<p>使用示例:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 添加映射</span></span><br><span class="line">PUT website</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;blog&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;blob&quot;</span>: &#123;<span class="string">&quot;type&quot;</span>: <span class="string">&quot;binary&quot;</span>&#125;   <span class="comment">// 二进制</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 添加数据</span></span><br><span class="line">PUT website/blog/<span class="number">1</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;title&quot;</span>: <span class="string">&quot;Some binary blog&quot;</span>,</span><br><span class="line">    <span class="string">&quot;blob&quot;</span>: <span class="string">&quot;hED903KSrA084fRiD5JLgY==&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意: Base64编码的二进制值不能嵌入换行符<code>\n</code>, 逗号(<code>0x2c</code>)等符号.</p>
</blockquote>
<h4 id="1-6-范围类型-range"><a href="#1-6-范围类型-range" class="headerlink" title="1.6 范围类型 - range"></a>1.6 范围类型 - range</h4><p>range类型支持以下几种:</p>
<table>
<thead>
<tr>
<th align="left">类型</th>
<th align="left">范围</th>
</tr>
</thead>
<tbody><tr>
<td align="left">integer_range</td>
<td align="left">(-2^{31}) ~ (2^{31}-1)</td>
</tr>
<tr>
<td align="left">long_range</td>
<td align="left">(-2^{63}) ~ (2^{63}-1)</td>
</tr>
<tr>
<td align="left">float_range</td>
<td align="left">32位单精度浮点型</td>
</tr>
<tr>
<td align="left">double_range</td>
<td align="left">64位双精度浮点型</td>
</tr>
<tr>
<td align="left">date_range</td>
<td align="left">64位整数, 毫秒计时</td>
</tr>
<tr>
<td align="left">ip_range</td>
<td align="left">IP值的范围, 支持IPV4和IPV6, 或者这两种同时存在</td>
</tr>
</tbody></table>
<p>(1)添加映射:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">PUT company</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;department&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;expected_number&quot;</span>: &#123;  <span class="comment">// 预期员工数</span></span><br><span class="line">                    <span class="string">&quot;type&quot;</span>: <span class="string">&quot;integer_range&quot;</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="string">&quot;time_frame&quot;</span>: &#123;       <span class="comment">// 发展时间线</span></span><br><span class="line">                    <span class="string">&quot;type&quot;</span>: <span class="string">&quot;date_range&quot;</span>, </span><br><span class="line">                    <span class="string">&quot;format&quot;</span>: <span class="string">&quot;yyyy-MM-dd HH:mm:ss||yyyy-MM-dd||epoch_millis&quot;</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="string">&quot;ip_whitelist&quot;</span>: &#123;     <span class="comment">// ip白名单</span></span><br><span class="line">                    <span class="string">&quot;type&quot;</span>: <span class="string">&quot;ip_range&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>(2)添加数据:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">PUT company/department/<span class="number">1</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;expected_number&quot;</span> : &#123;</span><br><span class="line">        <span class="string">&quot;gte&quot;</span> : <span class="number">10</span>,</span><br><span class="line">        <span class="string">&quot;lte&quot;</span> : <span class="number">20</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;time_frame&quot;</span> : &#123; </span><br><span class="line">        <span class="string">&quot;gte&quot;</span> : <span class="string">&quot;2018-10-01 12:00:00&quot;</span>, </span><br><span class="line">        <span class="string">&quot;lte&quot;</span> : <span class="string">&quot;2018-11-01&quot;</span></span><br><span class="line">    &#125;, </span><br><span class="line">    <span class="string">&quot;ip_whitelist&quot;</span>: <span class="string">&quot;192.168.0.0/16&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>(3)查询数据:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">GET company/department/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;term&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;expected_number&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;value&quot;</span>: <span class="number">12</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">GET company/department/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;range&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;time_frame&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;gte&quot;</span>: <span class="string">&quot;208-08-01&quot;</span>,</span><br><span class="line">                <span class="string">&quot;lte&quot;</span>: <span class="string">&quot;2018-12-01&quot;</span>,</span><br><span class="line">                <span class="string">&quot;relation&quot;</span>: <span class="string">&quot;within&quot;</span> </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>查询结果：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;took&quot;</span>: <span class="number">26</span>,</span><br><span class="line">  <span class="string">&quot;timed_out&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="string">&quot;_shards&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;total&quot;</span>: <span class="number">5</span>,</span><br><span class="line">    <span class="string">&quot;successful&quot;</span>: <span class="number">5</span>,</span><br><span class="line">    <span class="string">&quot;skipped&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="string">&quot;failed&quot;</span>: <span class="number">0</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;hits&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;total&quot;</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="string">&quot;max_score&quot;</span>: <span class="number">1.0</span>,</span><br><span class="line">    <span class="string">&quot;hits&quot;</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">&quot;_index&quot;</span>: <span class="string">&quot;company&quot;</span>,</span><br><span class="line">        <span class="string">&quot;_type&quot;</span>: <span class="string">&quot;department&quot;</span>,</span><br><span class="line">        <span class="string">&quot;_id&quot;</span>: <span class="string">&quot;1&quot;</span>,</span><br><span class="line">        <span class="string">&quot;_score&quot;</span>: <span class="number">1.0</span>,</span><br><span class="line">        <span class="string">&quot;_source&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;expected_number&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;gte&quot;</span>: <span class="number">10</span>,</span><br><span class="line">            <span class="string">&quot;lte&quot;</span>: <span class="number">20</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="string">&quot;time_frame&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;gte&quot;</span>: <span class="string">&quot;2018-10-01 12:00:00&quot;</span>,</span><br><span class="line">            <span class="string">&quot;lte&quot;</span>: <span class="string">&quot;2018-11-01&quot;</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="string">&quot;ip_whitelist&quot;</span> : <span class="string">&quot;192.168.0.0/16&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-复杂数据类型"><a href="#2-复杂数据类型" class="headerlink" title="2 复杂数据类型"></a>2 复杂数据类型</h3><h4 id="2-1-数组类型-array"><a href="#2-1-数组类型-array" class="headerlink" title="2.1 数组类型 - array"></a>2.1 数组类型 - array</h4><p>ES中没有专门的数组类型, 直接使用[]定义即可;</p>
<p><strong>数组中所有的值必须是同一种数据类型, 不支持混合数据类型的数组</strong>:</p>
<p><strong>1、</strong> 字符串数组: [“one”, “two”];<br><strong>2、</strong> 整数数组: [1, 2];<br><strong>3、</strong> 由数组组成的数组: [1, [2, 3]], 等价于[1, 2, 3];<br><strong>4、</strong> 对象数组: [{“name”: “Tom”, “age”: 20}, {“name”: “Jerry”, “age”: 18}].</p>
<p>注意:</p>
<blockquote>
<ul>
<li>动态添加数据时, 数组中第一个值的类型决定整个数组的类型;</li>
<li>不支持混合数组类型, 比如[1, “abc”];</li>
<li>数组可以包含null值, 空数组[]会被当做missing field —— 没有值的字段.</li>
</ul>
</blockquote>
<h4 id="2-2-对象类型-object"><a href="#2-2-对象类型-object" class="headerlink" title="2.2 对象类型 - object"></a>2.2 对象类型 - object</h4><p>JSON文档是分层的: 文档可以包含内部对象, 内部对象也可以包含内部对象.</p>
<p>(1)添加示例:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">PUT employee/developer/<span class="number">1</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;ma_shoufeng&quot;</span>,</span><br><span class="line">    <span class="string">&quot;address&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;region&quot;</span>: <span class="string">&quot;China&quot;</span>,</span><br><span class="line">        <span class="string">&quot;location&quot;</span>: &#123;<span class="string">&quot;province&quot;</span>: <span class="string">&quot;GuangDong&quot;</span>, <span class="string">&quot;city&quot;</span>: <span class="string">&quot;GuangZhou&quot;</span>&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>(2)存储方式:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;name&quot;</span>:                       <span class="string">&quot;ma_shoufeng&quot;</span>,</span><br><span class="line">    <span class="string">&quot;address.region&quot;</span>:             <span class="string">&quot;China&quot;</span>,</span><br><span class="line">    <span class="string">&quot;address.location.province&quot;</span>:  <span class="string">&quot;GuangDong&quot;</span>, </span><br><span class="line">    <span class="string">&quot;address.location.city&quot;</span>:      <span class="string">&quot;GuangZhou&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>(3)文档的映射结构类似为:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">PUT employee</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;developer&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;name&quot;</span>: &#123; <span class="string">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>, <span class="string">&quot;index&quot;</span>: <span class="string">&quot;true&quot;</span> &#125;, </span><br><span class="line">                <span class="string">&quot;address&quot;</span>: &#123;</span><br><span class="line">                    <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">                        <span class="string">&quot;region&quot;</span>: &#123; <span class="string">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>, <span class="string">&quot;index&quot;</span>: <span class="string">&quot;true&quot;</span> &#125;,</span><br><span class="line">                        <span class="string">&quot;location&quot;</span>: &#123;</span><br><span class="line">                            <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">                                <span class="string">&quot;province&quot;</span>: &#123; <span class="string">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>, <span class="string">&quot;index&quot;</span>: <span class="string">&quot;true&quot;</span> &#125;,</span><br><span class="line">                                <span class="string">&quot;city&quot;</span>: &#123; <span class="string">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>, <span class="string">&quot;index&quot;</span>: <span class="string">&quot;true&quot;</span> &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-3-嵌套类型-nested"><a href="#2-3-嵌套类型-nested" class="headerlink" title="2.3 嵌套类型 - nested"></a>2.3 嵌套类型 - nested</h4><p>嵌套类型是对象数据类型的一个特例, 可以让array类型的对象被独立索引和搜索.</p>
<h4 id="2-3-1-对象数组是如何存储的"><a href="#2-3-1-对象数组是如何存储的" class="headerlink" title="2.3.1 对象数组是如何存储的"></a>2.3.1 对象数组是如何存储的</h4><p><strong>1、</strong> 添加数据:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">PUT game_of_thrones/role/<span class="number">1</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;group&quot;</span>: <span class="string">&quot;stark&quot;</span>,</span><br><span class="line">	<span class="string">&quot;performer&quot;</span>: [</span><br><span class="line">        &#123;<span class="string">&quot;first&quot;</span>: <span class="string">&quot;John&quot;</span>, <span class="string">&quot;last&quot;</span>: <span class="string">&quot;Snow&quot;</span>&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;first&quot;</span>: <span class="string">&quot;Sansa&quot;</span>, <span class="string">&quot;last&quot;</span>: <span class="string">&quot;Stark&quot;</span>&#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>2、</strong> 内部存储结构:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;group&quot;</span>: 	         <span class="string">&quot;stark&quot;</span>,</span><br><span class="line">    <span class="string">&quot;performer.first&quot;</span>: [ <span class="string">&quot;john&quot;</span>, <span class="string">&quot;sansa&quot;</span> ],</span><br><span class="line">    <span class="string">&quot;performer.last&quot;</span>:  [ <span class="string">&quot;snow&quot;</span>, <span class="string">&quot;stark&quot;</span> ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>3、</strong> 存储分析:</p>
<p>可以看出, user.first和user.last会被平铺为多值字段, 这样一来, John和Snow之间的关联性就丢失了.</p>
<p>在查询时, 可能出现John Stark的结果.</p>
<h4 id="2-3-2-用nested类型解决object类型的不足"><a href="#2-3-2-用nested类型解决object类型的不足" class="headerlink" title="2.3.2 用nested类型解决object类型的不足"></a>2.3.2 用nested类型解决object类型的不足</h4><p>如果需要对以最对象进行索引, 且保留数组中每个对象的独立性, 就应该使用嵌套数据类型.</p>
<p>——嵌套对象实质是将每个对象分离出来, 作为隐藏文档进行索引.</p>
<p><strong>1、</strong> 创建映射:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">PUT game_of_thrones</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;role&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;performer&quot;</span>: &#123;<span class="string">&quot;type&quot;</span>: <span class="string">&quot;nested&quot;</span> &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>2、</strong> 添加数据:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">PUT game_of_thrones/role/<span class="number">1</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;group&quot;</span> : <span class="string">&quot;stark&quot;</span>,</span><br><span class="line">    <span class="string">&quot;performer&quot;</span> : [</span><br><span class="line">        &#123;<span class="string">&quot;first&quot;</span>: <span class="string">&quot;John&quot;</span>, <span class="string">&quot;last&quot;</span>: <span class="string">&quot;Snow&quot;</span>&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;first&quot;</span>: <span class="string">&quot;Sansa&quot;</span>, <span class="string">&quot;last&quot;</span>: <span class="string">&quot;Stark&quot;</span>&#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>3、</strong> 检索数据:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">GET game_of_thrones/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;nested&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;path&quot;</span>: <span class="string">&quot;performer&quot;</span>,</span><br><span class="line">            <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;bool&quot;</span>: &#123;</span><br><span class="line">                    <span class="string">&quot;must&quot;</span>: [</span><br><span class="line">                        &#123; <span class="string">&quot;match&quot;</span>: &#123; <span class="string">&quot;performer.first&quot;</span>: <span class="string">&quot;John&quot;</span> &#125;&#125;,</span><br><span class="line">                        &#123; <span class="string">&quot;match&quot;</span>: &#123; <span class="string">&quot;performer.last&quot;</span>:  <span class="string">&quot;Snow&quot;</span> &#125;&#125; </span><br><span class="line">                    ]</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;, </span><br><span class="line">            <span class="string">&quot;inner_hits&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;highlight&quot;</span>: &#123;</span><br><span class="line">                    <span class="string">&quot;fields&quot;</span>: &#123;<span class="string">&quot;performer.first&quot;</span>: &#123;&#125;&#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-地理数据类型"><a href="#3-地理数据类型" class="headerlink" title="3 地理数据类型"></a>3 地理数据类型</h3><h4 id="3-1-地理点类型-geo-point"><a href="#3-1-地理点类型-geo-point" class="headerlink" title="3.1 地理点类型 - geo point"></a>3.1 地理点类型 - geo point</h4><p>地理点类型用于存储地理位置的经纬度对, 可用于:</p>
<blockquote>
<ul>
<li>查找一定范围内的地理点;</li>
<li>通过地理位置或相对某个中心点的距离聚合文档;</li>
<li>将距离整合到文档的相关性评分中;</li>
<li>通过距离对文档进行排序.</li>
</ul>
</blockquote>
<p>(1)添加映射:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">PUT employee</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;developer&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;location&quot;</span>: &#123;<span class="string">&quot;type&quot;</span>: <span class="string">&quot;geo_point&quot;</span>&#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>(2)存储地理位置:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 方式一: 纬度 + 经度键值对</span></span><br><span class="line">PUT employee/developer/<span class="number">1</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;text&quot;</span>: <span class="string">&quot;小蛮腰-键值对地理点参数&quot;</span>, </span><br><span class="line">    <span class="string">&quot;location&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;lat&quot;</span>: <span class="number">23.11</span>, <span class="string">&quot;lon&quot;</span>: <span class="number">113.33</span>		<span class="comment">// 纬度: latitude, 经度: longitude</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 方式二: &quot;纬度, 经度&quot;的字符串参数</span></span><br><span class="line">PUT employee/developer/<span class="number">2</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;text&quot;</span>: <span class="string">&quot;小蛮腰-字符串地理点参数&quot;</span>,</span><br><span class="line">  <span class="string">&quot;location&quot;</span>: <span class="string">&quot;23.11, 113.33&quot;</span> 			<span class="comment">// 纬度, 经度</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 方式三: [&quot;经度, 纬度&quot;] 数组地理点参数</span></span><br><span class="line">PUT employee/developer/<span class="number">3</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;text&quot;</span>: <span class="string">&quot;小蛮腰-数组参数&quot;</span>,</span><br><span class="line">  <span class="string">&quot;location&quot;</span>: [ <span class="number">113.33</span>, <span class="number">23.11</span> ] 		<span class="comment">// 经度, 纬度</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>(3)查询示例:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET employee/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;query&quot;</span>: &#123; </span><br><span class="line">        <span class="string">&quot;geo_bounding_box&quot;</span>: &#123; </span><br><span class="line">            <span class="string">&quot;location&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;top_left&quot;</span>: &#123; <span class="string">&quot;lat&quot;</span>: <span class="number">24</span>, <span class="string">&quot;lon&quot;</span>: <span class="number">113</span> &#125;,		<span class="comment">// 地理盒子模型的上-左边</span></span><br><span class="line">                <span class="string">&quot;bottom_right&quot;</span>: &#123; <span class="string">&quot;lat&quot;</span>: <span class="number">22</span>, <span class="string">&quot;lon&quot;</span>: <span class="number">114</span> &#125;	<span class="comment">// 地理盒子模型的下-右边</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-2-地理形状类型-geo-shape"><a href="#3-2-地理形状类型-geo-shape" class="headerlink" title="3.2 地理形状类型 - geo_shape"></a>3.2 地理形状类型 - geo_shape</h4><p>是多边形的复杂形状. 使用较少, 这里省略.</p>
<p>可以参考这篇文章: <a target="_blank" rel="noopener" href="https://blog.csdn.net/u012332735/article/details/54971638">Elasticsearch地理位置总结</a></p>
<h3 id="4-专门数据类型"><a href="#4-专门数据类型" class="headerlink" title="4 专门数据类型"></a>4 专门数据类型</h3><h4 id="4-1-IP类型"><a href="#4-1-IP类型" class="headerlink" title="4.1 IP类型"></a>4.1 IP类型</h4><p>IP类型的字段用于存储IPv4或IPv6的地址, 本质上是一个长整型字段.</p>
<p>(1)添加映射:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">PUT employee</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;customer&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;ip_addr&quot;</span>: &#123; <span class="string">&quot;type&quot;</span>: <span class="string">&quot;ip&quot;</span> &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>(2)添加数据:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">PUT employee/customer/<span class="number">1</span></span><br><span class="line">&#123; <span class="string">&quot;ip_addr&quot;</span>: <span class="string">&quot;192.168.1.1&quot;</span> &#125;</span><br></pre></td></tr></table></figure>

<p>(3)查询数据:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">GET employee/customer/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;term&quot;</span>: &#123; <span class="string">&quot;ip_addr&quot;</span>: <span class="string">&quot;192.168.0.0/16&quot;</span> &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="4-2-计数数据类型-token-count"><a href="#4-2-计数数据类型-token-count" class="headerlink" title="4.2 计数数据类型 - token_count"></a>4.2 计数数据类型 - token_count</h4><p>token_count类型用于统计字符串中的单词数量.</p>
<p>本质上是一个整数型字段, 接受并分析字符串值, 然后索引字符串中单词的个数.</p>
<p>(1)添加映射:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">PUT employee</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;customer&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;name&quot;</span>: &#123; </span><br><span class="line">                    <span class="string">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;fields&quot;</span>: &#123;</span><br><span class="line">                        <span class="string">&quot;length&quot;</span>: &#123;</span><br><span class="line">                            <span class="string">&quot;type&quot;</span>: <span class="string">&quot;token_count&quot;</span>, </span><br><span class="line">                            <span class="string">&quot;analyzer&quot;</span>: <span class="string">&quot;standard&quot;</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>(2)添加数据:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">PUT employee/customer/<span class="number">1</span></span><br><span class="line">&#123; <span class="string">&quot;name&quot;</span>: <span class="string">&quot;John Snow&quot;</span> &#125;</span><br><span class="line">PUT employee/customer/<span class="number">2</span></span><br><span class="line">&#123; <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Tyrion Lannister&quot;</span> &#125;</span><br></pre></td></tr></table></figure>

<p>(3)查询数据:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">GET employee/customer/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;term&quot;</span>: &#123; <span class="string">&quot;name.length&quot;</span>: <span class="number">2</span> &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h2 id="DSL查询"><a href="#DSL查询" class="headerlink" title="DSL查询"></a>DSL查询</h2><h3 id="1-什么是DSL"><a href="#1-什么是DSL" class="headerlink" title="1 什么是DSL"></a>1 什么是DSL</h3><p>DSL: Domain Specific Language, 领域特定语言, 指的是专注于某个应用程序领域的、具有高度针对性的计算机语言.</p>
<p><strong>Query String 与 Query DSL之间的区别:</strong></p>
<blockquote>
<p>Query String: 在请求的URL后直接拼接查询条件;<br>Query DSL: 在请求的Request Body中携带查询条件.</p>
</blockquote>
<p><strong>DSL功能强大, 可以构建复杂的查询、过滤、聚合条件, 所以这种查询方式的用途最广.</strong></p>
<h3 id="2-validate-校验查询语句是否合法"><a href="#2-validate-校验查询语句是否合法" class="headerlink" title="2 _validate - 校验查询语句是否合法"></a>2 _validate - 校验查询语句是否合法</h3><p><strong>对于复杂的查询, 很有必要在查询前使用<code>validate API</code>进行验证, 保证DSL语句的正确有效:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 要查询name中包含&quot;java&quot;的文档: </span></span><br><span class="line">GET shop/it_book/_validate/query?explain</span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;math&quot;</span>: &#123;            <span class="comment">// 错误的查询名称, 应该是match</span></span><br><span class="line">            <span class="string">&quot;name&quot;</span>: <span class="string">&quot;java&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 校验结果: </span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;valid&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="string">&quot;error&quot;</span>: <span class="string">&quot;org.elasticsearch.common.ParsingException: no [query] registered for [math]&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 修改math为match后, 校验结果为: </span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;valid&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="string">&quot;_shards&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;total&quot;</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="string">&quot;successful&quot;</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="string">&quot;failed&quot;</span>: <span class="number">0</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;explanations&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;index&quot;</span>: <span class="string">&quot;shop&quot;</span>,</span><br><span class="line">            <span class="string">&quot;valid&quot;</span>: <span class="literal">true</span>,    <span class="comment">// 校验通过, DSL有效</span></span><br><span class="line">            <span class="string">&quot;explanation&quot;</span>: <span class="string">&quot;+name:java_type:it_book&quot;</span>  <span class="comment">// 查询条件, +表示必须存在</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-match-query-匹配查询"><a href="#3-match-query-匹配查询" class="headerlink" title="3 match query - 匹配查询"></a>3 match query - 匹配查询</h3><h4 id="3-1-简单功能示例"><a href="#3-1-简单功能示例" class="headerlink" title="3.1 简单功能示例"></a>3.1 简单功能示例</h4><h4 id="3-1-1-查询所有文档"><a href="#3-1-1-查询所有文档" class="headerlink" title="3.1.1 查询所有文档"></a>3.1.1 查询所有文档</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">GET shop/it_book/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;match_all&quot;</span>: &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-1-2-查询满足一定条件的文档"><a href="#3-1-2-查询满足一定条件的文档" class="headerlink" title="3.1.2 查询满足一定条件的文档"></a>3.1.2 查询满足一定条件的文档</h4><p>查询name中包含”java”的文档, 同时按照价格升序排序:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">GET shop/it_book/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;name&quot;</span>: <span class="string">&quot;java&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, </span><br><span class="line">    <span class="string">&quot;sort&quot;</span>: [</span><br><span class="line">        &#123; </span><br><span class="line">            <span class="string">&quot;price&quot;</span>: &#123;<span class="string">&quot;order&quot;</span>: <span class="string">&quot;asc&quot;</span>&#125; </span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-1-3-分页查询文档"><a href="#3-1-3-分页查询文档" class="headerlink" title="3.1.3 分页查询文档"></a>3.1.3 分页查询文档</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET shop/it_book/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;match_all&quot;</span>: &#123;&#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;from&quot;</span>: <span class="number">0</span>,      <span class="comment">// 开始记录数, 起始数为0</span></span><br><span class="line">    <span class="string">&quot;size&quot;</span>: <span class="number">1</span>       <span class="comment">// 页大小, 即每页显示的记录数</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-1-4-指定返回的结果中包含的字段"><a href="#3-1-4-指定返回的结果中包含的字段" class="headerlink" title="3.1.4 指定返回的结果中包含的字段"></a>3.1.4 指定返回的结果中包含的字段</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">GET shop/it_book/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;match_all&quot;</span>: &#123;&#125;</span><br><span class="line">    &#125;, </span><br><span class="line">    <span class="string">&quot;_source&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;name&quot;</span>, 	<span class="comment">// 显示商品名称</span></span><br><span class="line">        <span class="string">&quot;price&quot;</span>		<span class="comment">// 显示商品价格</span></span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-2-精确查询-match-phrase"><a href="#3-2-精确查询-match-phrase" class="headerlink" title="3.2 精确查询 - match_phrase"></a>3.2 精确查询 - match_phrase</h4><p>不同的数据类型在建立倒排索引时, 有的会作为full text处理, 有的作为exact value处理.</p>
<p>对查询串分词时, 使用的分析器(analyzer)必须和创建index时使用的相同, 否则将检索不到准确的数据.</p>
<h4 id="3-2-1-精确匹配-exact-value"><a href="#3-2-1-精确匹配-exact-value" class="headerlink" title="3.2.1 精确匹配 - exact value"></a>3.2.1 精确匹配 - exact value</h4><p>常见的exact value类型有date - 日期类型.</p>
<p><strong>ES检索时, 不会对String进行分词, 而是完全根据String的值去精确匹配, 查找相应的文档.</strong></p>
<p>在DSL中, 通过<code>match_phrase</code>短语匹配达到精确匹配的目的 —— 不会对查询串进行分词, 而是直接精确匹配查找.</p>
<p>示例:查询name中包含”thinking in java”的文档, 不会对查询串进行分词:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET shop/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;match_phrase&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;name&quot;</span>: <span class="string">&quot;thinking in java&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-2-2-全文搜索-full-text"><a href="#3-2-2-全文搜索-full-text" class="headerlink" title="3.2.2 全文搜索 - full text"></a>3.2.2 全文搜索 - full text</h4><p>常见的full text类型有: text - 文本串.</p>
<p><strong>ES检索时, 会对检索串进行分词, 包括缩写、时态、同义词等转换手段, 然后根据分词结果与倒排索引进行匹配, 查找相应的文档.</strong></p>
<blockquote>
<p>索引中只要有任意一个相关field的分词 匹配拆分后的词, 这个文档就可以出现在结果中, 只是匹配度越高的排名越靠前.</p>
</blockquote>
<p>示例:查询name中包含”thinking in java”的文档, 会将查询串拆分为”think”, “in”, “java”三个词:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET shop/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;name&quot;</span>: <span class="string">&quot;thinking in java&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-3-控制匹配规则-operator"><a href="#3-3-控制匹配规则-operator" class="headerlink" title="3.3 控制匹配规则 - operator"></a>3.3 控制匹配规则 - operator</h4><p><code>operator</code> 操作符, 用来指定ES对分词后的词项如何进行检索过滤. 选项有:</p>
<blockquote>
<p>and, 作用 &#x3D;&#x3D; match_phrase, 即全部匹配;<br>or, 作用 &#x3D;&#x3D; match, 即部分匹配.</p>
</blockquote>
<p>使用示例:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET shop/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;name&quot;</span>: &#123;					<span class="comment">// 要查询的field </span></span><br><span class="line">                <span class="string">&quot;query&quot;</span>: <span class="string">&quot;编程思想&quot;</span>,</span><br><span class="line">                <span class="string">&quot;operator&quot;</span>: <span class="string">&quot;or&quot;</span>		<span class="comment">// 操作符</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-4-指定命中的百分比-minimum-should-match"><a href="#3-4-指定命中的百分比-minimum-should-match" class="headerlink" title="3.4 指定命中的百分比 - minimum_should_match"></a>3.4 指定命中的百分比 - minimum_should_match</h4><p><code>minimum_should_match</code> 用来指定最少要匹配多少比例的分词, 才算符合条件并返回结果.</p>
<p>示例:搜索name中包含”并发编程的艺术”, 被拆分成”并发”, “编程”, “艺术”等词, 现在要求至少匹配50%的分词, 可以这样:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET shop/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;name&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;query&quot;</span>: <span class="string">&quot;并发编程的艺术&quot;</span>, </span><br><span class="line">                <span class="string">&quot;minimum_should_match&quot;</span>: <span class="string">&quot;50%&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当然这种需求也可以用 must、must_not、should 匹配同一个字段的方式进行组合查询.</p>
<h4 id="3-5-多字段的匹配-multi-match"><a href="#3-5-多字段的匹配-multi-match" class="headerlink" title="3.5 多字段的匹配 - multi_match"></a>3.5 多字段的匹配 - multi_match</h4><p><code>multi_match</code> 用来对多个字段同时进行匹配: 任意一个字段中存在相应的分词, 就可作为结果返回.</p>
<p>示例 <strong>1、</strong> : 查询 name 或 desc 字段中包含 “面试经典” 的文档 —— 会对查询串进行分词:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">GET shop/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;multi_match&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;query&quot;</span>: <span class="string">&quot;面试经典&quot;</span>, </span><br><span class="line">            <span class="string">&quot;fields&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;name&quot;</span>, </span><br><span class="line">                <span class="string">&quot;desc&quot;</span></span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>示例 <strong>2、</strong> : 查询 name 或 desc 字段中同时包含 “面试经典” 的文档 —— 不对查询串进行分词:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">GET shop/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;multi_match&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;query&quot;</span>: <span class="string">&quot;面试经典&quot;</span>,</span><br><span class="line">            <span class="string">&quot;type&quot;</span>: <span class="string">&quot;cross_fields&quot;</span>, <span class="comment">// 还有best_fields、most_fields、phrase、phrase_prefix选项</span></span><br><span class="line">            <span class="string">&quot;operator&quot;</span>: <span class="string">&quot;and&quot;</span>, 		<span class="comment">// 全部匹配, or是部分匹配</span></span><br><span class="line">            <span class="string">&quot;fields&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;name&quot;</span>, </span><br><span class="line">                <span class="string">&quot;desc&quot;</span></span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-bool-query-布尔查询-真假查询"><a href="#4-bool-query-布尔查询-真假查询" class="headerlink" title="4 bool query - 布尔查询(真假查询)"></a>4 bool query - 布尔查询(真假查询)</h3><p>bool query, 顾名思义, 就是 <strong>真假&#x2F;有无</strong> 查询. 包括4个子查询:</p>
<p><strong>1、</strong> must - 必须匹配, 类似于SQL中的 <code>=</code> ;<br><strong>2、</strong> must_not - 必须不匹配, 类似于SQL中的 <code>!=</code> ;<br><strong>3、</strong> should - 不强制匹配, 类似于SQL中的 <code>or</code> ;<br><strong>4、</strong> filter - 过滤, 将满足一定条件的文档筛选出来.</p>
<p><strong>除filter之外, 每个子查询都会根据自己的条件计算出每个文档的相关度分数, 然后bool综合所有分数, 合并为一个.</strong></p>
<h4 id="4-1-简单功能示例"><a href="#4-1-简单功能示例" class="headerlink" title="4.1 简单功能示例"></a>4.1 简单功能示例</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">GET shop/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;bool&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;must&quot;</span>:[ </span><br><span class="line">                &#123; <span class="string">&quot;match&quot;</span>: &#123; <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Java&quot;</span> &#125; &#125;</span><br><span class="line">            ], </span><br><span class="line">            <span class="string">&quot;must_not&quot;</span>: [</span><br><span class="line">                &#123; <span class="string">&quot;match&quot;</span>: &#123; <span class="string">&quot;desc&quot;</span>: <span class="string">&quot;编程&quot;</span> &#125; &#125;</span><br><span class="line">            ], </span><br><span class="line">            <span class="string">&quot;should&quot;</span>: [</span><br><span class="line">                &#123; <span class="string">&quot;match&quot;</span>: &#123; <span class="string">&quot;publisher&quot;</span>: <span class="string">&quot;机械工业&quot;</span> &#125; &#125;</span><br><span class="line">            ], </span><br><span class="line">            <span class="string">&quot;filter&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;bool&quot;</span>: &#123; </span><br><span class="line">                    <span class="string">&quot;must&quot;</span>: [</span><br><span class="line">                        &#123; <span class="string">&quot;range&quot;</span>: &#123; <span class="string">&quot;date&quot;</span>: &#123; <span class="string">&quot;gte&quot;</span>: <span class="string">&quot;2010-01-01&quot;</span> &#125;&#125;&#125;,</span><br><span class="line">                        &#123; <span class="string">&quot;range&quot;</span>: &#123; <span class="string">&quot;price&quot;</span>: &#123; <span class="string">&quot;lte&quot;</span>: <span class="number">99.00</span> &#125;&#125;&#125;</span><br><span class="line">                    ]</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="4-2-嵌套使用bool-query"><a href="#4-2-嵌套使用bool-query" class="headerlink" title="4.2 嵌套使用bool query"></a>4.2 嵌套使用bool query</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">GET shop/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;bool&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;should&quot;</span>: [</span><br><span class="line">                &#123; <span class="string">&quot;term&quot;</span>: &#123; <span class="string">&quot;name.keyword&quot;</span>: <span class="string">&quot;Java编程思想&quot;</span> &#125; &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="string">&quot;bool&quot;</span>: &#123;</span><br><span class="line">                        <span class="string">&quot;must&quot;</span>: [</span><br><span class="line">                            &#123; <span class="string">&quot;term&quot;</span>: &#123; <span class="string">&quot;product_desc&quot;</span>: <span class="string">&quot;刷头&quot;</span> &#125; &#125;</span><br><span class="line">                        ]</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="4-3-直接filter操作-使用constant-score"><a href="#4-3-直接filter操作-使用constant-score" class="headerlink" title="4.3 直接filter操作 - 使用constant_score"></a>4.3 直接filter操作 - 使用constant_score</h4><blockquote>
<p>如果不指定query条件而直接filter, 将抛出<code>no [query] registered for [filter]</code>, 此时通过<code>constant_score</code>即可实现直接filter.</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">GET shop/_search </span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    	<span class="string">&quot;constant_score&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;filter&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;range&quot;</span>: &#123; <span class="string">&quot;price&quot;</span>: &#123; <span class="string">&quot;gte&quot;</span>: <span class="number">80</span> &#125; &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="4-4-指定should的匹配个数-minimum-should-match"><a href="#4-4-指定should的匹配个数-minimum-should-match" class="headerlink" title="4.4 指定should的匹配个数 - minimum_should_match"></a>4.4 指定should的匹配个数 - minimum_should_match</h4><p>如果组合查询中没有<code>must</code>, 就会至少匹配一个<code>should</code>.</p>
<p>可以通过 <code>minimum_should_match</code> 指定匹配的<code>should</code>的个数.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">GET shop/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;bool&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;should&quot;</span>: [</span><br><span class="line">                &#123; <span class="string">&quot;match&quot;</span>: &#123; <span class="string">&quot;name&quot;</span>: <span class="string">&quot;java&quot;</span> &#125; &#125;, </span><br><span class="line">                &#123; <span class="string">&quot;match&quot;</span>: &#123; <span class="string">&quot;desc&quot;</span>: <span class="string">&quot;编程&quot;</span>&#125; &#125;, </span><br><span class="line">                &#123; <span class="string">&quot;match&quot;</span>: &#123; <span class="string">&quot;price&quot;</span>: <span class="number">109</span> &#125; &#125;</span><br><span class="line">            ], </span><br><span class="line">            <span class="string">&quot;minimum_should_match&quot;</span>: <span class="number">2</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="高级查询"><a href="#高级查询" class="headerlink" title="高级查询"></a>高级查询</h2><h3 id="1-term-query-索引词检索"><a href="#1-term-query-索引词检索" class="headerlink" title="1 term query - 索引词检索"></a>1 term query - 索引词检索</h3><h4 id="1-1-term-query-不分词检索"><a href="#1-1-term-query-不分词检索" class="headerlink" title="1.1 term query - 不分词检索"></a>1.1 term query - 不分词检索</h4><p><code>term query</code>: 把检索串当作一个整体来执行检索, 即不会对检索串分词.</p>
<blockquote>
<p>term是完全匹配检索, 要用在不分词的字段上, 如果某个field在映射中被分词了, term检索将不起作用.<br>所以, 不分词的field, 要在mapping中设置为不分词.</p>
</blockquote>
<p>——ES 5.x之后, 为每个text类型的字段新增了名为keyword的子字段, 是不分词的, 默认保留256个字符.</p>
<p>——可以使用keyword字段进行term检索. 示例:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET shop/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;term&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;name.keyword&quot;</span>: <span class="string">&quot;Java编程思想&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="1-2-terms-query-in检索"><a href="#1-2-terms-query-in检索" class="headerlink" title="1.2 terms query - in检索"></a>1.2 terms query - in检索</h4><p><code>terms</code>, 相当于多个<code>term</code>检索, 类似于SQL中in关键字的用法, 即在某些给定的数据中检索:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">GET shop/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;terms&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;name.keyword&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;Java编程思想&quot;</span>, <span class="string">&quot;Java并发编程的艺术&quot;</span></span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-prefix-query-前缀检索"><a href="#2-prefix-query-前缀检索" class="headerlink" title="2 prefix query - 前缀检索"></a>2 prefix query - 前缀检索</h3><p><code>prefix query</code>, 就是前缀检索. 比如商品name中有多个以”Java”开头的document, 检索前缀”Java”时就能检索到所有以”Java”开头的文档.</p>
<p>—— <strong>扫描所有倒排索引, 性能较差</strong>.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">GET shop/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;prefix&quot;</span>: &#123; <span class="string">&quot;name&quot;</span>: <span class="string">&quot;java&quot;</span> &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-wildcard-query-通配符检索"><a href="#3-wildcard-query-通配符检索" class="headerlink" title="3 wildcard query - 通配符检索"></a>3 wildcard query - 通配符检索</h3><p><strong>扫描所有倒排索引, 性能较差</strong>.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">GET shop/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;wildcard&quot;</span>: &#123; <span class="string">&quot;name&quot;</span>: <span class="string">&quot;ja*&quot;</span> &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-regexp-query-正则检索"><a href="#4-regexp-query-正则检索" class="headerlink" title="4 regexp query - 正则检索"></a>4 regexp query - 正则检索</h3><p><strong>扫描所有倒排索引, 性能较差</strong>.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">GET shop/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;regexp&quot;</span>: &#123; <span class="string">&quot;name&quot;</span>: <span class="string">&quot;jav[a-z]*&quot;</span> &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-fuzzy-query-纠错检索"><a href="#5-fuzzy-query-纠错检索" class="headerlink" title="5 fuzzy query - 纠错检索"></a>5 fuzzy query - 纠错检索</h3><p><code>fuzziness</code>的默认值是2 —— 表示最多可以纠错两次.</p>
<p>说明:<code>fuzziness</code>的值太大, 将削弱检索条件的作用, 也就是说纠错次数太多, 就会导致限定检索结果的检索条件被改变, 失去了限定作用.</p>
<p>示例:检索name中包含”Java”的文档, Java中缺失了一个字母a:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">GET shop/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;match&quot;</span>: &#123; </span><br><span class="line">            <span class="string">&quot;name&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;query&quot;</span>: <span class="string">&quot;Jav&quot;</span>, </span><br><span class="line">                <span class="string">&quot;fuzziness&quot;</span>: <span class="number">1</span>, </span><br><span class="line">                <span class="string">&quot;operator&quot;</span>: <span class="string">&quot;and&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="6-boost评分权重-控制文档的优先级别"><a href="#6-boost评分权重-控制文档的优先级别" class="headerlink" title="6 boost评分权重 - 控制文档的优先级别"></a>6 boost评分权重 - 控制文档的优先级别</h3><p>通过boost参数, 令满足某个条件的文档的得分更高, 从而使得其排名更靠前.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">GET shop/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;bool&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;must&quot;</span>: [</span><br><span class="line">                &#123; <span class="string">&quot;match&quot;</span>: &#123; <span class="string">&quot;name&quot;</span>: <span class="string">&quot;编程思想&quot;</span>&#125; &#125;</span><br><span class="line">            ], </span><br><span class="line">            <span class="string">&quot;should&quot;</span>: [</span><br><span class="line">                &#123; </span><br><span class="line">                   <span class="string">&quot;match&quot;</span>: &#123; </span><br><span class="line">                        <span class="string">&quot;name&quot;</span>: &#123;</span><br><span class="line">                            <span class="string">&quot;query&quot;</span>: <span class="string">&quot;艺术&quot;</span>, </span><br><span class="line">                            <span class="string">&quot;boost&quot;</span>: <span class="number">2</span>        <span class="comment">// 提升评分权重</span></span><br><span class="line">                        &#125; </span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="7-dis-max的用法-best-fields策略"><a href="#7-dis-max的用法-best-fields策略" class="headerlink" title="7 dis_max的用法 - best fields策略"></a>7 dis_max的用法 - best fields策略</h3><p>一般检索中, 检索条件会被分词, bool检索构建多个子检索 (<code>must</code> | <code>must_not</code> | <code>should</code> | <code>filter</code>), 这些子检索可能会包含多个field. 这时:</p>
<p><strong>多个子检索的field各自匹配少量关键字的文档的分数 &gt; 某个子检索的field匹配大量关键字的文档的分数</strong>.</p>
<h4 id="7-1-dis-max的提出"><a href="#7-1-dis-max的提出" class="headerlink" title="7.1 dis_max的提出"></a>7.1 dis_max的提出</h4><p>如果我们希望检索结果中 (检索串被分词后的) 关键字匹配越多, 这样的文档就越靠前, 而不是多个子检索中匹配少量分词的文档靠前.</p>
<p>⇒此时可以使用dis_max和tie_breaker.</p>
<blockquote>
<p>tie_breaker的值介于0~1之间, Elasticsearch将 <code>bool检索的分数 * tie_breaker</code>的结果与dis_max的最高分进行比较, 除了取dis_max的最高分以外, 还会考虑其他的检索结果的分数.</p>
</blockquote>
<h4 id="7-2-使用示例"><a href="#7-2-使用示例" class="headerlink" title="7.2 使用示例"></a>7.2 使用示例</h4><p>为了增加精准度, 常用的是配合boost、minimum_should_match等参数控制检索结果.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">GET shop/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;dis_max&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;queries&quot;</span>: [</span><br><span class="line">                &#123; <span class="string">&quot;match&quot;</span>: &#123; <span class="string">&quot;name&quot;</span>: <span class="string">&quot;虚拟机&quot;</span> &#125; &#125;,</span><br><span class="line">                &#123; <span class="string">&quot;match&quot;</span>: &#123; <span class="string">&quot;desc&quot;</span>: <span class="string">&quot;经典&quot;</span> &#125; &#125;</span><br><span class="line">            ],</span><br><span class="line">            <span class="string">&quot;tie_breaker&quot;</span>: <span class="number">0.2</span>		<span class="comment">// 对同时满足的文档的分值进行提升</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET shop/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;dis_max&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;queries&quot;</span>: [</span><br><span class="line">                &#123; </span><br><span class="line">                    <span class="string">&quot;match&quot;</span>: &#123; </span><br><span class="line">                        <span class="string">&quot;name&quot;</span>: &#123;</span><br><span class="line">                            <span class="string">&quot;query&quot;</span>: <span class="string">&quot;虚拟机&quot;</span>,</span><br><span class="line">                            <span class="string">&quot;minimum_should_match&quot;</span>: <span class="string">&quot;50%&quot;</span>,</span><br><span class="line">                            <span class="string">&quot;boost&quot;</span>: <span class="number">2</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">                        <span class="string">&quot;desc&quot;</span>: &#123;</span><br><span class="line">                            <span class="string">&quot;query&quot;</span>: <span class="string">&quot;经典&quot;</span>,</span><br><span class="line">                            <span class="string">&quot;minimum_should_match&quot;</span>: <span class="string">&quot;50%&quot;</span>, </span><br><span class="line">                            <span class="string">&quot;boost&quot;</span>: <span class="number">3</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            ],</span><br><span class="line">            <span class="string">&quot;tie_breaker&quot;</span>: <span class="number">0.3</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="8-exist-query-存在检索-已过期"><a href="#8-exist-query-存在检索-已过期" class="headerlink" title="8 exist query - 存在检索, 已过期"></a>8 exist query - 存在检索, 已过期</h3><p>这是Elasticsearch 2.x中的API, 后续版本不再支持.</p>
<h3 id="9-复杂检索的使用范例"><a href="#9-复杂检索的使用范例" class="headerlink" title="9 复杂检索的使用范例"></a>9 复杂检索的使用范例</h3><h4 id="9-1-多条件过滤-包含"><a href="#9-1-多条件过滤-包含" class="headerlink" title="9.1 多条件过滤 - 包含"></a>9.1 多条件过滤 - 包含</h4><blockquote>
<p>检索出版时间在2012-07之后, 且至少满足下述条件中一个的文档:<br>a. 名称(name)中包含”并发”;<br>b. 描述(desc)中包含”java”;<br>c. 出版社(publisher)名称中不包含”电子”.</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">GET shop/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;bool&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;filter&quot;</span>: &#123;					<span class="comment">// 按时间过滤</span></span><br><span class="line">                <span class="string">&quot;range&quot;</span>: &#123;</span><br><span class="line">                    <span class="string">&quot;date&quot;</span>: &#123;<span class="string">&quot;gte&quot;</span>: <span class="string">&quot;2012-07&quot;</span>&#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;should&quot;</span>: [					<span class="comment">// 可匹配, 可不匹配</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="string">&quot;match&quot;</span>: &#123; <span class="string">&quot;name&quot;</span>: <span class="string">&quot;并发&quot;</span> &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="string">&quot;bool&quot;</span>: &#123;</span><br><span class="line">                        <span class="string">&quot;must&quot;</span>: &#123;		<span class="comment">// 必须匹配</span></span><br><span class="line">                            <span class="string">&quot;match&quot;</span>: &#123; <span class="string">&quot;desc&quot;</span>: <span class="string">&quot;java&quot;</span> &#125;</span><br><span class="line">                        &#125;,</span><br><span class="line">                        <span class="string">&quot;must_not&quot;</span>: &#123;	<span class="comment">// 不能匹配</span></span><br><span class="line">                            <span class="string">&quot;match&quot;</span>: &#123; <span class="string">&quot;publisher&quot;</span>: <span class="string">&quot;电子&quot;</span> &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            ],</span><br><span class="line">            <span class="string">&quot;minimum_should_match&quot;</span>: <span class="number">1</span>	<span class="comment">// 至少满足should中的一个条件</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, </span><br><span class="line">    <span class="comment">// 自定义排序</span></span><br><span class="line">	<span class="string">&quot;sort&quot;</span>: [</span><br><span class="line">        &#123; <span class="string">&quot;price&quot;</span>: &#123; <span class="string">&quot;order&quot;</span>: <span class="string">&quot;desc&quot;</span> &#125; &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意:排序的字段最好是数字, 或日期, 因为字符串字段会被分词, ES会通过分词后的某个词去排序, 结果难以预测.</p>
<h4 id="9-2-多条件拼接-包含-范围-排序"><a href="#9-2-多条件拼接-包含-范围-排序" class="headerlink" title="9.2 多条件拼接 - 包含+范围+排序"></a>9.2 多条件拼接 - 包含+范围+排序</h4><blockquote>
<p>匹配检索: name中包含”java”却不包含”虚拟机”;<br>范围检索: 价格大于50、小于80;<br>结果排序: 按照价格升序排序.</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">GET shop/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;bool&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;must&quot;</span>: &#123;						<span class="comment">// 必须匹配</span></span><br><span class="line">                <span class="string">&quot;match&quot;</span>: &#123; <span class="string">&quot;name&quot;</span>: <span class="string">&quot;java&quot;</span> &#125;</span><br><span class="line">            &#125;, </span><br><span class="line">            <span class="string">&quot;must_not&quot;</span>: &#123;					<span class="comment">// 必须不匹配</span></span><br><span class="line">                <span class="string">&quot;match&quot;</span>: &#123; <span class="string">&quot;name&quot;</span>: <span class="string">&quot;虚拟机&quot;</span> &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;filter&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;range&quot;</span>: &#123;</span><br><span class="line">                    <span class="string">&quot;price&quot;</span>: &#123;</span><br><span class="line">                        <span class="string">&quot;gte&quot;</span>: <span class="number">40</span>,</span><br><span class="line">                        <span class="string">&quot;lte&quot;</span>: <span class="number">80</span>,</span><br><span class="line">                        <span class="string">&quot;boost&quot;</span>: <span class="number">2.0</span>	<span class="comment">// 设置得分的权重值(提升值), 默认是1.0</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>关于范围检索的使用, 请参考下篇文章: [ES 22 - Elasticsearch对数值或日期类型进行范围检索][ES 22 - Elasticsearch]</p>
<h4 id="9-3-定制检索结果的排序规则"><a href="#9-3-定制检索结果的排序规则" class="headerlink" title="9.3 定制检索结果的排序规则"></a>9.3 定制检索结果的排序规则</h4><p><strong>(1) 默认排序规则:</strong></p>
<p>ES默认是按检索结果的分值(_score)降序排列的.</p>
<p>某些情况下, 可能存在无实际意义的_score, 比如filter时所有_score的值都相同:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">GET website/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;bool&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;filter&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;term&quot;</span>: &#123;</span><br><span class="line">                    <span class="string">&quot;author_id&quot;</span>: <span class="number">5520</span>	<span class="comment">// 此时所有符合条件的_score都为0</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 或通过constant_score过滤: </span></span><br><span class="line">GET website/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;constant_score&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;filter&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;term&quot;</span>: &#123;</span><br><span class="line">                    <span class="string">&quot;author_id&quot;</span>: <span class="number">5520</span>	<span class="comment">// 此时所有符合条件的_score都为1</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>(2) 定制排序规则:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">GET website/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;constant_score&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;filter&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;term&quot;</span>: &#123;</span><br><span class="line">                    <span class="string">&quot;author_id&quot;</span>: <span class="number">5520</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, </span><br><span class="line">    <span class="string">&quot;sort&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;post_date&quot;</span>: &#123; <span class="string">&quot;order&quot;</span>: <span class="string">&quot;asc&quot;</span> &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="聚合查询"><a href="#聚合查询" class="headerlink" title="聚合查询"></a>聚合查询</h2><h3 id="1-普通聚合分析"><a href="#1-普通聚合分析" class="headerlink" title="1 普通聚合分析"></a>1 普通聚合分析</h3><h4 id="1-1-直接聚合统计"><a href="#1-1-直接聚合统计" class="headerlink" title="1.1 直接聚合统计"></a>1.1 直接聚合统计</h4><p><strong>(1) 计算每个tag下的文档数量, 请求语法:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET book_shop/it_book/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;size&quot;</span>: <span class="number">0</span>,    			<span class="comment">// 不显示命中(hits)的所有文档信息</span></span><br><span class="line">    <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;group_by_tags&quot;</span>: &#123;	<span class="comment">// 聚合结果的名称, 需要自定义(复制时请去掉此注释)</span></span><br><span class="line">            <span class="string">&quot;terms&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;field&quot;</span>: <span class="string">&quot;tags&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>(2) 发生错误:</strong></p>
<p>说明:索引book_shop的mapping映射是ES自动创建的, 它把tag解析成了text类型, 在发起对tag的聚合请求后, 将抛出如下错误:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;error&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;root_cause&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&quot;type&quot;</span>: <span class="string">&quot;illegal_argument_exception&quot;</span>,</span><br><span class="line">                <span class="string">&quot;reason&quot;</span>: <span class="string">&quot;Fielddata is disabled on text fields by default. Set fielddata=true on [tags] in order to load fielddata in memory by uninverting the inverted index. Note that this can however use significant memory. Alternatively use a keyword field instead.&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        ],</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;search_phase_execution_exception&quot;</span>,</span><br><span class="line">        <span class="string">&quot;reason&quot;</span>: <span class="string">&quot;all shards failed&quot;</span>,</span><br><span class="line">        <span class="string">&quot;phase&quot;</span>: <span class="string">&quot;query&quot;</span>,</span><br><span class="line">        <span class="string">&quot;grouped&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="string">&quot;failed_shards&quot;</span>: [......]</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;status&quot;</span>: <span class="number">400</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>(3) 错误分析:</strong></p>
<blockquote>
<p>错误信息: <code>Set fielddata=true on [xxxx] ......</code><br>错误分析: 默认情况下, Elasticsearch 对 text 类型的字段(field)禁用了 fielddata;<br>text 类型的字段在创建索引时会进行分词处理, 而聚合操作必须基于字段的原始值进行分析;<br>所以如果要对 text 类型的字段进行聚合操作, 就需要存储其原始值 —— 创建mapping时指定<code>fielddata=true</code>, 以便通过反转倒排索引(即正排索引)将索引数据加载至内存中.</p>
</blockquote>
<p><strong>(4) 解决方案一: 对text类型的字段开启fielddata属性:</strong></p>
<ul>
<li>将要分组统计的text field(即tags)的fielddata设置为true:</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">PUT book_shop/_mapping/it_book</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;tags&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">            <span class="string">&quot;fielddata&quot;</span>: <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>可参考官方文档进行设置:<br><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/6.6/fielddata.html">https://www.elastic.co/guide/en/elasticsearch/reference/6.6/fielddata.html</a>. 成功后的结果如下:</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;acknowledged&quot;</span>: <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>再次统计, 得到的结果如下:</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;took&quot;</span>: <span class="number">153</span>,</span><br><span class="line">    <span class="string">&quot;timed_out&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="string">&quot;_shards&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;total&quot;</span>: <span class="number">5</span>,</span><br><span class="line">        <span class="string">&quot;successful&quot;</span>: <span class="number">5</span>,</span><br><span class="line">        <span class="string">&quot;skipped&quot;</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="string">&quot;failed&quot;</span>: <span class="number">0</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;hits&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;total&quot;</span>: <span class="number">4</span>,</span><br><span class="line">        <span class="string">&quot;max_score&quot;</span>: <span class="number">0.0</span>,</span><br><span class="line">        <span class="string">&quot;hits&quot;</span>: []</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;aggregations&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;group_by_tags&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;doc_count_error_upper_bound&quot;</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="string">&quot;sum_other_doc_count&quot;</span>: <span class="number">6</span>,</span><br><span class="line">            <span class="string">&quot;buckets&quot;</span>: [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="string">&quot;key&quot;</span>: <span class="string">&quot;java&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;doc_count&quot;</span>: <span class="number">3</span></span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="string">&quot;key&quot;</span>: <span class="string">&quot;程&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;doc_count&quot;</span>: <span class="number">2</span></span><br><span class="line">                &#125;,</span><br><span class="line">                ......</span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>(5) 解决方法二: 使用内置keyword字段:</strong></p>
<ul>
<li>开启fielddata将占用大量的内存.</li>
<li>Elasticsearch 5.x 版本开始支持通过text的内置字段keyword作精确查询、聚合分析:</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET shop/it_book/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;size&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;group_by_tags&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;terms&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;field&quot;</span>: <span class="string">&quot;tags.keyword&quot;</span>	<span class="comment">// 使用text类型的内置keyword字段</span></span><br><span class="line">    	    &#125;</span><br><span class="line">    	&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="1-2-先检索-再聚合"><a href="#1-2-先检索-再聚合" class="headerlink" title="1.2 先检索, 再聚合"></a>1.2 先检索, 再聚合</h4><p><strong>(1) 统计name中含有“jvm”的图书中每个tag的文档数量, 请求语法:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET book_shop/it_book/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;match&quot;</span>: &#123; <span class="string">&quot;name&quot;</span>: <span class="string">&quot;jvm&quot;</span> &#125;</span><br><span class="line">    &#125;, </span><br><span class="line">    <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;group_by_tags&quot;</span>: &#123;  <span class="comment">// 聚合结果的名称, 需要自定义. 下面使用内置的keyword字段: </span></span><br><span class="line">            <span class="string">&quot;terms&quot;</span>: &#123; <span class="string">&quot;field&quot;</span>: <span class="string">&quot;tags.keyword&quot;</span> &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>(2) 响应结果:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;took&quot;</span> : <span class="number">7</span>,</span><br><span class="line">  <span class="string">&quot;timed_out&quot;</span> : <span class="literal">false</span>,</span><br><span class="line">  <span class="string">&quot;_shards&quot;</span> : &#123;</span><br><span class="line">    <span class="string">&quot;total&quot;</span> : <span class="number">5</span>,</span><br><span class="line">    <span class="string">&quot;successful&quot;</span> : <span class="number">5</span>,</span><br><span class="line">    <span class="string">&quot;skipped&quot;</span> : <span class="number">0</span>,</span><br><span class="line">    <span class="string">&quot;failed&quot;</span> : <span class="number">0</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;hits&quot;</span> : &#123;</span><br><span class="line">    <span class="string">&quot;total&quot;</span> : <span class="number">1</span>,</span><br><span class="line">    <span class="string">&quot;max_score&quot;</span> : <span class="number">0.64072424</span>,</span><br><span class="line">    <span class="string">&quot;hits&quot;</span> : [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">&quot;_index&quot;</span> : <span class="string">&quot;book_shop&quot;</span>,</span><br><span class="line">        <span class="string">&quot;_type&quot;</span> : <span class="string">&quot;it_book&quot;</span>,</span><br><span class="line">        <span class="string">&quot;_id&quot;</span> : <span class="string">&quot;2&quot;</span>,</span><br><span class="line">        <span class="string">&quot;_score&quot;</span> : <span class="number">0.64072424</span>,</span><br><span class="line">        <span class="string">&quot;_source&quot;</span> : &#123;</span><br><span class="line">          <span class="string">&quot;name&quot;</span> : <span class="string">&quot;深入理解Java虚拟机：JVM高级特性与最佳实践&quot;</span>,</span><br><span class="line">          <span class="string">&quot;author&quot;</span> : <span class="string">&quot;周志明&quot;</span>,</span><br><span class="line">          <span class="string">&quot;category&quot;</span> : <span class="string">&quot;编程语言&quot;</span>,</span><br><span class="line">          <span class="string">&quot;desc&quot;</span> : <span class="string">&quot;Java图书领域公认的经典著作&quot;</span>,</span><br><span class="line">          <span class="string">&quot;price&quot;</span> : <span class="number">79.0</span>,</span><br><span class="line">          <span class="string">&quot;date&quot;</span> : <span class="string">&quot;2013-10-01&quot;</span>,</span><br><span class="line">          <span class="string">&quot;publisher&quot;</span> : <span class="string">&quot;机械工业出版社&quot;</span>,</span><br><span class="line">          <span class="string">&quot;tags&quot;</span> : [</span><br><span class="line">            <span class="string">&quot;Java&quot;</span>,</span><br><span class="line">            <span class="string">&quot;虚拟机&quot;</span>,</span><br><span class="line">            <span class="string">&quot;最佳实践&quot;</span></span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;aggregations&quot;</span> : &#123;</span><br><span class="line">    <span class="string">&quot;group_by_tags&quot;</span> : &#123;</span><br><span class="line">      <span class="string">&quot;doc_count_error_upper_bound&quot;</span> : <span class="number">0</span>,</span><br><span class="line">      <span class="string">&quot;sum_other_doc_count&quot;</span> : <span class="number">0</span>,</span><br><span class="line">      <span class="string">&quot;buckets&quot;</span> : [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;key&quot;</span> : <span class="string">&quot;Java&quot;</span>,</span><br><span class="line">          <span class="string">&quot;doc_count&quot;</span> : <span class="number">1</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;key&quot;</span> : <span class="string">&quot;最佳实践&quot;</span>,</span><br><span class="line">          <span class="string">&quot;doc_count&quot;</span> : <span class="number">1</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;key&quot;</span> : <span class="string">&quot;虚拟机&quot;</span>,</span><br><span class="line">          <span class="string">&quot;doc_count&quot;</span> : <span class="number">1</span></span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="1-3-扩展-fielddata和keyword的聚合比较"><a href="#1-3-扩展-fielddata和keyword的聚合比较" class="headerlink" title="1.3 扩展: fielddata和keyword的聚合比较"></a>1.3 扩展: fielddata和keyword的聚合比较</h4><ul>
<li>为某个 text 类型的字段开启fielddata字段后, 聚合分析操作会对这个字段的所有分词分别进行聚合, 获得的结果大多数情况下并不符合我们的需求.</li>
<li><strong>使用keyword内置字段, 不会对相关的分词进行聚合, 结果可能更有用.</strong></li>
</ul>
<p>—— <strong>推荐使用text类型字段的内置keyword进行聚合操作.</strong></p>
<h3 id="2-嵌套聚合"><a href="#2-嵌套聚合" class="headerlink" title="2 嵌套聚合"></a>2 嵌套聚合</h3><h4 id="2-1-先分组-再聚合统计"><a href="#2-1-先分组-再聚合统计" class="headerlink" title="2.1 先分组, 再聚合统计"></a>2.1 先分组, 再聚合统计</h4><p><strong>(1) 先按tags分组, 再计算每个tag下图书的平均价格, 请求语法:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">GET book_shop/it_book/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;size&quot;</span>: <span class="number">0</span>, </span><br><span class="line">    <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;group_by_tags&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;terms&quot;</span>: &#123; <span class="string">&quot;field&quot;</span>: <span class="string">&quot;tags.keyword&quot;</span> &#125;,</span><br><span class="line">            <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;avg_price&quot;</span>: &#123;</span><br><span class="line">                    <span class="string">&quot;avg&quot;</span>: &#123; <span class="string">&quot;field&quot;</span>: <span class="string">&quot;price&quot;</span> &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>(2) 响应结果:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;hits&quot;</span> : &#123;</span><br><span class="line">  <span class="string">&quot;total&quot;</span> : <span class="number">3</span>,</span><br><span class="line">  <span class="string">&quot;max_score&quot;</span> : <span class="number">0.0</span>,</span><br><span class="line">  <span class="string">&quot;hits&quot;</span> : [ ]</span><br><span class="line">&#125;,</span><br><span class="line"><span class="string">&quot;aggregations&quot;</span> : &#123;</span><br><span class="line">  <span class="string">&quot;group_by_tags&quot;</span> : &#123;</span><br><span class="line">    <span class="string">&quot;doc_count_error_upper_bound&quot;</span> : <span class="number">0</span>,</span><br><span class="line">    <span class="string">&quot;sum_other_doc_count&quot;</span> : <span class="number">0</span>,</span><br><span class="line">    <span class="string">&quot;buckets&quot;</span> : [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">&quot;key&quot;</span> : <span class="string">&quot;Java&quot;</span>,</span><br><span class="line">        <span class="string">&quot;doc_count&quot;</span> : <span class="number">3</span>,</span><br><span class="line">        <span class="string">&quot;avg_price&quot;</span> : &#123;</span><br><span class="line">          <span class="string">&quot;value&quot;</span> : <span class="number">102.33333333333333</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">&quot;key&quot;</span> : <span class="string">&quot;编程语言&quot;</span>,</span><br><span class="line">        <span class="string">&quot;doc_count&quot;</span> : <span class="number">2</span>,</span><br><span class="line">        <span class="string">&quot;avg_price&quot;</span> : &#123;</span><br><span class="line">          <span class="string">&quot;value&quot;</span> : <span class="number">114.0</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      ......</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-2-先分组-再统计-最后排序"><a href="#2-2-先分组-再统计-最后排序" class="headerlink" title="2.2 先分组, 再统计, 最后排序"></a>2.2 先分组, 再统计, 最后排序</h4><p><strong>(1) 计算每个tag下图书的平均价格, 再按平均价格降序排序, 查询语法:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">GET book_shop/it_book/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;size&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;all_tags&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;terms&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;field&quot;</span>: <span class="string">&quot;tags.keyword&quot;</span>, </span><br><span class="line">                <span class="string">&quot;order&quot;</span>: &#123; <span class="string">&quot;avg_price&quot;</span>: <span class="string">&quot;desc&quot;</span> &#125; <span class="comment">// 根据下述统计的结果排序</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;avg_price&quot;</span>: &#123;</span><br><span class="line">                    <span class="string">&quot;avg&quot;</span>: &#123; <span class="string">&quot;field&quot;</span>: <span class="string">&quot;price&quot;</span> &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>(2) 响应结果:</strong></p>
<p>与#2.1节内容相似, 区别在于按照价格排序显示了.</p>
<h4 id="2-3-先分组-组内再分组-然后统计、排序"><a href="#2-3-先分组-组内再分组-然后统计、排序" class="headerlink" title="2.3 先分组, 组内再分组, 然后统计、排序"></a>2.3 先分组, 组内再分组, 然后统计、排序</h4><p><strong>(1) 先按价格区间分组, 组内再按tags分组, 计算每个tags组的平均价格, 查询语法:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">GET book_shop/it_book/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;size&quot;</span>: <span class="number">0</span>, </span><br><span class="line">    <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;group_by_price&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;range&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;field&quot;</span>: <span class="string">&quot;price&quot;</span>, </span><br><span class="line">                <span class="string">&quot;ranges&quot;</span>: [</span><br><span class="line">                    &#123; <span class="string">&quot;from&quot;</span>: <span class="number">00</span>,  <span class="string">&quot;to&quot;</span>: <span class="number">100</span> &#125;,</span><br><span class="line">                    &#123; <span class="string">&quot;from&quot;</span>: <span class="number">100</span>, <span class="string">&quot;to&quot;</span>: <span class="number">150</span> &#125;</span><br><span class="line">                ]</span><br><span class="line">            &#125;, </span><br><span class="line">            <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;group_by_tags&quot;</span>: &#123;</span><br><span class="line">                    <span class="string">&quot;terms&quot;</span>: &#123; <span class="string">&quot;field&quot;</span>: <span class="string">&quot;tags.keyword&quot;</span> &#125;, </span><br><span class="line">                    <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">                        <span class="string">&quot;avg_price&quot;</span>: &#123;</span><br><span class="line">                            <span class="string">&quot;avg&quot;</span>: &#123; <span class="string">&quot;field&quot;</span>: <span class="string">&quot;price&quot;</span> &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>(2) 响应结果:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;hits&quot;</span> : &#123;</span><br><span class="line">  <span class="string">&quot;total&quot;</span> : <span class="number">3</span>,</span><br><span class="line">  <span class="string">&quot;max_score&quot;</span> : <span class="number">0.0</span>,</span><br><span class="line">  <span class="string">&quot;hits&quot;</span> : [ ]</span><br><span class="line">&#125;,</span><br><span class="line"><span class="string">&quot;aggregations&quot;</span> : &#123;</span><br><span class="line">  <span class="string">&quot;group_by_price&quot;</span> : &#123;</span><br><span class="line">    <span class="string">&quot;buckets&quot;</span> : [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">&quot;key&quot;</span> : <span class="string">&quot;0.0-100.0&quot;</span>,    <span class="comment">// 区间0.0-100.0</span></span><br><span class="line">        <span class="string">&quot;from&quot;</span> : <span class="number">0.0</span>,</span><br><span class="line">        <span class="string">&quot;to&quot;</span> : <span class="number">100.0</span>,</span><br><span class="line">        <span class="string">&quot;doc_count&quot;</span> : <span class="number">1</span>,        <span class="comment">// 共查找到了3条文档</span></span><br><span class="line">        <span class="string">&quot;group_by_tags&quot;</span> : &#123;     <span class="comment">// 对tags分组聚合</span></span><br><span class="line">          <span class="string">&quot;doc_count_error_upper_bound&quot;</span> : <span class="number">0</span>,</span><br><span class="line">          <span class="string">&quot;sum_other_doc_count&quot;</span> : <span class="number">0</span>,</span><br><span class="line">          <span class="string">&quot;buckets&quot;</span> : [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="string">&quot;key&quot;</span> : <span class="string">&quot;Java&quot;</span>,</span><br><span class="line">              <span class="string">&quot;doc_count&quot;</span> : <span class="number">1</span>,</span><br><span class="line">              <span class="string">&quot;avg_price&quot;</span> : &#123;</span><br><span class="line">                <span class="string">&quot;value&quot;</span> : <span class="number">79.0</span></span><br><span class="line">              &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            ......</span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">&quot;key&quot;</span> : <span class="string">&quot;100.0-150.0&quot;</span>,</span><br><span class="line">        <span class="string">&quot;from&quot;</span> : <span class="number">100.0</span>,</span><br><span class="line">        <span class="string">&quot;to&quot;</span> : <span class="number">150.0</span>,</span><br><span class="line">        <span class="string">&quot;doc_count&quot;</span> : <span class="number">2</span>,</span><br><span class="line">        <span class="string">&quot;group_by_tags&quot;</span> : &#123;</span><br><span class="line">          <span class="string">&quot;doc_count_error_upper_bound&quot;</span> : <span class="number">0</span>,</span><br><span class="line">          <span class="string">&quot;sum_other_doc_count&quot;</span> : <span class="number">0</span>,</span><br><span class="line">          <span class="string">&quot;buckets&quot;</span> : [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="string">&quot;key&quot;</span> : <span class="string">&quot;Java&quot;</span>,</span><br><span class="line">              <span class="string">&quot;doc_count&quot;</span> : <span class="number">2</span>,</span><br><span class="line">              <span class="string">&quot;avg_price&quot;</span> : &#123;</span><br><span class="line">                <span class="string">&quot;value&quot;</span> : <span class="number">114.0</span></span><br><span class="line">              &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            ......</span><br><span class="line">            &#125;</span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="集群搭建建议"><a href="#集群搭建建议" class="headerlink" title="集群搭建建议"></a>集群搭建建议</h2><blockquote>
<p>在生产环境中, 要保证服务在各种极限情况下的稳定和高可用, 所以在部署ES集群时, 需要考虑服务器的内存、CPU、磁盘, 集群的网络、节点个数, 并且要优化JVM的各项参数. 首先从这些方面着手进行部署前的规划.</p>
</blockquote>
<h3 id="1-服务器的内存"><a href="#1-服务器的内存" class="headerlink" title="1 服务器的内存"></a>1 服务器的内存</h3><p>ES非常消耗内存 —— 不是JVM用到的内存, 而是机器的物理内存, 因为ES在运行期间对JVM Heap(堆内存)的需求较小.</p>
<blockquote>
<p>ES底层是基于Lucene创建的, 而Lucene是基于磁盘中的文件来读写和保存索引数据(包括倒排索引、正排索引);<br>Lucene的特点是基于OS File System Cache(操作系统的文件缓存系统), 它会尽可能地把频繁访问的磁盘文件缓存在操作系统的内存中, 从而提高对磁盘文件的读写性能.<br>关于Lucene的更多资料, 可参考: <a target="_blank" rel="noopener" href="https://www.cnblogs.com/shoufeng/category/1259723.html">https://www.cnblogs.com/shoufeng/category/1259723.html</a>.</p>
</blockquote>
<p>可以这样说: <strong>ES的性能很大程度上(80%)取决于分配给JVM Heap内存之后、服务器的剩余内存大小</strong>.<br>——这些剩余内存会缓存Lucene的索引文件, 缓存的越多, 索引的读写性能都越高, 尤其是检索和聚合操作, 它们需要读取几乎所有的索引数据.</p>
<p><strong>实践建议: 数据量过亿, 建议单台服务器的内存至少要有64GB.</strong></p>
<h3 id="2-服务器的CPU"><a href="#2-服务器的CPU" class="headerlink" title="2 服务器的CPU"></a>2 服务器的CPU</h3><p>ES集群对CPU的要求比较低, 一般来说2~8个CPU Core即可满足集群的需求.</p>
<p><strong>实践建议: 尽可能使用多核处理器, 因为并发处理能力会更好.</strong></p>
<h3 id="3-服务器的磁盘"><a href="#3-服务器的磁盘" class="headerlink" title="3 服务器的磁盘"></a>3 服务器的磁盘</h3><p>ES生产环境中, 磁盘的读写能力是非常重要的, 尤其对于大量写操作的集群, 比如电商公司将每天的实时日志数据以高并发的方式写入ES集群.</p>
<p><strong>(1) 在磁盘的使用上, 推荐使用SSD(固态硬盘), 而不是(HDD)机械硬盘.</strong></p>
<blockquote>
<p>使用SSD, 就需要配置SSD的I&#x2F;O Scheduler —— 数据写入磁盘时, IO Scheduler会决定将数据从OS Cache刷入到磁盘的时机.<br>大部分SSD的默认IO Scheduler是CFQ (completely fair queuing), 它会为每个进程都分配一些时间片(time slice), 然后通过磁盘的物理布局来决定如何将数据写入磁盘 (对各个进程的数据写入进行优化), 进而提升写入磁盘的性能.<br>但是默认的CFQ并不高效. 对SSD来说, 推荐使用Deadline&#x2F;Noop Scheduler, 它基于写操作被Pending的时间长短来进行写磁盘优化, 而Noop Scheduler就是一个简单的FIFO(先进先出)队列机制.</p>
</blockquote>
<p><strong>(2) 此外, 使用<code>RAID 0</code>也是一种提升磁盘读写速度的高效方式, 无论是HDD, 或者SSD都支持RAID 0.</strong></p>
<blockquote>
<p>RAID 0也被称之为条带式(striping)存储机制, 在RAID各种级别中性能是最高的, 它的基本原理是:<br>把连续的数据分散存储到多个磁盘上进行读写, 也就是对数据进行条带式存储 —— 磁盘的读写请求被分散到多个磁盘上并行执行.<br>没有必要使用镜像或者RAID的其他模式, 因为我们并不需要通过RAID来实现数据的高可用存储 —— 这方面的工作ES的Replica副本机制已经实现了.</p>
</blockquote>
<p>(3)最后, 要避免使用与网络相关的存储模式 (network-attached storage, NAS), 比如基于网络的分布式存储模式.</p>
<blockquote>
<p>虽然很多供应商都说他们的NAS解决方案性能非常高, 而且比本地存储的可靠性更高, 但在实际使用上还是会有很多风险: 网络传输可能存在比较高的时延, 还可能存在单点故障.</p>
</blockquote>
<p><strong>实践建议: 推荐使用SSD, 并调整其IO Scheduler为Deadline&#x2F;Noop Scheduler, 这可以带来很大的性能提升, 理想情况下可能达到上百倍.</strong></p>
<h3 id="4-集群的网络"><a href="#4-集群的网络" class="headerlink" title="4 集群的网络"></a>4 集群的网络</h3><p>对ES这种分布式系统来说, 快速可靠的网络是非常重要的:</p>
<blockquote>
<p>高速网络通信可以让ES节点间的通信时延降低;<br>高带宽可以让Shard的移动、恢复, 以及分配等操作更加快速.</p>
</blockquote>
<p><strong>不低于千兆网卡对大多数集群来说都已足够, 但要避免一个集群横跨多个数据中心</strong>, 比如异地多机房部署一个集群 —— 跨地域跨机房会降低网络通信和数据传输的效率.</p>
<p><strong>1、</strong> ES集群是一种p2p模式的分布式系统架构, 并不是master-slave主从分布式系统.<br><strong>2、</strong> <strong>ES集群中, 所有节点都是平等的, 任意两个节点之间的通信都很频繁</strong>, 如果部署在异地多机房, 就会导致各个节点之间频繁跨地域通信, 通信时延会非常高, 甚至有可能造成集群运行频繁出现异常.<br><strong>3、</strong> 与NAS存储模式一样, 很多供应商都声称他们的跨地域多数据中心是可靠、低时延的, 即使果真如此, 一旦网络出现故障, 整个集群就会不可用. 大多数情况下, 跨地域多机房部署一个ES集群带来的效益要远远低于维护这类集群所付出的额外成本.</p>
<p><strong>实践建议: 不低于千兆网卡, 且不要垮多个数据中心, 尤其不要跨地域多机房.</strong></p>
<h3 id="5-集群的节点个数"><a href="#5-集群的节点个数" class="headerlink" title="5 集群的节点个数"></a>5 集群的节点个数</h3><p>ES集群的节点个数:</p>
<p><strong>1、</strong> 建议部署少个节点, 但每个节点对应服务器的资源都必须充足;<br><strong>2、</strong> 不建议在一台高性能服务器上部署多个节点: 不仅降低了集群的可用性, 而且集群的维护复杂度也变得更高了.</p>
<p>尽量避免部署大量的低资源的服务器, 因为对运维和管理而言, 管理5个物理机组成的集群, 要比管理10个虚拟机组成的集群要简单简单太多.</p>
<p><strong>实践建议: 小规模、高配置, 但无需超高配置, 会造成资源的浪费.</strong></p>
<h3 id="6-JVM的参数设置"><a href="#6-JVM的参数设置" class="headerlink" title="6 JVM的参数设置"></a>6 JVM的参数设置</h3><p>ES的版本越新, 使用的JDK的版本也应该越新, 既提高性能, 也避免一些不常见的系统Bug(包括Lucene和JDK的).</p>
<p><strong>以本系列博文为例, 示例的ES版本为6.6.0, 使用的JDK版本是<code>jdk1.8.0_151</code>.</strong></p>
<p><strong>(1) 如果通过Java API操作ES服务, 那么编译Java程序的JVM版本最好与ES服务器所运行的JVM版本一致.</strong></p>
<blockquote>
<p>ES中用到了很多与JVM版本相关的特性, 比如本地序列化机制 (包括IP地址、异常信息等等), 而JVM在不同的minor版本中可能会修改序列化机制, 版本不同可能会导致序列化异常.</p>
</blockquote>
<p><strong>(2) 同时官方强烈建议: 不要随意调整JVM的参数设置</strong>.</p>
<blockquote>
<p>ES是一个非常复杂的分布式软件系统, 它默认的JVM配置经过了大量真实业务场景下的检验, 除非你很明确地知道自己的服务瓶颈出在哪几个参数上, 否则不要调整.</p>
</blockquote>
<p><strong>ES服务中, JVM Heap堆内存的大小一般不超过服务器物理内存的一半, 以1&#x2F;4为宜, 且最多不宜超过32GB.</strong></p>
<h3 id="7-集群的数据量"><a href="#7-集群的数据量" class="headerlink" title="7 集群的数据量"></a>7 集群的数据量</h3><p>对很多中小型公司, 建议ES集群承载的数据量在百亿级规模以内.</p>
<p>(1)ES的常见使用场景有:</p>
<p><strong>1、</strong> 构建业务搜索功能模块, 且多是垂直领域的搜索: 以网站或APP为例, 数据规模相对比较大, 通常是百万级到亿级;<br><strong>2、</strong> 进行数据分析: 需要消耗更大的内存, 但支持的数据规模要小很多, 通常是十万级到千万级;<br><strong>3、</strong> 用于大规模数据的实时OLAP(联机处理分析), 经典的如ELK Stack, 数据规模可能达到千亿或更多, 集群规模可能达到几十上百节点.</p>
<p>(2)数据量特别大时的处理思路:</p>
<blockquote>
<p>如果应用的数据量特别大, 日增量几十上百万, 那就不建议将数据全量写入ES中, ES也不适合这种数据无限膨胀的场景 —— ES消耗内存, 无限膨胀的数据量会导致无法提供足够的内存来支撑大规模数据的快速检索.<br>此时可以考虑: 将部分热数据 (比如最近一月的数据) 存放到ES中做高频高性能搜索, 将大量的、较少访问的冷数据存放至大数据系统 (比如Hadoop) 中做离线批量处理.</p>
</blockquote>
<p><strong>不同数据规模与内存容量下的检索性能表现: 如果服务器的内存可以将ES所需的文件全部纳入到OS Cache中, 就能达到ms(毫秒)级的检索性能; 否则检索会大量访问磁盘, 检索时间就会上升到s(秒)级.</strong></p>
<h3 id="8-总结"><a href="#8-总结" class="headerlink" title="8 总结"></a>8 总结</h3><p><strong>要提升ES的性能, 最重要的是规划合理的数据量, 配置足够的物理内存用作OS Cache, 尽可能减少从磁盘中访问数据.</strong></p>
<h2 id="ES的数据建模"><a href="#ES的数据建模" class="headerlink" title="ES的数据建模"></a>ES的数据建模</h2><h3 id="1-什么是数据建模"><a href="#1-什么是数据建模" class="headerlink" title="1 什么是数据建模?"></a>1 什么是数据建模?</h3><p>数据建模(Data modeling), 是创建数据模型的过程.</p>
<blockquote>
<p>数据模型是对真实世界进行抽象描述的一种工具和方法, 实现对现实世界的映射. 比如影视作品、演员、观众评论…</p>
</blockquote>
<p>数据建模有三个过程: <strong>概念模型 &#x3D;&gt; 逻辑模型 &#x3D;&gt; 数据模型(第三范式)</strong></p>
<p>数据模型, 需要结合使用的数据库类型, 在满足业务读写性能等需求的前提下, 制定出最终的定义.</p>
<h3 id="2-如何对-ES-中的数据进行建模"><a href="#2-如何对-ES-中的数据进行建模" class="headerlink" title="2 如何对 ES 中的数据进行建模"></a>2 如何对 ES 中的数据进行建模</h3><p><strong>ES中的数据建模:</strong></p>
<p>由数据存储、检索等功能需求提炼出实体属性、实体之间的关系 &#x3D;》形成逻辑模型;</p>
<p>由性能需求提炼制定索引模板、索引Mapping(包括字段的配置、关系的处理) &#x3D;&#x3D;》形成物理模型.</p>
<p>ES中存储、检索的基本单位是索引文档(document), 文档由字段(field)组成, 所以ES的建模就是对字段进行建模.</p>
<blockquote>
<p>文档类似于关系型数据库中的一行数据, 字段对应关系型数据库中的某一列数据.</p>
</blockquote>
<h4 id="2-1-字段类型的建模方案"><a href="#2-1-字段类型的建模方案" class="headerlink" title="2.1 字段类型的建模方案"></a>2.1 字段类型的建模方案</h4><p><strong>(1) text 与 keyword 比较:</strong></p>
<ul>
<li>text: 用于全文本字段, 文本会被 Analyzer 分词; 默认不支持聚合分析及排序, 设置 “fielddata”: true 即可支持;</li>
<li>keyword: 用于 id、枚举及不需要分词的文本, 比如身份证号码、电话号码，Email地址等; 适用于 Filter(精确匹配过滤)、Sorting(排序) 和 Aggregations(聚合).</li>
<li>设置多字段类型:</li>
</ul>
<blockquote>
<p>默认会为文本类型设置成 text, 并设置一个 keyword 的子字段;<br>在处理人类自然语⾔时, 可以添加“英⽂”、“拼⾳”、“标准”等分词器, 提高搜索结果的正确性.</p>
</blockquote>
<p><strong>(2) 结构化数据:</strong></p>
<ul>
<li>数值类型: 尽量选择贴近的类型, 例如可以用 byte, 就不要用 long;</li>
<li>枚举类型: 设置为 keyword, 即使是数字, 也应该设置成 keyword, 获取更好的性能; 另外范围检索使用keyword, 速度更快;</li>
<li>其他类型: 日期、二进制、布尔、地理信息等类型.</li>
</ul>
<h4 id="2-2-检索、聚合及排序的建模方案"><a href="#2-2-检索、聚合及排序的建模方案" class="headerlink" title="2.2 检索、聚合及排序的建模方案"></a>2.2 检索、聚合及排序的建模方案</h4><ul>
<li>如不需要检索、排序和聚合分析, 则可设置 “enable”: false ;</li>
<li>如不需要检索, 则可设置 “index”: false ;</li>
<li>如不需要排序、聚合分析功能, 则可设置 “doc_values”: false &#x2F; “fielddate”: false ;</li>
<li>更新频繁、聚合查询频繁的 keyword 类型的字段, 推荐设置 “eager_global_ordinals”: true .</li>
</ul>
<h4 id="2-3-额外存储的建模方案"><a href="#2-3-额外存储的建模方案" class="headerlink" title="2.3 额外存储的建模方案"></a>2.3 额外存储的建模方案</h4><ul>
<li><strong>是否需要专门存储当前字段数据?</strong></li>
</ul>
<blockquote>
<p><code>&quot;store&quot;: true</code>, 可以存储该字段的原始内容;</p>
<p>一般结合 <code>&quot;_source&quot;: &#123; &quot;enabled&quot;: false &#125;</code> 进行使用, 因为默认的 <code>&quot;_source&quot;: &#123; &quot;enabled&quot;: true &#125;</code>, 也就是添加索引时文档的原始 JSON 结构都会存储到 <code>_source</code> 中.</p>
</blockquote>
<ul>
<li>disable_source: 禁用 _source 元字段, 能节约磁盘, 适用于指标型数据 —— 类似于标识字段、时间字段的数据, 不会更新、高亮查询, 多用来进行过滤操作以快速筛选出更小的结果集, 用来支撑更快的聚合操作.</li>
</ul>
<blockquote>
<p>官方建议: 如果更多关注磁盘空间, 那么建议优先考虑增加数据的压缩⽐, 而不是禁用 <code>_source</code>;</p>
<p>无法看到 <code>_source</code> 字段, 就不能做 <code>reindex</code>、<code>update</code>、<code>update_by_query</code> 操作;</p>
<p>目前为止, Kibana 中无法对禁用了 <code>_source</code> 字段的索引进行 Discover 挖掘操作.</p>
<p>—— 谨慎禁用 <code>_source</code> 字段, 参考: <a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/mapping-source-field.html">https://www.elastic.co/guide/en/elasticsearch/reference/current/mapping-source-field.html</a></p>
</blockquote>
<h3 id="3-ES-数据建模实例演示"><a href="#3-ES-数据建模实例演示" class="headerlink" title="3 ES 数据建模实例演示"></a>3 ES 数据建模实例演示</h3><h4 id="3-1-动态创建映射关系"><a href="#3-1-动态创建映射关系" class="headerlink" title="3.1 动态创建映射关系"></a>3.1 动态创建映射关系</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"># 直接写入一本图书信息:</span><br><span class="line">POST books/_doc</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;title&quot;</span>: <span class="string">&quot;Thinking in Elasticsearch 7.2.0&quot;</span>,</span><br><span class="line">  <span class="string">&quot;author&quot;</span>: <span class="string">&quot;Heal Chow&quot;</span>,</span><br><span class="line">  <span class="string">&quot;publish_date&quot;</span>: <span class="string">&quot;2019-10-01&quot;</span>,</span><br><span class="line">  <span class="string">&quot;description&quot;</span>: <span class="string">&quot;Master the searching, indexing, and aggregation features in Elasticsearch.&quot;</span>,</span><br><span class="line">  <span class="string">&quot;cover_url&quot;</span>: <span class="string">&quot;https://healchow.com/images/29dMkliO2a1f.jpg&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 查看自动创建的mapping关系:</span><br><span class="line">GET books/_mapping</span><br><span class="line"># 内容如下:</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;books&quot;</span> : &#123;</span><br><span class="line">    <span class="string">&quot;mappings&quot;</span> : &#123;</span><br><span class="line">      <span class="string">&quot;properties&quot;</span> : &#123;</span><br><span class="line">        <span class="string">&quot;author&quot;</span> : &#123;</span><br><span class="line">          <span class="string">&quot;type&quot;</span> : <span class="string">&quot;text&quot;</span>,</span><br><span class="line">          <span class="string">&quot;fields&quot;</span> : &#123;</span><br><span class="line">            <span class="string">&quot;keyword&quot;</span> : &#123;</span><br><span class="line">              <span class="string">&quot;type&quot;</span> : <span class="string">&quot;keyword&quot;</span>,</span><br><span class="line">              <span class="string">&quot;ignore_above&quot;</span> : <span class="number">256</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;cover_url&quot;</span> : &#123;</span><br><span class="line">          <span class="string">&quot;type&quot;</span> : <span class="string">&quot;text&quot;</span>,</span><br><span class="line">          <span class="string">&quot;fields&quot;</span> : &#123;</span><br><span class="line">            <span class="string">&quot;keyword&quot;</span> : &#123;</span><br><span class="line">              <span class="string">&quot;type&quot;</span> : <span class="string">&quot;keyword&quot;</span>,</span><br><span class="line">              <span class="string">&quot;ignore_above&quot;</span> : <span class="number">256</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;description&quot;</span> : &#123;</span><br><span class="line">          <span class="string">&quot;type&quot;</span> : <span class="string">&quot;text&quot;</span>,</span><br><span class="line">          <span class="string">&quot;fields&quot;</span> : &#123;</span><br><span class="line">            <span class="string">&quot;keyword&quot;</span> : &#123;</span><br><span class="line">              <span class="string">&quot;type&quot;</span> : <span class="string">&quot;keyword&quot;</span>,</span><br><span class="line">              <span class="string">&quot;ignore_above&quot;</span> : <span class="number">256</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;publish_date&quot;</span> : &#123;</span><br><span class="line">          <span class="string">&quot;type&quot;</span> : <span class="string">&quot;date&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;title&quot;</span> : &#123;</span><br><span class="line">          <span class="string">&quot;type&quot;</span> : <span class="string">&quot;text&quot;</span>,</span><br><span class="line">          <span class="string">&quot;fields&quot;</span> : &#123;</span><br><span class="line">            <span class="string">&quot;keyword&quot;</span> : &#123;</span><br><span class="line">              <span class="string">&quot;type&quot;</span> : <span class="string">&quot;keyword&quot;</span>,</span><br><span class="line">              <span class="string">&quot;ignore_above&quot;</span> : <span class="number">256</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-2-手动创建映射关系"><a href="#3-2-手动创建映射关系" class="headerlink" title="3.2 手动创建映射关系"></a>3.2 手动创建映射关系</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"># 删除自动创建的图书索引:</span><br><span class="line">DELETE books</span><br><span class="line"></span><br><span class="line"># 手动优化字段的mapping:</span><br><span class="line">PUT books</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;_source&quot;</span>: &#123; <span class="string">&quot;enabled&quot;</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">    <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;title&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">        <span class="string">&quot;fields&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;keyword&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>,</span><br><span class="line">            <span class="string">&quot;ignore_above&quot;</span>: <span class="number">100</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;author&quot;</span>: &#123; <span class="string">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span> &#125;,</span><br><span class="line">      <span class="string">&quot;publish_date&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;date&quot;</span>,</span><br><span class="line">        <span class="string">&quot;format&quot;</span>: <span class="string">&quot;yyyy-MM-dd HH:mm:ss||yyyyMMddHHmmss||yyyy-MM-dd||epoch_millis&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;description&quot;</span>: &#123; <span class="string">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span> &#125;,</span><br><span class="line">      <span class="string">&quot;cover_url&quot;</span>: &#123;          index 设置成 <span class="literal">false</span>, 不支持搜索, 但支持 Terms 聚合</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>,</span><br><span class="line">        <span class="string">&quot;index&quot;</span>: <span class="literal">false</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>说明:<code>_source</code> 元字段默认是开启的, 若禁用后, 就无法对搜索的结果进行展示, 也无法进行 <code>reindex</code>、<code>update</code>、<code>update_by_query</code> 操作.</p>
<h4 id="3-3-新增需求-添加大字段"><a href="#3-3-新增需求-添加大字段" class="headerlink" title="3.3 新增需求 - 添加大字段"></a>3.3 新增需求 - 添加大字段</h4><ul>
<li>需求描述: 添加图书内容字段, 要求支持全文搜索, 并且能够高亮显示.</li>
<li>需求分析: 新需求会导致 _source 的内容过⼤, 虽然我们可以通过source filtering对要搜索结果中的字段进行过滤:</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;_source&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;includes&quot;</span>: [<span class="string">&quot;title&quot;</span>]  或 <span class="string">&quot;excludes&quot;</span>: [<span class="string">&quot;xxx&quot;</span>] 排除某些字段, includes 优先级更高</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但这种方式只是 ES 服务端传输给客户端时的过滤, 内部 Fetch 数据时, ES 各数据节点还是会传输 <code>_source</code> 中的所有数据到协调节点 —— 网络 IO 没有得到本质上的降低.</p>
<h4 id="3-4-解决大字段带来的性能问题"><a href="#3-4-解决大字段带来的性能问题" class="headerlink" title="3.4 解决大字段带来的性能问题"></a>3.4 解决大字段带来的性能问题</h4><p>(1)在创建 mapping 时手动关闭 <code>_source</code> 元字段: <code>&quot;_source&quot;: &#123; &quot;enabled&quot;: false&#125;</code> ;</p>
<p>(2)然后为每个字段设置 <code>&quot;store&quot;: true</code> .</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"># 关闭_source元字段, 设置store=<span class="literal">true</span>:</span><br><span class="line">PUT books</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;_source&quot;</span>: &#123; <span class="string">&quot;enabled&quot;</span>: <span class="literal">false</span> &#125;,</span><br><span class="line">    <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;title&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">        <span class="string">&quot;store&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="string">&quot;fields&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;keyword&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>,</span><br><span class="line">            <span class="string">&quot;ignore_above&quot;</span>: <span class="number">100</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;author&quot;</span>: &#123; <span class="string">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>, <span class="string">&quot;store&quot;</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">      <span class="string">&quot;publish_date&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;date&quot;</span>,</span><br><span class="line">        <span class="string">&quot;store&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="string">&quot;format&quot;</span>: <span class="string">&quot;yyyy-MM-dd HH:mm:ss||yyyyMMddHHmmss||yyyy-MM-dd||epoch_millis&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;description&quot;</span>: &#123; <span class="string">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>, <span class="string">&quot;store&quot;</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">      <span class="string">&quot;cover_url&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>,</span><br><span class="line">        <span class="string">&quot;index&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;store&quot;</span>: <span class="literal">true</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;content&quot;</span>: &#123; <span class="string">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>, <span class="string">&quot;store&quot;</span>: <span class="literal">true</span> &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>(3)加数据, 并进行高亮查询:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"># 添加包含新字段的文档:</span><br><span class="line">POST books/_doc</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;title&quot;</span>: <span class="string">&quot;Thinking in Elasticsearch 7.2.0&quot;</span>,</span><br><span class="line">  <span class="string">&quot;author&quot;</span>: <span class="string">&quot;Heal Chow&quot;</span>,</span><br><span class="line">  <span class="string">&quot;publish_date&quot;</span>: <span class="string">&quot;2019-10-01&quot;</span>,</span><br><span class="line">  <span class="string">&quot;description&quot;</span>: <span class="string">&quot;Master the searching, indexing, and aggregation features in Elasticsearch.&quot;</span>,</span><br><span class="line">  <span class="string">&quot;cover_url&quot;</span>: <span class="string">&quot;https://healchow.com/images/29dMkliO2a1f.jpg&quot;</span>,</span><br><span class="line">  <span class="string">&quot;content&quot;</span>: <span class="string">&quot;1. Revisiting Elasticsearch and the Changes. 2. The Improved Query DSL. 3. Beyond Full Text Search. 4. Data Modeling and Analytics. 5. Improving the User Search Experience. 6. The Index Distribution Architecture.  ..........&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 通过 stored_fields 指定要查询的字段:</span><br><span class="line">GET books/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;stored_fields&quot;</span>: [<span class="string">&quot;title&quot;</span>, <span class="string">&quot;author&quot;</span>, <span class="string">&quot;publish_date&quot;</span>],</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;match&quot;</span>: &#123; <span class="string">&quot;content&quot;</span>: <span class="string">&quot;data modeling&quot;</span> &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;highlight&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;fields&quot;</span>: &#123; <span class="string">&quot;content&quot;</span>: &#123;&#125; &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>查询结果如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;took&quot;</span> : <span class="number">1</span>,</span><br><span class="line">  <span class="string">&quot;timed_out&quot;</span> : <span class="literal">false</span>,</span><br><span class="line">  <span class="string">&quot;_shards&quot;</span> : &#123;</span><br><span class="line">    <span class="string">&quot;total&quot;</span> : <span class="number">1</span>,</span><br><span class="line">    <span class="string">&quot;successful&quot;</span> : <span class="number">1</span>,</span><br><span class="line">    <span class="string">&quot;skipped&quot;</span> : <span class="number">0</span>,</span><br><span class="line">    <span class="string">&quot;failed&quot;</span> : <span class="number">0</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;hits&quot;</span> : &#123;</span><br><span class="line">    <span class="string">&quot;total&quot;</span> : &#123;</span><br><span class="line">      <span class="string">&quot;value&quot;</span> : <span class="number">1</span>,</span><br><span class="line">      <span class="string">&quot;relation&quot;</span> : <span class="string">&quot;eq&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;max_score&quot;</span> : <span class="number">0.5753642</span>,</span><br><span class="line">    <span class="string">&quot;hits&quot;</span> : [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">&quot;_index&quot;</span> : <span class="string">&quot;books&quot;</span>,</span><br><span class="line">        <span class="string">&quot;_type&quot;</span> : <span class="string">&quot;_doc&quot;</span>,</span><br><span class="line">        <span class="string">&quot;_id&quot;</span> : <span class="string">&quot;dukLoG0BdfGBNhbF13CJ&quot;</span>,</span><br><span class="line">        <span class="string">&quot;_score&quot;</span> : <span class="number">0.5753642</span>,</span><br><span class="line">        <span class="string">&quot;highlight&quot;</span> : &#123;</span><br><span class="line">          <span class="string">&quot;content&quot;</span> : [</span><br><span class="line">            <span class="string">&quot;&lt;em&gt;Data&lt;/em&gt; &lt;em&gt;Modeling&lt;/em&gt; and Analytics. 5. Improving the User Search Experience. 6.&quot;</span></span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>(4)结果说明:</p>
<blockquote>
<ul>
<li>返回结果中不包含 _source 字段;</li>
<li>对需要显示的信息, 要在查询中指定 “stored_fields”: [“xxx”, “yyy”] ;</li>
<li>禁⽌ _source 字段后, 仍然支持使用 Highlights API 的使用.</li>
</ul>
</blockquote>
<h4 id="3-5-mapping中字段的常用参数"><a href="#3-5-mapping中字段的常用参数" class="headerlink" title="3.5 mapping中字段的常用参数"></a>3.5 mapping中字段的常用参数</h4><p>参考:<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/mapping-params.html">https://www.elastic.co/guide/en/elasticsearch/reference/current/mapping-params.html</a></p>
<ul>
<li>enabled – 设置成 false, 当前字段就只存储, 不支持搜索和聚合分析 (数据保存在 _source 中);</li>
<li>index – 是否构建倒排索引, 设置成 false, 就无法被搜索, 但还是支持聚合操作, 并会出现在 _source 中;</li>
<li>norms – 只⽤来过滤和聚合分析(指标数据)、不关心评分的字段, 建议关闭, 节约存储空间;</li>
<li>doc_values – 是否启用 doc_values, 用于排序和聚合分析;</li>
<li>field_data – 如果要对 text 类型启用排序和聚合分析, fielddata 需要设置成true;</li>
<li>coerce – 是否开启数据类型的自动转换 (如: 字符串转数字), 默认开启;</li>
<li>multifields - 是否开启多字段特性;</li>
<li>dynamic – 控制 mapping 的动态更新策略, 有 true &#x2F; false &#x2F; strict 三种.</li>
</ul>
<p>doc_values 与 fielddata 比较:</p>
<blockquote>
<p>doc_values: 聚合和排序的字段需要开启 —— 默认 <strong>为所有非text类型的字段</strong> 开启 —— 内存不够时, 会写入磁盘文件中;</p>
<p>fielddata: 是否为text类型开启, 以实现排序和聚合分析 —— 默认关闭 —— 全部加载进内存中.</p>
</blockquote>
<h4 id="3-6-mapping-设置小结"><a href="#3-6-mapping-设置小结" class="headerlink" title="3.6 mapping 设置小结"></a>3.6 mapping 设置小结</h4><p>(1)支持加入新的字段 (包括子字段)、更换分词器等操作:</p>
<blockquote>
<p>可以通过 update_by_query 令旧数据得到清洗.</p>
</blockquote>
<p>(2)Index Template: 根据索引的名称匹配不同的 mappings 和 settings;</p>
<p>(3)Dynamic Template: 在一个 mapping 上动态设定字段类型;</p>
<p>(4)Reindex: 如果要修改、删除已经存在的字段, 或者修改分片个数等参数, 就要重建索引.</p>
<blockquote>
<p>必须停机, 数据量大时耗时会比较久.</p>
<p>可借助 Index Alias (索引别名) 来实现零停机维护.</p>
</blockquote>
<h3 id="4-ES-数据建模最佳实践"><a href="#4-ES-数据建模最佳实践" class="headerlink" title="4 ES 数据建模最佳实践"></a>4 ES 数据建模最佳实践</h3><h4 id="4-1-如何处理关联关系"><a href="#4-1-如何处理关联关系" class="headerlink" title="4.1 如何处理关联关系"></a>4.1 如何处理关联关系</h4><p>(1)范式化设计:</p>
<p>我们知道, 在关系型数据库中有“范式化设计”的概念, 有 1NF、2NF、3NF、BCNF 等等, 主要目标是减少不必要的更新, 虽然节省了存储空间, 但缺点是数据读取操作可能会更慢, 尤其是跨表操作, 需要 join 的表会很多.</p>
<p>反范式化设计: 数据扁平, 不使用关联关系, 而是在文档中通过 <code>_source</code> 字段来保存冗余的数据拷贝.</p>
<blockquote>
<p>优点: 无需处理 join 操作, 数据读取性能好;</p>
<p>缺点: 不适合数据频繁修改的场景.</p>
</blockquote>
<p>&#x3D;&#x3D;》ES 不擅长处理关联关系, 一般可以通过对象类型(object)、嵌套类型(nested)、父子关联关系(child&#x2F;parent)解决.</p>
<p>具体使用所占篇幅较大, 这里省略.</p>
<h4 id="4-2-避免太多的字段"><a href="#4-2-避免太多的字段" class="headerlink" title="4.2 避免太多的字段"></a>4.2 避免太多的字段</h4><p>(1)一个⽂档中, 最好不要有⼤量的字段:</p>
<blockquote>
<ul>
<li>过多的字段导致数据不容易维护;</li>
<li>mapping 信息保存在 Cluster State 中, 数据量过⼤, 对集群性能会有影响 (Cluster State 信息需要和所有的节点同步);</li>
<li>删除或修改字段时, 需要 reindex;</li>
</ul>
</blockquote>
<p>(2)ES中单个索引最大字段数默认是 1000, 可以通过参数 <code>index.mapping.total_fields.limt</code> 修改最⼤字段数.</p>
<p>思考:什么原因会导致文档中有成百上千的字段?</p>
<blockquote>
<p>ES 是无模式 (schemaless) 的, 默认情况下, 每添加一个字段, ES 都会根据该字段可能的类型自动添加映射关系.</p>
<p>如果业务处理不严谨, 会出现字段爆炸的现象. 为了避免这种现象的发生, 需要制定 dynamic 策略:</p>
<ul>
<li>true - 未知字段会被自动加入, 是默认设置;</li>
<li>false - 新字段不会被索引, 但是会保存到 _source 中;</li>
<li>strict - 新增字段不会被索引, ⽂档写入失败, 抛出异常.</li>
</ul>
<p><strong>—— 生产环境中, 尽量不要使用默认的 “dynamic”: true .</strong></p>
</blockquote>
<h4 id="4-3-避免正则查询"><a href="#4-3-避免正则查询" class="headerlink" title="4.3 避免正则查询"></a>4.3 避免正则查询</h4><p>正则、前缀、通配符查询, 都属于 Term 查询, 但是性能很不好(扫描所有文档, 并逐一比对), 特别是将通配符放在开头, 会导致性能灾难.</p>
<p>(1)案例:</p>
<blockquote>
<ul>
<li>文档中某个字段包含了 Elasticsearch 的版本信息, 例如 version: “7.2.0” ;</li>
<li>搜索某系列的 bug_fix 版本(末位非0的版本号)? 每个主要版本号所关联的文档?</li>
</ul>
</blockquote>
<p>(2)通配符查询示例:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"># 插入<span class="number">2</span>条数据:</span><br><span class="line">PUT softwares/_doc/<span class="number">1</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;version&quot;</span>: <span class="string">&quot;7.2.0&quot;</span>,</span><br><span class="line">  <span class="string">&quot;doc_url&quot;</span>: <span class="string">&quot;https://www.elastic.co/guide/en/elasticsearch/.../.html&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT softwares/_doc/<span class="number">2</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;version&quot;</span>: <span class="string">&quot;7.3.0&quot;</span>,</span><br><span class="line">  <span class="string">&quot;doc_url&quot;</span>: <span class="string">&quot;https://www.elastic.co/guide/en/elasticsearch/.../.html&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 通配符查询:</span><br><span class="line">GET softwares/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;wildcard&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;version&quot;</span>: <span class="string">&quot;7*&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>(3)解决方案 - 将字符串类型转换为对象类型:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"># 创建对象类型的映射:</span><br><span class="line">PUT softwares</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;version&quot;</span>: &#123;		# 版本号设置为对象类型</span><br><span class="line">        <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;display_name&quot;</span>: &#123; <span class="string">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span> &#125;,</span><br><span class="line">          <span class="string">&quot;major&quot;</span>: &#123; <span class="string">&quot;type&quot;</span>: <span class="string">&quot;byte&quot;</span> &#125;,</span><br><span class="line">          <span class="string">&quot;minor&quot;</span>: &#123; <span class="string">&quot;type&quot;</span>: <span class="string">&quot;byte&quot;</span> &#125;,</span><br><span class="line">          <span class="string">&quot;bug_fix&quot;</span>: &#123; <span class="string">&quot;type&quot;</span>: <span class="string">&quot;byte&quot;</span> &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;doc_url&quot;</span>: &#123; <span class="string">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span> &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 添加数据:</span><br><span class="line">PUT softwares/_doc/<span class="number">1</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;version&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;display_name&quot;</span>: <span class="string">&quot;7.2.0&quot;</span>,</span><br><span class="line">    <span class="string">&quot;major&quot;</span>: <span class="number">7</span>,</span><br><span class="line">    <span class="string">&quot;minor&quot;</span>: <span class="number">2</span>,</span><br><span class="line">    <span class="string">&quot;bug_fix&quot;</span>: <span class="number">0</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;doc_url&quot;</span>: <span class="string">&quot;https://www.elastic.co/guide/en/elasticsearch/.../.html&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT softwares/_doc/<span class="number">2</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;version&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;display_name&quot;</span>: <span class="string">&quot;7.3.0&quot;</span>,</span><br><span class="line">    <span class="string">&quot;major&quot;</span>: <span class="number">7</span>,</span><br><span class="line">    <span class="string">&quot;minor&quot;</span>: <span class="number">3</span>,</span><br><span class="line">    <span class="string">&quot;bug_fix&quot;</span>: <span class="number">0</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;doc_url&quot;</span>: <span class="string">&quot;https://www.elastic.co/guide/en/elasticsearch/.../.html&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 通过filter过滤, 避免正则查询, 大大提升性能:</span><br><span class="line">GET softwares/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;bool&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;filter&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;match&quot;</span>: &#123; <span class="string">&quot;version.major&quot;</span>: <span class="number">7</span> &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;match&quot;</span>: &#123; <span class="string">&quot;version.minor&quot;</span>: <span class="number">2</span> &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="4-4-避免空值引起的聚合不准"><a href="#4-4-避免空值引起的聚合不准" class="headerlink" title="4.4 避免空值引起的聚合不准"></a>4.4 避免空值引起的聚合不准</h4><p>(1)示例:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"># 添加数据, 包含<span class="number">1</span>条 <span class="literal">null</span> 值的数据:</span><br><span class="line">PUT ratings/_doc/<span class="number">1</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;rating&quot;</span>: <span class="number">5</span></span><br><span class="line">&#125;</span><br><span class="line">PUT ratings/_doc/<span class="number">2</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;rating&quot;</span>: <span class="literal">null</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 对含有 <span class="literal">null</span> 值的字段进行聚合:</span><br><span class="line">GET ratings/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;size&quot;</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;avg_rating&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;avg&quot;</span>: &#123; <span class="string">&quot;field&quot;</span>: <span class="string">&quot;rating&quot;</span>&#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 结果如下:</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;took&quot;</span> : <span class="number">3</span>,</span><br><span class="line">  <span class="string">&quot;timed_out&quot;</span> : <span class="literal">false</span>,</span><br><span class="line">  <span class="string">&quot;_shards&quot;</span> : &#123;</span><br><span class="line">    <span class="string">&quot;total&quot;</span> : <span class="number">1</span>,</span><br><span class="line">    <span class="string">&quot;successful&quot;</span> : <span class="number">1</span>,</span><br><span class="line">    <span class="string">&quot;skipped&quot;</span> : <span class="number">0</span>,</span><br><span class="line">    <span class="string">&quot;failed&quot;</span> : <span class="number">0</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;hits&quot;</span> : &#123;</span><br><span class="line">    <span class="string">&quot;total&quot;</span> : &#123;</span><br><span class="line">      <span class="string">&quot;value&quot;</span> : <span class="number">2</span>,				# <span class="number">2</span>条数据, avg_rating 结果不正确</span><br><span class="line">      <span class="string">&quot;relation&quot;</span> : <span class="string">&quot;eq&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;max_score&quot;</span> : <span class="literal">null</span>,</span><br><span class="line">    <span class="string">&quot;hits&quot;</span> : [ ]</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;aggregations&quot;</span> : &#123;</span><br><span class="line">    <span class="string">&quot;avg_rating&quot;</span> : &#123;</span><br><span class="line">      <span class="string">&quot;value&quot;</span> : <span class="number">5.0</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>(2)使用 <code>null_value</code> 解决空值的问题:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"># 创建 mapping 时, 设置 null_value:</span><br><span class="line">PUT ratings</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;rating&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;float&quot;</span>,</span><br><span class="line">        <span class="string">&quot;null_value&quot;</span>: <span class="string">&quot;1.0&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 添加相同的数据, 再次聚合, 结果正确:</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;took&quot;</span> : <span class="number">0</span>,</span><br><span class="line">  <span class="string">&quot;timed_out&quot;</span> : <span class="literal">false</span>,</span><br><span class="line">  <span class="string">&quot;_shards&quot;</span> : &#123;</span><br><span class="line">    <span class="string">&quot;total&quot;</span> : <span class="number">1</span>,</span><br><span class="line">    <span class="string">&quot;successful&quot;</span> : <span class="number">1</span>,</span><br><span class="line">    <span class="string">&quot;skipped&quot;</span> : <span class="number">0</span>,</span><br><span class="line">    <span class="string">&quot;failed&quot;</span> : <span class="number">0</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;hits&quot;</span> : &#123;</span><br><span class="line">    <span class="string">&quot;total&quot;</span> : &#123;</span><br><span class="line">      <span class="string">&quot;value&quot;</span> : <span class="number">2</span>,</span><br><span class="line">      <span class="string">&quot;relation&quot;</span> : <span class="string">&quot;eq&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;max_score&quot;</span> : <span class="literal">null</span>,</span><br><span class="line">    <span class="string">&quot;hits&quot;</span> : [ ]</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;aggregations&quot;</span> : &#123;</span><br><span class="line">    <span class="string">&quot;avg_rating&quot;</span> : &#123;</span><br><span class="line">      <span class="string">&quot;value&quot;</span> : <span class="number">3.0</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h2 id="案例、实例"><a href="#案例、实例" class="headerlink" title="案例、实例"></a>案例、实例</h2> <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/05/05/es-basic/4056955e1543c0fad5fcdae13169866e_1699267532161.png" class="">

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/18/8zaCgmDb1HyFLeX.png"></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="http://xeons.cn">Calico</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="http://xeons.cn/2023/05/05/es-basic/">http://xeons.cn/2023/05/05/es-basic/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://xeons.cn" target="_blank">Calico's Space</a>！</span></div></div><script>function setClipboardText(event){
    let clipboardData = event.clipboardData || window.clipboardData;
    if (!clipboardData) { return; }
    event.preventDefault();
    let text = window.getSelection().toString();
    if (text) {
        event.preventDefault();
        var copyright = "\n\n---\n著作权归 Calico 所有 \n原文链接: http://xeons.cn/2023/05/05/es-basic/";
        clipboardData.setData('text/plain', text + copyright);
    }
};
var contents = document.getElementsByClassName("post");
contents[0].addEventListener('copy',function(e){
    setClipboardText(e);
});</script><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/java/">java</a><a class="post-meta__tags" href="/tags/elasticsearch/">elasticsearch</a></div><div class="post_share"><div class="social-share" data-image="/2023/05/05/es-basic/logo.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i>赞助</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/images/wxpay.png" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images/wxpay.png" alt="wechat"/></a><div class="post-qr-code-desc">wechat</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2023/05/18/python-crawer/" title="使用 Python 做数据采集(爬虫)"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">使用 Python 做数据采集(爬虫)</div></div></a></div><div class="next-post pull-right"><a href="/2023/05/04/mq-kafka/" title="消息队列-kafka"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/05/04/mq-kafka/logo.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">消息队列-kafka</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2023/01/03/data-structure-and-algorithm/" title="常见数据结构和算法"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/01/03/data-structure-and-algorithm/logo.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-01-03</div><div class="title">常见数据结构和算法</div></div></a></div><div><a href="/2023/06/03/hashmap-sourcecode-analyes/" title="HashMap 源码解析"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-06-03</div><div class="title">HashMap 源码解析</div></div></a></div><div><a href="/2023/06/03/java-basic/" title="Java 基础试题1"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/05/13/8KXvfwkxihBbtGM.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-06-03</div><div class="title">Java 基础试题1</div></div></a></div><div><a href="/2023/06/23/java-memory-optimize/" title="JVM内存调优"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/06/23/java-memory-optimize/logo.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-06-23</div><div class="title">JVM内存调优</div></div></a></div><div><a href="/2023/06/04/java-concurrent-basic/" title="Java“并发”常见问题概述"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/05/13/8KXvfwkxihBbtGM.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-06-04</div><div class="title">Java“并发”常见问题概述</div></div></a></div><div><a href="/2023/06/03/jvm-faq/" title="JVM 常见问答题"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/05/13/8KXvfwkxihBbtGM.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-06-03</div><div class="title">JVM 常见问答题</div></div></a></div></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="lv-container" data-id="city" data-uid="MTAyMC81OTczMi8zNjE5NA=="></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images/calico.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Calico</div><div class="author-info__description">It's my blog，Record everything！</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">33</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">23</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">22</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xeonsuo"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/xeonsuo" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="https://weibo.com/xeons" target="_blank" title="微博"><i class="fab fa-weibo" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:xeon511@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">python、aiAgent 进化中...</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9B%B8%E5%85%B3%E6%A6%82%E5%BF%B5"><span class="toc-number">1.</span> <span class="toc-text">相关概念</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-Elasticsearch%E6%A6%82%E8%BF%B0"><span class="toc-number">1.1.</span> <span class="toc-text">1 Elasticsearch概述</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-Elasticsearch%E6%98%AF%E4%BB%80%E4%B9%88"><span class="toc-number">1.1.1.</span> <span class="toc-text">1.1 Elasticsearch是什么</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-Elasticsearch%E7%9A%84%E4%BC%98%E7%82%B9"><span class="toc-number">1.1.2.</span> <span class="toc-text">1.2 Elasticsearch的优点</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3-Elasticsearch%E7%9A%84%E7%9B%B8%E5%85%B3%E4%BA%A7%E5%93%81"><span class="toc-number">1.1.3.</span> <span class="toc-text">1.3 Elasticsearch的相关产品</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-4-Elasticsearch%E7%9A%84%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">1.1.4.</span> <span class="toc-text">1.4 Elasticsearch的使用场景</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-Elasticsearch%E7%9A%84%E5%8A%9F%E8%83%BD%E6%A6%82%E8%BF%B0"><span class="toc-number">1.2.</span> <span class="toc-text">2 Elasticsearch的功能概述</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-%E5%88%86%E5%B8%83%E5%BC%8F%E7%9A%84%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E%E5%92%8C%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90%E5%BC%95%E6%93%8E"><span class="toc-number">1.2.1.</span> <span class="toc-text">2.1 分布式的搜索引擎和数据分析引擎</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-%E5%85%A8%E6%96%87%E6%A3%80%E7%B4%A2-%E7%BB%93%E6%9E%84%E5%8C%96%E6%A3%80%E7%B4%A2-%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90"><span class="toc-number">1.2.2.</span> <span class="toc-text">2.2 全文检索 结构化检索 数据分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-%E6%B5%B7%E9%87%8F%E6%95%B0%E6%8D%AE%E7%9A%84%E8%BF%91%E5%AE%9E%E6%97%B6%E5%A4%84%E7%90%86"><span class="toc-number">1.2.3.</span> <span class="toc-text">2.3 海量数据的近实时处理</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-Elasticsearch%E7%9A%84%E6%9E%B6%E6%9E%84"><span class="toc-number">1.3.</span> <span class="toc-text">3 Elasticsearch的架构</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-gateway-%E9%97%A8%E6%88%B7%E3%80%81%E7%BD%91%E5%85%B3"><span class="toc-number">1.3.1.</span> <span class="toc-text">3.1 gateway - 门户、网关</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-Lucene-%E5%88%86%E5%B8%83%E5%BC%8FLucene%E7%9B%AE%E5%BD%95"><span class="toc-number">1.3.2.</span> <span class="toc-text">3.2 Lucene - 分布式Lucene目录</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-Discovery-%E5%8F%91%E7%8E%B0%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.3.3.</span> <span class="toc-text">3.2 Discovery - 发现服务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-Scripting-%E8%84%9A%E6%9C%AC"><span class="toc-number">1.3.4.</span> <span class="toc-text">3.3 Scripting - 脚本</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-4-3rd-Plugins-%E4%B8%89%E6%96%B9%E6%8F%92%E4%BB%B6"><span class="toc-number">1.3.5.</span> <span class="toc-text">3.4 3rd Plugins - 三方插件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-5-Transport-%E9%80%9A%E4%BF%A1%E6%A8%A1%E5%9D%97"><span class="toc-number">1.3.6.</span> <span class="toc-text">3.5 Transport - 通信模块</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-6-JMX-Java%E7%AE%A1%E7%90%86%E6%A1%86%E6%9E%B6"><span class="toc-number">1.3.7.</span> <span class="toc-text">3.6 JMX - Java管理框架</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-7-RESTful-style-API-%E4%B8%8E%E9%9B%86%E7%BE%A4%E8%BF%9B%E8%A1%8C%E4%BA%A4%E4%BA%92"><span class="toc-number">1.3.8.</span> <span class="toc-text">3.7 RESTful style API - 与集群进行交互</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-Elasticsearch%E7%B4%A2%E5%BC%95%E7%9B%B8%E5%85%B3%E6%A6%82%E5%BF%B5"><span class="toc-number">1.3.9.</span> <span class="toc-text">4 Elasticsearch索引相关概念</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-term-%E7%B4%A2%E5%BC%95%E8%AF%8D"><span class="toc-number">1.3.10.</span> <span class="toc-text">4.1 term(索引词)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-text-%E6%96%87%E6%9C%AC"><span class="toc-number">1.3.11.</span> <span class="toc-text">4.2 text(文本)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-3-analysis-%E5%88%86%E6%9E%90"><span class="toc-number">1.3.12.</span> <span class="toc-text">4.3 analysis(分析)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-4-cluster-%E9%9B%86%E7%BE%A4"><span class="toc-number">1.3.13.</span> <span class="toc-text">4.4 cluster(集群)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-5-node-%E8%8A%82%E7%82%B9"><span class="toc-number">1.3.14.</span> <span class="toc-text">4.5 node(节点)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-6-shard-%E5%88%86%E7%89%87"><span class="toc-number">1.3.15.</span> <span class="toc-text">4.6 shard(分片)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-7-replica-%E5%89%AF%E6%9C%AC"><span class="toc-number">1.3.16.</span> <span class="toc-text">4.7 replica(副本)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-8-river-%E6%95%B0%E6%8D%AE%E6%BA%90"><span class="toc-number">1.3.17.</span> <span class="toc-text">4.8 river(数据源)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-9-index-%E7%B4%A2%E5%BC%95"><span class="toc-number">1.3.18.</span> <span class="toc-text">4.9 index(索引)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-10-type-%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.3.19.</span> <span class="toc-text">4.10 type(类型)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-11-document-%E6%96%87%E6%A1%A3"><span class="toc-number">1.3.20.</span> <span class="toc-text">4.11 document(文档)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-12-mapping-%E6%98%A0%E5%B0%84"><span class="toc-number">1.3.21.</span> <span class="toc-text">4.12 mapping(映射)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-13-field-%E5%AD%97%E6%AE%B5"><span class="toc-number">1.3.22.</span> <span class="toc-text">4.13 field(字段)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-14-recovery-%E6%95%B0%E6%8D%AE%E6%81%A2%E5%A4%8D"><span class="toc-number">1.3.23.</span> <span class="toc-text">4.14 recovery(数据恢复)</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%BB%E8%A6%81%E9%85%8D%E7%BD%AE"><span class="toc-number">2.</span> <span class="toc-text">主要配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-elasticsearch-yml-ES%E6%9C%8D%E5%8A%A1%E9%85%8D%E7%BD%AE"><span class="toc-number">2.1.</span> <span class="toc-text">1 elasticsearch.yml(ES服务配置)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-Cluster%E9%9B%86%E7%BE%A4%E9%85%8D%E7%BD%AE"><span class="toc-number">2.1.1.</span> <span class="toc-text">1.1 Cluster集群配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-Node%E8%8A%82%E7%82%B9%E9%85%8D%E7%BD%AE"><span class="toc-number">2.1.2.</span> <span class="toc-text">1.2 Node节点配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3-Paths%E8%B7%AF%E5%BE%84%E9%85%8D%E7%BD%AE"><span class="toc-number">2.1.3.</span> <span class="toc-text">1.3 Paths路径配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-4-Memory%E5%86%85%E5%AD%98%E9%85%8D%E7%BD%AE"><span class="toc-number">2.1.4.</span> <span class="toc-text">1.4 Memory内存配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-5-Network%E7%BD%91%E7%BB%9C%E9%85%8D%E7%BD%AE"><span class="toc-number">2.1.5.</span> <span class="toc-text">1.5 Network网络配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-6-Discovery%E8%8A%82%E7%82%B9%E5%8F%91%E7%8E%B0%E9%85%8D%E7%BD%AE"><span class="toc-number">2.1.6.</span> <span class="toc-text">1.6 Discovery节点发现配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-7-Gateway%E7%BD%91%E5%85%B3%E9%85%8D%E7%BD%AE"><span class="toc-number">2.1.7.</span> <span class="toc-text">1.7 Gateway网关配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-8-Various%E5%85%B6%E4%BB%96%E9%85%8D%E7%BD%AE"><span class="toc-number">2.1.8.</span> <span class="toc-text">1.8 Various其他配置</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-jvm-options-JVM%E5%8F%82%E6%95%B0%E9%85%8D%E7%BD%AE"><span class="toc-number">2.2.</span> <span class="toc-text">2 jvm.options(JVM参数配置)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-log4j2-properties-%E6%97%A5%E5%BF%97%E9%85%8D%E7%BD%AE"><span class="toc-number">2.3.</span> <span class="toc-text">3 log4j2.properties(日志配置)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AE%80%E5%8D%95%E6%9F%A5%E8%AF%A2"><span class="toc-number">3.</span> <span class="toc-text">简单查询</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-Query-String-Search-%E6%9F%A5%E8%AF%A2%E4%B8%B2%E6%A3%80%E7%B4%A2"><span class="toc-number">3.1.</span> <span class="toc-text">1 Query String Search(查询串检索)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-Query-DSL-ES%E7%89%B9%E5%AE%9A%E8%AF%AD%E6%B3%95%E6%A3%80%E7%B4%A2"><span class="toc-number">3.2.</span> <span class="toc-text">2 Query DSL(ES特定语法检索)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-Query-Filter-%E8%BF%87%E6%BB%A4%E6%A3%80%E7%B4%A2"><span class="toc-number">3.3.</span> <span class="toc-text">3 Query Filter(过滤检索)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-Full-Text-Search-%E5%85%A8%E6%96%87%E6%A3%80%E7%B4%A2"><span class="toc-number">3.4.</span> <span class="toc-text">4 Full Text Search(全文检索)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-Phrase-Search-%E7%9F%AD%E8%AF%AD%E6%A3%80%E7%B4%A2"><span class="toc-number">3.5.</span> <span class="toc-text">5 Phrase Search(短语检索)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-Highlight-Search-%E9%AB%98%E4%BA%AE%E6%A3%80%E7%B4%A2"><span class="toc-number">3.6.</span> <span class="toc-text">6 Highlight Search(高亮检索)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%B4%A2%E5%BC%95%E6%93%8D%E4%BD%9C"><span class="toc-number">4.</span> <span class="toc-text">索引操作</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%88%9B%E5%BB%BAindex%EF%BC%88%E9%85%8D%E7%BD%AEmapping-%E6%98%A0%E5%B0%84-%EF%BC%89"><span class="toc-number">4.1.</span> <span class="toc-text">1 创建index（配置mapping[映射]）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E6%9F%A5%E7%9C%8Bindex"><span class="toc-number">4.2.</span> <span class="toc-text">2 查看index</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E4%BF%AE%E6%94%B9index"><span class="toc-number">4.3.</span> <span class="toc-text">3 修改index</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E5%88%A0%E9%99%A4index"><span class="toc-number">4.4.</span> <span class="toc-text">4 删除index</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E6%89%93%E5%BC%80-%E5%85%B3%E9%97%ADindex"><span class="toc-number">4.5.</span> <span class="toc-text">5 打开&#x2F;关闭index</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E5%8F%8A%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95"><span class="toc-number">4.6.</span> <span class="toc-text">6 常见问题及解决方法</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#document%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="toc-number">5.</span> <span class="toc-text">document数据类型</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E6%A0%B8%E5%BF%83%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="toc-number">5.1.</span> <span class="toc-text">1 核心数据类型</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-%E5%AD%97%E7%AC%A6%E4%B8%B2%E7%B1%BB%E5%9E%8B-string-%E4%B8%8D%E5%86%8D%E6%94%AF%E6%8C%81"><span class="toc-number">5.1.1.</span> <span class="toc-text">1.1 字符串类型 - string(不再支持)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-1-%E6%96%87%E6%9C%AC%E7%B1%BB%E5%9E%8B-text"><span class="toc-number">5.1.2.</span> <span class="toc-text">1.1.1 文本类型 - text</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-2-%E5%85%B3%E9%94%AE%E5%AD%97%E7%B1%BB%E5%9E%8B-keyword"><span class="toc-number">5.1.3.</span> <span class="toc-text">1.1.2 关键字类型 - keyword</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-%E6%95%B0%E5%AD%97%E7%B1%BB%E5%9E%8B-8%E7%A7%8D"><span class="toc-number">5.1.4.</span> <span class="toc-text">1.2 数字类型 - 8种</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3-%E6%97%A5%E6%9C%9F%E7%B1%BB%E5%9E%8B-date"><span class="toc-number">5.1.5.</span> <span class="toc-text">1.3 日期类型 - date</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-4-%E5%B8%83%E5%B0%94%E7%B1%BB%E5%9E%8B-boolean"><span class="toc-number">5.1.6.</span> <span class="toc-text">1.4 布尔类型 - boolean</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-5-%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%9E%8B-binary"><span class="toc-number">5.1.7.</span> <span class="toc-text">1.5 二进制型 - binary</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-6-%E8%8C%83%E5%9B%B4%E7%B1%BB%E5%9E%8B-range"><span class="toc-number">5.1.8.</span> <span class="toc-text">1.6 范围类型 - range</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%A4%8D%E6%9D%82%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="toc-number">5.2.</span> <span class="toc-text">2 复杂数据类型</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-%E6%95%B0%E7%BB%84%E7%B1%BB%E5%9E%8B-array"><span class="toc-number">5.2.1.</span> <span class="toc-text">2.1 数组类型 - array</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-%E5%AF%B9%E8%B1%A1%E7%B1%BB%E5%9E%8B-object"><span class="toc-number">5.2.2.</span> <span class="toc-text">2.2 对象类型 - object</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-%E5%B5%8C%E5%A5%97%E7%B1%BB%E5%9E%8B-nested"><span class="toc-number">5.2.3.</span> <span class="toc-text">2.3 嵌套类型 - nested</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-1-%E5%AF%B9%E8%B1%A1%E6%95%B0%E7%BB%84%E6%98%AF%E5%A6%82%E4%BD%95%E5%AD%98%E5%82%A8%E7%9A%84"><span class="toc-number">5.2.4.</span> <span class="toc-text">2.3.1 对象数组是如何存储的</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-2-%E7%94%A8nested%E7%B1%BB%E5%9E%8B%E8%A7%A3%E5%86%B3object%E7%B1%BB%E5%9E%8B%E7%9A%84%E4%B8%8D%E8%B6%B3"><span class="toc-number">5.2.5.</span> <span class="toc-text">2.3.2 用nested类型解决object类型的不足</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E5%9C%B0%E7%90%86%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="toc-number">5.3.</span> <span class="toc-text">3 地理数据类型</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-%E5%9C%B0%E7%90%86%E7%82%B9%E7%B1%BB%E5%9E%8B-geo-point"><span class="toc-number">5.3.1.</span> <span class="toc-text">3.1 地理点类型 - geo point</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-%E5%9C%B0%E7%90%86%E5%BD%A2%E7%8A%B6%E7%B1%BB%E5%9E%8B-geo-shape"><span class="toc-number">5.3.2.</span> <span class="toc-text">3.2 地理形状类型 - geo_shape</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E4%B8%93%E9%97%A8%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="toc-number">5.4.</span> <span class="toc-text">4 专门数据类型</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-IP%E7%B1%BB%E5%9E%8B"><span class="toc-number">5.4.1.</span> <span class="toc-text">4.1 IP类型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-%E8%AE%A1%E6%95%B0%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B-token-count"><span class="toc-number">5.4.2.</span> <span class="toc-text">4.2 计数数据类型 - token_count</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DSL%E6%9F%A5%E8%AF%A2"><span class="toc-number">6.</span> <span class="toc-text">DSL查询</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E4%BB%80%E4%B9%88%E6%98%AFDSL"><span class="toc-number">6.1.</span> <span class="toc-text">1 什么是DSL</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-validate-%E6%A0%A1%E9%AA%8C%E6%9F%A5%E8%AF%A2%E8%AF%AD%E5%8F%A5%E6%98%AF%E5%90%A6%E5%90%88%E6%B3%95"><span class="toc-number">6.2.</span> <span class="toc-text">2 _validate - 校验查询语句是否合法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-match-query-%E5%8C%B9%E9%85%8D%E6%9F%A5%E8%AF%A2"><span class="toc-number">6.3.</span> <span class="toc-text">3 match query - 匹配查询</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-%E7%AE%80%E5%8D%95%E5%8A%9F%E8%83%BD%E7%A4%BA%E4%BE%8B"><span class="toc-number">6.3.1.</span> <span class="toc-text">3.1 简单功能示例</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-1-%E6%9F%A5%E8%AF%A2%E6%89%80%E6%9C%89%E6%96%87%E6%A1%A3"><span class="toc-number">6.3.2.</span> <span class="toc-text">3.1.1 查询所有文档</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-2-%E6%9F%A5%E8%AF%A2%E6%BB%A1%E8%B6%B3%E4%B8%80%E5%AE%9A%E6%9D%A1%E4%BB%B6%E7%9A%84%E6%96%87%E6%A1%A3"><span class="toc-number">6.3.3.</span> <span class="toc-text">3.1.2 查询满足一定条件的文档</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-3-%E5%88%86%E9%A1%B5%E6%9F%A5%E8%AF%A2%E6%96%87%E6%A1%A3"><span class="toc-number">6.3.4.</span> <span class="toc-text">3.1.3 分页查询文档</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-4-%E6%8C%87%E5%AE%9A%E8%BF%94%E5%9B%9E%E7%9A%84%E7%BB%93%E6%9E%9C%E4%B8%AD%E5%8C%85%E5%90%AB%E7%9A%84%E5%AD%97%E6%AE%B5"><span class="toc-number">6.3.5.</span> <span class="toc-text">3.1.4 指定返回的结果中包含的字段</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-%E7%B2%BE%E7%A1%AE%E6%9F%A5%E8%AF%A2-match-phrase"><span class="toc-number">6.3.6.</span> <span class="toc-text">3.2 精确查询 - match_phrase</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-1-%E7%B2%BE%E7%A1%AE%E5%8C%B9%E9%85%8D-exact-value"><span class="toc-number">6.3.7.</span> <span class="toc-text">3.2.1 精确匹配 - exact value</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-2-%E5%85%A8%E6%96%87%E6%90%9C%E7%B4%A2-full-text"><span class="toc-number">6.3.8.</span> <span class="toc-text">3.2.2 全文搜索 - full text</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-%E6%8E%A7%E5%88%B6%E5%8C%B9%E9%85%8D%E8%A7%84%E5%88%99-operator"><span class="toc-number">6.3.9.</span> <span class="toc-text">3.3 控制匹配规则 - operator</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-4-%E6%8C%87%E5%AE%9A%E5%91%BD%E4%B8%AD%E7%9A%84%E7%99%BE%E5%88%86%E6%AF%94-minimum-should-match"><span class="toc-number">6.3.10.</span> <span class="toc-text">3.4 指定命中的百分比 - minimum_should_match</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-5-%E5%A4%9A%E5%AD%97%E6%AE%B5%E7%9A%84%E5%8C%B9%E9%85%8D-multi-match"><span class="toc-number">6.3.11.</span> <span class="toc-text">3.5 多字段的匹配 - multi_match</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-bool-query-%E5%B8%83%E5%B0%94%E6%9F%A5%E8%AF%A2-%E7%9C%9F%E5%81%87%E6%9F%A5%E8%AF%A2"><span class="toc-number">6.4.</span> <span class="toc-text">4 bool query - 布尔查询(真假查询)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-%E7%AE%80%E5%8D%95%E5%8A%9F%E8%83%BD%E7%A4%BA%E4%BE%8B"><span class="toc-number">6.4.1.</span> <span class="toc-text">4.1 简单功能示例</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-%E5%B5%8C%E5%A5%97%E4%BD%BF%E7%94%A8bool-query"><span class="toc-number">6.4.2.</span> <span class="toc-text">4.2 嵌套使用bool query</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-3-%E7%9B%B4%E6%8E%A5filter%E6%93%8D%E4%BD%9C-%E4%BD%BF%E7%94%A8constant-score"><span class="toc-number">6.4.3.</span> <span class="toc-text">4.3 直接filter操作 - 使用constant_score</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-4-%E6%8C%87%E5%AE%9Ashould%E7%9A%84%E5%8C%B9%E9%85%8D%E4%B8%AA%E6%95%B0-minimum-should-match"><span class="toc-number">6.4.4.</span> <span class="toc-text">4.4 指定should的匹配个数 - minimum_should_match</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%AB%98%E7%BA%A7%E6%9F%A5%E8%AF%A2"><span class="toc-number">7.</span> <span class="toc-text">高级查询</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-term-query-%E7%B4%A2%E5%BC%95%E8%AF%8D%E6%A3%80%E7%B4%A2"><span class="toc-number">7.1.</span> <span class="toc-text">1 term query - 索引词检索</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-term-query-%E4%B8%8D%E5%88%86%E8%AF%8D%E6%A3%80%E7%B4%A2"><span class="toc-number">7.1.1.</span> <span class="toc-text">1.1 term query - 不分词检索</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-terms-query-in%E6%A3%80%E7%B4%A2"><span class="toc-number">7.1.2.</span> <span class="toc-text">1.2 terms query - in检索</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-prefix-query-%E5%89%8D%E7%BC%80%E6%A3%80%E7%B4%A2"><span class="toc-number">7.2.</span> <span class="toc-text">2 prefix query - 前缀检索</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-wildcard-query-%E9%80%9A%E9%85%8D%E7%AC%A6%E6%A3%80%E7%B4%A2"><span class="toc-number">7.3.</span> <span class="toc-text">3 wildcard query - 通配符检索</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-regexp-query-%E6%AD%A3%E5%88%99%E6%A3%80%E7%B4%A2"><span class="toc-number">7.4.</span> <span class="toc-text">4 regexp query - 正则检索</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-fuzzy-query-%E7%BA%A0%E9%94%99%E6%A3%80%E7%B4%A2"><span class="toc-number">7.5.</span> <span class="toc-text">5 fuzzy query - 纠错检索</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-boost%E8%AF%84%E5%88%86%E6%9D%83%E9%87%8D-%E6%8E%A7%E5%88%B6%E6%96%87%E6%A1%A3%E7%9A%84%E4%BC%98%E5%85%88%E7%BA%A7%E5%88%AB"><span class="toc-number">7.6.</span> <span class="toc-text">6 boost评分权重 - 控制文档的优先级别</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-dis-max%E7%9A%84%E7%94%A8%E6%B3%95-best-fields%E7%AD%96%E7%95%A5"><span class="toc-number">7.7.</span> <span class="toc-text">7 dis_max的用法 - best fields策略</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#7-1-dis-max%E7%9A%84%E6%8F%90%E5%87%BA"><span class="toc-number">7.7.1.</span> <span class="toc-text">7.1 dis_max的提出</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-2-%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B"><span class="toc-number">7.7.2.</span> <span class="toc-text">7.2 使用示例</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-exist-query-%E5%AD%98%E5%9C%A8%E6%A3%80%E7%B4%A2-%E5%B7%B2%E8%BF%87%E6%9C%9F"><span class="toc-number">7.8.</span> <span class="toc-text">8 exist query - 存在检索, 已过期</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-%E5%A4%8D%E6%9D%82%E6%A3%80%E7%B4%A2%E7%9A%84%E4%BD%BF%E7%94%A8%E8%8C%83%E4%BE%8B"><span class="toc-number">7.9.</span> <span class="toc-text">9 复杂检索的使用范例</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#9-1-%E5%A4%9A%E6%9D%A1%E4%BB%B6%E8%BF%87%E6%BB%A4-%E5%8C%85%E5%90%AB"><span class="toc-number">7.9.1.</span> <span class="toc-text">9.1 多条件过滤 - 包含</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#9-2-%E5%A4%9A%E6%9D%A1%E4%BB%B6%E6%8B%BC%E6%8E%A5-%E5%8C%85%E5%90%AB-%E8%8C%83%E5%9B%B4-%E6%8E%92%E5%BA%8F"><span class="toc-number">7.9.2.</span> <span class="toc-text">9.2 多条件拼接 - 包含+范围+排序</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#9-3-%E5%AE%9A%E5%88%B6%E6%A3%80%E7%B4%A2%E7%BB%93%E6%9E%9C%E7%9A%84%E6%8E%92%E5%BA%8F%E8%A7%84%E5%88%99"><span class="toc-number">7.9.3.</span> <span class="toc-text">9.3 定制检索结果的排序规则</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%81%9A%E5%90%88%E6%9F%A5%E8%AF%A2"><span class="toc-number">8.</span> <span class="toc-text">聚合查询</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E6%99%AE%E9%80%9A%E8%81%9A%E5%90%88%E5%88%86%E6%9E%90"><span class="toc-number">8.1.</span> <span class="toc-text">1 普通聚合分析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-%E7%9B%B4%E6%8E%A5%E8%81%9A%E5%90%88%E7%BB%9F%E8%AE%A1"><span class="toc-number">8.1.1.</span> <span class="toc-text">1.1 直接聚合统计</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-%E5%85%88%E6%A3%80%E7%B4%A2-%E5%86%8D%E8%81%9A%E5%90%88"><span class="toc-number">8.1.2.</span> <span class="toc-text">1.2 先检索, 再聚合</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3-%E6%89%A9%E5%B1%95-fielddata%E5%92%8Ckeyword%E7%9A%84%E8%81%9A%E5%90%88%E6%AF%94%E8%BE%83"><span class="toc-number">8.1.3.</span> <span class="toc-text">1.3 扩展: fielddata和keyword的聚合比较</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%B5%8C%E5%A5%97%E8%81%9A%E5%90%88"><span class="toc-number">8.2.</span> <span class="toc-text">2 嵌套聚合</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-%E5%85%88%E5%88%86%E7%BB%84-%E5%86%8D%E8%81%9A%E5%90%88%E7%BB%9F%E8%AE%A1"><span class="toc-number">8.2.1.</span> <span class="toc-text">2.1 先分组, 再聚合统计</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-%E5%85%88%E5%88%86%E7%BB%84-%E5%86%8D%E7%BB%9F%E8%AE%A1-%E6%9C%80%E5%90%8E%E6%8E%92%E5%BA%8F"><span class="toc-number">8.2.2.</span> <span class="toc-text">2.2 先分组, 再统计, 最后排序</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-%E5%85%88%E5%88%86%E7%BB%84-%E7%BB%84%E5%86%85%E5%86%8D%E5%88%86%E7%BB%84-%E7%84%B6%E5%90%8E%E7%BB%9F%E8%AE%A1%E3%80%81%E6%8E%92%E5%BA%8F"><span class="toc-number">8.2.3.</span> <span class="toc-text">2.3 先分组, 组内再分组, 然后统计、排序</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA%E5%BB%BA%E8%AE%AE"><span class="toc-number">9.</span> <span class="toc-text">集群搭建建议</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%9A%84%E5%86%85%E5%AD%98"><span class="toc-number">9.1.</span> <span class="toc-text">1 服务器的内存</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%9A%84CPU"><span class="toc-number">9.2.</span> <span class="toc-text">2 服务器的CPU</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%9A%84%E7%A3%81%E7%9B%98"><span class="toc-number">9.3.</span> <span class="toc-text">3 服务器的磁盘</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E9%9B%86%E7%BE%A4%E7%9A%84%E7%BD%91%E7%BB%9C"><span class="toc-number">9.4.</span> <span class="toc-text">4 集群的网络</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E9%9B%86%E7%BE%A4%E7%9A%84%E8%8A%82%E7%82%B9%E4%B8%AA%E6%95%B0"><span class="toc-number">9.5.</span> <span class="toc-text">5 集群的节点个数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-JVM%E7%9A%84%E5%8F%82%E6%95%B0%E8%AE%BE%E7%BD%AE"><span class="toc-number">9.6.</span> <span class="toc-text">6 JVM的参数设置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-%E9%9B%86%E7%BE%A4%E7%9A%84%E6%95%B0%E6%8D%AE%E9%87%8F"><span class="toc-number">9.7.</span> <span class="toc-text">7 集群的数据量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-%E6%80%BB%E7%BB%93"><span class="toc-number">9.8.</span> <span class="toc-text">8 总结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ES%E7%9A%84%E6%95%B0%E6%8D%AE%E5%BB%BA%E6%A8%A1"><span class="toc-number">10.</span> <span class="toc-text">ES的数据建模</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E4%BB%80%E4%B9%88%E6%98%AF%E6%95%B0%E6%8D%AE%E5%BB%BA%E6%A8%A1"><span class="toc-number">10.1.</span> <span class="toc-text">1 什么是数据建模?</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%A6%82%E4%BD%95%E5%AF%B9-ES-%E4%B8%AD%E7%9A%84%E6%95%B0%E6%8D%AE%E8%BF%9B%E8%A1%8C%E5%BB%BA%E6%A8%A1"><span class="toc-number">10.2.</span> <span class="toc-text">2 如何对 ES 中的数据进行建模</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-%E5%AD%97%E6%AE%B5%E7%B1%BB%E5%9E%8B%E7%9A%84%E5%BB%BA%E6%A8%A1%E6%96%B9%E6%A1%88"><span class="toc-number">10.2.1.</span> <span class="toc-text">2.1 字段类型的建模方案</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-%E6%A3%80%E7%B4%A2%E3%80%81%E8%81%9A%E5%90%88%E5%8F%8A%E6%8E%92%E5%BA%8F%E7%9A%84%E5%BB%BA%E6%A8%A1%E6%96%B9%E6%A1%88"><span class="toc-number">10.2.2.</span> <span class="toc-text">2.2 检索、聚合及排序的建模方案</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-%E9%A2%9D%E5%A4%96%E5%AD%98%E5%82%A8%E7%9A%84%E5%BB%BA%E6%A8%A1%E6%96%B9%E6%A1%88"><span class="toc-number">10.2.3.</span> <span class="toc-text">2.3 额外存储的建模方案</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-ES-%E6%95%B0%E6%8D%AE%E5%BB%BA%E6%A8%A1%E5%AE%9E%E4%BE%8B%E6%BC%94%E7%A4%BA"><span class="toc-number">10.3.</span> <span class="toc-text">3 ES 数据建模实例演示</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-%E5%8A%A8%E6%80%81%E5%88%9B%E5%BB%BA%E6%98%A0%E5%B0%84%E5%85%B3%E7%B3%BB"><span class="toc-number">10.3.1.</span> <span class="toc-text">3.1 动态创建映射关系</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-%E6%89%8B%E5%8A%A8%E5%88%9B%E5%BB%BA%E6%98%A0%E5%B0%84%E5%85%B3%E7%B3%BB"><span class="toc-number">10.3.2.</span> <span class="toc-text">3.2 手动创建映射关系</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-%E6%96%B0%E5%A2%9E%E9%9C%80%E6%B1%82-%E6%B7%BB%E5%8A%A0%E5%A4%A7%E5%AD%97%E6%AE%B5"><span class="toc-number">10.3.3.</span> <span class="toc-text">3.3 新增需求 - 添加大字段</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-4-%E8%A7%A3%E5%86%B3%E5%A4%A7%E5%AD%97%E6%AE%B5%E5%B8%A6%E6%9D%A5%E7%9A%84%E6%80%A7%E8%83%BD%E9%97%AE%E9%A2%98"><span class="toc-number">10.3.4.</span> <span class="toc-text">3.4 解决大字段带来的性能问题</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-5-mapping%E4%B8%AD%E5%AD%97%E6%AE%B5%E7%9A%84%E5%B8%B8%E7%94%A8%E5%8F%82%E6%95%B0"><span class="toc-number">10.3.5.</span> <span class="toc-text">3.5 mapping中字段的常用参数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-6-mapping-%E8%AE%BE%E7%BD%AE%E5%B0%8F%E7%BB%93"><span class="toc-number">10.3.6.</span> <span class="toc-text">3.6 mapping 设置小结</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-ES-%E6%95%B0%E6%8D%AE%E5%BB%BA%E6%A8%A1%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="toc-number">10.4.</span> <span class="toc-text">4 ES 数据建模最佳实践</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-%E5%A6%82%E4%BD%95%E5%A4%84%E7%90%86%E5%85%B3%E8%81%94%E5%85%B3%E7%B3%BB"><span class="toc-number">10.4.1.</span> <span class="toc-text">4.1 如何处理关联关系</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-%E9%81%BF%E5%85%8D%E5%A4%AA%E5%A4%9A%E7%9A%84%E5%AD%97%E6%AE%B5"><span class="toc-number">10.4.2.</span> <span class="toc-text">4.2 避免太多的字段</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-3-%E9%81%BF%E5%85%8D%E6%AD%A3%E5%88%99%E6%9F%A5%E8%AF%A2"><span class="toc-number">10.4.3.</span> <span class="toc-text">4.3 避免正则查询</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-4-%E9%81%BF%E5%85%8D%E7%A9%BA%E5%80%BC%E5%BC%95%E8%B5%B7%E7%9A%84%E8%81%9A%E5%90%88%E4%B8%8D%E5%87%86"><span class="toc-number">10.4.4.</span> <span class="toc-text">4.4 避免空值引起的聚合不准</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B%E3%80%81%E5%AE%9E%E4%BE%8B"><span class="toc-number">11.</span> <span class="toc-text">案例、实例</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2023/08/15/vue3-quick/" title="vue3快速上手（尚硅谷b站）"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/08/15/vue3-quick/logo.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="vue3快速上手（尚硅谷b站）"/></a><div class="content"><a class="title" href="/2023/08/15/vue3-quick/" title="vue3快速上手（尚硅谷b站）">vue3快速上手（尚硅谷b站）</a><time datetime="2023-08-14T16:00:00.000Z" title="发表于 2023-08-15 00:00:00">2023-08-15</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/08/06/redis-basic/" title="redis 基础"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/08/06/redis-basic/logo.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="redis 基础"/></a><div class="content"><a class="title" href="/2023/08/06/redis-basic/" title="redis 基础">redis 基础</a><time datetime="2023-08-05T16:00:00.000Z" title="发表于 2023-08-06 00:00:00">2023-08-06</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/08/05/transactions-mysql/" title="mysql事务原理"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/08/05/transactions-mysql/logo.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="mysql事务原理"/></a><div class="content"><a class="title" href="/2023/08/05/transactions-mysql/" title="mysql事务原理">mysql事务原理</a><time datetime="2023-08-04T16:00:00.000Z" title="发表于 2023-08-05 00:00:00">2023-08-05</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/08/05/transactions-basic/" title="事务详解"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/08/05/transactions-basic/logo.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="事务详解"/></a><div class="content"><a class="title" href="/2023/08/05/transactions-basic/" title="事务详解">事务详解</a><time datetime="2023-08-04T16:00:00.000Z" title="发表于 2023-08-05 00:00:00">2023-08-05</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/06/23/java-memory-optimize/" title="JVM内存调优"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/06/23/java-memory-optimize/logo.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="JVM内存调优"/></a><div class="content"><a class="title" href="/2023/06/23/java-memory-optimize/" title="JVM内存调优">JVM内存调优</a><time datetime="2023-06-22T16:00:00.000Z" title="发表于 2023-06-23 00:00:00">2023-06-23</time></div></div></div></div></div></div></main><footer id="footer" style="background: none"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2025 By Calico</div><div class="footer_custom_text"><a href="icp"><span>Create By hexo,butterfly</span></a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=4.13.0"></script><script src="/js/main.js?v=4.13.0"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload@17.8.8/dist/lazyload.iife.min.js"></script><div class="js-pjax"><script>(() => {
  const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
  if ($mermaid.length === 0) return
  const runMermaid = () => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    Array.from($mermaid).forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const mermaidThemeConfig = '%%{init:{ \'theme\':\'' + theme + '\'}}%%\n'
      const mermaidID = 'mermaid-' + index
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)

      const renderV10 = () => {
        renderFn.then(({svg}) => {
          mermaidSrc.insertAdjacentHTML('afterend', svg)
        })
      }

      const renderV9 = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      typeof renderFn === 'string' ? renderV9(renderFn) : renderV10()
    })
  }

  const loadMermaid = () => {
    window.loadMermaid ? runMermaid() : getScript('https://cdn.jsdelivr.net/npm/mermaid@10.8.0/dist/mermaid.min.js').then(runMermaid)
  }

  btf.addGlobalFn('themeChange', runMermaid, 'mermaid')

  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script><script>(()=>{
  const loadLivere = () => {
    if (typeof LivereTower === 'object') window.LivereTower.init()
    else {
      (function(d, s) {
          var j, e = d.getElementsByTagName(s)[0];
          if (typeof LivereTower === 'function') { return; }
          j = d.createElement(s);
          j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
          j.async = true;
          e.parentNode.insertBefore(j, e);
      })(document, 'script');
    }
  }

  if ('Livere' === 'Livere' || !false) {
    if (false) btf.loadComment(document.getElementById('lv-container'), loadLivere)
    else loadLivere()
  } else {
    window.loadOtherComment = loadLivere
  }
})()</script></div><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="false" data-click="true"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>