<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>消息队列-ActiveMQ | Calico's Space</title><meta name="author" content="Calico"><meta name="copyright" content="Calico"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="消息队列和其作用消息队列是一种业务处理方案，目的是减轻同步业务的压力，缓解突发流量和提高系统可利用率的一种常见处理方式。消息队列中间件是该方案的具体实现和具体产品。 作用： （解耦、消峰、异步）  抵御洪峰流量，（吞吐量）达到保护主业务的目的，消息都给中间件（消峰） 消息给中间件后，等通知，不用一直等着（异步） 消息给了中间件，与消息多少没关系，也就是新模块进来，代码改动最小（解耦  目前比较常见">
<meta property="og:type" content="article">
<meta property="og:title" content="消息队列-ActiveMQ">
<meta property="og:url" content="http://xeons.cn/2023/05/03/mq-basic/index.html">
<meta property="og:site_name" content="Calico&#39;s Space">
<meta property="og:description" content="消息队列和其作用消息队列是一种业务处理方案，目的是减轻同步业务的压力，缓解突发流量和提高系统可利用率的一种常见处理方式。消息队列中间件是该方案的具体实现和具体产品。 作用： （解耦、消峰、异步）  抵御洪峰流量，（吞吐量）达到保护主业务的目的，消息都给中间件（消峰） 消息给中间件后，等通知，不用一直等着（异步） 消息给了中间件，与消息多少没关系，也就是新模块进来，代码改动最小（解耦  目前比较常见">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://xeons.cn/2023/05/03/mq-basic/mq.jpg">
<meta property="article:published_time" content="2023-05-02T16:00:00.000Z">
<meta property="article:author" content="Calico">
<meta property="article:tag" content="java">
<meta property="article:tag" content="mq">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://xeons.cn/2023/05/03/mq-basic/mq.jpg"><link rel="shortcut icon" href="/images/calico-ss.png"><link rel="canonical" href="http://xeons.cn/2023/05/03/mq-basic/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//hm.baidu.com"/><meta/><link rel="stylesheet" href="/css/index.css?v=4.13.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?6f97e3791752fae830e3db5ba194c6cb";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.11.1/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '消息队列-ActiveMQ',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-03-12 21:47:48'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.1.1"><link rel="alternate" href="/atom.xml" title="Calico's Space" type="application/atom+xml">
</head><body><script>window.paceOptions = {
  restartOnPushState: false
}

document.addEventListener('pjax:send', () => {
  Pace.restart()
})
</script><link rel="stylesheet" href="/css/loading_bar.css"/><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images/calico.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">33</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">23</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">22</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list hide"></i><span> 其他</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/demopage/"><i class="fa-fw fas fa-music"></i><span> Theme测试页</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="not-top-img" id="page-header"><nav id="nav"><span id="blog-info"><a href="/" title="Calico's Space"><span class="site-name">Calico's Space</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list hide"></i><span> 其他</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/demopage/"><i class="fa-fw fas fa-music"></i><span> Theme测试页</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav></header><main class="layout" id="content-inner"><div id="post"><div id="post-info"><h1 class="post-title">消息队列-ActiveMQ</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="fa-fw post-meta-icon far fa-calendar-alt"></i><span class="post-meta-label">发表于</span><time datetime="2023-05-02T16:00:00.000Z" title="发表于 2023-05-03 00:00:00">2023-05-03</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%8A%80%E6%9C%AF/">技术</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%8A%80%E6%9C%AF/java/">java</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%8A%80%E6%9C%AF/java/mq/">mq</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%8A%80%E6%9C%AF/java/mq/activemq/">activemq</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">11.7k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>43分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="消息队列-ActiveMQ"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div><article class="post-content" id="article-container"><h2 id="消息队列和其作用"><a href="#消息队列和其作用" class="headerlink" title="消息队列和其作用"></a>消息队列和其作用</h2><p>消息队列是一种业务处理方案，目的是减轻同步业务的压力，缓解突发流量和提高系统可利用率的一种常见处理方式。消息队列中间件是该方案的具体实现和具体产品。</p>
<p>作用： <strong>（解耦、消峰、异步）</strong></p>
<ul>
<li>抵御洪峰流量，（吞吐量）达到保护主业务的目的，消息都给中间件（消峰）</li>
<li>消息给中间件后，等通知，不用一直等着（异步）</li>
<li>消息给了中间件，与消息多少没关系，也就是新模块进来，代码改动最小（解耦</li>
</ul>
<p><strong>目前比较常见和可靠的MQ的产品具体有</strong>：kafka、RabbitMQ、RocketMQ、ActiveMQ</p>
<p>基于产品要求的特点，上面的产品必须要解决以下问题：</p>
<table>
<thead>
<tr>
<th align="left">技术维度</th>
<th align="left">专业名词</th>
</tr>
</thead>
<tbody><tr>
<td align="left">消息中间件</td>
<td align="left">有api发送和接收</td>
</tr>
<tr>
<td align="left">不能宕机</td>
<td align="left">高可用性</td>
</tr>
<tr>
<td align="left">需要多而不是单机版</td>
<td align="left">集群和容错配置</td>
</tr>
<tr>
<td align="left">不能断不能丢</td>
<td align="left">持久化</td>
</tr>
<tr>
<td align="left">取消撤回</td>
<td align="left">延时发送&#x2F;定时投递</td>
</tr>
<tr>
<td align="left">有无收到</td>
<td align="left">签收机制</td>
</tr>
</tbody></table>
<p>如果没有引入MQ，生产者和消费者互相调用，在大型分布式应用中，系统间的RPC交互繁杂，即每增加一个消费者，生产者都要修改（系统之间的接口耦合比较严重）；等待同步消息性存在问题（RPC接口基本上是同步调用，类似“木桶理论”）；面对消息多容易冲垮</p>
<ul>
<li>Kafka：最初由Linkedin公司开发，是一个分布式、分区的、多副本的、多订阅者，基于zookeeper协调的分布式日志系统（也可以当做MQ系统），常见可以用于web&#x2F;nginx日志、访问日志，消息服务等等，Linkedin于2010年贡献给了Apache基金会并成为顶级开源项目。</li>
<li>RabbitMQ：实现了高级消息队列协议（AMQP）的开源消息代理软件（亦称面向消息的中间件）。RabbitMQ服务器是用Erlang语言编写的，而集群和故障转移是构建在开放电信平台框架上的。所有主要的编程语言均有与代理接口通讯的客户端库。</li>
<li>RocketMQ：RocketMQ是一款分布式消息中间件，最初是由阿里巴巴消息中间件团队研发并大规模应用于生产系统，满足线上海量消息堆积的需求， 在2016年底捐赠给Apache开源基金会成为孵化项目，经过不到一年时间正式成为了Apache顶级项目；早期阿里曾经基于ActiveMQ研发消息系统， 随着业务消息的规模增大，瓶颈逐渐显现，后来也考虑过Kafka，但因为在低延迟和高可靠性方面没有选择，最后才自主研发了RocketMQ， 各方面的性能都比目前已有的消息队列要好，RocketMQ和Kafka在概念和原理上都非常相似，所以也经常被拿来对比；RocketMQ默认采用长轮询的拉模式， 单机支持千万级别的消息堆积，可以非常好的应用在海量消息系统中。</li>
<li>ActiveMQ：Apache ActiveMQ是Apache软件基金会所研发的开放源代码消息中间件；由于ActiveMQ是一个纯Java程序，因此只需要操作系统支持Java虚拟机，ActiveMQ便可执行。</li>
</ul>
<p>下面分别介绍几款mq产品，分别描述各自的优缺点和涉及简单原理、以及springboot的简单集成；</p>
<h2 id="ActiveMQ"><a href="#ActiveMQ" class="headerlink" title="ActiveMQ"></a>ActiveMQ</h2><p>Apache ActiveMQ是Apache软件基金会的一个开源项目，是一个基于消息的通信中间件。ActiveMQ是JMS的一个具体实现，支持JMS的两种消息模型。ActiveMQ使用AMQP协议集成多平台应用，使用STOMP协议通过websockets在Web应用程序之间交换消息，使用MQTT协议管理物联网设备。（参考ActiveMQ官网）</p>
<h3 id="概念理解"><a href="#概念理解" class="headerlink" title="概念理解"></a>概念理解</h3><p><strong>涉及的几个概念：</strong></p>
<p>点到点、发布&#x2F;订阅</p>
<p><strong>点对点消息传递域的特点如下：</strong></p>
<p>1、每个消息只能有一个消费者。不是每一个队列只能有一个消费者<br>2、消息的生产者和消费者之间没有时间上的相关性。无论消费者在生产者发送消息的时候是否处于运行状态，它都可以提取消息。类似于发短信。</p>
<p><strong>发布&#x2F;订阅消息传递域的特点如下：</strong></p>
<p>1、每个消息可以有多个消费者，可以想象成关注微博中的一个话题。的确和微博比较像，哈哈<br>2、生产者和消费者之间有时间上的相关性。订阅一个主题的消费者只能消费自它订阅之后发布的消息，订阅之前的消息是收不到的。JMS规范允许客户创建持久订阅，这在一定程度上放松了时间上的相关性要求。持久订阅允许消费者消费它在未处于激活状态时发送的消息。</p>
<p><strong>Broker</strong> </p>
<p>一个java实现的mq实例应用； 队列和订阅都是发布到broker上的。 B和C也是与此通信实现mq的所有作用；</p>
<p>Quene </p>
<p>队列，表面消息要投递到的地方。 是一个虚拟的概念，用于消息的分裂投递；</p>
<p>ACK</p>
<p>应答，消息的可靠性保证，一般需要回复broker消息被消费的 确定性；</p>
<h3 id="集成和代码实现"><a href="#集成和代码实现" class="headerlink" title="集成和代码实现"></a>集成和代码实现</h3><h4 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h4><ul>
<li>启动的ActiveMQ服务</li>
<li>JDK1.8+</li>
<li>IDEA或Eclipse</li>
<li>Maven环境</li>
<li>SpringBoot和ActiveMQ整合的依赖</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--activemq启动器--&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-starter-activemq&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;!--boot启动器--&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-starter&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;<span class="number">2.2</span><span class="number">.1</span>.RELEASE&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;!--测试启动器--&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;</span><br><span class="line">    &lt;scope&gt;test&lt;/scope&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;junit&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;junit&lt;/artifactId&gt;</span><br><span class="line">    &lt;scope&gt;test&lt;/scope&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<h4 id="环境启动配置和代码"><a href="#环境启动配置和代码" class="headerlink" title="环境启动配置和代码"></a>环境启动配置和代码</h4><ul>
<li>application.yml配置：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">server:</span><br><span class="line">  port: <span class="number">7777</span></span><br><span class="line">spring:</span><br><span class="line">  activemq:</span><br><span class="line">   你的activemq连接地址</span><br><span class="line">    broker-url: tcp:<span class="comment">//192.168.64.129:61616</span></span><br><span class="line">   账号</span><br><span class="line">    user: admin</span><br><span class="line">   密码</span><br><span class="line">    password: admin</span><br><span class="line">  jms:</span><br><span class="line">   指定连接的是队列(Queue)还是主题(Topic)，<span class="literal">false</span>代表队列,<span class="literal">true</span>代表主题</span><br><span class="line">    pub-sub-domain: <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">queue:</span><br><span class="line">  name: boot-queue-test</span><br><span class="line">  </span><br><span class="line">topic:</span><br><span class="line">  name: boot-topic-test</span><br></pre></td></tr></table></figure>

<p>ActiveMQ配置类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.huazai.activemq.springboot.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.activemq.command.ActiveMQQueue;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.jms.Queue;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> DDKK.COM 弟弟快看，程序员编程资料站</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/1/16 19:13</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ActiveConfig</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;queue.name&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String queueName;</span><br><span class="line">    </span><br><span class="line">	<span class="meta">@Value(&quot;$&#123;topic.name&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String topicName;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">activeQueue</span><span class="params">()</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ActiveMQQueue</span>(queueName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Topic <span class="title function_">activeTopic</span><span class="params">()</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ActiveMQTopic</span>(topicName);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>启动类：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.huazai.activemq.springboot;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.jms.annotation.EnableJms;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> DDKK.COM 弟弟快看，程序员编程资料站</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/1/16 18:51</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="comment">// 开启JMS服务</span></span><br><span class="line"><span class="meta">@EnableJms</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BootQueueProviderMain</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">        SpringApplication.run(BootQueueProviderMain.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="队列生产者代码"><a href="#队列生产者代码" class="headerlink" title="队列生产者代码"></a>队列生产者代码</h4><ul>
<li>消息生产者服务：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.huazai.activemq.springboot.queue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.jms.annotation.JmsListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.jms.core.JmsMessagingTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.jms.core.JmsTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.jms.JMSException;</span><br><span class="line"><span class="keyword">import</span> javax.jms.Queue;</span><br><span class="line"><span class="keyword">import</span> java.util.UUID;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">QueueProviderService</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 相当于 &#123;<span class="doctag">@link</span> JmsTemplate&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JmsMessagingTemplate jmsMessagingTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> Queue queue;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 生产消息</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> JMSException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@JmsListener(destination = &quot;$&#123;queue.name&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">productMessage</span><span class="params">()</span> <span class="keyword">throws</span> JMSException &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">        <span class="comment">// 生产者生产并发送消息，此方法是send方法的加强版</span></span><br><span class="line">        jmsMessagingTemplate.convertAndSend(queue, <span class="string">&quot;消费者发送消息：&quot;</span> + UUID.randomUUID());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>队列消息发送测试类：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.huazai.activemq.springboot.BootQueueProviderMain;</span><br><span class="line"><span class="keyword">import</span> com.huazai.activemq.springboot.queue.QueueProviderService;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">import</span> org.junit.runner.RunWith;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.context.junit4.SpringJUnit4ClassRunner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.jms.JMSException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> DDKK.COM 弟弟快看，程序员编程资料站</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/1/16 19:25</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SpringBootTest(classes = BootQueueProviderMain.class)</span></span><br><span class="line"><span class="meta">@RunWith(SpringJUnit4ClassRunner.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">QueueProviderTest</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> QueueProviderService queueProviderService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSend</span><span class="params">()</span> <span class="keyword">throws</span> JMSException &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">        queueProviderService.productMessage();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>启动测试类，将消息发送到名称为<code>boot-queue-test</code>队列，结果如下：<br> <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/05/03/mq-basic/1697185733704.png" class=""></p>
<p>队列消费者代码</p>
<ul>
<li>消息监听消费服务：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.huazai.activemq.springboot.queue;</span><br><span class="line"><span class="keyword">import</span> org.springframework.jms.annotation.JmsListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.jms.JMSException;</span><br><span class="line"><span class="keyword">import</span> javax.jms.TextMessage;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">QueueConsumerService</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 监听接收的方法，监听的目的地名称为$&#123;queue.name&#125;配置</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@JmsListener(destination = &quot;$&#123;queue.name&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">receive</span><span class="params">(TextMessage textMessage)</span> <span class="keyword">throws</span> JMSException &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">        <span class="type">String</span> <span class="variable">text</span> <span class="operator">=</span> textMessage.getText();</span><br><span class="line">        System.out.println(<span class="string">&quot;***消费者收到的消息:    &quot;</span> + text);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>启动消费者服务，接受到了之前生产者生产的消息，测试结果如下：<br> <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/05/03/mq-basic/1697185733995.png" class=""></p>
<h4 id="主题代码"><a href="#主题代码" class="headerlink" title="主题代码"></a>主题代码</h4><ul>
<li>主题订阅者服务</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.huazai.activemq.springboot.topic;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.jms.core.JmsMessagingTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.scheduling.annotation.Scheduled;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.jms.Topic;</span><br><span class="line"><span class="keyword">import</span> java.util.UUID;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> DDKK.COM 弟弟快看，程序员编程资料站</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/1/17 15:14</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TopicProviderService</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JmsMessagingTemplate jmsMessagingTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> Topic topic;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 每隔3秒定时发布主题消息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Scheduled(fixedDelay = 3000)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">productTopic</span><span class="params">()</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">        jmsMessagingTemplate.convertAndSend(topic, <span class="string">&quot;发布者发布主题消息：&quot;</span> + UUID.randomUUID());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>主题发布者服务</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.huazai.activemq.springboot.topic;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.jms.annotation.JmsListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.jms.JMSException;</span><br><span class="line"><span class="keyword">import</span> javax.jms.TextMessage;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> DDKK.COM 弟弟快看，程序员编程资料站</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/1/17 15:15</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TopicConsumerService</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 开启监听器监听主题消息</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> textMessage</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> JMSException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@JmsListener(destination = &quot;$&#123;topic.name&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">receive</span><span class="params">(TextMessage textMessage)</span> <span class="keyword">throws</span> JMSException &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">        <span class="type">String</span> <span class="variable">text</span> <span class="operator">=</span> textMessage.getText();</span><br><span class="line">        System.out.println(<span class="string">&quot;订阅者订阅到的消息：&quot;</span> + text);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>先启动主题订阅者，再启动主题发布者，主题订阅者会间隔3秒接收到主题发布者的消息，结果如下：</p>
 <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/05/03/mq-basic/1697185735911.png" class="">





<h3 id="高可用"><a href="#高可用" class="headerlink" title="高可用"></a>高可用</h3><h4 id="持久化方案"><a href="#持久化方案" class="headerlink" title="持久化方案"></a>持久化方案</h4><p>为了避免服务器意外宕机后导致消息队列数据丢失，需要引入持久化机制保证服务器重启后恢复消息队列数据使ActiveMQ达到高可用性。</p>
<p>ActiveMQ的消息持久化机制有JDBC，AMQ，KahaDB和LevelDB，无论使用哪种持久化方式，消息的存储逻辑都是一致的。</p>
<p>就是在发送者将消息发送出去后，消息中心首先将消息存储到本地数据文件、内存数据库或者远程数据库等。再试图将消息发给接收者，成功则将消息从存储中删除，失败则继续尝试尝试发送。</p>
<p>消息中心启动以后，要先检查指定的存储位置是否有未成功发送的消息，如果有，则会先把存储位置中的消息发出去。</p>
<p>持久化方式</p>
<ul>
<li>AMQ（了解）<br>AMQ 消息存储是一种基于文件存储形式，它具有写入速度快和容易恢复的特点。消息存储在一个个文件中文件的默认大小为32M，当一个文件中的消息已经全部被消费，那么这个文件将被标识为可删除，在下一个清除阶段，这个文件被删除。AMQ适用于ActiveMQ5.3之前的版本</li>
<li>KahaDB（重点）</li>
<li>KahaDB消息存储是基于日志文件的存储方式，它是5.4版本之后默认存储方式。</li>
</ul>
<p>在ActiveMQ安装目录的<code>conf/activemq.xml</code>文件配置了ActiveMQ的默认持久化方式。</p>
 <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/05/03/mq-basic/1697185742451.png" class="">

<p>其中，directory属性值配置了KahaDB持久化方式日志所在目录，即<code>data/kahadb</code>。官方参考地址：<a target="_blank" rel="noopener" href="http://activemq.apache.org/kahadb">http://activemq.apache.org/kahadb</a></p>
 <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/05/03/mq-basic/1697185743345.png" class="">

<ul>
<li>KahaDB可用于任何场景，提高了性能和恢复能力。消息存储使用一个<code>事务日志</code>和仅仅用一个<code>索引文件</code>来存储它所有的地址。<br><code>事务日志用于保存持久化数据，相当于新华字典内容；索引文件作为索引指向事务日志，相当于新华字典目录。</code></li>
<li>KahaDB是一个专门针对消息持久化的解决方案，它对典型的消息使用模型进行了优化。</li>
</ul>
<p>数据被追加到data logs中。当不再需要log文件中的数据的时候，log文件会被丢弃。</p>
<ul>
<li>db-number.log（事务日志）<br>KahaDB存储消息到预定大小的数据纪录文件中，文件名为db-number.log。当数据文件已满时，一个新的文件会随之创建，number数值也会随之递增，它随着消息数量的增多，如每32M一个文件，文件名按照数字进行编号，如db-1.log，db-2.log······。当不再有引用到数据文件中的任何消息时，文件会被删除或者归档。</li>
<li>db.data（索引文件）<br>该文件包含了持久化的BTree索引，索引了消息数据记录中的消息，它是消息的索引文件，本质上是B-Tree（B树），使用B-Tree作为索引指向db-number.log里面存储消息。</li>
<li>db.free<br>记录当前db.data文件里面哪些页面是空闲的，文件具体内容是所有空闲页的ID，方便下次记录数据时，从空闲的页面开始建立索引，保证索引的连续型且没有碎片。</li>
<li>db.redo<br>用来进行消息恢复，如果KahaDB消息存储再强制退出后启动，用于恢复BTree索引。</li>
<li>lock<br>文件锁，表示当前kahadb独写权限的broker。</li>
<li>LevelDB（了解）<br>LevelDB文件系统是从ActiveMQ5.8之后引进的，它和KahaDB很相似，也是基于文件的本地数据库存储形式，但是它提供比KahaDB更快的持久性，但它不再使用自定义B-Tree实现来索引预写日志，而是使用基于LevelDB的索引。相对于KahaDB它具有如下更好的优点：</li>
<li>快速更新（无需进行随机磁盘更新）</li>
<li>并发读取</li>
<li>使用硬链接快速索引快照</li>
</ul>
<p>为什么LevelDB比KahaDB有着更好的性能，为什么现在使用KahaDB使用广泛呢？按照官网的说法是：LevelDB存储已被弃用，不再支持或推荐使用，Replicated LevelDB（可复制的LevelDB）有望取代LevelDB。推荐的存储方式是KahaDB。参考官网地址：<a target="_blank" rel="noopener" href="http://activemq.apache.org/leveldb-store">http://activemq.apache.org/leveldb-store</a></p>
<p>如何配置LevelDB?在ActiveMQ安装目录的<code>conf/activemq.xml</code>找到<code>persistenceAdapter</code>地方将原来默认的kahaDB进行如下修改：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;persistenceAdapter&gt;</span><br><span class="line">		&lt;!--&lt;kahaDB directory=<span class="string">&quot;$&#123;activemq.data&#125;/kahadb&quot;</span>/&gt; --&gt;</span><br><span class="line">       &lt;levelDB directory=<span class="string">&quot;$&#123;activemq.data&#125;/leveldb&quot;</span>/&gt;</span><br><span class="line">&lt;/persistenceAdapter&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>JDBC（重点）<br>JDBC持久化方式顾名思义就是将数据持久化到数据库中（如mysql），实现步骤如下：</li>
</ul>
<p><strong>1、</strong> 添加mysql驱动到ActiveMQ安装目录的<code>lib</code>文件夹中；<br> <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/05/03/mq-basic/1697185743983.png" class=""> <strong>2、</strong> 配置ActiveMQ.xml；<br>在ActiveMQ安装目录的<code>conf/activemq.xml</code>中找到<code>persistenceAdapter</code>标签替换有以下内容：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;persistenceAdapter&gt;</span><br><span class="line">    &lt;!--&lt;kahaDB directory=<span class="string">&quot;$&#123;activemq.data&#125;/kahadb&quot;</span>/&gt; --&gt;</span><br><span class="line">    &lt;jdbcPersistenceAdapter dataSource=<span class="string">&quot;#mysql-ds&quot;</span> createTablesOnStartup=<span class="string">&quot;true&quot;</span> /&gt;</span><br><span class="line">&lt;/persistenceAdapter&gt;</span><br><span class="line">dataSource属性值指定将要引用的持久化数据库的bean名称（后面会配置一个名为mysql-ds的bean）；createTablesOnStartup属性值是否在启动的时候创建数据库表，默认是<span class="literal">true</span>，这样每次启动都会去创建表了，一般是第一次启动的时候设置为<span class="literal">true</span>，然后再去改成<span class="literal">false</span>。</span><br></pre></td></tr></table></figure>

<p><strong>1、</strong> 数据库连接池配置；<br>配置连接池之前先在数据库中建立一个数据库，比如我建立数据库名称为：activemq_test</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;bean id=<span class="string">&quot;mysql-ds&quot;</span> class=<span class="string">&quot;org.apache.commons.dbcp2.BasicDataSource&quot;</span> destroy-method=<span class="string">&quot;close&quot;</span>&gt;</span><br><span class="line">    &lt;!-- 数据库驱动名称，此处是mysql驱动名称--&gt;</span><br><span class="line">    &lt;property name=<span class="string">&quot;driverClassName&quot;</span> value=<span class="string">&quot;com.mysql.jdbc.Driver&quot;</span>/&gt;</span><br><span class="line">    &lt;!-- 连接数据库url，ip换成自己数据库所在的机器ip，数据库名为新建立数据库的名称--&gt;</span><br><span class="line">    &lt;property name=<span class="string">&quot;url&quot;</span> value=<span class="string">&quot;jdbc:mysql://your ip:3306/your db&#x27;s name?relaxAutoCommit=true&amp;serverTimezone=GMT&quot;</span>/&gt;</span><br><span class="line">    &lt;!-- 连接数据库用户名--&gt;</span><br><span class="line">    &lt;property name=<span class="string">&quot;username&quot;</span> value=<span class="string">&quot;your username&quot;</span>/&gt;</span><br><span class="line">    &lt;!-- 连接数据库密码--&gt;</span><br><span class="line">    &lt;property name=<span class="string">&quot;password&quot;</span> value=<span class="string">&quot;your password&quot;</span>/&gt;</span><br><span class="line">    &lt;property name=<span class="string">&quot;poolPreparedStatements&quot;</span> value=<span class="string">&quot;true&quot;</span>/&gt;</span><br><span class="line">&lt;/bean&gt;</span><br><span class="line">ActiveMQ默认使用DBCP连接池，并且自带了DBCP连接池相关jar包，如果想要换成C3P0等连接池，需要自行引入相关jar包。其中bean的id属性值一定要和上面的dataSource属性值一样。</span><br></pre></td></tr></table></figure>

<p><strong>1、</strong> 启动ActiveMQ；<br>运行命令<code>./activemq start</code>启动服务，不出意外的话，启动成功后，将会在配置的数据库中生成相应的三张表。<br> <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/05/03/mq-basic/1697185745304.png" class=""><br><code>表创建后记得修改activemq.xml的jdbcPersistenceAdapter标签的createTablesOnStartup属性值改为false。</code></p>
<p>ACTIVEMQ_MSGS：消息表，Queue和Topic都存在里面。</p>
<table>
<thead>
<tr>
<th align="left">列名</th>
<th align="left">类型</th>
<th align="left">字段描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left">ID</td>
<td align="left">bigint(20)</td>
<td align="left">主键</td>
</tr>
<tr>
<td align="left">CONTAINER</td>
<td align="left">varchar(250)</td>
<td align="left">消息的Destination</td>
</tr>
<tr>
<td align="left">MSGID_PROD</td>
<td align="left">varchar(250)</td>
<td align="left">消息发送者的主键</td>
</tr>
<tr>
<td align="left">MSGID_SEQ</td>
<td align="left">bigint(20)</td>
<td align="left">发送消息的顺序，MSGID_PROD+MSG_SEQ可以组成JMS的MessageID</td>
</tr>
<tr>
<td align="left">EXPIRATION</td>
<td align="left">bigint(20)</td>
<td align="left">消息的过期时间，存储的是从1970-01-01到现在的毫秒数，0表示用不过期</td>
</tr>
<tr>
<td align="left">MSG</td>
<td align="left">blob(0)</td>
<td align="left">消息本体的Java序列化对象的二进制数据</td>
</tr>
<tr>
<td align="left">PRIORITY</td>
<td align="left">bigint(20)</td>
<td align="left">优先级，从0-9，数值越大优先级越高，默认0</td>
</tr>
<tr>
<td align="left">XID</td>
<td align="left">varchar(250)</td>
<td align="left">-</td>
</tr>
</tbody></table>
<p>ACTIVEMQ_ACKS：订阅关系表，如果是持久化Topic，订阅者和服务器的订阅关系保存在这个表。</p>
<table>
<thead>
<tr>
<th align="left">列名</th>
<th align="left">类型</th>
<th align="left">字段描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left">CONTAINER</td>
<td align="left">varchar(250)</td>
<td align="left">消息的Destination</td>
</tr>
<tr>
<td align="left">SUB_DEST</td>
<td align="left">varchar(250)</td>
<td align="left">如果使用的是Static集群（静态集群）,将保存集群其他系统的信息</td>
</tr>
<tr>
<td align="left">CLIENT_ID</td>
<td align="left">varchar(250)</td>
<td align="left">每个订阅者都必须有一个唯一的客户端ID用以区分</td>
</tr>
<tr>
<td align="left">SUB_NAME</td>
<td align="left">varchar(250)</td>
<td align="left">订阅者名称</td>
</tr>
<tr>
<td align="left">SELECTOR</td>
<td align="left">varchar(250)</td>
<td align="left">选择器，可以选择只消费满足条件的消息，条件可以自定义属性实现，可支持多属性AND和OR操作</td>
</tr>
<tr>
<td align="left">LAST_ACKED_ID</td>
<td align="left">bigint(20)</td>
<td align="left">记录消费过消息的ID</td>
</tr>
<tr>
<td align="left">PRIORITY</td>
<td align="left">bigint(20)</td>
<td align="left">优先级，从0-9，数值越大优先级越高，默认5</td>
</tr>
<tr>
<td align="left">XID</td>
<td align="left">varchar(250)</td>
<td align="left">-</td>
</tr>
</tbody></table>
<p>ACTIVEMQ_LOCK：在集群环境下才有用，只有一个Broker可以获取消息，称为Master Broker，其他的只能作为备份等待Master Broker不可用，才可能成为下一个Master Broker。这个表用于记录哪个Broker是当前的Master Broker。</p>
<table>
<thead>
<tr>
<th align="left">列名</th>
<th align="left">类型</th>
<th align="left">字段描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left">ID</td>
<td align="left">bigint(20)</td>
<td align="left">主键</td>
</tr>
<tr>
<td align="left">TIME</td>
<td align="left">bigint(20)</td>
<td align="left">timestamp</td>
</tr>
<tr>
<td align="left">BROKER_NAME</td>
<td align="left">varchar(250)</td>
<td align="left">当前的 master broker名称</td>
</tr>
</tbody></table>
<p>(意外启动失败则看这里）ActiveMQ启动日志记录在安装目录的<code>data/activemq.log</code>日志文件中，启动失败的常见原因拒绝连接数据库，因为mysql默认没有开启连接远程连接的权限，比如我启动失败的错误信息如下（启动错误请根据自身情况处理）：<br> <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/05/03/mq-basic/1697185745515.png" class=""><br>解决方案：开启允许远程连接mysql服务，执行脚本如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">use mysql;</span><br><span class="line">select host, user, authentication_string, plugin from user;</span><br><span class="line">update user set host=<span class="string">&#x27;%&#x27;</span> where user=<span class="string">&#x27;root&#x27;</span>;</span><br><span class="line">flush privileges;</span><br><span class="line">此方式是开放所有IP的root访问权限，如果是正式环境还是建议用 开放指定IP的方式。</span><br></pre></td></tr></table></figure>

<p><strong>1、</strong> java代码连接测试queue；<br>代码参考：<a target="_blank" rel="noopener" href="http://ddkk.com/zhuanlan/mq/activemq/2/4.html">4.Java编码实现ActiveMQ通讯（Queue）</a><br>先启动队列生产者，由于ActiveMQ默认是开启持久化方式，启动成功后，表ACTIVEMQ_MSGS表数据如下：<br> <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/05/03/mq-basic/1697185746735.png" class=""><br>再启动队列消费者，消息消费成功后，数据表的数据被清空了，结论如下：</p>
<ul>
<li>当DeliveryMode设置为NON_PERSISTENCE时，消息被保存在内存中。</li>
<li>当DeliveryMode设置为PERSISTENCE时，消息保存在broker的相应的文件或者数据库中。</li>
<li>点对点类型中消息一旦被Consumer消费，就从数据中删除。</li>
<li>消费前的队列消息,会被存放到数据库。<br><code>如果开启非持久化方式，则消息不会持久化到数据表。</code> <strong>2、</strong> java代码连接测试topic；<br>代码参考：<a target="_blank" rel="noopener" href="http://ddkk.com/zhuanlan/mq/activemq/2/5.html">5.Java编码实现ActiveMQ通讯（Topic）</a><br>先启动topic订阅者，再启动主题发布者，数据表数据如下：<br><code>一定先启动订阅者，表示该topic存在订阅者，否则发布的topic是不会持久化到数据库中，换句话说不存在订阅者的topic就是废消息，没必要持久化到JDBC中。</code> <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/05/03/mq-basic/1697185747142.png" class="">
结论如下：<br>topic与queue不同，被消费的消息不会在数据表中删除。 <strong>3、</strong> jdbc持久化方式+ActiveMQJournal（日志）；<br>jdbc持久化方式将消息持久化到数据库中虽好，但是JDBC每次消息过来，都需要去写库读库。引入<br>ActiveMQ Journal，使每次消息过来之后在ActiveMQ和JDBC之间加一层高速缓存，使用高速缓存写入技术，大大提高了性能。</li>
</ul>
<p>如：当有消息过来后，消息不会立马持久化到数据库中，而是先保存到缓存中，被消费的消息也是先从缓存中读取，经过了指定的时间之后，才把缓存中的数据持久化到数据库中。如果是queue，则只持久化未被消费的消息。</p>
<p>用法：在activemq.xml文件中，将persistenceFactory替换掉persistenceAdapter内容</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- &lt;persistenceAdapter&gt; --&gt;</span><br><span class="line">&lt;!--&lt;kahaDB directory=<span class="string">&quot;$&#123;activemq.data&#125;/kahadb&quot;</span>/&gt; --&gt;</span><br><span class="line">&lt;!--&lt;jdbcPersistenceAdapter dataSource=<span class="string">&quot;#mysql-ds&quot;</span> createTablesOnStartup=<span class="string">&quot;true&quot;</span> /&gt; --&gt;</span><br><span class="line">&lt;!-- &lt;/persistenceAdapter&gt; --&gt;</span><br><span class="line"></span><br><span class="line">&lt;persistenceFactory&gt;</span><br><span class="line">    &lt;journalPersistenceAdapterFactory</span><br><span class="line">            journalLogFiles=<span class="string">&quot;5&quot;</span></span><br><span class="line">            journalLogFileSize=<span class="string">&quot;32768&quot;</span></span><br><span class="line">            useJournal=<span class="string">&quot;true&quot;</span></span><br><span class="line">            useQuickJournal=<span class="string">&quot;true&quot;</span></span><br><span class="line">            dataSource=<span class="string">&quot;#mysql-ds&quot;</span></span><br><span class="line">            dataDirectory=<span class="string">&quot;../activemq-data&quot;</span> /&gt;</span><br><span class="line">&lt;/persistenceFactory&gt;</span><br></pre></td></tr></table></figure>

<p><code>dataSource属性值指定将要引用的持久化数据库的bean名称，dataDirectory属性指定了Journal相关的日志保存位置。成功启动后则会发现多出一个activemq-data文件夹。</code><br>配置成功后，重启ActiveMQ服务。启动队列生产生产消息，消息不会立即同步到数据库中，如果过了一段时间后队列的消息还没被消费，则会自动持久化到数据库中。</p>
<ul>
<li>从最初的AMQ Message Store方案到ActiveMQ V4版本退出的High Performance Journal（高性能事务支持）附件，并且同步推出了关于关系型数据库的存储方案。ActiveMQ5.3版本又推出了对KahaDB的支持（5.4版本后被作为默认的持久化方案），后来ActiveMQ 5.8版本开始支持LevelDB，到现在5.9提供了标准的Zookeeper+LevelDB集群化方案。</li>
<li>ActiveMQ消息持久化机制有：</li>
<li>AMQ 基于日志文件</li>
<li>KahaDB 基于日志文件，从ActiveMQ5.4开始默认使用</li>
<li>JDBC 基于第三方数据库</li>
<li>Replicated LevelDB Store 从5.9开始提供了LevelDB和Zookeeper的数据复制方法，用于Master-slave方式的首选数据复制方案。</li>
</ul>
<h4 id="集群部署"><a href="#集群部署" class="headerlink" title="集群部署"></a>集群部署</h4><blockquote>
<p>5.9前的版本，采用的是 主从的方式，基于静态地址做双向的数据备份。 </p>
<p>后面的新版本加入zk实现了更强大的集群可靠性；</p>
</blockquote>
<p><strong>ActiveMQ集群有以下三种方式：</strong></p>
<p><strong>1、</strong> 基于shareFileSystem共享文件系统（KahaDB）；<br><strong>2、</strong> 基于JDBC；<br><strong>3、</strong> 基于Zookeeper和LevelDB搭建的集群；</p>
<p>本章只重点讲解基于Zookeeper和LevelDB的集群方式</p>
<p>其他集群方式参考官网：<a target="_blank" rel="noopener" href="http://activemq.apache.org/masterslave">http://activemq.apache.org/masterslave</a></p>
<h4 id="基于zk的集群搭建"><a href="#基于zk的集群搭建" class="headerlink" title="基于zk的集群搭建"></a>基于zk的集群搭建</h4><h5 id="Zookeeper集群介绍"><a href="#Zookeeper集群介绍" class="headerlink" title="Zookeeper集群介绍"></a>Zookeeper集群介绍</h5><p>从ActiveMQ5.9开始,ActiveMQ的集群实现方式取消了传统的Masster-Slave方式，增加了基于Zookeeper+LevelDB的Master-Slave实现方式,从5.9版本后也是官网的推荐。</p>
<h5 id="集群原理"><a href="#集群原理" class="headerlink" title="集群原理"></a>集群原理</h5> <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/05/03/mq-basic/1697189778287.png" class="">
<p>使用Zookeeper集群注册所有的ActiveMQ Broker但只有其中一个Broker可以提供服务，它将被视为Master，其他的Broker处于待机状态被视为Slave。</p>
<p>如果Master因故障而不能提供服务，Zookeeper会从Slave中选举出一个Broker充当Master。Slave连接Master并同步他们的存储状态，Slave不接受client连接，所有的client都只会连接到Master。Master所有的存储操作都将被复制到连接至Maste的Slaves。</p>
<p>如果Master宕机了，则最新更新的Slave会变成Master。如果原本Master故障节点恢复，则会重新加入集群并连接新的Master进入Slave模式。</p>
<p>所有需要同步的消息操作都将等待存储状态被复制到其他法定节点的操作完成才能完成。 所以，如给你配置了replicas&#x3D;3，name法定大小是（3&#x2F;2）+1 &#x3D; 2。Master将会存储更新然后等待（2-1）&#x3D;1个Slave存储和更新完成，才汇报success。</p>
<p>在Zookeeper中，有一个node要作为观察者存在。当一个新的Master被选中，你需要至少保障一个法定node在线以能够找到拥有最新状态的node，这个node才可以成为新的Master。因此，推荐运行至少3个replica nodes以防止一个node失败后服务中断。</p>
<h5 id="集群操作"><a href="#集群操作" class="headerlink" title="集群操作"></a>集群操作</h5><p>集群环境准备：linux系统 + jdk + zookeeper + apache-activemq。<br>在linux操作系统上创建mq_cluster文件夹，以下所有下载安装的文件都放到这里。创建命令：mkdir &#x2F;opt&#x2F;mq_cluster</p>
<h5 id="zookeeper安装和配置"><a href="#zookeeper安装和配置" class="headerlink" title="zookeeper安装和配置"></a>zookeeper安装和配置</h5><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/xiaozhegaa/article/details/114464798">详细配置启动看这篇文章，手把手教学</a><br>那么这里就默认zookeeper集群搭建完毕</p>
<h5 id="ActiveMQ安装和配置"><a href="#ActiveMQ安装和配置" class="headerlink" title="ActiveMQ安装和配置"></a>ActiveMQ安装和配置</h5><p><strong>1、</strong> ActiveMQ下载；<br>此处重点讲ActiveMQ集群配置，ActiveMQ下载和安装参考：ActiveMQ下载和安装（Linux版） <strong>2、</strong> 将下载好的ActiveMQ解压3份并分别重命名为：mq_node01、mq_node02、mq_node03；<br><strong>3、</strong> 修改访问控制台端口；<br>除了mq_node01使用默认的控制台访问端口（8161）不用修改外，mq_node02和mq_node03控制台访问端口分别改为8162和8163。<br>分别在mq_node02和mq_node03路径的conf&#x2F;jetty.xml配置文件中找到bean id为jettyPort，并将port属性值分别改为8162和8163。将host改为0.0.0.0方便外部机器远程连接访问控制台，示例如下：<br> <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/05/03/mq-basic/1697189778611.png" class=""> <strong>4、</strong> 修改brokerName；<br>mq_node01、mq_node02和mq_node03的activemq.xml的brokerName改成一样。示例如下：<br> <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/05/03/mq-basic/1697189778984.png" class=""> <strong>5、</strong> 持久化配置；<br>在mq_node01、mq_node02、mq_node03目录下的conf&#x2F;activemq.xm将默认的persistenceAdapter替换成以下内容：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">        &lt;persistenceAdapter&gt;</span></span><br><span class="line"><span class="comment">            &lt;kahaDB directory=&quot;$&#123;activemq.data&#125;/kahadb&quot;/&gt;</span></span><br><span class="line"><span class="comment">        &lt;/persistenceAdapter&gt;</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- mq_node01的bind属性值端口为63631，mq_node02的bind属性值端口为63632，mq_node03的bind属性值端口为63633 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">persistenceAdapter</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">replicatedLevelDB</span></span></span><br><span class="line"><span class="tag">		<span class="attr">directory</span>=<span class="string">&quot;$&#123;activemq.data&#125;/leveldb&quot;</span></span></span><br><span class="line"><span class="tag">		<span class="attr">replicas</span>=<span class="string">&quot;3&quot;</span></span></span><br><span class="line"><span class="tag">		<span class="attr">bind</span>=<span class="string">&quot;tcp://0.0.0.0:63631&quot;</span></span></span><br><span class="line"><span class="tag">		<span class="attr">zkAddress</span>=<span class="string">&quot;localhost:2181,localhost:2182,localhost:2183&quot;</span></span></span><br><span class="line"><span class="tag">		<span class="attr">hostname</span>=<span class="string">&quot;localhost&quot;</span></span></span><br><span class="line"><span class="tag">		<span class="attr">zkPath</span>=<span class="string">&quot;/activemq/leveldb-stores&quot;</span></span></span><br><span class="line"><span class="tag">	/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">persistenceAdapter</span>&gt;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>directory：持久化数据路径<br>replicas：当前主从模型中的节点数，根据实际配置<br>bind：主从实例间的通讯端口。<br>zkAddress：zookeeper应用的安装位置<br>hostname：ActiveMQ实例安装的实际linux主机名<br>zkPath：ActiveMQ的主从信息保存在zookeeper中的什么目录</p>
</blockquote>
<p><strong>1、</strong> 修改消息端口；<br>除了mq_node01使用默认端口（61616），同样修改activemq.xml，mq_node02和mq_node03端口分别改为61617和616168。示例如下：<br> <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/05/03/mq-basic/1697189779241.png" class=""></p>
<h5 id="测试集群"><a href="#测试集群" class="headerlink" title="测试集群"></a>测试集群</h5><p><strong>1、</strong> 编写mq_batch_start.sh批量开启activeMQ：；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/sh</span><br><span class="line"></span><br><span class="line">cd /opt/mq_cluster/mq_node01/bin</span><br><span class="line">./activemq start</span><br><span class="line"></span><br><span class="line">cd /opt/mq_cluster/mq_node02/bin</span><br><span class="line">./activemq start</span><br><span class="line"></span><br><span class="line">cd /opt/mq_cluster/mq_node03/bin</span><br><span class="line">./activemq start</span><br></pre></td></tr></table></figure>

<p><strong>1、</strong> 编写mq_batch_stop.sh批量关闭activeMQ：；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/sh</span><br><span class="line"></span><br><span class="line">cd /opt/mq_cluster/mq_node01/bin</span><br><span class="line">./activemq stop</span><br><span class="line"></span><br><span class="line">cd /opt/mq_cluster/mq_node02/bin</span><br><span class="line">./activemq stop</span><br><span class="line"></span><br><span class="line">cd /opt/mq_cluster/mq_node03/bin</span><br><span class="line">./activemq stop</span><br></pre></td></tr></table></figure>

<p>分别给两个批处理文件赋予执行权限，命令：chomod 777 &lt;文件名称&gt;<br><strong>3、</strong> 启动zk集群，若不知道zk集群，看上面推荐文章；<br><strong>4、</strong> 执行.&#x2F;mq_batch_start.sh分别启动activeMQ服务，ps-ef|grepactivemq|grep-vgrep查看MQ启动情况；<br> <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/05/03/mq-basic/1697189779875.png" class=""><br><strong>5、</strong> 使用客户端连接其中一台zookeeper，.&#x2F;zkCli.sh-server127.0.0.1:2181；<br> <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/05/03/mq-basic/1697189780820.png" class=""><br><strong>6、</strong> 查看三台activeMQ是否成功注册到了zookeeper，ls&#x2F;activemq&#x2F;leveldb-stores；<br> <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/05/03/mq-basic/1697189781177.png" class=""><br><strong>7、</strong> 可以看到三台activeMQ节点分别为：00000000016,00000000017,00000000018；<br>分别查看这三个节点的主从状态，get &#x2F;activemq&#x2F;leveldb-stores&#x2F;00000000016、get &#x2F;activemq&#x2F;leveldb-stores&#x2F;00000000017、get &#x2F;activemq&#x2F;leveldb-stores&#x2F;00000000018。 <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/05/03/mq-basic/1697189781651.png" class=""><br>可以看到仅仅00000000018节点的elected属性值不为null，则表示00000000018为Master，其他两个节点为Slave。</p>
<h5 id="集群可用性测试"><a href="#集群可用性测试" class="headerlink" title="集群可用性测试"></a>集群可用性测试</h5><p>Slave不接受client连接，client只与Master连接，所以客户端连接的Broker应该使用failover协议（失败转移）。</p>
<p>由以上连接测试可知，Master为00000000016节点，该节点访问消息端口为61616，访问控制台（client）端口为8161。所以通过浏览器打开控制台只能使用8161，同样的，使用lsof -i:&lt;端口&gt;命令查看ActiveMQ服务启动情况，只能查看到61616端口的服务在监听着。</p>
<h5 id="java代码连通测试"><a href="#java代码连通测试" class="headerlink" title="java代码连通测试"></a>java代码连通测试</h5><p>集群测试消息生产者代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.huazai.activemq.cluster;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.activemq.ActiveMQConnectionFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.jms.*;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> DDKK.COM 弟弟快看，程序员编程资料站</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020/12/23 23:21</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ClusterJMSProducer</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">    <span class="comment">// 集群地址需要换成failover协议（失败转移）</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ACTIVEMQ_URL</span> <span class="operator">=</span> <span class="string">&quot;failover:(tcp://192.168.64.129:61616,tcp://192.168.64.129:61617,tcp://192.168.64.129:61618)&quot;</span>;</span><br><span class="line">    <span class="comment">// 消息队列名称</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">QUEUE_NAME</span> <span class="operator">=</span> <span class="string">&quot;queue-cluster&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">        <span class="comment">// 1.创建给定ActiveMQ服务连接工厂，使用默认的用户名和密码</span></span><br><span class="line">        <span class="type">ActiveMQConnectionFactory</span> <span class="variable">activeMQConnectionFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ActiveMQConnectionFactory</span>(ACTIVEMQ_URL);</span><br><span class="line">        <span class="comment">// 2.通过连接工厂，创建连接对象并启动访问</span></span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> activeMQConnectionFactory.createConnection();</span><br><span class="line">        connection.start();</span><br><span class="line">        <span class="comment">// 3.创建会话，第一个参数为是否开启事务，第二个参数为签收</span></span><br><span class="line">        <span class="type">Session</span> <span class="variable">session</span> <span class="operator">=</span> connection.createSession(<span class="literal">false</span>, Session.AUTO_ACKNOWLEDGE);</span><br><span class="line">        <span class="comment">// 4.创建目的地（队列或者主题）</span></span><br><span class="line">        <span class="type">Queue</span> <span class="variable">queue</span> <span class="operator">=</span> session.createQueue(QUEUE_NAME);</span><br><span class="line">        <span class="comment">// 可以用父接口Destination接受</span></span><br><span class="line">        <span class="comment">// Destination queue = session.createQueue(QUEUE_NAME);</span></span><br><span class="line">        <span class="comment">// 5.创建消息的生产者</span></span><br><span class="line">        <span class="type">MessageProducer</span> <span class="variable">producer</span> <span class="operator">=</span> session.createProducer(queue);</span><br><span class="line">        <span class="comment">// 6.通过消息生产者生产6条消息发送MQ队列</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">            <span class="comment">// 7.创建消息</span></span><br><span class="line">            <span class="type">TextMessage</span> <span class="variable">textMessage</span> <span class="operator">=</span> session.createTextMessage(<span class="string">&quot;msg&quot;</span> + i + <span class="string">&quot;:hello world&quot;</span>);</span><br><span class="line">            <span class="comment">// 8.将消息发送到MQ</span></span><br><span class="line">            producer.send(textMessage);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 9.关闭资源</span></span><br><span class="line">        producer.close();</span><br><span class="line">        session.close();</span><br><span class="line">        connection.close();</span><br><span class="line">        System.out.println(<span class="string">&quot;finish&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>集群测试消息消费者代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.huazai.activemq.cluster;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.activemq.ActiveMQConnectionFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.jms.*;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> DDKK.COM 弟弟快看，程序员编程资料站</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020/12/24 22:09</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ClusterJMSConsumer</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">    <span class="comment">// 集群地址需要换成failover协议（失败转移）</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ACTIVEMQ_URL</span> <span class="operator">=</span> <span class="string">&quot;failover:(tcp://192.168.64.129:61616,tcp://192.168.64.129:61617,tcp://192.168.64.129:61618)&quot;</span>;</span><br><span class="line">    <span class="comment">// 消息队列名称，取消息必须和存消息的队列名称一致</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">QUEUE_NAME</span> <span class="operator">=</span> <span class="string">&quot;queue-cluster&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">        <span class="comment">// 1.创建给定ActiveMQ服务连接工厂，使用默认的用户名和密码</span></span><br><span class="line">        <span class="type">ActiveMQConnectionFactory</span> <span class="variable">activeMQConnectionFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ActiveMQConnectionFactory</span>(ACTIVEMQ_URL);</span><br><span class="line">        <span class="comment">// 2.通过连接工厂，创建连接对象并启动访问</span></span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> activeMQConnectionFactory.createConnection();</span><br><span class="line">        connection.start();</span><br><span class="line">        <span class="comment">// 3.创建会话，第一个参数为是否开启事务，第二个参数为签收</span></span><br><span class="line">        <span class="type">Session</span> <span class="variable">session</span> <span class="operator">=</span> connection.createSession(<span class="literal">false</span>, Session.CLIENT_ACKNOWLEDGE);</span><br><span class="line">        <span class="comment">// 4.创建目的地（队列或者主题）</span></span><br><span class="line">        <span class="type">Queue</span> <span class="variable">queue</span> <span class="operator">=</span> session.createQueue(QUEUE_NAME);</span><br><span class="line">        <span class="comment">// 5.创建消费者</span></span><br><span class="line">        <span class="type">MessageConsumer</span> <span class="variable">consumer</span> <span class="operator">=</span> session.createConsumer(queue);</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">            <span class="comment">// 接受消息根据生产者发送消息类型强类型转换</span></span><br><span class="line">            <span class="type">TextMessage</span> <span class="variable">message</span> <span class="operator">=</span> (TextMessage) consumer.receive();</span><br><span class="line">            <span class="keyword">if</span> (message != <span class="literal">null</span>) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">                <span class="type">String</span> <span class="variable">text</span> <span class="operator">=</span> message.getText();</span><br><span class="line">                System.out.println(text);</span><br><span class="line">                message.acknowledge();</span><br><span class="line"><span class="comment">//                session.commit();</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        consumer.close();</span><br><span class="line">        session.close();</span><br><span class="line">        connection.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>先启动生产者，再启动消费者代码，控制台输出如下：<br> <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/05/03/mq-basic/1697189782551.png" class=""><br> <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/05/03/mq-basic/1697189783374.png" class=""></p>
<h5 id="测试Master选举"><a href="#测试Master选举" class="headerlink" title="测试Master选举"></a>测试Master选举</h5> <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/05/03/mq-basic/1697189783671.png" class="">
<p>手动将Master的broker服务关闭（演示宕机）后，是否会从其他两台Slave中选举出一个Master呢？<br> <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/05/03/mq-basic/1697189784224.png" class=""></p>
<p>由此可知，当Master宕机后，查看00000000016节点已经不存在，通过选举00000000017为新的Master。</p>
<p>当旧的Master服务重新连接后，是继续为Master，还是为新的Master成为Slave？<br> <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/05/03/mq-basic/1697189785136.png" class=""></p>
<p>上图可知，当旧的Master重新连接后，生成了一个新的节点，并为Slave，现Master仍然是通过选举的00000000017。</p>
<h3 id="高级特性"><a href="#高级特性" class="headerlink" title="高级特性"></a>高级特性</h3><p>ActiveMQ高级特性：</p>
<p><strong>1、</strong> 异步投递；<br><strong>2、</strong> 延迟投递和定时投递；<br><strong>3、</strong> 分发策略；<br><strong>4、</strong> 消息重试机制；<br><strong>5、</strong> 死信队列；</p>
<h5 id="异步投递"><a href="#异步投递" class="headerlink" title="异步投递"></a>异步投递</h5><p>ActiveMQ支持同步，异步两种发送的模式将消息发送到broker，模式的选择对发送延时有巨大的影响。producer能达到怎么样的产出率（<code>产出率=发送数据总量/时间</code>）主要受发送延时的影响，使用异步发送可以显著提高发送的性能。</p>
<p><code>ActiveMQ默认使用异步发送的模式</code>，除非明确指定使用同步发送的方式或者在未使用事务的前提下发送持久化的消息，这两种情况都是同步发送的。</p>
<p>如果你没有使用事务且发送的是持久化的消息，每一次发送都是默认同步发送的且会阻塞producer直到broker返回一个确认，表示消息已经被安全的持久化到磁盘。确认机制提供了消息安全的保障，但同时会阻塞客户端带来了很大的延时。</p>
<p>很多高性能的应用，允许在失败的情况下有少量的数据丢失。如果你的应用满足这个特点，你可以使用异步发送来提高生产率，即使发送的是持久化的消息。</p>
<p><code>异步发送它可以最大化producer端的发送效率。</code>我们通常在发送消息量比较密集的情况下使用异步发送，它可以很大的提升producer性能。不过这也带来了额外的问题，就是需要消耗更多的Client端内存同时也会导致broker端性能消耗增加，此外它不能有效的确保消息的发送成功。在异步投递的情况下客户端需要容忍消息丢失的可能。</p>
<p><strong>设置异步投递的三种方式：</strong></p>
<p><strong>1、</strong> 连接ActiveMQ的url添加<code>jms.useAsyncSend=true</code>参数；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cf = <span class="keyword">new</span> <span class="title class_">ActiveMQConnectionFactory</span>(<span class="string">&quot;tcp://locahost:61616?jms.useAsyncSend=true&quot;</span>);</span><br></pre></td></tr></table></figure>

<p><strong>1、</strong> ActiveMQConnectionFactory方法设置；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">((ActiveMQConnectionFactory)connectionFactory).setUseAsyncSend(<span class="literal">true</span>);</span><br></pre></td></tr></table></figure>

<p><strong>1、</strong> ActiveMQConnection方法设置；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">((ActiveMQConnection)connection).setUseAsyncSend(<span class="literal">true</span>);</span><br></pre></td></tr></table></figure>

<p>参考官网：<a target="_blank" rel="noopener" href="http://activemq.apache.org/async-sends">Async Sends</a></p>
<p><strong>异步消息如何确定发送成功？</strong><br>当设置异步投递后，使用producer.send(msg)持续发送消息，如果消息不阻塞，生产者会认为所有send的消息均被成功发送至MQ。如果MQ突然宕机，此时生产者端内存中尚未被发送至MQ的消息都会丢失。</p>
<p>答案是：正确的异步发送方法是需要接收回调的。同步发送等send方法不阻塞了就表示一定发送成功了；异步发送需要客户端回执并由客户端再判断一次是否发送成功。</p>
<p><strong>案例演示</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.huazai.activemq.advanced;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.activemq.ActiveMQConnectionFactory;</span><br><span class="line"><span class="keyword">import</span> org.apache.activemq.ActiveMQMessageProducer;</span><br><span class="line"><span class="keyword">import</span> org.apache.activemq.AsyncCallback;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.jms.*;</span><br><span class="line"><span class="keyword">import</span> java.util.UUID;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ActiveMQ高级特性之异步投递</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> DDKK.COM 弟弟快看，程序员编程资料站</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JmsProduceAsyncSend</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">    <span class="comment">// ActiveMQ服务地址</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ACTIVEMQ_URL</span> <span class="operator">=</span> <span class="string">&quot;tcp://192.168.64.129:61616&quot;</span>;</span><br><span class="line">    <span class="comment">// 消息队列名称</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">QUEUE_NAME</span> <span class="operator">=</span> <span class="string">&quot;queue-async&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">        <span class="comment">// 1.创建给定ActiveMQ服务连接工厂，使用默认的用户名和密码</span></span><br><span class="line">        <span class="type">ActiveMQConnectionFactory</span> <span class="variable">activeMQConnectionFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ActiveMQConnectionFactory</span>(ACTIVEMQ_URL);</span><br><span class="line">        <span class="comment">// 开启异步投递</span></span><br><span class="line">        activeMQConnectionFactory.setUseAsyncSend(<span class="literal">true</span>);</span><br><span class="line">        <span class="comment">// 2.通过连接工厂，创建连接对象并启动访问</span></span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> activeMQConnectionFactory.createConnection();</span><br><span class="line">        connection.start();</span><br><span class="line">        <span class="comment">// 3.创建会话，第一个参数为是否开启事务，第二个参数为签收</span></span><br><span class="line">        <span class="type">Session</span> <span class="variable">session</span> <span class="operator">=</span> connection.createSession(<span class="literal">false</span>, Session.AUTO_ACKNOWLEDGE);</span><br><span class="line">        <span class="comment">// 4.创建目的地（队列或者主题）</span></span><br><span class="line">        <span class="type">Queue</span> <span class="variable">queue</span> <span class="operator">=</span> session.createQueue(QUEUE_NAME);</span><br><span class="line">        <span class="comment">// 可以用父接口Destination接受</span></span><br><span class="line">        <span class="comment">// Destination queue = session.createQueue(QUEUE_NAME);</span></span><br><span class="line">        <span class="comment">// 5.创建消息的生产者，一定要向上转型为ActiveMQMessageProducer类型才有异步投递功能</span></span><br><span class="line">        <span class="type">ActiveMQMessageProducer</span> <span class="variable">activeMQMessageProducer</span> <span class="operator">=</span> (ActiveMQMessageProducer) session.createProducer(queue);</span><br><span class="line">        <span class="comment">// 6.通过消息生产者生产6条消息发送MQ队列</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">            <span class="comment">// 7.创建消息</span></span><br><span class="line">            <span class="type">TextMessage</span> <span class="variable">textMessage</span> <span class="operator">=</span> session.createTextMessage(<span class="string">&quot;异步投递消息&quot;</span> + i + <span class="string">&quot;:hello world&quot;</span>);</span><br><span class="line">            <span class="comment">// 给消息设置一个唯一的id可以知道哪条消息发送成功，哪条消息发送失败</span></span><br><span class="line">            textMessage.setJMSMessageID(UUID.randomUUID().toString());</span><br><span class="line">            <span class="type">String</span> <span class="variable">msgId</span> <span class="operator">=</span> textMessage.getJMSMessageID();</span><br><span class="line">            <span class="comment">// 8.将消息发送到MQ，并回调判断消息是否发送成功</span></span><br><span class="line">            activeMQMessageProducer.send(textMessage, <span class="keyword">new</span> <span class="title class_">AsyncCallback</span>() &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">                <span class="comment">/**</span></span><br><span class="line"><span class="comment">                 * 消息发送成功回调方法</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onSuccess</span><span class="params">()</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">                    System.out.println(<span class="string">&quot;消息成功发送回调方法，成功消息标识：&quot;</span> + msgId);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">/**</span></span><br><span class="line"><span class="comment">                 * 消息发送失败回调方法</span></span><br><span class="line"><span class="comment">                 *</span></span><br><span class="line"><span class="comment">                 * <span class="doctag">@param</span> exception</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onException</span><span class="params">(JMSException exception)</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">                    System.err.println(<span class="string">&quot;消息发送失败回调方法，失败消息标识：&quot;</span> + msgId);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 9.关闭资源</span></span><br><span class="line">        activeMQMessageProducer.close();</span><br><span class="line">        session.close();</span><br><span class="line">        connection.close();</span><br><span class="line">        System.out.println(<span class="string">&quot;finish&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行结果：<br> <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/05/03/mq-basic/1697185762339.png" class=""></p>
<h5 id="延迟投递和定时投递"><a href="#延迟投递和定时投递" class="headerlink" title="延迟投递和定时投递"></a>延迟投递和定时投递</h5><p>延迟投递：延迟多长时间开始投递消息<br>定时投递：间隔多长时间开始投递消息</p>
<p><strong>开启定时投递和间隔投递功能</strong></p>
<p>在<code>activemq.xml</code>文件中配置broker的<code>schedulerSupport</code>属性为true，并重启服务。<br> <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/05/03/mq-basic/1697185763203.png" class=""><br><strong>四大属性</strong></p>
<table>
<thead>
<tr>
<th align="left">Property Name</th>
<th align="left">Type</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody><tr>
<td align="left">AMQ_SCHEDULED_DELAY</td>
<td align="left">long</td>
<td align="left">延迟投递的时间</td>
</tr>
<tr>
<td align="left">AMQ_SCHEDULED_PERIOD</td>
<td align="left">long</td>
<td align="left">重复投递的时间间隔</td>
</tr>
<tr>
<td align="left">AMQ_SCHEDULED_REPEAT</td>
<td align="left">int</td>
<td align="left">重复投递次数</td>
</tr>
<tr>
<td align="left">AMQ_SCHEDULED_CRON</td>
<td align="left">String</td>
<td align="left">Cron表达式，可以用这表达式配置以上三个属性值，类似Spring的Schedule的cron</td>
</tr>
</tbody></table>
<p><strong>案例演示</strong></p>
<p>消费者代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.huazai.activemq.advanced;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.activemq.ActiveMQConnectionFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.jms.*;</span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> DDKK.COM 弟弟快看，程序员编程资料站</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/1/30 20:54</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JmsConsumerDelayAndScheduleRecieve</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">    <span class="comment">// ActiveMQ服务地址</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ACTIVEMQ_URL</span> <span class="operator">=</span> <span class="string">&quot;tcp://192.168.64.129:61616&quot;</span>;</span><br><span class="line">    <span class="comment">// 消息队列名称，取消息必须和存消息的队列名称一致</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">QUEUE_NAME</span> <span class="operator">=</span> <span class="string">&quot;queue-delay-schedule&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">        <span class="comment">// 1.创建给定ActiveMQ服务连接工厂，使用默认的用户名和密码</span></span><br><span class="line">        <span class="type">ActiveMQConnectionFactory</span> <span class="variable">activeMQConnectionFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ActiveMQConnectionFactory</span>(ACTIVEMQ_URL);</span><br><span class="line">        <span class="comment">// 2.通过连接工厂，创建连接对象并启动访问</span></span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> activeMQConnectionFactory.createConnection();</span><br><span class="line">        connection.start();</span><br><span class="line">        <span class="comment">// 3.创建会话，第一个参数为是否开启事务，第二个参数为签收</span></span><br><span class="line">        <span class="type">Session</span> <span class="variable">session</span> <span class="operator">=</span> connection.createSession(<span class="literal">false</span>, Session.AUTO_ACKNOWLEDGE);</span><br><span class="line">        <span class="comment">// 4.创建目的地（队列或者主题）</span></span><br><span class="line">        <span class="type">Queue</span> <span class="variable">queue</span> <span class="operator">=</span> session.createQueue(QUEUE_NAME);</span><br><span class="line">        <span class="comment">// 5.创建消费者</span></span><br><span class="line">        <span class="type">MessageConsumer</span> <span class="variable">consumer</span> <span class="operator">=</span> session.createConsumer(queue);</span><br><span class="line">        <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">            <span class="comment">// 接受消息根据生产者发送消息类型强类型转换</span></span><br><span class="line">            <span class="type">TextMessage</span> <span class="variable">message</span> <span class="operator">=</span> (TextMessage) consumer.receive();</span><br><span class="line">            <span class="keyword">if</span> (message != <span class="literal">null</span>) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">                <span class="type">String</span> <span class="variable">text</span> <span class="operator">=</span> message.getText();</span><br><span class="line">                System.out.print(<span class="string">&quot;第&quot;</span> + ++i + <span class="string">&quot;次接受延迟消息：&quot;</span>);</span><br><span class="line">                System.out.println(text);</span><br><span class="line">                <span class="type">int</span> <span class="variable">endSecond</span> <span class="operator">=</span> LocalDateTime.now().getSecond();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        consumer.close();</span><br><span class="line">        session.close();</span><br><span class="line">        connection.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>生产者代码：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.huazai.activemq.advanced;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.activemq.ActiveMQConnectionFactory;</span><br><span class="line"><span class="keyword">import</span> org.apache.activemq.ActiveMQMessageProducer;</span><br><span class="line"><span class="keyword">import</span> org.apache.activemq.AsyncCallback;</span><br><span class="line"><span class="keyword">import</span> org.apache.activemq.ScheduledMessage;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.jms.*;</span><br><span class="line"><span class="keyword">import</span> java.util.UUID;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> DDKK.COM 弟弟快看，程序员编程资料站</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/1/30 20:25</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JmsProduceDelayAndScheduleSend</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">    <span class="comment">// ActiveMQ服务地址</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ACTIVEMQ_URL</span> <span class="operator">=</span> <span class="string">&quot;tcp://192.168.64.129:61616&quot;</span>;</span><br><span class="line">    <span class="comment">// 消息队列名称</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">QUEUE_NAME</span> <span class="operator">=</span> <span class="string">&quot;queue-delay-schedule&quot;</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 延迟投递的时间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">DELAY</span> <span class="operator">=</span> <span class="number">3</span> * <span class="number">1000</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 每次投递的时间间隔</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">PERIOD</span> <span class="operator">=</span> <span class="number">4</span> * <span class="number">1000</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 投递的次数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">REPEAT</span> <span class="operator">=</span> <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">        <span class="comment">// 1.创建给定ActiveMQ服务连接工厂，使用默认的用户名和密码</span></span><br><span class="line">        <span class="type">ActiveMQConnectionFactory</span> <span class="variable">activeMQConnectionFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ActiveMQConnectionFactory</span>(ACTIVEMQ_URL);</span><br><span class="line">        <span class="comment">// 2.通过连接工厂，创建连接对象并启动访问</span></span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> activeMQConnectionFactory.createConnection();</span><br><span class="line">        connection.start();</span><br><span class="line">        <span class="comment">// 3.创建会话，第一个参数为是否开启事务，第二个参数为签收</span></span><br><span class="line">        <span class="type">Session</span> <span class="variable">session</span> <span class="operator">=</span> connection.createSession(<span class="literal">false</span>, Session.AUTO_ACKNOWLEDGE);</span><br><span class="line">        <span class="comment">// 4.创建目的地（队列或者主题）</span></span><br><span class="line">        <span class="type">Queue</span> <span class="variable">queue</span> <span class="operator">=</span> session.createQueue(QUEUE_NAME);</span><br><span class="line">        <span class="comment">// 可以用父接口Destination接受</span></span><br><span class="line">        <span class="comment">// Destination queue = session.createQueue(QUEUE_NAME);</span></span><br><span class="line">        <span class="comment">// 5.创建消息的生产者，一向上转型为ActiveMQMessageProducer</span></span><br><span class="line">        <span class="type">ActiveMQMessageProducer</span> <span class="variable">activeMQMessageProducer</span> <span class="operator">=</span> (ActiveMQMessageProducer) session.createProducer(queue);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 6.通过消息生产者生产6条消息发送MQ队列</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">            <span class="comment">// 7.创建消息</span></span><br><span class="line">            <span class="type">TextMessage</span> <span class="variable">textMessage</span> <span class="operator">=</span> session.createTextMessage(<span class="string">&quot;延迟投递和定时投递消息&quot;</span> + i + <span class="string">&quot;:hello world\n&quot;</span>);</span><br><span class="line">            <span class="comment">// 给消息设置一个唯一的id可以知道哪条消息发送成功，哪条消息发送失败</span></span><br><span class="line">            textMessage.setJMSMessageID(UUID.randomUUID().toString());</span><br><span class="line">            <span class="type">String</span> <span class="variable">msgId</span> <span class="operator">=</span> textMessage.getJMSMessageID();</span><br><span class="line">            <span class="comment">// 延迟投递的时间</span></span><br><span class="line">            textMessage.setLongProperty(ScheduledMessage.AMQ_SCHEDULED_DELAY, DELAY);</span><br><span class="line">            <span class="comment">// 每次投递的时间间隔</span></span><br><span class="line">            textMessage.setLongProperty(ScheduledMessage.AMQ_SCHEDULED_PERIOD, PERIOD);</span><br><span class="line">            <span class="comment">// 投递的次数</span></span><br><span class="line">            textMessage.setIntProperty(ScheduledMessage.AMQ_SCHEDULED_REPEAT, REPEAT);</span><br><span class="line">            <span class="comment">// 8.将消息发送到MQ，并回调判断消息是否发送成功</span></span><br><span class="line">            activeMQMessageProducer.send(textMessage);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 9.关闭资源</span></span><br><span class="line">        activeMQMessageProducer.close();</span><br><span class="line">        session.close();</span><br><span class="line">        connection.close();</span><br><span class="line">        System.out.println(<span class="string">&quot;finish&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>先启动消费者，再启动生产者，然后观察消费者控制台，结果如下：<br> <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/05/03/mq-basic/1697185763710.png" class=""></p>
<h5 id="消息重试机制"><a href="#消息重试机制" class="headerlink" title="消息重试机制"></a>消息重试机制</h5><p><strong>以下情况会引发消息重发：</strong></p>
<p>activeMQ中的消息重发，指的是消息可以被broker重新分派给消费者，不一定的之前的消费者。重发消息之后，消费者可以重新消费。消息重发的情况有以下几种：</p>
<p><strong>1、</strong> Client用了transactions且在session中调用了rollback；<br><strong>2、</strong> Client用了transactions且在调用commit之前关闭或者没有commit；<br><strong>3、</strong> Client再CLIENT_ACKNOWLEDGE的传递模式下，session中调用了recover；<br><strong>4、</strong> Client连接超时(可能正在执行的代码花费的时间比配置的超时时间长)；</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">消息默认重发时间间隔为1秒，默认重发次数为6。一个消息被redelivedred超过默认的最大重发次数（默认6次）时，消费端会给MQ发一个“poison ack”表示这个消息有毒，告诉broker不要再发了。这个时候broker会把这个消息放到DLQ（死信队列）。</span><br></pre></td></tr></table></figure>

<p><strong>案例演示（演示第2种没有提交事务引发的重试机制）</strong></p>
<p>生产者代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.huazai.activemq.advanced;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.activemq.ActiveMQConnectionFactory;</span><br><span class="line"><span class="keyword">import</span> org.apache.activemq.ActiveMQMessageProducer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.jms.Connection;</span><br><span class="line"><span class="keyword">import</span> javax.jms.Queue;</span><br><span class="line"><span class="keyword">import</span> javax.jms.Session;</span><br><span class="line"><span class="keyword">import</span> javax.jms.TextMessage;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ActiveMQ高级特性之重试机制生产者</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> DDKK.COM 弟弟快看，程序员编程资料站</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/2/1 23:24</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JmsProduceRedeliveryPolicy</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">    <span class="comment">// ActiveMQ服务地址</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ACTIVEMQ_URL</span> <span class="operator">=</span> <span class="string">&quot;tcp://192.168.64.129:61616&quot;</span>;</span><br><span class="line">    <span class="comment">// 消息队列名称</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">QUEUE_NAME</span> <span class="operator">=</span> <span class="string">&quot;queue-redelivery-policy&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">        <span class="comment">// 1.创建给定ActiveMQ服务连接工厂，使用默认的用户名和密码</span></span><br><span class="line">        <span class="type">ActiveMQConnectionFactory</span> <span class="variable">activeMQConnectionFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ActiveMQConnectionFactory</span>(ACTIVEMQ_URL);</span><br><span class="line">        <span class="comment">// 2.通过连接工厂，创建连接对象并启动访问</span></span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> activeMQConnectionFactory.createConnection();</span><br><span class="line">        connection.start();</span><br><span class="line">        <span class="comment">// 3.创建会话，第一个参数为是否开启事务，第二个参数为签收</span></span><br><span class="line">        <span class="type">Session</span> <span class="variable">session</span> <span class="operator">=</span> connection.createSession(<span class="literal">false</span>, Session.AUTO_ACKNOWLEDGE);</span><br><span class="line">        <span class="comment">// 4.创建目的地（队列或者主题）</span></span><br><span class="line">        <span class="type">Queue</span> <span class="variable">queue</span> <span class="operator">=</span> session.createQueue(QUEUE_NAME);</span><br><span class="line">        <span class="comment">// 可以用父接口Destination接受</span></span><br><span class="line">        <span class="comment">// Destination queue = session.createQueue(QUEUE_NAME);</span></span><br><span class="line">        <span class="comment">// 5.创建消息的生产者，一定要向上转型为ActiveMQMessageProducer类型才有异步投递功能</span></span><br><span class="line">        <span class="type">ActiveMQMessageProducer</span> <span class="variable">activeMQMessageProducer</span> <span class="operator">=</span> (ActiveMQMessageProducer) session.createProducer(queue);</span><br><span class="line">        <span class="comment">// 6.通过消息生产者生产消息发送MQ队列</span></span><br><span class="line">        <span class="comment">// 7.创建消息</span></span><br><span class="line">        <span class="type">TextMessage</span> <span class="variable">textMessage</span> <span class="operator">=</span> session.createTextMessage(<span class="string">&quot;投递消息：&quot;</span> + <span class="string">&quot;:hello world&quot;</span>);</span><br><span class="line">        <span class="comment">// 8.将消息发送到MQ，并回调判断消息是否发送成功</span></span><br><span class="line">        activeMQMessageProducer.send(textMessage);</span><br><span class="line">        <span class="comment">// 9.关闭资源</span></span><br><span class="line">        activeMQMessageProducer.close();</span><br><span class="line">        session.close();</span><br><span class="line">        connection.close();</span><br><span class="line">        System.out.println(<span class="string">&quot;finish&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>消费者代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.huazai.activemq.advanced;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.activemq.ActiveMQConnectionFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.jms.*;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ActiveMQ高级特性之重试机制消费者</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> DDKK.COM 弟弟快看，程序员编程资料站</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/2/1 23:29</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JmsConsumerRedeliveryPolicy</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">    <span class="comment">// ActiveMQ服务地址</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ACTIVEMQ_URL</span> <span class="operator">=</span> <span class="string">&quot;tcp://192.168.64.129:61616&quot;</span>;</span><br><span class="line">    <span class="comment">// 消息队列名称，取消息必须和存消息的队列名称一致</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">QUEUE_NAME</span> <span class="operator">=</span> <span class="string">&quot;queue-redelivery-policy&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">        <span class="comment">// 1.创建给定ActiveMQ服务连接工厂，使用默认的用户名和密码</span></span><br><span class="line">        <span class="type">ActiveMQConnectionFactory</span> <span class="variable">activeMQConnectionFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ActiveMQConnectionFactory</span>(ACTIVEMQ_URL);</span><br><span class="line">        <span class="comment">// 2.通过连接工厂，创建连接对象并启动访问</span></span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> activeMQConnectionFactory.createConnection();</span><br><span class="line">        connection.start();</span><br><span class="line">        <span class="comment">// 3.创建会话，true开启事务</span></span><br><span class="line">        <span class="type">Session</span> <span class="variable">session</span> <span class="operator">=</span> connection.createSession(<span class="literal">true</span>, Session.AUTO_ACKNOWLEDGE);</span><br><span class="line">        <span class="comment">// 4.创建目的地（队列或者主题）</span></span><br><span class="line">        <span class="type">Queue</span> <span class="variable">queue</span> <span class="operator">=</span> session.createQueue(QUEUE_NAME);</span><br><span class="line">        <span class="comment">// 5.创建消费者</span></span><br><span class="line">        <span class="type">MessageConsumer</span> <span class="variable">consumer</span> <span class="operator">=</span> session.createConsumer(queue);</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">            <span class="comment">// 接受消息根据生产者发送消息类型强类型转换</span></span><br><span class="line">            <span class="type">TextMessage</span> <span class="variable">message</span> <span class="operator">=</span> (TextMessage) consumer.receive();</span><br><span class="line">            <span class="keyword">if</span> (message != <span class="literal">null</span>) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">                <span class="type">String</span> <span class="variable">text</span> <span class="operator">=</span> message.getText();</span><br><span class="line">                System.out.println(text);</span><br><span class="line">                <span class="comment">// 注意此处故意不提交事务</span></span><br><span class="line">                <span class="comment">// session.commit();</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        consumer.close();</span><br><span class="line">        session.close();</span><br><span class="line">        connection.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">注意消费者代码已开启事务，但故意不提交事务。</span><br></pre></td></tr></table></figure>

<p>启动生产者服务，再启动消费者服务，消费者能成功接收到队列的消息，但是控制台的消息并未出队。<br> <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/05/03/mq-basic/1697185764458.png" class=""><br>再重新启动消费者服务，发现之前消费的消息还能重复消费。ActiveMQ默认重发次数为6次，当消费者第七次启动消费消息时，发现消费不到消息，查看控制台发现，未消费的消息已出队列，并且多出了一个名为<code>ActiveMQ.DLQ</code>的队列。<br> <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/05/03/mq-basic/1697185765698.png" class=""><br><code>ActiveMQ.DLQ</code>即为死信队列，超过重复消费上限次数（6次）的消息被放到了死信队列里。</p>
<p>此时如果我们把代码里的队列名称改成ActiveMQ.DLQ，同样会拿到之前重复消费的消息。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">QUEUE_NAME</span> <span class="operator">=</span> <span class="string">&quot;ActiveMQ.DLQ&quot;</span>;</span><br></pre></td></tr></table></figure>

<h5 id="死信队列"><a href="#死信队列" class="headerlink" title="死信队列"></a>死信队列</h5><p>ActiveMQ中引入了“死信队列”(Dead Letter Queue)的概念。即一条消息再被重发了多次后(默认为重发6次，即redeliveryCounter&#x3D;&#x3D;6) 。将会被ActiveMQ移入“死信队列”。开发人员可以在这个Queue中查看处理出错的消息，进行人工干预。</p>
<p><strong>死信队列应用案例</strong></p>
<p>DLQ-死信队列(Dead Letter Queue)用来保存处理失败或者过期的消息。<br> <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/05/03/mq-basic/1697185766169.png" class=""><br>一般生产环境中在使用MQ的时候设计两个队列：一个是核心业务队列，一个是死信队列。</p>
<p>核心业务队列，就是比如上图专门用来让订单系统发送订单消息的，然后另外一个死信队列就是用来处理异常情况的。</p>
<p>假如第三方物流系统故障了，此时无法请求，那么仓储系统每次消费到一条订单消息，尝试通知发货和配送都会遇到对方的接口报错。此时仓储系统就可以把这条消息拒绝访问或者标记为处理失败。一旦标记这条消息处理失败了之后，MQ就会把这条消息转入提前设置好的一个死信队列中。然后你会看到的就是，在第三方物流系统故障期间，所有的订单消息全部处理失败，全部都会转入到死信队列。然后你的仓储系统得专门找一个后台线程，监控第三方物流系统是否正常，是否能请求，不停地监视。一旦发现对方恢复正常，这个后台线程就从死信队列消费出来处理失败的订单，重新执行发货和配送通知。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">缺省持久消息过期，会被送到死信队列，非持久消息不会送到DLQ。`</span><br><span class="line">`缺省的死信队列是ActiveMQ.DLQ，如果没有特别指定，死信都会被发送到这个队列中。</span><br></pre></td></tr></table></figure>

<p><strong>死信队列策略</strong></p>
<p><strong>1、</strong> 共享队列策略（默认）；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- “&gt;”表示对所有队列生效，如果需要设置指定队列，则直接写队 列名称--&gt;</span><br><span class="line">&lt;policyEntry queue=<span class="string">&quot;&gt;&quot;</span>&gt;</span><br><span class="line">	&lt;deadLetterStrategy&gt;</span><br><span class="line">		&lt;sharedDeadLetterStrategy processNonPersistent=<span class="string">&quot;false&quot;</span> processExpired=<span class="string">&quot;true&quot;</span> deadLetterQueue=<span class="string">&quot;&quot;</span> /&gt;</span><br><span class="line">	&lt;/deadLetterStrategy&gt;</span><br><span class="line">&lt;/policyEntry&gt;  </span><br><span class="line">processNonPersistent：是否将非持久化消息发送到死信队列，默认<span class="literal">false</span>；processExpired：是否将过期消息放入到死信队列中，默认为<span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p><strong>1、</strong> 独立死信队列策略；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- “&gt;”表示对所有队列生效，如果需要设置指定队列，则直接写队 列名称--&gt;</span><br><span class="line">&lt;policyEntry queue=<span class="string">&quot;&gt;&quot;</span>&gt;</span><br><span class="line">	&lt;deadLetterStrategy&gt;</span><br><span class="line">	&lt;!--</span><br><span class="line">		Use the prefix <span class="string">&#x27;DLQ.&#x27;</span> <span class="keyword">for</span> the destination name, and make</span><br><span class="line">		the DLQ a queue rather than a topic</span><br><span class="line">	--&gt;</span><br><span class="line">		&lt;individualDeadLetterStrategy queuePrefix=<span class="string">&quot;DLQ.&quot;</span>/&gt;</span><br><span class="line">	&lt;/deadLetterStrategy&gt;</span><br><span class="line">&lt;/policyEntry&gt;</span><br><span class="line">queuePrefix：设置死信队列前缀</span><br></pre></td></tr></table></figure>

<p>更多死信队列参考官网：<a target="_blank" rel="noopener" href="http://activemq.apache.org/message-redelivery-and-dlq-handling">Message Redelivery and DLQ Handling</a></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="http://xeons.cn">Calico</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="http://xeons.cn/2023/05/03/mq-basic/">http://xeons.cn/2023/05/03/mq-basic/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://xeons.cn" target="_blank">Calico's Space</a>！</span></div></div><script>function setClipboardText(event){
    let clipboardData = event.clipboardData || window.clipboardData;
    if (!clipboardData) { return; }
    event.preventDefault();
    let text = window.getSelection().toString();
    if (text) {
        event.preventDefault();
        var copyright = "\n\n---\n著作权归 Calico 所有 \n原文链接: http://xeons.cn/2023/05/03/mq-basic/";
        clipboardData.setData('text/plain', text + copyright);
    }
};
var contents = document.getElementsByClassName("post");
contents[0].addEventListener('copy',function(e){
    setClipboardText(e);
});</script><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/java/">java</a><a class="post-meta__tags" href="/tags/mq/">mq</a></div><div class="post_share"><div class="social-share" data-image="/2023/05/03/mq-basic/mq.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i>赞助</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/images/wxpay.png" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images/wxpay.png" alt="wechat"/></a><div class="post-qr-code-desc">wechat</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2023/05/04/tomcat-basic/" title="Tomcat 详解"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/05/04/tomcat-basic/logo.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Tomcat 详解</div></div></a></div><div class="next-post pull-right"><a href="/2023/05/03/mq-rabbitMQ/" title="消息队列-RabbitMQ"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/05/03/mq-rabbitMQ/logo.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">消息队列-RabbitMQ</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2023/05/04/mq-kafka/" title="消息队列-kafka"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/05/04/mq-kafka/logo.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-05-04</div><div class="title">消息队列-kafka</div></div></a></div><div><a href="/2023/05/03/mq-rabbitMQ/" title="消息队列-RabbitMQ"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/05/03/mq-rabbitMQ/logo.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-05-03</div><div class="title">消息队列-RabbitMQ</div></div></a></div><div><a href="/2023/05/03/mq-rocketMQ/" title="消息队列-rocketMQ"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/05/03/mq-rocketMQ/logo.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-05-03</div><div class="title">消息队列-rocketMQ</div></div></a></div><div><a href="/2023/01/03/data-structure-and-algorithm/" title="常见数据结构和算法"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/01/03/data-structure-and-algorithm/logo.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-01-03</div><div class="title">常见数据结构和算法</div></div></a></div><div><a href="/2023/06/03/hashmap-sourcecode-analyes/" title="HashMap 源码解析"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-06-03</div><div class="title">HashMap 源码解析</div></div></a></div><div><a href="/2023/06/03/java-basic/" title="Java 基础试题1"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/05/13/8KXvfwkxihBbtGM.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-06-03</div><div class="title">Java 基础试题1</div></div></a></div></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="lv-container" data-id="city" data-uid="MTAyMC81OTczMi8zNjE5NA=="></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images/calico.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Calico</div><div class="author-info__description">It's my blog，Record everything！</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">33</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">23</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">22</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xeonsuo"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/xeonsuo" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="https://weibo.com/xeons" target="_blank" title="微博"><i class="fab fa-weibo" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:xeon511@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">python、aiAgent 进化中...</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E5%92%8C%E5%85%B6%E4%BD%9C%E7%94%A8"><span class="toc-number">1.</span> <span class="toc-text">消息队列和其作用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ActiveMQ"><span class="toc-number">2.</span> <span class="toc-text">ActiveMQ</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A6%82%E5%BF%B5%E7%90%86%E8%A7%A3"><span class="toc-number">2.1.</span> <span class="toc-text">概念理解</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9B%86%E6%88%90%E5%92%8C%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="toc-number">2.2.</span> <span class="toc-text">集成和代码实现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87"><span class="toc-number">2.2.1.</span> <span class="toc-text">环境准备</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E5%90%AF%E5%8A%A8%E9%85%8D%E7%BD%AE%E5%92%8C%E4%BB%A3%E7%A0%81"><span class="toc-number">2.2.2.</span> <span class="toc-text">环境启动配置和代码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%98%9F%E5%88%97%E7%94%9F%E4%BA%A7%E8%80%85%E4%BB%A3%E7%A0%81"><span class="toc-number">2.2.3.</span> <span class="toc-text">队列生产者代码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%BB%E9%A2%98%E4%BB%A3%E7%A0%81"><span class="toc-number">2.2.4.</span> <span class="toc-text">主题代码</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%AB%98%E5%8F%AF%E7%94%A8"><span class="toc-number">2.3.</span> <span class="toc-text">高可用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8C%81%E4%B9%85%E5%8C%96%E6%96%B9%E6%A1%88"><span class="toc-number">2.3.1.</span> <span class="toc-text">持久化方案</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2"><span class="toc-number">2.3.2.</span> <span class="toc-text">集群部署</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8Ezk%E7%9A%84%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA"><span class="toc-number">2.3.3.</span> <span class="toc-text">基于zk的集群搭建</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Zookeeper%E9%9B%86%E7%BE%A4%E4%BB%8B%E7%BB%8D"><span class="toc-number">2.3.3.1.</span> <span class="toc-text">Zookeeper集群介绍</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E5%8E%9F%E7%90%86"><span class="toc-number">2.3.3.2.</span> <span class="toc-text">集群原理</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E6%93%8D%E4%BD%9C"><span class="toc-number">2.3.3.3.</span> <span class="toc-text">集群操作</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#zookeeper%E5%AE%89%E8%A3%85%E5%92%8C%E9%85%8D%E7%BD%AE"><span class="toc-number">2.3.3.4.</span> <span class="toc-text">zookeeper安装和配置</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#ActiveMQ%E5%AE%89%E8%A3%85%E5%92%8C%E9%85%8D%E7%BD%AE"><span class="toc-number">2.3.3.5.</span> <span class="toc-text">ActiveMQ安装和配置</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E9%9B%86%E7%BE%A4"><span class="toc-number">2.3.3.6.</span> <span class="toc-text">测试集群</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E5%8F%AF%E7%94%A8%E6%80%A7%E6%B5%8B%E8%AF%95"><span class="toc-number">2.3.3.7.</span> <span class="toc-text">集群可用性测试</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#java%E4%BB%A3%E7%A0%81%E8%BF%9E%E9%80%9A%E6%B5%8B%E8%AF%95"><span class="toc-number">2.3.3.8.</span> <span class="toc-text">java代码连通测试</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95Master%E9%80%89%E4%B8%BE"><span class="toc-number">2.3.3.9.</span> <span class="toc-text">测试Master选举</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7"><span class="toc-number">2.4.</span> <span class="toc-text">高级特性</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%BC%82%E6%AD%A5%E6%8A%95%E9%80%92"><span class="toc-number">2.4.0.1.</span> <span class="toc-text">异步投递</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%BB%B6%E8%BF%9F%E6%8A%95%E9%80%92%E5%92%8C%E5%AE%9A%E6%97%B6%E6%8A%95%E9%80%92"><span class="toc-number">2.4.0.2.</span> <span class="toc-text">延迟投递和定时投递</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E9%87%8D%E8%AF%95%E6%9C%BA%E5%88%B6"><span class="toc-number">2.4.0.3.</span> <span class="toc-text">消息重试机制</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%AD%BB%E4%BF%A1%E9%98%9F%E5%88%97"><span class="toc-number">2.4.0.4.</span> <span class="toc-text">死信队列</span></a></li></ol></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2023/08/15/vue3-quick/" title="vue3快速上手（尚硅谷b站）"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/08/15/vue3-quick/logo.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="vue3快速上手（尚硅谷b站）"/></a><div class="content"><a class="title" href="/2023/08/15/vue3-quick/" title="vue3快速上手（尚硅谷b站）">vue3快速上手（尚硅谷b站）</a><time datetime="2023-08-14T16:00:00.000Z" title="发表于 2023-08-15 00:00:00">2023-08-15</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/08/06/redis-basic/" title="redis 基础"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/08/06/redis-basic/logo.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="redis 基础"/></a><div class="content"><a class="title" href="/2023/08/06/redis-basic/" title="redis 基础">redis 基础</a><time datetime="2023-08-05T16:00:00.000Z" title="发表于 2023-08-06 00:00:00">2023-08-06</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/08/05/transactions-mysql/" title="mysql事务原理"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/08/05/transactions-mysql/logo.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="mysql事务原理"/></a><div class="content"><a class="title" href="/2023/08/05/transactions-mysql/" title="mysql事务原理">mysql事务原理</a><time datetime="2023-08-04T16:00:00.000Z" title="发表于 2023-08-05 00:00:00">2023-08-05</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/08/05/transactions-basic/" title="事务详解"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/08/05/transactions-basic/logo.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="事务详解"/></a><div class="content"><a class="title" href="/2023/08/05/transactions-basic/" title="事务详解">事务详解</a><time datetime="2023-08-04T16:00:00.000Z" title="发表于 2023-08-05 00:00:00">2023-08-05</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/06/23/java-memory-optimize/" title="JVM内存调优"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2023/06/23/java-memory-optimize/logo.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="JVM内存调优"/></a><div class="content"><a class="title" href="/2023/06/23/java-memory-optimize/" title="JVM内存调优">JVM内存调优</a><time datetime="2023-06-22T16:00:00.000Z" title="发表于 2023-06-23 00:00:00">2023-06-23</time></div></div></div></div></div></div></main><footer id="footer" style="background: none"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2025 By Calico</div><div class="footer_custom_text"><a href="icp"><span>Create By hexo,butterfly</span></a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=4.13.0"></script><script src="/js/main.js?v=4.13.0"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload@17.8.8/dist/lazyload.iife.min.js"></script><div class="js-pjax"><script>(() => {
  const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
  if ($mermaid.length === 0) return
  const runMermaid = () => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    Array.from($mermaid).forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const mermaidThemeConfig = '%%{init:{ \'theme\':\'' + theme + '\'}}%%\n'
      const mermaidID = 'mermaid-' + index
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)

      const renderV10 = () => {
        renderFn.then(({svg}) => {
          mermaidSrc.insertAdjacentHTML('afterend', svg)
        })
      }

      const renderV9 = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      typeof renderFn === 'string' ? renderV9(renderFn) : renderV10()
    })
  }

  const loadMermaid = () => {
    window.loadMermaid ? runMermaid() : getScript('https://cdn.jsdelivr.net/npm/mermaid@10.8.0/dist/mermaid.min.js').then(runMermaid)
  }

  btf.addGlobalFn('themeChange', runMermaid, 'mermaid')

  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script><script>(()=>{
  const loadLivere = () => {
    if (typeof LivereTower === 'object') window.LivereTower.init()
    else {
      (function(d, s) {
          var j, e = d.getElementsByTagName(s)[0];
          if (typeof LivereTower === 'function') { return; }
          j = d.createElement(s);
          j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
          j.async = true;
          e.parentNode.insertBefore(j, e);
      })(document, 'script');
    }
  }

  if ('Livere' === 'Livere' || !false) {
    if (false) btf.loadComment(document.getElementById('lv-container'), loadLivere)
    else loadLivere()
  } else {
    window.loadOtherComment = loadLivere
  }
})()</script></div><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="false" data-click="true"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>